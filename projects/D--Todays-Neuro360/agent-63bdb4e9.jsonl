{"parentUuid":null,"isSidechain":true,"userType":"external","cwd":"D:\\Todays\\Neuro360","sessionId":"042556c2-8872-4445-8efb-d2658cbac4a7","version":"2.0.33","gitBranch":"main","agentId":"63bdb4e9","type":"user","message":{"role":"user","content":"The user is getting a \"API Quota Exceeded\" error for Google Gemini API even though billing is enabled. The error is coming from AlgorithmDataProcessor.jsx:476.\n\nPlease investigate:\n1. Read AlgorithmDataProcessor.jsx around line 476 to understand the error handling\n2. Read the Gemini PDF generator service to see how the API is being called\n3. Check server/index.js and any environment configuration for API key setup\n4. Look for rate limiting, quota management, or API configuration issues\n5. Check if there are multiple API calls being made that could exceed limits\n6. Identify the root cause of why billing-enabled account is still hitting quota limits\n\nReturn a comprehensive analysis of:\n- What the current implementation does\n- Why the quota error might be occurring despite billing\n- The likely root cause (wrong API key, rate limiting, concurrent requests, etc.)\n- What needs to be fixed"},"uuid":"6f5ff0af-aaf9-4ed6-a1b7-3c39ca04fc6a","timestamp":"2025-12-09T06:10:58.925Z"}
{"parentUuid":"6f5ff0af-aaf9-4ed6-a1b7-3c39ca04fc6a","isSidechain":true,"userType":"external","cwd":"D:\\Todays\\Neuro360","sessionId":"042556c2-8872-4445-8efb-d2658cbac4a7","version":"2.0.33","gitBranch":"main","agentId":"63bdb4e9","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01SJrFTc9kc2CR2DshAQsggf","type":"message","role":"assistant","content":[{"type":"text","text":"I'll investigate the Google Gemini API quota issue systematically. Let me start by reading the relevant files."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":9033,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":9033,"ephemeral_1h_input_tokens":0},"output_tokens":208,"service_tier":"standard"}},"requestId":"req_011CVvck1XeH3WTGzZUNgwVG","type":"assistant","uuid":"7f308e53-8213-4f16-9ecf-2487e398ca33","timestamp":"2025-12-09T06:11:01.911Z"}
{"parentUuid":"7f308e53-8213-4f16-9ecf-2487e398ca33","isSidechain":true,"userType":"external","cwd":"D:\\Todays\\Neuro360","sessionId":"042556c2-8872-4445-8efb-d2658cbac4a7","version":"2.0.33","gitBranch":"main","agentId":"63bdb4e9","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01SJrFTc9kc2CR2DshAQsggf","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01QvEcFS4mHKs9d6ZYqCAUKf","name":"Read","input":{"file_path":"D:\\Todays\\Neuro360\\src\\components\\admin\\AlgorithmDataProcessor.jsx"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":9033,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":9033,"ephemeral_1h_input_tokens":0},"output_tokens":208,"service_tier":"standard"}},"requestId":"req_011CVvck1XeH3WTGzZUNgwVG","type":"assistant","uuid":"f479768f-2c4c-4185-b079-26fcc0a22c33","timestamp":"2025-12-09T06:11:02.818Z"}
{"parentUuid":"f479768f-2c4c-4185-b079-26fcc0a22c33","isSidechain":true,"userType":"external","cwd":"D:\\Todays\\Neuro360","sessionId":"042556c2-8872-4445-8efb-d2658cbac4a7","version":"2.0.33","gitBranch":"main","agentId":"63bdb4e9","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01SJrFTc9kc2CR2DshAQsggf","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01U7zdbUGauYpan9qyf7caW4","name":"Read","input":{"file_path":"D:\\Todays\\Neuro360\\server\\services\\geminiPdfGenerator.js"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":9033,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":9033,"ephemeral_1h_input_tokens":0},"output_tokens":208,"service_tier":"standard"}},"requestId":"req_011CVvck1XeH3WTGzZUNgwVG","type":"assistant","uuid":"63bc105e-09b3-4ce6-9460-31016494ae2e","timestamp":"2025-12-09T06:11:03.319Z"}
{"parentUuid":"63bc105e-09b3-4ce6-9460-31016494ae2e","isSidechain":true,"userType":"external","cwd":"D:\\Todays\\Neuro360","sessionId":"042556c2-8872-4445-8efb-d2658cbac4a7","version":"2.0.33","gitBranch":"main","agentId":"63bdb4e9","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01SJrFTc9kc2CR2DshAQsggf","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01THuFjyg75GtEfUTvwrMnUj","name":"Read","input":{"file_path":"D:\\Todays\\Neuro360\\server\\index.js"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":9033,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":9033,"ephemeral_1h_input_tokens":0},"output_tokens":208,"service_tier":"standard"}},"requestId":"req_011CVvck1XeH3WTGzZUNgwVG","type":"assistant","uuid":"2177f1b0-0e34-45a7-b296-22e76a83522d","timestamp":"2025-12-09T06:11:03.683Z"}
{"parentUuid":"2177f1b0-0e34-45a7-b296-22e76a83522d","isSidechain":true,"userType":"external","cwd":"D:\\Todays\\Neuro360","sessionId":"042556c2-8872-4445-8efb-d2658cbac4a7","version":"2.0.33","gitBranch":"main","agentId":"63bdb4e9","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01THuFjyg75GtEfUTvwrMnUj","type":"tool_result","content":"     1â†’const path = require('path');\n     2â†’require('dotenv').config({ path: path.join(__dirname, '.env') });\n     3â†’const express = require('express');\n     4â†’const cors = require('cors');\n     5â†’const fs = require('fs');\n     6â†’const qeegRoutes = require('./routes/qeegRoutes');\n     7â†’\n     8â†’const app = express();\n     9â†’const PORT = process.env.PORT || 5000;\n    10â†’\n    11â†’// Middleware - CORS Configuration\n    12â†’// Allow multiple origins (development + production)\n    13â†’const allowedOrigins = [\n    14â†’  'http://localhost:3000',      // Local dev - Vite primary\n    15â†’  'http://localhost:3001',      // Local dev - Vite alternate\n    16â†’  'http://localhost:3002',      // Local dev - Vite alternate\n    17â†’  'http://localhost:5173',      // Local dev - Vite default\n    18â†’  'https://neurosense360.site', // Production\n    19â†’  'https://www.neurosense360.site' // Production with www\n    20â†’];\n    21â†’\n    22â†’app.use(cors({\n    23â†’  origin: function (origin, callback) {\n    24â†’    // Allow requests with no origin (mobile apps, Postman, curl, etc.)\n    25â†’    if (!origin) return callback(null, true);\n    26â†’\n    27â†’    if (allowedOrigins.indexOf(origin) !== -1) {\n    28â†’      callback(null, true);\n    29â†’    } else {\n    30â†’      console.log('CORS blocked origin:', origin);\n    31â†’      callback(new Error('Not allowed by CORS'));\n    32â†’    }\n    33â†’  },\n    34â†’  credentials: true,\n    35â†’  methods: ['GET', 'POST', 'PUT', 'DELETE', 'OPTIONS'],\n    36â†’  allowedHeaders: ['Content-Type', 'Authorization']\n    37â†’}));\n    38â†’app.use(express.json());\n    39â†’app.use(express.urlencoded({ extended: true }));\n    40â†’\n    41â†’// Custom route to serve PDFs with download headers\n    42â†’app.get('/uploads/:filename', (req, res) => {\n    43â†’  const filename = req.params.filename;\n    44â†’  const filePath = path.join(__dirname, 'uploads', filename);\n    45â†’\n    46â†’  // Check if file exists\n    47â†’  if (!fs.existsSync(filePath)) {\n    48â†’    return res.status(404).json({ error: 'File not found' });\n    49â†’  }\n    50â†’\n    51â†’  // Set headers to force download\n    52â†’  res.setHeader('Content-Type', 'application/pdf');\n    53â†’  res.setHeader('Content-Disposition', `attachment; filename=\"${filename}\"`);\n    54â†’\n    55â†’  // Send file\n    56â†’  res.sendFile(filePath);\n    57â†’});\n    58â†’\n    59â†’// Routes\n    60â†’app.use('/api/qeeg', qeegRoutes);\n    61â†’\n    62â†’// Health check\n    63â†’app.get('/api/health', (req, res) => {\n    64â†’  res.json({\n    65â†’    status: 'ok',\n    66â†’    message: 'Neuro360 Backend Server is running',\n    67â†’    timestamp: new Date().toISOString(),\n    68â†’    env: {\n    69â†’      geminiApiKey: !!process.env.GEMINI_API_KEY,\n    70â†’      openaiApiKey: !!process.env.OPENAI_API_KEY,\n    71â†’      supabaseUrl: !!process.env.SUPABASE_URL\n    72â†’    }\n    73â†’  });\n    74â†’});\n    75â†’\n    76â†’// Gemini API test endpoint\n    77â†’app.get('/api/test-gemini', async (req, res) => {\n    78â†’  try {\n    79â†’    const GeminiService = require('./services/geminiService');\n    80â†’\n    81â†’    console.log('ðŸ§ª Testing Gemini API connection...');\n    82â†’    const result = await GeminiService.testConnection();\n    83â†’\n    84â†’    res.json({\n    85â†’      success: result.success,\n    86â†’      message: result.success ? 'Gemini API is working!' : 'Gemini API test failed',\n    87â†’      response: result.response || null,\n    88â†’      error: result.error || null\n    89â†’    });\n    90â†’  } catch (error) {\n    91â†’    console.error('âŒ Gemini test error:', error);\n    92â†’    res.status(500).json({\n    93â†’      success: false,\n    94â†’      message: 'Gemini API test failed',\n    95â†’      error: error.message\n    96â†’    });\n    97â†’  }\n    98â†’});\n    99â†’\n   100â†’// Error handling middleware\n   101â†’app.use((err, req, res, next) => {\n   102â†’  console.error('Error:', err);\n   103â†’  res.status(err.status || 500).json({\n   104â†’    error: true,\n   105â†’    message: err.message || 'Internal server error',\n   106â†’    ...(process.env.NODE_ENV === 'development' && { stack: err.stack })\n   107â†’  });\n   108â†’});\n   109â†’\n   110â†’// Start server\n   111â†’app.listen(PORT, () => {\n   112â†’  console.log(`ðŸš€ Neuro360 Backend Server running on port ${PORT}`);\n   113â†’  console.log(`ðŸ“Š QEEG Processing API: http://localhost:${PORT}/api/qeeg`);\n   114â†’  console.log(`ðŸ’š Health Check: http://localhost:${PORT}/api/health`);\n   115â†’\n   116â†’  // Environment variable checks\n   117â†’  console.log('\\nðŸ“‹ Environment Configuration:');\n   118â†’  console.log(`   PORT: ${PORT}`);\n   119â†’  console.log(`   NODE_ENV: ${process.env.NODE_ENV || 'not set'}`);\n   120â†’  console.log(`   GEMINI_API_KEY: ${process.env.GEMINI_API_KEY ? 'âœ“ Set' : 'âœ— Missing'}`);\n   121â†’  console.log(`   OPENAI_API_KEY: ${process.env.OPENAI_API_KEY ? 'âœ“ Set' : 'âœ— Missing'}`);\n   122â†’  console.log(`   SUPABASE_URL: ${process.env.SUPABASE_URL ? 'âœ“ Set' : 'âœ— Missing'}`);\n   123â†’  console.log(`   SUPABASE_SERVICE_ROLE_KEY: ${process.env.SUPABASE_SERVICE_ROLE_KEY ? 'âœ“ Set' : 'âœ— Missing'}`);\n   124â†’  console.log('');\n   125â†’});\n   126â†’\n   127â†’module.exports = app;\n   128â†’\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"db3765c1-ee78-47a3-b2a6-dcd3e32b0a16","timestamp":"2025-12-09T06:11:10.702Z","toolUseResult":{"type":"text","file":{"filePath":"D:\\Todays\\Neuro360\\server\\index.js","content":"const path = require('path');\nrequire('dotenv').config({ path: path.join(__dirname, '.env') });\nconst express = require('express');\nconst cors = require('cors');\nconst fs = require('fs');\nconst qeegRoutes = require('./routes/qeegRoutes');\n\nconst app = express();\nconst PORT = process.env.PORT || 5000;\n\n// Middleware - CORS Configuration\n// Allow multiple origins (development + production)\nconst allowedOrigins = [\n  'http://localhost:3000',      // Local dev - Vite primary\n  'http://localhost:3001',      // Local dev - Vite alternate\n  'http://localhost:3002',      // Local dev - Vite alternate\n  'http://localhost:5173',      // Local dev - Vite default\n  'https://neurosense360.site', // Production\n  'https://www.neurosense360.site' // Production with www\n];\n\napp.use(cors({\n  origin: function (origin, callback) {\n    // Allow requests with no origin (mobile apps, Postman, curl, etc.)\n    if (!origin) return callback(null, true);\n\n    if (allowedOrigins.indexOf(origin) !== -1) {\n      callback(null, true);\n    } else {\n      console.log('CORS blocked origin:', origin);\n      callback(new Error('Not allowed by CORS'));\n    }\n  },\n  credentials: true,\n  methods: ['GET', 'POST', 'PUT', 'DELETE', 'OPTIONS'],\n  allowedHeaders: ['Content-Type', 'Authorization']\n}));\napp.use(express.json());\napp.use(express.urlencoded({ extended: true }));\n\n// Custom route to serve PDFs with download headers\napp.get('/uploads/:filename', (req, res) => {\n  const filename = req.params.filename;\n  const filePath = path.join(__dirname, 'uploads', filename);\n\n  // Check if file exists\n  if (!fs.existsSync(filePath)) {\n    return res.status(404).json({ error: 'File not found' });\n  }\n\n  // Set headers to force download\n  res.setHeader('Content-Type', 'application/pdf');\n  res.setHeader('Content-Disposition', `attachment; filename=\"${filename}\"`);\n\n  // Send file\n  res.sendFile(filePath);\n});\n\n// Routes\napp.use('/api/qeeg', qeegRoutes);\n\n// Health check\napp.get('/api/health', (req, res) => {\n  res.json({\n    status: 'ok',\n    message: 'Neuro360 Backend Server is running',\n    timestamp: new Date().toISOString(),\n    env: {\n      geminiApiKey: !!process.env.GEMINI_API_KEY,\n      openaiApiKey: !!process.env.OPENAI_API_KEY,\n      supabaseUrl: !!process.env.SUPABASE_URL\n    }\n  });\n});\n\n// Gemini API test endpoint\napp.get('/api/test-gemini', async (req, res) => {\n  try {\n    const GeminiService = require('./services/geminiService');\n\n    console.log('ðŸ§ª Testing Gemini API connection...');\n    const result = await GeminiService.testConnection();\n\n    res.json({\n      success: result.success,\n      message: result.success ? 'Gemini API is working!' : 'Gemini API test failed',\n      response: result.response || null,\n      error: result.error || null\n    });\n  } catch (error) {\n    console.error('âŒ Gemini test error:', error);\n    res.status(500).json({\n      success: false,\n      message: 'Gemini API test failed',\n      error: error.message\n    });\n  }\n});\n\n// Error handling middleware\napp.use((err, req, res, next) => {\n  console.error('Error:', err);\n  res.status(err.status || 500).json({\n    error: true,\n    message: err.message || 'Internal server error',\n    ...(process.env.NODE_ENV === 'development' && { stack: err.stack })\n  });\n});\n\n// Start server\napp.listen(PORT, () => {\n  console.log(`ðŸš€ Neuro360 Backend Server running on port ${PORT}`);\n  console.log(`ðŸ“Š QEEG Processing API: http://localhost:${PORT}/api/qeeg`);\n  console.log(`ðŸ’š Health Check: http://localhost:${PORT}/api/health`);\n\n  // Environment variable checks\n  console.log('\\nðŸ“‹ Environment Configuration:');\n  console.log(`   PORT: ${PORT}`);\n  console.log(`   NODE_ENV: ${process.env.NODE_ENV || 'not set'}`);\n  console.log(`   GEMINI_API_KEY: ${process.env.GEMINI_API_KEY ? 'âœ“ Set' : 'âœ— Missing'}`);\n  console.log(`   OPENAI_API_KEY: ${process.env.OPENAI_API_KEY ? 'âœ“ Set' : 'âœ— Missing'}`);\n  console.log(`   SUPABASE_URL: ${process.env.SUPABASE_URL ? 'âœ“ Set' : 'âœ— Missing'}`);\n  console.log(`   SUPABASE_SERVICE_ROLE_KEY: ${process.env.SUPABASE_SERVICE_ROLE_KEY ? 'âœ“ Set' : 'âœ— Missing'}`);\n  console.log('');\n});\n\nmodule.exports = app;\n","numLines":128,"startLine":1,"totalLines":128}}}
{"parentUuid":"db3765c1-ee78-47a3-b2a6-dcd3e32b0a16","isSidechain":true,"userType":"external","cwd":"D:\\Todays\\Neuro360","sessionId":"042556c2-8872-4445-8efb-d2658cbac4a7","version":"2.0.33","gitBranch":"main","agentId":"63bdb4e9","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01U7zdbUGauYpan9qyf7caW4","type":"tool_result","content":"     1â†’const PDFDocument = require('pdfkit');\n     2â†’const fs = require('fs');\n     3â†’const path = require('path');\n     4â†’const GeminiService = require('./geminiService');\n     5â†’const { ChartJSNodeCanvas } = require('chartjs-node-canvas');\n     6â†’\n     7â†’class GeminiPdfGenerator {\n     8â†’  constructor(patientData, algorithmResults, qeegData) {\n     9â†’    this.patientData = patientData;\n    10â†’    this.algorithmResults = algorithmResults;\n    11â†’    this.qeegData = qeegData;\n    12â†’    this.geminiReportData = null;\n    13â†’  }\n    14â†’\n    15â†’  /**\n    16â†’   * Transform algorithm results to Gemini input format\n    17â†’   */\n    18â†’  transformToGeminiFormat() {\n    19â†’    const brainParameters = {\n    20â†’      Cognition: null,\n    21â†’      Stress: null,\n    22â†’      FocusAndAttention: null,\n    23â†’      BurnoutAndFatigue: null,\n    24â†’      EmotionalRegulation: null,\n    25â†’      Learning: null,\n    26â†’      Creativity: null\n    27â†’    };\n    28â†’\n    29â†’    // Map the parameters from algorithm results\n    30â†’    this.algorithmResults.parameters.forEach(param => {\n    31â†’      const paramName = param.name.replace(/\\s+/g, '').replace(/&/g, 'And');\n    32â†’      if (brainParameters.hasOwnProperty(paramName)) {\n    33â†’        brainParameters[paramName] = {\n    34â†’          score: param.score,\n    35â†’          maxScore: param.maxScore,\n    36â†’          bucket: param.bucket || param.classification,\n    37â†’          subparameters: (param.metrics || param.subParameters || []).map(metric => ({\n    38â†’            name: metric.name,\n    39â†’            score: metric.score,\n    40â†’            value: metric.value,\n    41â†’            threshold: metric.threshold\n    42â†’          }))\n    43â†’        };\n    44â†’      }\n    45â†’    });\n    46â†’\n    47â†’    return brainParameters;\n    48â†’  }\n    49â†’\n    50â†’  /**\n    51â†’   * Generate report structure using Gemini AI\n    52â†’   */\n    53â†’  async generateReportStructure() {\n    54â†’    console.log('\\nðŸ¤– === Generating report structure with Gemini AI ===');\n    55â†’    const brainParameters = this.transformToGeminiFormat();\n    56â†’\n    57â†’    console.log('ðŸ“Š INPUT DATA TO GEMINI (Brain Parameters):');\n    58â†’    Object.keys(brainParameters).forEach(paramKey => {\n    59â†’      const param = brainParameters[paramKey];\n    60â†’      if (param) {\n    61â†’        console.log(`   ${paramKey}: score=${param.score}/${param.maxScore}, bucket=${param.bucket}, subParams=${param.subparameters?.length || 0}`);\n    62â†’      }\n    63â†’    });\n    64â†’\n    65â†’    try {\n    66â†’      const result = await GeminiService.generateBrainPerformanceReport(brainParameters);\n    67â†’\n    68â†’      if (!result.success) {\n    69â†’        console.error('âŒ Gemini API returned error:', result.error);\n    70â†’        throw new Error(`Gemini AI failed: ${result.error}`);\n    71â†’      }\n    72â†’\n    73â†’      this.geminiReportData = result.data;\n    74â†’      console.log('\\nâœ… Gemini report structure generated successfully');\n    75â†’      console.log('ðŸ“„ OUTPUT FROM GEMINI:');\n    76â†’      if (result.data.parameters) {\n    77â†’        result.data.parameters.forEach(param => {\n    78â†’          console.log(`   ${param.name}: score=${param.score}/${param.maxScore}, bucket=${param.bucket}`);\n    79â†’        });\n    80â†’      }\n    81â†’\n    82â†’      return this.geminiReportData;\n    83â†’    } catch (error) {\n    84â†’      console.error('âŒ Error in generateReportStructure:', error.message);\n    85â†’      console.error('   Stack:', error.stack);\n    86â†’      throw error;\n    87â†’    }\n    88â†’  }\n    89â†’\n    90â†’  /**\n    91â†’   * Main report generation function\n    92â†’   */\n    93â†’  async generateReport(outputPath) {\n    94â†’    try {\n    95â†’      // Step 1: Try to generate AI report structure with Gemini\n    96â†’      let usingGemini = false;\n    97â†’      try {\n    98â†’        console.log('ðŸ¤– Attempting to generate report with Gemini AI...');\n    99â†’        await this.generateReportStructure();\n   100â†’        usingGemini = true;\n   101â†’        console.log('âœ… Gemini AI report structure ready');\n   102â†’      } catch (geminiError) {\n   103â†’        console.error('âš ï¸ Gemini AI failed, using fallback data structure');\n   104â†’        console.error('   Gemini Error:', geminiError.message);\n   105â†’\n   106â†’        // Fallback: Create basic report structure from algorithm data\n   107â†’        this.geminiReportData = this.createFallbackReportStructure();\n   108â†’        console.log('âœ… Fallback report structure created');\n   109â†’      }\n   110â†’\n   111â†’      // Step 2: Create PDF from the report structure (AI or fallback)\n   112â†’      const doc = new PDFDocument({\n   113â†’        size: 'A4',\n   114â†’        margins: { top: 50, bottom: 50, left: 50, right: 50 }\n   115â†’      });\n   116â†’\n   117â†’      const stream = fs.createWriteStream(outputPath);\n   118â†’      doc.pipe(stream);\n   119â†’\n   120â†’      // Generate PDF content\n   121â†’      await this.generatePDFContent(doc);\n   122â†’\n   123â†’      doc.end();\n   124â†’\n   125â†’      // Wait for PDF to finish writing\n   126â†’      await new Promise((resolve, reject) => {\n   127â†’        stream.on('finish', resolve);\n   128â†’        stream.on('error', reject);\n   129â†’      });\n   130â†’\n   131â†’      const sourceType = usingGemini ? 'Gemini AI' : 'Fallback (Basic)';\n   132â†’      console.log(`âœ… PDF generated successfully with ${sourceType} content`);\n   133â†’      return outputPath;\n   134â†’\n   135â†’    } catch (error) {\n   136â†’      console.error('âŒ Error generating PDF:', error);\n   137â†’      console.error('   Stack:', error.stack);\n   138â†’      throw error;\n   139â†’    }\n   140â†’  }\n   141â†’\n   142â†’  /**\n   143â†’   * Create fallback report structure when Gemini fails\n   144â†’   */\n   145â†’  createFallbackReportStructure() {\n   146â†’    console.log('ðŸ“‹ Creating fallback report structure...');\n   147â†’    console.log('   Algorithm results:', JSON.stringify(this.algorithmResults, null, 2));\n   148â†’\n   149â†’    const parameters = this.algorithmResults.parameters.map(param => {\n   150â†’      // Use metrics (correct field from algorithm) instead of subParameters\n   151â†’      const subMetrics = param.metrics || param.subParameters || [];\n   152â†’\n   153â†’      console.log(`   Processing ${param.name}:`);\n   154â†’      console.log(`     Score: ${param.score}/${param.maxScore}`);\n   155â†’      console.log(`     Classification: ${param.classification}`);\n   156â†’      console.log(`     Metrics count: ${subMetrics.length}`);\n   157â†’\n   158â†’      return {\n   159â†’        name: param.name,\n   160â†’        score: param.score,\n   161â†’        bucket: param.classification || 'Average',\n   162â†’        bucketColor: this.getBucketColor(param.classification, param.name),\n   163â†’        summary: `${param.name} score is ${param.score} out of ${param.maxScore} (${param.classification || 'Average'})`,\n   164â†’        subparameters: subMetrics.map(metric => ({\n   165â†’          name: metric.name || 'Metric',\n   166â†’          score: metric.score !== undefined ? metric.score : (typeof metric.value === 'number' ? metric.value : 0),\n   167â†’          interpretation: metric.score === 1 ? 'âœ“ Within optimal range' : 'âœ— Outside optimal range',\n   168â†’          details: metric.description || (metric.value !== undefined && typeof metric.value === 'number' ? `Value: ${metric.value.toFixed(2)}` : '')\n   169â†’        }))\n   170â†’      };\n   171â†’    });\n   172â†’\n   173â†’    console.log('   Fallback structure created with', parameters.length, 'parameters');\n   174â†’\n   175â†’    return {\n   176â†’      title: 'Brain Performance Report',\n   177â†’      patientSummary: `This report shows the analysis of ${this.algorithmResults.parameters.length} brain performance parameters for ${this.patientData.name}. Overall score: ${this.algorithmResults.overallScore || 'N/A'}.`,\n   178â†’      parameters: parameters,\n   179â†’      recommendations: [\n   180â†’        'Continue monitoring brain health metrics regularly',\n   181â†’        'Maintain healthy lifestyle habits including proper sleep and exercise',\n   182â†’        'Consult with healthcare provider for detailed interpretation and personalized recommendations'\n   183â†’      ]\n   184â†’    };\n   185â†’  }\n   186â†’\n   187â†’  /**\n   188â†’   * Generate PDF content from Gemini AI data\n   189â†’   */\n   190â†’  async generatePDFContent(doc) {\n   191â†’    const reportData = this.geminiReportData;\n   192â†’\n   193â†’    console.log('\\nðŸ“„ === Generating PDF Content ===');\n   194â†’    console.log('   Report Title:', reportData.title);\n   195â†’    console.log('   Parameters count:', reportData.parameters?.length || 0);\n   196â†’\n   197â†’    if (reportData.parameters && reportData.parameters.length > 0) {\n   198â†’      reportData.parameters.forEach((param, idx) => {\n   199â†’        console.log(`   ${idx + 1}. ${param.name}: ${param.score} (${param.bucket}), Sub-metrics: ${param.subparameters?.length || 0}`);\n   200â†’      });\n   201â†’    }\n   202â†’\n   203â†’    // Header\n   204â†’    this.addHeader(doc);\n   205â†’\n   206â†’    // Add watermark to first page\n   207â†’    this.addWatermark(doc);\n   208â†’\n   209â†’    // Patient Information\n   210â†’    this.addPatientInfo(doc);\n   211â†’\n   212â†’    doc.moveDown(0.3);\n   213â†’\n   214â†’    // Title with decorative elements - Infographic Style\n   215â†’    const titleY = doc.y;\n   216â†’\n   217â†’    // Decorative line before title\n   218â†’    doc.moveTo(150, titleY)\n   219â†’       .lineTo(445, titleY)\n   220â†’       .lineWidth(2)\n   221â†’       .stroke('#4299E1');\n   222â†’\n   223â†’    doc.moveDown(0.3);\n   224â†’\n   225â†’    doc.fontSize(20)\n   226â†’       .fillColor('#323956')\n   227â†’       .font('Helvetica-Bold')\n   228â†’       .text(reportData.title || 'Brain Performance Infographic', 50, doc.y, { width: 495, align: 'center' });\n   229â†’\n   230â†’    // Subtitle if available\n   231â†’    if (reportData.subtitle) {\n   232â†’      doc.fontSize(11)\n   233â†’         .fillColor('#4A5568')\n   234â†’         .font('Helvetica')\n   235â†’         .text(reportData.subtitle, 50, doc.y, { width: 495, align: 'center' });\n   236â†’    }\n   237â†’\n   238â†’    doc.moveDown(0.3);\n   239â†’\n   240â†’    // Decorative line after title\n   241â†’    const afterTitleY = doc.y;\n   242â†’    doc.moveTo(150, afterTitleY)\n   243â†’       .lineTo(445, afterTitleY)\n   244â†’       .lineWidth(2)\n   245â†’       .stroke('#4299E1');\n   246â†’\n   247â†’    doc.moveDown(0.5);\n   248â†’\n   249â†’    // === RADAR CHART - Visual Infographic ===\n   250â†’    try {\n   251â†’      const chartBuffer = await this.generateRadarChart();\n   252â†’      if (chartBuffer) {\n   253â†’        // Add chart to PDF\n   254â†’        const chartX = (595 - 400) / 2; // Center on A4 page (595px wide)\n   255â†’        const chartY = doc.y;\n   256â†’\n   257â†’        doc.image(chartBuffer, chartX, chartY, {\n   258â†’          width: 400,\n   259â†’          height: 400,\n   260â†’          align: 'center'\n   261â†’        });\n   262â†’\n   263â†’        console.log(`âœ… Radar chart embedded in PDF at position (${chartX}, ${chartY})`);\n   264â†’\n   265â†’        // Move cursor below chart - reduced spacing\n   266â†’        doc.y = chartY + 380;\n   267â†’      }\n   268â†’    } catch (chartError) {\n   269â†’      console.error('âš ï¸  Could not add radar chart to PDF:', chartError.message);\n   270â†’      // Continue without chart if it fails\n   271â†’    }\n   272â†’\n   273â†’    // Parameters Section\n   274â†’    if (reportData.parameters && reportData.parameters.length > 0) {\n   275â†’      console.log('\\nðŸ“Š Adding parameters to PDF...');\n   276â†’      reportData.parameters.forEach((param, index) => {\n   277â†’        this.addParameterSection(doc, param, index);\n   278â†’      });\n   279â†’      console.log('âœ… All parameters added to PDF\\n');\n   280â†’    } else {\n   281â†’      console.error('âŒ No parameters found in report data!');\n   282â†’    }\n   283â†’\n   284â†’    doc.moveDown(1);\n   285â†’\n   286â†’    // === NEW: Extracted QEEG Data Section ===\n   287â†’    console.log('ðŸ“Š Adding Extracted QEEG Data section...');\n   288â†’    this.addExtractedDataSection(doc);\n   289â†’    console.log('âœ… Extracted data section added\\n');\n   290â†’\n   291â†’    doc.moveDown(1);\n   292â†’\n   293â†’    // === NEW: Detailed Calculations Section ===\n   294â†’    console.log('ðŸ§® Adding Detailed Calculations section...');\n   295â†’    this.addCalculationsSection(doc);\n   296â†’    console.log('âœ… Calculations section added\\n');\n   297â†’\n   298â†’    doc.moveDown(1);\n   299â†’\n   300â†’    // Patient Summary\n   301â†’    if (reportData.patientSummary) {\n   302â†’      this.addSummarySection(doc, reportData.patientSummary);\n   303â†’    }\n   304â†’\n   305â†’    // Recommendations\n   306â†’    if (reportData.recommendations && reportData.recommendations.length > 0) {\n   307â†’      this.addRecommendations(doc, reportData.recommendations);\n   308â†’    }\n   309â†’\n   310â†’    // Footer\n   311â†’    this.addFooter(doc);\n   312â†’  }\n   313â†’\n   314â†’  /**\n   315â†’   * Add header to PDF - Infographic Style\n   316â†’   */\n   317â†’  addHeader(doc) {\n   318â†’    // Bold colored header bar for infographic look\n   319â†’    doc.rect(0, 0, 595, 60)\n   320â†’       .fill('#323956');\n   321â†’\n   322â†’    // Add logo to top right if available\n   323â†’    try {\n   324â†’      // Try multiple possible logo locations\n   325â†’      const logoPaths = [\n   326â†’        path.join(__dirname, '../../public/header logo.png'),\n   327â†’        path.join(__dirname, '../assets/header-logo.png')\n   328â†’      ];\n   329â†’\n   330â†’      let logoPath = null;\n   331â†’      for (const testPath of logoPaths) {\n   332â†’        if (fs.existsSync(testPath)) {\n   333â†’          logoPath = testPath;\n   334â†’          break;\n   335â†’        }\n   336â†’      }\n   337â†’\n   338â†’      if (logoPath) {\n   339â†’        doc.image(logoPath, 470, 5, {\n   340â†’          width: 55,\n   341â†’          height: 55,\n   342â†’          fit: [55, 55]\n   343â†’        });\n   344â†’      }\n   345â†’    } catch (logoError) {\n   346â†’      console.log('Logo not found, continuing without it:', logoError.message);\n   347â†’    }\n   348â†’\n   349â†’    doc.fontSize(16)\n   350â†’       .fillColor('#FFFFFF')\n   351â†’       .font('Helvetica-Bold')\n   352â†’       .text('NeuroSense Report', 50, 20);\n   353â†’\n   354â†’    doc.fontSize(10)\n   355â†’       .fillColor('#A8D5FF')\n   356â†’       .font('Helvetica')\n   357â†’       .text('Brain Performance Analysis', 50, 42);\n   358â†’\n   359â†’    doc.fontSize(9)\n   360â†’       .fillColor('#FFFFFF')\n   361â†’       .text(new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' }), 360, 28);\n   362â†’\n   363â†’    doc.moveDown(2);\n   364â†’  }\n   365â†’\n   366â†’  /**\n   367â†’   * Add patient information - Infographic Style\n   368â†’   */\n   369â†’  addPatientInfo(doc) {\n   370â†’    const y = doc.y;\n   371â†’\n   372â†’    // Colored info box for visual appeal - increased height for more fields\n   373â†’    doc.roundedRect(50, y, 495, 85, 5)\n   374â†’       .fillAndStroke('#F7FAFC', '#E2E8F0');\n   375â†’\n   376â†’    doc.fontSize(11)\n   377â†’       .fillColor('#323956')\n   378â†’       .font('Helvetica-Bold')\n   379â†’       .text('Patient Information', 60, y + 10);\n   380â†’\n   381â†’    // Row 1: Name and Date of Recording (properly aligned)\n   382â†’    const col1X = 60;\n   383â†’    const col1ValueX = 145;\n   384â†’    const col2X = 310;\n   385â†’    const col2ValueX = 430;\n   386â†’\n   387â†’    doc.fontSize(9)\n   388â†’       .fillColor('#4A5568')\n   389â†’       .font('Helvetica-Bold')\n   390â†’       .text('Name:', col1X, y + 28)\n   391â†’       .font('Helvetica')\n   392â†’       .fillColor('#2D3748')\n   393â†’       .text(this.patientData.name || 'N/A', col1ValueX, y + 28);\n   394â†’\n   395â†’    doc.font('Helvetica-Bold')\n   396â†’       .fillColor('#4A5568')\n   397â†’       .text('Date of Recording:', col2X, y + 28)\n   398â†’       .font('Helvetica')\n   399â†’       .fillColor('#2D3748')\n   400â†’       .text(this.patientData.dateOfRecording || this.patientData.recordingDate || new Date().toLocaleDateString('en-US'), col2ValueX, y + 28);\n   401â†’\n   402â†’    // Row 2: Age and Clinic (properly aligned)\n   403â†’    doc.font('Helvetica-Bold')\n   404â†’       .fillColor('#4A5568')\n   405â†’       .text('Age:', col1X, y + 45)\n   406â†’       .font('Helvetica')\n   407â†’       .fillColor('#2D3748')\n   408â†’       .text(`${this.patientData.age || 'N/A'}`, col1ValueX, y + 45);\n   409â†’\n   410â†’    if (this.patientData.clinicName) {\n   411â†’      doc.font('Helvetica-Bold')\n   412â†’         .fillColor('#4A5568')\n   413â†’         .text('Clinic:', col2X, y + 45)\n   414â†’         .font('Helvetica')\n   415â†’         .fillColor('#2D3748')\n   416â†’         .text(this.patientData.clinicName, col2ValueX, y + 45);\n   417â†’    }\n   418â†’\n   419â†’    // Row 3: Gender and Handedness (properly aligned)\n   420â†’    doc.font('Helvetica-Bold')\n   421â†’       .fillColor('#4A5568')\n   422â†’       .text('Gender:', col1X, y + 62)\n   423â†’       .font('Helvetica')\n   424â†’       .fillColor('#2D3748')\n   425â†’       .text(this.patientData.gender || 'N/A', col1ValueX, y + 62);\n   426â†’\n   427â†’    doc.font('Helvetica-Bold')\n   428â†’       .fillColor('#4A5568')\n   429â†’       .text('Handedness:', col2X, y + 62)\n   430â†’       .font('Helvetica')\n   431â†’       .fillColor('#2D3748')\n   432â†’       .text(this.patientData.handedness || 'N/A', col2ValueX, y + 62);\n   433â†’\n   434â†’    doc.moveDown(2.5);\n   435â†’  }\n   436â†’\n   437â†’  /**\n   438â†’   * Add watermark to current page\n   439â†’   */\n   440â†’  addWatermark(doc) {\n   441â†’    // Save current position\n   442â†’    const currentY = doc.y;\n   443â†’\n   444â†’    // Save the current graphics state\n   445â†’    doc.save();\n   446â†’\n   447â†’    // Add semi-transparent watermark\n   448â†’    doc.opacity(0.05)\n   449â†’       .fontSize(50)\n   450â†’       .fillColor('#000000')\n   451â†’       .font('Helvetica-Bold')\n   452â†’       .rotate(-45, { origin: [297.5, 421] })\n   453â†’       .text('NeuroSense Report', 150, 400, {\n   454â†’         width: 500,\n   455â†’         align: 'center'\n   456â†’       });\n   457â†’\n   458â†’    // Restore graphics state\n   459â†’    doc.restore();\n   460â†’\n   461â†’    // Restore position (watermark shouldn't move cursor)\n   462â†’    doc.y = currentY;\n   463â†’  }\n   464â†’\n   465â†’  /**\n   466â†’   * Add parameter section - Infographic Style\n   467â†’   */\n   468â†’  addParameterSection(doc, param, index) {\n   469â†’    // Only create new page if we're very close to bottom (need at least 150px for parameter header + some content)\n   470â†’    if (doc.y > 700) {\n   471â†’      doc.addPage();\n   472â†’      this.addWatermark(doc);\n   473â†’    }\n   474â†’\n   475â†’    const y = doc.y;\n   476â†’\n   477â†’    // Determine background color based on score (Low=Red, Medium=Orange, High=Green)\n   478â†’    const bgColor = this.getScoreColor(param.score, param.maxScore || 3, param.name);\n   479â†’\n   480â†’    // Main colored header\n   481â†’    doc.roundedRect(50, y, 495, 35, 5)\n   482â†’       .fill(bgColor);\n   483â†’\n   484â†’    // Parameter name (no icon to avoid rendering issues)\n   485â†’    doc.fontSize(16)\n   486â†’       .fillColor('#FFFFFF')\n   487â†’       .font('Helvetica-Bold')\n   488â†’       .text(param.name, 60, y + 10);\n   489â†’\n   490â†’    // Score badge with color-coded background based on score\n   491â†’    const scoreText = param.maxScore ? `${param.score}/${param.maxScore}` : `${param.score}`;\n   492â†’    const scoreColor = this.getScoreColor(param.score, param.maxScore || 3, param.name);\n   493â†’    const scoreBadgeX = 420;\n   494â†’\n   495â†’    doc.roundedRect(scoreBadgeX, y + 7, 50, 20, 3)\n   496â†’       .fillAndStroke(scoreColor, scoreColor);\n   497â†’\n   498â†’    doc.fontSize(12)\n   499â†’       .fillColor('#FFFFFF')\n   500â†’       .font('Helvetica-Bold')\n   501â†’       .text(scoreText, scoreBadgeX + 10, y + 11);\n   502â†’\n   503â†’    // Bucket label (aligned to the right)\n   504â†’    doc.fontSize(9)\n   505â†’       .fillColor('#FFFFFF')\n   506â†’       .font('Helvetica-Bold')\n   507â†’       .text(param.bucket || '', 475, y + 13, { width: 60, align: 'right' });\n   508â†’\n   509â†’    doc.moveDown(1.8);\n   510â†’\n   511â†’    // Parameter summary with light background box\n   512â†’    if (param.summary) {\n   513â†’      const summaryY = doc.y;\n   514â†’      doc.roundedRect(50, summaryY - 3, 495, 25, 3)\n   515â†’         .fill('#F8F9FA');\n   516â†’\n   517â†’      doc.fontSize(10)\n   518â†’         .fillColor('#2D3748')\n   519â†’         .font('Helvetica')\n   520â†’         .text(param.summary, 60, summaryY, {\n   521â†’           width: 475,\n   522â†’           align: 'left'\n   523â†’         });\n   524â†’\n   525â†’      doc.moveDown(0.7);\n   526â†’    }\n   527â†’\n   528â†’    // Subparameters (metrics) with visual indicators\n   529â†’    if (param.subparameters && param.subparameters.length > 0) {\n   530â†’      console.log(`   ðŸ“Š Adding ${param.subparameters.length} sub-metrics for ${param.name}`);\n   531â†’\n   532â†’      doc.fontSize(9)\n   533â†’         .fillColor('#323956')\n   534â†’         .font('Helvetica-Bold')\n   535â†’         .text('Key Metrics:', 55, doc.y);\n   536â†’\n   537â†’      doc.moveDown(0.5);\n   538â†’\n   539â†’      param.subparameters.forEach((sub, idx) => {\n   540â†’        console.log(`     ${idx + 1}. ${sub.name}: score=${sub.score}, interpretation=\"${sub.interpretation}\"`);\n   541â†’\n   542â†’        const metricY = doc.y;\n   543â†’\n   544â†’        // For Stress and Burnout, LOW scores (0) are GOOD, so invert the logic\n   545â†’        const isProblemParameter = param.name === 'Stress' || param.name === 'Burnout & Fatigue' || param.name === 'Burnout and Fatigue';\n   546â†’        const isHealthy = isProblemParameter ? (sub.score === 0) : (sub.score === 1);\n   547â†’\n   548â†’        const checkColor = isHealthy ? '#38A169' : '#E53E3E';\n   549â†’        const checkSymbol = isHealthy ? 'Pass' : 'Fail';\n   550â†’\n   551â†’        // Visual indicator box (properly aligned)\n   552â†’        doc.roundedRect(60, metricY, 30, 12, 2)\n   553â†’           .fillAndStroke(checkColor, checkColor);\n   554â†’\n   555â†’        doc.fontSize(7)\n   556â†’           .fillColor('#FFFFFF')\n   557â†’           .font('Helvetica-Bold')\n   558â†’           .text(checkSymbol, 63, metricY + 2);\n   559â†’\n   560â†’        // Metric name and interpretation (aligned at x=98)\n   561â†’        doc.fontSize(9)\n   562â†’           .fillColor('#2D3748')\n   563â†’           .font('Helvetica-Bold')\n   564â†’           .text(sub.name, 98, metricY, { width: 442, continued: true })\n   565â†’           .font('Helvetica')\n   566â†’           .fillColor('#4A5568')\n   567â†’           .text(` - ${sub.interpretation || ''}`, { width: 442 });\n   568â†’\n   569â†’        // Add details if available\n   570â†’        if (sub.details) {\n   571â†’          doc.fontSize(7)\n   572â†’             .fillColor('#718096')\n   573â†’             .text(`    ${sub.details}`, 98, doc.y);\n   574â†’        }\n   575â†’\n   576â†’        doc.moveDown(0.3);\n   577â†’      });\n   578â†’    } else {\n   579â†’      console.log(`   âš ï¸ No sub-metrics for ${param.name}`);\n   580â†’    }\n   581â†’\n   582â†’    doc.moveDown(0.8);\n   583â†’  }\n   584â†’\n   585â†’  /**\n   586â†’   * Add summary section - Infographic Style\n   587â†’   */\n   588â†’  addSummarySection(doc, summary) {\n   589â†’    if (doc.y > 700) {\n   590â†’      doc.addPage();\n   591â†’      this.addWatermark(doc);\n   592â†’    }\n   593â†’\n   594â†’    const y = doc.y;\n   595â†’\n   596â†’    // Colored banner for summary\n   597â†’    doc.roundedRect(50, y, 495, 30, 5)\n   598â†’       .fill('#4299E1');\n   599â†’\n   600â†’    doc.fontSize(14)\n   601â†’       .fillColor('#FFFFFF')\n   602â†’       .font('Helvetica-Bold')\n   603â†’       .text('Overall Brain Health Summary', 60, y + 8);\n   604â†’\n   605â†’    doc.moveDown(1.3);\n   606â†’\n   607â†’    // Summary content box\n   608â†’    const contentY = doc.y;\n   609â†’    doc.roundedRect(50, contentY, 495, 70, 5)\n   610â†’       .fillAndStroke('#EBF8FF', '#4299E1');\n   611â†’\n   612â†’    doc.fontSize(10)\n   613â†’       .fillColor('#2D3748')\n   614â†’       .font('Helvetica')\n   615â†’       .text(summary, 60, contentY + 10, {\n   616â†’         width: 475,\n   617â†’         align: 'left'\n   618â†’       });\n   619â†’\n   620â†’    doc.moveDown(2);\n   621â†’  }\n   622â†’\n   623â†’  /**\n   624â†’   * Add recommendations - Infographic Style\n   625â†’   */\n   626â†’  addRecommendations(doc, recommendations) {\n   627â†’    if (doc.y > 700) {\n   628â†’      doc.addPage();\n   629â†’      this.addWatermark(doc);\n   630â†’    }\n   631â†’\n   632â†’    const y = doc.y;\n   633â†’\n   634â†’    // Colored banner for recommendations\n   635â†’    doc.roundedRect(50, y, 495, 30, 5)\n   636â†’       .fill('#48BB78');\n   637â†’\n   638â†’    doc.fontSize(14)\n   639â†’       .fillColor('#FFFFFF')\n   640â†’       .font('Helvetica-Bold')\n   641â†’       .text('Personalized Recommendations', 60, y + 8);\n   642â†’\n   643â†’    doc.moveDown(1.2);\n   644â†’\n   645â†’    // Recommendations with numbered badges\n   646â†’    recommendations.forEach((rec, idx) => {\n   647â†’      const recY = doc.y;\n   648â†’\n   649â†’      // Numbered badge (professional box style)\n   650â†’      doc.roundedRect(60, recY, 20, 16, 2)\n   651â†’         .fillAndStroke('#48BB78', '#48BB78');\n   652â†’\n   653â†’      doc.fontSize(10)\n   654â†’         .fillColor('#FFFFFF')\n   655â†’         .font('Helvetica-Bold')\n   656â†’         .text(`${idx + 1}`, 67, recY + 3);\n   657â†’\n   658â†’      // Recommendation text (aligned at x=88)\n   659â†’      doc.fontSize(9)\n   660â†’         .fillColor('#2D3748')\n   661â†’         .font('Helvetica')\n   662â†’         .text(rec, 88, recY, {\n   663â†’           width: 452,\n   664â†’           align: 'left'\n   665â†’         });\n   666â†’\n   667â†’      doc.moveDown(0.5);\n   668â†’    });\n   669â†’  }\n   670â†’\n   671â†’  /**\n   672â†’   * Add footer - Infographic Style\n   673â†’   */\n   674â†’  addFooter(doc) {\n   675â†’    const bottomY = 750;\n   676â†’\n   677â†’    // Footer bar\n   678â†’    doc.rect(0, bottomY - 5, 595, 50)\n   679â†’       .fill('#F7FAFC');\n   680â†’\n   681â†’    doc.moveTo(50, bottomY - 5)\n   682â†’       .lineTo(545, bottomY - 5)\n   683â†’       .stroke('#4299E1');\n   684â†’\n   685â†’    doc.fontSize(7)\n   686â†’       .fillColor('#4A5568')\n   687â†’       .font('Helvetica')\n   688â†’       .text('This infographic is generated using AI-powered analysis and should be interpreted by a qualified healthcare professional.',\n   689â†’             50, bottomY + 5, {\n   690â†’               width: 495,\n   691â†’               align: 'center'\n   692â†’             });\n   693â†’\n   694â†’    doc.fontSize(7)\n   695â†’       .fillColor('#2D3748')\n   696â†’       .font('Helvetica-Bold')\n   697â†’       .text('Â© 2025 NeuroSense360 â€¢ Powered by Google Gemini AI',\n   698â†’             50, bottomY + 20, {\n   699â†’               width: 495,\n   700â†’               align: 'center'\n   701â†’             });\n   702â†’  }\n   703â†’\n   704â†’  /**\n   705â†’   * Get score color based on percentage (for color-coded scoring)\n   706â†’   * CONSISTENT across ALL parameters:\n   707â†’   * Low score (0-40%) â†’ Red\n   708â†’   * Medium score (41-70%) â†’ Orange\n   709â†’   * High score (71-100%) â†’ Green\n   710â†’   */\n   711â†’  getScoreColor(score, maxScore, parameterName = '') {\n   712â†’    const percentage = (score / maxScore) * 100;\n   713â†’\n   714â†’    // Consistent color mapping for ALL parameters\n   715â†’    // Low = Red, Medium = Orange, High = Green\n   716â†’    if (percentage <= 40) return '#E53E3E';      // Red (Low)\n   717â†’    if (percentage <= 70) return '#ED8936';      // Orange (Medium)\n   718â†’    return '#38A169';                            // Green (High)\n   719â†’  }\n   720â†’\n   721â†’  /**\n   722â†’   * Get color for bucket classification\n   723â†’   * Consistent color mapping: Low=Red, Medium=Orange, High=Green across ALL parameters\n   724â†’   */\n   725â†’  getBucketColor(bucketOrColor, parameterName = '') {\n   726â†’    // If it's already a hex color\n   727â†’    if (bucketOrColor && bucketOrColor.startsWith('#')) {\n   728â†’      return bucketOrColor;\n   729â†’    }\n   730â†’\n   731â†’    // Consistent color mapping for ALL parameters\n   732â†’    // Low metrics = Red, Medium = Orange, High = Green\n   733â†’    const colorMap = {\n   734â†’      'Poor': '#E53E3E',        // Red\n   735â†’      'Below Average': '#F56565', // Light Red\n   736â†’      'Average': '#ED8936',      // Orange\n   737â†’      'Moderate': '#ED8936',     // Orange\n   738â†’      'Good': '#48BB78',         // Green\n   739â†’      'Excellent': '#38A169',    // Dark Green\n   740â†’      'Low': '#E53E3E',          // Red (consistent for all Low)\n   741â†’      'Medium': '#ED8936',       // Orange\n   742â†’      'High': '#38A169'          // Green (consistent for all High)\n   743â†’    };\n   744â†’\n   745â†’    return colorMap[bucketOrColor] || '#4299E1';\n   746â†’  }\n   747â†’\n   748â†’  /**\n   749â†’   * Generate radar chart showing all 7 brain parameters\n   750â†’   * Returns Buffer containing PNG image\n   751â†’   */\n   752â†’  async generateRadarChart() {\n   753â†’    try {\n   754â†’      console.log('\\nðŸ“Š Generating radar chart for 7 brain parameters...');\n   755â†’\n   756â†’      // Extract parameter data\n   757â†’      const parameters = this.algorithmResults.parameters || [];\n   758â†’      const labels = parameters.map(p => p.name);\n   759â†’      const scores = parameters.map(p => (p.score / p.maxScore) * 100); // Convert to percentage\n   760â†’\n   761â†’      console.log(`   Parameters: ${labels.join(', ')}`);\n   762â†’      console.log(`   Scores: ${scores.map(s => s.toFixed(0) + '%').join(', ')}`);\n   763â†’\n   764â†’      // Create chart configuration\n   765â†’      const width = 600;\n   766â†’      const height = 600;\n   767â†’      const chartJSNodeCanvas = new ChartJSNodeCanvas({ width, height });\n   768â†’\n   769â†’      const configuration = {\n   770â†’        type: 'radar',\n   771â†’        data: {\n   772â†’          labels: labels,\n   773â†’          datasets: [{\n   774â†’            label: 'Brain Performance Score',\n   775â†’            data: scores,\n   776â†’            fill: true,\n   777â†’            backgroundColor: 'rgba(54, 162, 235, 0.2)',\n   778â†’            borderColor: 'rgb(54, 162, 235)',\n   779â†’            pointBackgroundColor: 'rgb(54, 162, 235)',\n   780â†’            pointBorderColor: '#fff',\n   781â†’            pointHoverBackgroundColor: '#fff',\n   782â†’            pointHoverBorderColor: 'rgb(54, 162, 235)',\n   783â†’            borderWidth: 2,\n   784â†’            pointRadius: 5,\n   785â†’            pointHoverRadius: 7\n   786â†’          }]\n   787â†’        },\n   788â†’        options: {\n   789â†’          responsive: false,\n   790â†’          plugins: {\n   791â†’            title: {\n   792â†’              display: true,\n   793â†’              text: '7 Brain Health Parameters - Performance Overview',\n   794â†’              font: {\n   795â†’                size: 20,\n   796â†’                weight: 'bold'\n   797â†’              },\n   798â†’              color: '#323956',\n   799â†’              padding: 20\n   800â†’            },\n   801â†’            legend: {\n   802â†’              display: false\n   803â†’            }\n   804â†’          },\n   805â†’          scales: {\n   806â†’            r: {\n   807â†’              angleLines: {\n   808â†’                display: true,\n   809â†’                color: '#E2E8F0'\n   810â†’              },\n   811â†’              grid: {\n   812â†’                color: '#E2E8F0'\n   813â†’              },\n   814â†’              pointLabels: {\n   815â†’                font: {\n   816â†’                  size: 14,\n   817â†’                  weight: 'bold'\n   818â†’                },\n   819â†’                color: '#323956'\n   820â†’              },\n   821â†’              ticks: {\n   822â†’                beginAtZero: true,\n   823â†’                max: 100,\n   824â†’                stepSize: 25,\n   825â†’                callback: function(value) {\n   826â†’                  return value + '%';\n   827â†’                },\n   828â†’                backdropColor: 'transparent',\n   829â†’                color: '#718096',\n   830â†’                font: {\n   831â†’                  size: 12\n   832â†’                }\n   833â†’              },\n   834â†’              suggestedMin: 0,\n   835â†’              suggestedMax: 100\n   836â†’            }\n   837â†’          }\n   838â†’        }\n   839â†’      };\n   840â†’\n   841â†’      // Generate chart image\n   842â†’      const imageBuffer = await chartJSNodeCanvas.renderToBuffer(configuration);\n   843â†’      console.log('âœ… Radar chart generated successfully');\n   844â†’      console.log(`   Size: ${(imageBuffer.length / 1024).toFixed(2)} KB\\n`);\n   845â†’\n   846â†’      return imageBuffer;\n   847â†’    } catch (error) {\n   848â†’      console.error('âŒ Error generating radar chart:', error.message);\n   849â†’      console.error('   Stack:', error.stack);\n   850â†’      return null;\n   851â†’    }\n   852â†’  }\n   853â†’\n   854â†’  /**\n   855â†’   * Add Extracted QEEG Data Section - Shows raw data extracted from uploaded PDFs\n   856â†’   */\n   857â†’  addExtractedDataSection(doc) {\n   858â†’    // Create new page for data section\n   859â†’    doc.addPage();\n   860â†’    this.addWatermark(doc);\n   861â†’\n   862â†’    const y = doc.y;\n   863â†’\n   864â†’    // Section header\n   865â†’    doc.roundedRect(50, y, 495, 35, 5)\n   866â†’       .fill('#2C5282');\n   867â†’\n   868â†’    doc.fontSize(16)\n   869â†’       .fillColor('#FFFFFF')\n   870â†’       .font('Helvetica-Bold')\n   871â†’       .text('ðŸ“Š Extracted QEEG Data', 60, y + 10);\n   872â†’\n   873â†’    doc.moveDown(2);\n   874â†’\n   875â†’    // Description\n   876â†’    doc.fontSize(10)\n   877â†’       .fillColor('#4A5568')\n   878â†’       .font('Helvetica')\n   879â†’       .text('This section shows the raw brainwave data extracted from your uploaded Eye Open (EO) and Eye Closed (EC) reports.', 50, doc.y, { width: 495, align: 'left' });\n   880â†’\n   881â†’    doc.moveDown(1);\n   882â†’\n   883â†’    // === EYES OPEN DATA ===\n   884â†’    this.addDataTable(doc, 'Eyes Open (EO) - Absolute Power (Î¼VÂ²)', this.qeegData.EO?.absolute);\n   885â†’    doc.moveDown(0.5);\n   886â†’    this.addDataTable(doc, 'Eyes Open (EO) - Relative Power (%)', this.qeegData.EO?.relative);\n   887â†’\n   888â†’    // Check if we need new page\n   889â†’    if (doc.y > 650) {\n   890â†’      doc.addPage();\n   891â†’      this.addWatermark(doc);\n   892â†’    }\n   893â†’\n   894â†’    doc.moveDown(0.5);\n   895â†’\n   896â†’    // === EYES CLOSED DATA ===\n   897â†’    this.addDataTable(doc, 'Eyes Closed (EC) - Absolute Power (Î¼VÂ²)', this.qeegData.EC?.absolute);\n   898â†’    doc.moveDown(0.5);\n   899â†’    this.addDataTable(doc, 'Eyes Closed (EC) - Relative Power (%)', this.qeegData.EC?.relative);\n   900â†’\n   901â†’    // === SPECIAL VALUES ===\n   902â†’    if (this.qeegData.EC?.special) {\n   903â†’      doc.moveDown(1);\n   904â†’      doc.fontSize(12)\n   905â†’         .fillColor('#323956')\n   906â†’         .font('Helvetica-Bold')\n   907â†’         .text('Special Values', 50, doc.y);\n   908â†’\n   909â†’      doc.moveDown(0.5);\n   910â†’      doc.fontSize(9)\n   911â†’         .fillColor('#2D3748')\n   912â†’         .font('Helvetica');\n   913â†’\n   914â†’      if (this.qeegData.EC.special.alphaPeak) {\n   915â†’        doc.text(`â€¢ Alpha Peak Frequency: ${this.qeegData.EC.special.alphaPeak} Hz`, 60, doc.y);\n   916â†’      }\n   917â†’    }\n   918â†’  }\n   919â†’\n   920â†’  /**\n   921â†’   * Helper method to add data table to PDF\n   922â†’   */\n   923â†’  addDataTable(doc, title, data) {\n   924â†’    if (!data) return;\n   925â†’\n   926â†’    // Check if we need new page\n   927â†’    if (doc.y > 680) {\n   928â†’      doc.addPage();\n   929â†’      this.addWatermark(doc);\n   930â†’    }\n   931â†’\n   932â†’    // Title\n   933â†’    doc.fontSize(12)\n   934â†’       .fillColor('#323956')\n   935â†’       .font('Helvetica-Bold')\n   936â†’       .text(title, 50, doc.y);\n   937â†’\n   938â†’    doc.moveDown(0.5);\n   939â†’\n   940â†’    // Table header\n   941â†’    const startY = doc.y;\n   942â†’    const rowHeight = 14;\n   943â†’    const colWidth = 65;\n   944â†’\n   945â†’    // Header row background\n   946â†’    doc.rect(50, startY, 495, rowHeight)\n   947â†’       .fill('#E2E8F0');\n   948â†’\n   949â†’    // Header text\n   950â†’    doc.fontSize(8)\n   951â†’       .fillColor('#2D3748')\n   952â†’       .font('Helvetica-Bold');\n   953â†’\n   954â†’    doc.text('Channel', 55, startY + 3, { width: 55 });\n   955â†’    doc.text('Delta', 115, startY + 3, { width: colWidth });\n   956â†’    doc.text('Theta', 180, startY + 3, { width: colWidth });\n   957â†’    doc.text('Alpha', 245, startY + 3, { width: colWidth });\n   958â†’    doc.text('Beta', 310, startY + 3, { width: colWidth });\n   959â†’    doc.text('HiBeta', 375, startY + 3, { width: colWidth });\n   960â†’\n   961â†’    let currentY = startY + rowHeight;\n   962â†’\n   963â†’    // Data rows\n   964â†’    const channels = ['Fz', 'Cz', 'Pz', 'F3', 'F4', 'C3', 'C4', 'P3', 'P4'];\n   965â†’    doc.fontSize(8).font('Helvetica').fillColor('#2D3748');\n   966â†’\n   967â†’    channels.forEach((channel, index) => {\n   968â†’      const bands = data[channel];\n   969â†’      if (!bands) return;\n   970â†’\n   971â†’      // Alternating row colors\n   972â†’      if (index % 2 === 0) {\n   973â†’        doc.rect(50, currentY, 495, rowHeight).fill('#F7FAFC');\n   974â†’      }\n   975â†’\n   976â†’      doc.fillColor('#2D3748');\n   977â†’      doc.text(channel, 55, currentY + 3, { width: 55 });\n   978â†’      doc.text(bands.Delta?.toFixed(2) || '0.00', 115, currentY + 3, { width: colWidth });\n   979â†’      doc.text(bands.Theta?.toFixed(2) || '0.00', 180, currentY + 3, { width: colWidth });\n   980â†’      doc.text(bands.Alpha?.toFixed(2) || '0.00', 245, currentY + 3, { width: colWidth });\n   981â†’      doc.text(bands.Beta?.toFixed(2) || '0.00', 310, currentY + 3, { width: colWidth });\n   982â†’      doc.text(bands.HiBeta?.toFixed(2) || '0.00', 375, currentY + 3, { width: colWidth });\n   983â†’\n   984â†’      currentY += rowHeight;\n   985â†’    });\n   986â†’\n   987â†’    // Update cursor position\n   988â†’    doc.y = currentY + 5;\n   989â†’  }\n   990â†’\n   991â†’  /**\n   992â†’   * Add Detailed Calculations Section - Shows how scores were calculated\n   993â†’   */\n   994â†’  addCalculationsSection(doc) {\n   995â†’    // Create new page for calculations\n   996â†’    doc.addPage();\n   997â†’    this.addWatermark(doc);\n   998â†’\n   999â†’    const y = doc.y;\n  1000â†’\n  1001â†’    // Section header\n  1002â†’    doc.roundedRect(50, y, 495, 35, 5)\n  1003â†’       .fill('#2C5282');\n  1004â†’\n  1005â†’    doc.fontSize(16)\n  1006â†’       .fillColor('#FFFFFF')\n  1007â†’       .font('Helvetica-Bold')\n  1008â†’       .text('ðŸ§® Detailed Calculations', 60, y + 10);\n  1009â†’\n  1010â†’    doc.moveDown(2);\n  1011â†’\n  1012â†’    // Description\n  1013â†’    doc.fontSize(10)\n  1014â†’       .fillColor('#4A5568')\n  1015â†’       .font('Helvetica')\n  1016â†’       .text('This section shows step-by-step calculations for each brain health parameter, including formulas, thresholds, and scoring logic.', 50, doc.y, { width: 495, align: 'left' });\n  1017â†’\n  1018â†’    doc.moveDown(1);\n  1019â†’\n  1020â†’    // Add calculation details for each parameter\n  1021â†’    if (this.algorithmResults.parameters) {\n  1022â†’      this.algorithmResults.parameters.forEach((param, index) => {\n  1023â†’        this.addParameterCalculation(doc, param, index + 1);\n  1024â†’      });\n  1025â†’    }\n  1026â†’  }\n  1027â†’\n  1028â†’  /**\n  1029â†’   * Add individual parameter calculation details\n  1030â†’   */\n  1031â†’  addParameterCalculation(doc, param, number) {\n  1032â†’    // Check if we need new page\n  1033â†’    if (doc.y > 650) {\n  1034â†’      doc.addPage();\n  1035â†’      this.addWatermark(doc);\n  1036â†’    }\n  1037â†’\n  1038â†’    // Parameter header\n  1039â†’    doc.fontSize(12)\n  1040â†’       .fillColor('#323956')\n  1041â†’       .font('Helvetica-Bold')\n  1042â†’       .text(`${number}. ${param.name} - Score: ${param.score}/3 (${param.classification})`, 50, doc.y);\n  1043â†’\n  1044â†’    doc.moveDown(0.5);\n  1045â†’\n  1046â†’    // Metrics/Sub-calculations\n  1047â†’    if (param.metrics && param.metrics.length > 0) {\n  1048â†’      param.metrics.forEach((metric, idx) => {\n  1049â†’        // Check if we need new page before each metric\n  1050â†’        if (doc.y > 720) {\n  1051â†’          doc.addPage();\n  1052â†’          this.addWatermark(doc);\n  1053â†’        }\n  1054â†’\n  1055â†’        // Metric box\n  1056â†’        const metricY = doc.y;\n  1057â†’        doc.roundedRect(55, metricY, 485, 'auto', 3)\n  1058â†’           .lineWidth(1)\n  1059â†’           .stroke('#CBD5E0');\n  1060â†’\n  1061â†’        doc.fontSize(10)\n  1062â†’           .fillColor('#2D3748')\n  1063â†’           .font('Helvetica-Bold')\n  1064â†’           .text(`   ${String.fromCharCode(97 + idx)}) ${metric.name}: ${metric.score} point`, 60, metricY + 5, { width: 475 });\n  1065â†’\n  1066â†’        doc.moveDown(0.3);\n  1067â†’\n  1068â†’        // Formula/Description\n  1069â†’        if (metric.description) {\n  1070â†’          doc.fontSize(9)\n  1071â†’             .fillColor('#4A5568')\n  1072â†’             .font('Helvetica')\n  1073â†’             .text(`      ${metric.description}`, 60, doc.y, { width: 475 });\n  1074â†’        }\n  1075â†’\n  1076â†’        // Value details\n  1077â†’        if (metric.value !== undefined && metric.value !== null) {\n  1078â†’          doc.fontSize(9)\n  1079â†’             .fillColor('#2D3748')\n  1080â†’             .font('Helvetica');\n  1081â†’\n  1082â†’          if (typeof metric.value === 'object') {\n  1083â†’            doc.text(`      Raw Values: ${JSON.stringify(metric.value)}`, 60, doc.y, { width: 475 });\n  1084â†’          } else {\n  1085â†’            doc.text(`      Calculated Value: ${typeof metric.value === 'number' ? metric.value.toFixed(3) : metric.value}`, 60, doc.y, { width: 475 });\n  1086â†’          }\n  1087â†’        }\n  1088â†’\n  1089â†’        // Interpretation\n  1090â†’        if (metric.score === 1) {\n  1091â†’          doc.fontSize(9)\n  1092â†’             .fillColor('#22543D')\n  1093â†’             .font('Helvetica-Bold')\n  1094â†’             .text('      âœ“ PASS - Within optimal range', 60, doc.y, { width: 475 });\n  1095â†’        } else {\n  1096â†’          doc.fontSize(9)\n  1097â†’             .fillColor('#742A2A')\n  1098â†’             .font('Helvetica-Bold')\n  1099â†’             .text('      âœ— FAIL - Outside optimal range', 60, doc.y, { width: 475 });\n  1100â†’        }\n  1101â†’\n  1102â†’        doc.moveDown(0.8);\n  1103â†’      });\n  1104â†’    }\n  1105â†’\n  1106â†’    doc.moveDown(0.5);\n  1107â†’  }\n  1108â†’}\n  1109â†’\n  1110â†’module.exports = GeminiPdfGenerator;\n  1111â†’\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"12921409-d65c-434f-8c1f-77c452b5c4e6","timestamp":"2025-12-09T06:11:11.548Z","toolUseResult":{"type":"text","file":{"filePath":"D:\\Todays\\Neuro360\\server\\services\\geminiPdfGenerator.js","content":"const PDFDocument = require('pdfkit');\nconst fs = require('fs');\nconst path = require('path');\nconst GeminiService = require('./geminiService');\nconst { ChartJSNodeCanvas } = require('chartjs-node-canvas');\n\nclass GeminiPdfGenerator {\n  constructor(patientData, algorithmResults, qeegData) {\n    this.patientData = patientData;\n    this.algorithmResults = algorithmResults;\n    this.qeegData = qeegData;\n    this.geminiReportData = null;\n  }\n\n  /**\n   * Transform algorithm results to Gemini input format\n   */\n  transformToGeminiFormat() {\n    const brainParameters = {\n      Cognition: null,\n      Stress: null,\n      FocusAndAttention: null,\n      BurnoutAndFatigue: null,\n      EmotionalRegulation: null,\n      Learning: null,\n      Creativity: null\n    };\n\n    // Map the parameters from algorithm results\n    this.algorithmResults.parameters.forEach(param => {\n      const paramName = param.name.replace(/\\s+/g, '').replace(/&/g, 'And');\n      if (brainParameters.hasOwnProperty(paramName)) {\n        brainParameters[paramName] = {\n          score: param.score,\n          maxScore: param.maxScore,\n          bucket: param.bucket || param.classification,\n          subparameters: (param.metrics || param.subParameters || []).map(metric => ({\n            name: metric.name,\n            score: metric.score,\n            value: metric.value,\n            threshold: metric.threshold\n          }))\n        };\n      }\n    });\n\n    return brainParameters;\n  }\n\n  /**\n   * Generate report structure using Gemini AI\n   */\n  async generateReportStructure() {\n    console.log('\\nðŸ¤– === Generating report structure with Gemini AI ===');\n    const brainParameters = this.transformToGeminiFormat();\n\n    console.log('ðŸ“Š INPUT DATA TO GEMINI (Brain Parameters):');\n    Object.keys(brainParameters).forEach(paramKey => {\n      const param = brainParameters[paramKey];\n      if (param) {\n        console.log(`   ${paramKey}: score=${param.score}/${param.maxScore}, bucket=${param.bucket}, subParams=${param.subparameters?.length || 0}`);\n      }\n    });\n\n    try {\n      const result = await GeminiService.generateBrainPerformanceReport(brainParameters);\n\n      if (!result.success) {\n        console.error('âŒ Gemini API returned error:', result.error);\n        throw new Error(`Gemini AI failed: ${result.error}`);\n      }\n\n      this.geminiReportData = result.data;\n      console.log('\\nâœ… Gemini report structure generated successfully');\n      console.log('ðŸ“„ OUTPUT FROM GEMINI:');\n      if (result.data.parameters) {\n        result.data.parameters.forEach(param => {\n          console.log(`   ${param.name}: score=${param.score}/${param.maxScore}, bucket=${param.bucket}`);\n        });\n      }\n\n      return this.geminiReportData;\n    } catch (error) {\n      console.error('âŒ Error in generateReportStructure:', error.message);\n      console.error('   Stack:', error.stack);\n      throw error;\n    }\n  }\n\n  /**\n   * Main report generation function\n   */\n  async generateReport(outputPath) {\n    try {\n      // Step 1: Try to generate AI report structure with Gemini\n      let usingGemini = false;\n      try {\n        console.log('ðŸ¤– Attempting to generate report with Gemini AI...');\n        await this.generateReportStructure();\n        usingGemini = true;\n        console.log('âœ… Gemini AI report structure ready');\n      } catch (geminiError) {\n        console.error('âš ï¸ Gemini AI failed, using fallback data structure');\n        console.error('   Gemini Error:', geminiError.message);\n\n        // Fallback: Create basic report structure from algorithm data\n        this.geminiReportData = this.createFallbackReportStructure();\n        console.log('âœ… Fallback report structure created');\n      }\n\n      // Step 2: Create PDF from the report structure (AI or fallback)\n      const doc = new PDFDocument({\n        size: 'A4',\n        margins: { top: 50, bottom: 50, left: 50, right: 50 }\n      });\n\n      const stream = fs.createWriteStream(outputPath);\n      doc.pipe(stream);\n\n      // Generate PDF content\n      await this.generatePDFContent(doc);\n\n      doc.end();\n\n      // Wait for PDF to finish writing\n      await new Promise((resolve, reject) => {\n        stream.on('finish', resolve);\n        stream.on('error', reject);\n      });\n\n      const sourceType = usingGemini ? 'Gemini AI' : 'Fallback (Basic)';\n      console.log(`âœ… PDF generated successfully with ${sourceType} content`);\n      return outputPath;\n\n    } catch (error) {\n      console.error('âŒ Error generating PDF:', error);\n      console.error('   Stack:', error.stack);\n      throw error;\n    }\n  }\n\n  /**\n   * Create fallback report structure when Gemini fails\n   */\n  createFallbackReportStructure() {\n    console.log('ðŸ“‹ Creating fallback report structure...');\n    console.log('   Algorithm results:', JSON.stringify(this.algorithmResults, null, 2));\n\n    const parameters = this.algorithmResults.parameters.map(param => {\n      // Use metrics (correct field from algorithm) instead of subParameters\n      const subMetrics = param.metrics || param.subParameters || [];\n\n      console.log(`   Processing ${param.name}:`);\n      console.log(`     Score: ${param.score}/${param.maxScore}`);\n      console.log(`     Classification: ${param.classification}`);\n      console.log(`     Metrics count: ${subMetrics.length}`);\n\n      return {\n        name: param.name,\n        score: param.score,\n        bucket: param.classification || 'Average',\n        bucketColor: this.getBucketColor(param.classification, param.name),\n        summary: `${param.name} score is ${param.score} out of ${param.maxScore} (${param.classification || 'Average'})`,\n        subparameters: subMetrics.map(metric => ({\n          name: metric.name || 'Metric',\n          score: metric.score !== undefined ? metric.score : (typeof metric.value === 'number' ? metric.value : 0),\n          interpretation: metric.score === 1 ? 'âœ“ Within optimal range' : 'âœ— Outside optimal range',\n          details: metric.description || (metric.value !== undefined && typeof metric.value === 'number' ? `Value: ${metric.value.toFixed(2)}` : '')\n        }))\n      };\n    });\n\n    console.log('   Fallback structure created with', parameters.length, 'parameters');\n\n    return {\n      title: 'Brain Performance Report',\n      patientSummary: `This report shows the analysis of ${this.algorithmResults.parameters.length} brain performance parameters for ${this.patientData.name}. Overall score: ${this.algorithmResults.overallScore || 'N/A'}.`,\n      parameters: parameters,\n      recommendations: [\n        'Continue monitoring brain health metrics regularly',\n        'Maintain healthy lifestyle habits including proper sleep and exercise',\n        'Consult with healthcare provider for detailed interpretation and personalized recommendations'\n      ]\n    };\n  }\n\n  /**\n   * Generate PDF content from Gemini AI data\n   */\n  async generatePDFContent(doc) {\n    const reportData = this.geminiReportData;\n\n    console.log('\\nðŸ“„ === Generating PDF Content ===');\n    console.log('   Report Title:', reportData.title);\n    console.log('   Parameters count:', reportData.parameters?.length || 0);\n\n    if (reportData.parameters && reportData.parameters.length > 0) {\n      reportData.parameters.forEach((param, idx) => {\n        console.log(`   ${idx + 1}. ${param.name}: ${param.score} (${param.bucket}), Sub-metrics: ${param.subparameters?.length || 0}`);\n      });\n    }\n\n    // Header\n    this.addHeader(doc);\n\n    // Add watermark to first page\n    this.addWatermark(doc);\n\n    // Patient Information\n    this.addPatientInfo(doc);\n\n    doc.moveDown(0.3);\n\n    // Title with decorative elements - Infographic Style\n    const titleY = doc.y;\n\n    // Decorative line before title\n    doc.moveTo(150, titleY)\n       .lineTo(445, titleY)\n       .lineWidth(2)\n       .stroke('#4299E1');\n\n    doc.moveDown(0.3);\n\n    doc.fontSize(20)\n       .fillColor('#323956')\n       .font('Helvetica-Bold')\n       .text(reportData.title || 'Brain Performance Infographic', 50, doc.y, { width: 495, align: 'center' });\n\n    // Subtitle if available\n    if (reportData.subtitle) {\n      doc.fontSize(11)\n         .fillColor('#4A5568')\n         .font('Helvetica')\n         .text(reportData.subtitle, 50, doc.y, { width: 495, align: 'center' });\n    }\n\n    doc.moveDown(0.3);\n\n    // Decorative line after title\n    const afterTitleY = doc.y;\n    doc.moveTo(150, afterTitleY)\n       .lineTo(445, afterTitleY)\n       .lineWidth(2)\n       .stroke('#4299E1');\n\n    doc.moveDown(0.5);\n\n    // === RADAR CHART - Visual Infographic ===\n    try {\n      const chartBuffer = await this.generateRadarChart();\n      if (chartBuffer) {\n        // Add chart to PDF\n        const chartX = (595 - 400) / 2; // Center on A4 page (595px wide)\n        const chartY = doc.y;\n\n        doc.image(chartBuffer, chartX, chartY, {\n          width: 400,\n          height: 400,\n          align: 'center'\n        });\n\n        console.log(`âœ… Radar chart embedded in PDF at position (${chartX}, ${chartY})`);\n\n        // Move cursor below chart - reduced spacing\n        doc.y = chartY + 380;\n      }\n    } catch (chartError) {\n      console.error('âš ï¸  Could not add radar chart to PDF:', chartError.message);\n      // Continue without chart if it fails\n    }\n\n    // Parameters Section\n    if (reportData.parameters && reportData.parameters.length > 0) {\n      console.log('\\nðŸ“Š Adding parameters to PDF...');\n      reportData.parameters.forEach((param, index) => {\n        this.addParameterSection(doc, param, index);\n      });\n      console.log('âœ… All parameters added to PDF\\n');\n    } else {\n      console.error('âŒ No parameters found in report data!');\n    }\n\n    doc.moveDown(1);\n\n    // === NEW: Extracted QEEG Data Section ===\n    console.log('ðŸ“Š Adding Extracted QEEG Data section...');\n    this.addExtractedDataSection(doc);\n    console.log('âœ… Extracted data section added\\n');\n\n    doc.moveDown(1);\n\n    // === NEW: Detailed Calculations Section ===\n    console.log('ðŸ§® Adding Detailed Calculations section...');\n    this.addCalculationsSection(doc);\n    console.log('âœ… Calculations section added\\n');\n\n    doc.moveDown(1);\n\n    // Patient Summary\n    if (reportData.patientSummary) {\n      this.addSummarySection(doc, reportData.patientSummary);\n    }\n\n    // Recommendations\n    if (reportData.recommendations && reportData.recommendations.length > 0) {\n      this.addRecommendations(doc, reportData.recommendations);\n    }\n\n    // Footer\n    this.addFooter(doc);\n  }\n\n  /**\n   * Add header to PDF - Infographic Style\n   */\n  addHeader(doc) {\n    // Bold colored header bar for infographic look\n    doc.rect(0, 0, 595, 60)\n       .fill('#323956');\n\n    // Add logo to top right if available\n    try {\n      // Try multiple possible logo locations\n      const logoPaths = [\n        path.join(__dirname, '../../public/header logo.png'),\n        path.join(__dirname, '../assets/header-logo.png')\n      ];\n\n      let logoPath = null;\n      for (const testPath of logoPaths) {\n        if (fs.existsSync(testPath)) {\n          logoPath = testPath;\n          break;\n        }\n      }\n\n      if (logoPath) {\n        doc.image(logoPath, 470, 5, {\n          width: 55,\n          height: 55,\n          fit: [55, 55]\n        });\n      }\n    } catch (logoError) {\n      console.log('Logo not found, continuing without it:', logoError.message);\n    }\n\n    doc.fontSize(16)\n       .fillColor('#FFFFFF')\n       .font('Helvetica-Bold')\n       .text('NeuroSense Report', 50, 20);\n\n    doc.fontSize(10)\n       .fillColor('#A8D5FF')\n       .font('Helvetica')\n       .text('Brain Performance Analysis', 50, 42);\n\n    doc.fontSize(9)\n       .fillColor('#FFFFFF')\n       .text(new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' }), 360, 28);\n\n    doc.moveDown(2);\n  }\n\n  /**\n   * Add patient information - Infographic Style\n   */\n  addPatientInfo(doc) {\n    const y = doc.y;\n\n    // Colored info box for visual appeal - increased height for more fields\n    doc.roundedRect(50, y, 495, 85, 5)\n       .fillAndStroke('#F7FAFC', '#E2E8F0');\n\n    doc.fontSize(11)\n       .fillColor('#323956')\n       .font('Helvetica-Bold')\n       .text('Patient Information', 60, y + 10);\n\n    // Row 1: Name and Date of Recording (properly aligned)\n    const col1X = 60;\n    const col1ValueX = 145;\n    const col2X = 310;\n    const col2ValueX = 430;\n\n    doc.fontSize(9)\n       .fillColor('#4A5568')\n       .font('Helvetica-Bold')\n       .text('Name:', col1X, y + 28)\n       .font('Helvetica')\n       .fillColor('#2D3748')\n       .text(this.patientData.name || 'N/A', col1ValueX, y + 28);\n\n    doc.font('Helvetica-Bold')\n       .fillColor('#4A5568')\n       .text('Date of Recording:', col2X, y + 28)\n       .font('Helvetica')\n       .fillColor('#2D3748')\n       .text(this.patientData.dateOfRecording || this.patientData.recordingDate || new Date().toLocaleDateString('en-US'), col2ValueX, y + 28);\n\n    // Row 2: Age and Clinic (properly aligned)\n    doc.font('Helvetica-Bold')\n       .fillColor('#4A5568')\n       .text('Age:', col1X, y + 45)\n       .font('Helvetica')\n       .fillColor('#2D3748')\n       .text(`${this.patientData.age || 'N/A'}`, col1ValueX, y + 45);\n\n    if (this.patientData.clinicName) {\n      doc.font('Helvetica-Bold')\n         .fillColor('#4A5568')\n         .text('Clinic:', col2X, y + 45)\n         .font('Helvetica')\n         .fillColor('#2D3748')\n         .text(this.patientData.clinicName, col2ValueX, y + 45);\n    }\n\n    // Row 3: Gender and Handedness (properly aligned)\n    doc.font('Helvetica-Bold')\n       .fillColor('#4A5568')\n       .text('Gender:', col1X, y + 62)\n       .font('Helvetica')\n       .fillColor('#2D3748')\n       .text(this.patientData.gender || 'N/A', col1ValueX, y + 62);\n\n    doc.font('Helvetica-Bold')\n       .fillColor('#4A5568')\n       .text('Handedness:', col2X, y + 62)\n       .font('Helvetica')\n       .fillColor('#2D3748')\n       .text(this.patientData.handedness || 'N/A', col2ValueX, y + 62);\n\n    doc.moveDown(2.5);\n  }\n\n  /**\n   * Add watermark to current page\n   */\n  addWatermark(doc) {\n    // Save current position\n    const currentY = doc.y;\n\n    // Save the current graphics state\n    doc.save();\n\n    // Add semi-transparent watermark\n    doc.opacity(0.05)\n       .fontSize(50)\n       .fillColor('#000000')\n       .font('Helvetica-Bold')\n       .rotate(-45, { origin: [297.5, 421] })\n       .text('NeuroSense Report', 150, 400, {\n         width: 500,\n         align: 'center'\n       });\n\n    // Restore graphics state\n    doc.restore();\n\n    // Restore position (watermark shouldn't move cursor)\n    doc.y = currentY;\n  }\n\n  /**\n   * Add parameter section - Infographic Style\n   */\n  addParameterSection(doc, param, index) {\n    // Only create new page if we're very close to bottom (need at least 150px for parameter header + some content)\n    if (doc.y > 700) {\n      doc.addPage();\n      this.addWatermark(doc);\n    }\n\n    const y = doc.y;\n\n    // Determine background color based on score (Low=Red, Medium=Orange, High=Green)\n    const bgColor = this.getScoreColor(param.score, param.maxScore || 3, param.name);\n\n    // Main colored header\n    doc.roundedRect(50, y, 495, 35, 5)\n       .fill(bgColor);\n\n    // Parameter name (no icon to avoid rendering issues)\n    doc.fontSize(16)\n       .fillColor('#FFFFFF')\n       .font('Helvetica-Bold')\n       .text(param.name, 60, y + 10);\n\n    // Score badge with color-coded background based on score\n    const scoreText = param.maxScore ? `${param.score}/${param.maxScore}` : `${param.score}`;\n    const scoreColor = this.getScoreColor(param.score, param.maxScore || 3, param.name);\n    const scoreBadgeX = 420;\n\n    doc.roundedRect(scoreBadgeX, y + 7, 50, 20, 3)\n       .fillAndStroke(scoreColor, scoreColor);\n\n    doc.fontSize(12)\n       .fillColor('#FFFFFF')\n       .font('Helvetica-Bold')\n       .text(scoreText, scoreBadgeX + 10, y + 11);\n\n    // Bucket label (aligned to the right)\n    doc.fontSize(9)\n       .fillColor('#FFFFFF')\n       .font('Helvetica-Bold')\n       .text(param.bucket || '', 475, y + 13, { width: 60, align: 'right' });\n\n    doc.moveDown(1.8);\n\n    // Parameter summary with light background box\n    if (param.summary) {\n      const summaryY = doc.y;\n      doc.roundedRect(50, summaryY - 3, 495, 25, 3)\n         .fill('#F8F9FA');\n\n      doc.fontSize(10)\n         .fillColor('#2D3748')\n         .font('Helvetica')\n         .text(param.summary, 60, summaryY, {\n           width: 475,\n           align: 'left'\n         });\n\n      doc.moveDown(0.7);\n    }\n\n    // Subparameters (metrics) with visual indicators\n    if (param.subparameters && param.subparameters.length > 0) {\n      console.log(`   ðŸ“Š Adding ${param.subparameters.length} sub-metrics for ${param.name}`);\n\n      doc.fontSize(9)\n         .fillColor('#323956')\n         .font('Helvetica-Bold')\n         .text('Key Metrics:', 55, doc.y);\n\n      doc.moveDown(0.5);\n\n      param.subparameters.forEach((sub, idx) => {\n        console.log(`     ${idx + 1}. ${sub.name}: score=${sub.score}, interpretation=\"${sub.interpretation}\"`);\n\n        const metricY = doc.y;\n\n        // For Stress and Burnout, LOW scores (0) are GOOD, so invert the logic\n        const isProblemParameter = param.name === 'Stress' || param.name === 'Burnout & Fatigue' || param.name === 'Burnout and Fatigue';\n        const isHealthy = isProblemParameter ? (sub.score === 0) : (sub.score === 1);\n\n        const checkColor = isHealthy ? '#38A169' : '#E53E3E';\n        const checkSymbol = isHealthy ? 'Pass' : 'Fail';\n\n        // Visual indicator box (properly aligned)\n        doc.roundedRect(60, metricY, 30, 12, 2)\n           .fillAndStroke(checkColor, checkColor);\n\n        doc.fontSize(7)\n           .fillColor('#FFFFFF')\n           .font('Helvetica-Bold')\n           .text(checkSymbol, 63, metricY + 2);\n\n        // Metric name and interpretation (aligned at x=98)\n        doc.fontSize(9)\n           .fillColor('#2D3748')\n           .font('Helvetica-Bold')\n           .text(sub.name, 98, metricY, { width: 442, continued: true })\n           .font('Helvetica')\n           .fillColor('#4A5568')\n           .text(` - ${sub.interpretation || ''}`, { width: 442 });\n\n        // Add details if available\n        if (sub.details) {\n          doc.fontSize(7)\n             .fillColor('#718096')\n             .text(`    ${sub.details}`, 98, doc.y);\n        }\n\n        doc.moveDown(0.3);\n      });\n    } else {\n      console.log(`   âš ï¸ No sub-metrics for ${param.name}`);\n    }\n\n    doc.moveDown(0.8);\n  }\n\n  /**\n   * Add summary section - Infographic Style\n   */\n  addSummarySection(doc, summary) {\n    if (doc.y > 700) {\n      doc.addPage();\n      this.addWatermark(doc);\n    }\n\n    const y = doc.y;\n\n    // Colored banner for summary\n    doc.roundedRect(50, y, 495, 30, 5)\n       .fill('#4299E1');\n\n    doc.fontSize(14)\n       .fillColor('#FFFFFF')\n       .font('Helvetica-Bold')\n       .text('Overall Brain Health Summary', 60, y + 8);\n\n    doc.moveDown(1.3);\n\n    // Summary content box\n    const contentY = doc.y;\n    doc.roundedRect(50, contentY, 495, 70, 5)\n       .fillAndStroke('#EBF8FF', '#4299E1');\n\n    doc.fontSize(10)\n       .fillColor('#2D3748')\n       .font('Helvetica')\n       .text(summary, 60, contentY + 10, {\n         width: 475,\n         align: 'left'\n       });\n\n    doc.moveDown(2);\n  }\n\n  /**\n   * Add recommendations - Infographic Style\n   */\n  addRecommendations(doc, recommendations) {\n    if (doc.y > 700) {\n      doc.addPage();\n      this.addWatermark(doc);\n    }\n\n    const y = doc.y;\n\n    // Colored banner for recommendations\n    doc.roundedRect(50, y, 495, 30, 5)\n       .fill('#48BB78');\n\n    doc.fontSize(14)\n       .fillColor('#FFFFFF')\n       .font('Helvetica-Bold')\n       .text('Personalized Recommendations', 60, y + 8);\n\n    doc.moveDown(1.2);\n\n    // Recommendations with numbered badges\n    recommendations.forEach((rec, idx) => {\n      const recY = doc.y;\n\n      // Numbered badge (professional box style)\n      doc.roundedRect(60, recY, 20, 16, 2)\n         .fillAndStroke('#48BB78', '#48BB78');\n\n      doc.fontSize(10)\n         .fillColor('#FFFFFF')\n         .font('Helvetica-Bold')\n         .text(`${idx + 1}`, 67, recY + 3);\n\n      // Recommendation text (aligned at x=88)\n      doc.fontSize(9)\n         .fillColor('#2D3748')\n         .font('Helvetica')\n         .text(rec, 88, recY, {\n           width: 452,\n           align: 'left'\n         });\n\n      doc.moveDown(0.5);\n    });\n  }\n\n  /**\n   * Add footer - Infographic Style\n   */\n  addFooter(doc) {\n    const bottomY = 750;\n\n    // Footer bar\n    doc.rect(0, bottomY - 5, 595, 50)\n       .fill('#F7FAFC');\n\n    doc.moveTo(50, bottomY - 5)\n       .lineTo(545, bottomY - 5)\n       .stroke('#4299E1');\n\n    doc.fontSize(7)\n       .fillColor('#4A5568')\n       .font('Helvetica')\n       .text('This infographic is generated using AI-powered analysis and should be interpreted by a qualified healthcare professional.',\n             50, bottomY + 5, {\n               width: 495,\n               align: 'center'\n             });\n\n    doc.fontSize(7)\n       .fillColor('#2D3748')\n       .font('Helvetica-Bold')\n       .text('Â© 2025 NeuroSense360 â€¢ Powered by Google Gemini AI',\n             50, bottomY + 20, {\n               width: 495,\n               align: 'center'\n             });\n  }\n\n  /**\n   * Get score color based on percentage (for color-coded scoring)\n   * CONSISTENT across ALL parameters:\n   * Low score (0-40%) â†’ Red\n   * Medium score (41-70%) â†’ Orange\n   * High score (71-100%) â†’ Green\n   */\n  getScoreColor(score, maxScore, parameterName = '') {\n    const percentage = (score / maxScore) * 100;\n\n    // Consistent color mapping for ALL parameters\n    // Low = Red, Medium = Orange, High = Green\n    if (percentage <= 40) return '#E53E3E';      // Red (Low)\n    if (percentage <= 70) return '#ED8936';      // Orange (Medium)\n    return '#38A169';                            // Green (High)\n  }\n\n  /**\n   * Get color for bucket classification\n   * Consistent color mapping: Low=Red, Medium=Orange, High=Green across ALL parameters\n   */\n  getBucketColor(bucketOrColor, parameterName = '') {\n    // If it's already a hex color\n    if (bucketOrColor && bucketOrColor.startsWith('#')) {\n      return bucketOrColor;\n    }\n\n    // Consistent color mapping for ALL parameters\n    // Low metrics = Red, Medium = Orange, High = Green\n    const colorMap = {\n      'Poor': '#E53E3E',        // Red\n      'Below Average': '#F56565', // Light Red\n      'Average': '#ED8936',      // Orange\n      'Moderate': '#ED8936',     // Orange\n      'Good': '#48BB78',         // Green\n      'Excellent': '#38A169',    // Dark Green\n      'Low': '#E53E3E',          // Red (consistent for all Low)\n      'Medium': '#ED8936',       // Orange\n      'High': '#38A169'          // Green (consistent for all High)\n    };\n\n    return colorMap[bucketOrColor] || '#4299E1';\n  }\n\n  /**\n   * Generate radar chart showing all 7 brain parameters\n   * Returns Buffer containing PNG image\n   */\n  async generateRadarChart() {\n    try {\n      console.log('\\nðŸ“Š Generating radar chart for 7 brain parameters...');\n\n      // Extract parameter data\n      const parameters = this.algorithmResults.parameters || [];\n      const labels = parameters.map(p => p.name);\n      const scores = parameters.map(p => (p.score / p.maxScore) * 100); // Convert to percentage\n\n      console.log(`   Parameters: ${labels.join(', ')}`);\n      console.log(`   Scores: ${scores.map(s => s.toFixed(0) + '%').join(', ')}`);\n\n      // Create chart configuration\n      const width = 600;\n      const height = 600;\n      const chartJSNodeCanvas = new ChartJSNodeCanvas({ width, height });\n\n      const configuration = {\n        type: 'radar',\n        data: {\n          labels: labels,\n          datasets: [{\n            label: 'Brain Performance Score',\n            data: scores,\n            fill: true,\n            backgroundColor: 'rgba(54, 162, 235, 0.2)',\n            borderColor: 'rgb(54, 162, 235)',\n            pointBackgroundColor: 'rgb(54, 162, 235)',\n            pointBorderColor: '#fff',\n            pointHoverBackgroundColor: '#fff',\n            pointHoverBorderColor: 'rgb(54, 162, 235)',\n            borderWidth: 2,\n            pointRadius: 5,\n            pointHoverRadius: 7\n          }]\n        },\n        options: {\n          responsive: false,\n          plugins: {\n            title: {\n              display: true,\n              text: '7 Brain Health Parameters - Performance Overview',\n              font: {\n                size: 20,\n                weight: 'bold'\n              },\n              color: '#323956',\n              padding: 20\n            },\n            legend: {\n              display: false\n            }\n          },\n          scales: {\n            r: {\n              angleLines: {\n                display: true,\n                color: '#E2E8F0'\n              },\n              grid: {\n                color: '#E2E8F0'\n              },\n              pointLabels: {\n                font: {\n                  size: 14,\n                  weight: 'bold'\n                },\n                color: '#323956'\n              },\n              ticks: {\n                beginAtZero: true,\n                max: 100,\n                stepSize: 25,\n                callback: function(value) {\n                  return value + '%';\n                },\n                backdropColor: 'transparent',\n                color: '#718096',\n                font: {\n                  size: 12\n                }\n              },\n              suggestedMin: 0,\n              suggestedMax: 100\n            }\n          }\n        }\n      };\n\n      // Generate chart image\n      const imageBuffer = await chartJSNodeCanvas.renderToBuffer(configuration);\n      console.log('âœ… Radar chart generated successfully');\n      console.log(`   Size: ${(imageBuffer.length / 1024).toFixed(2)} KB\\n`);\n\n      return imageBuffer;\n    } catch (error) {\n      console.error('âŒ Error generating radar chart:', error.message);\n      console.error('   Stack:', error.stack);\n      return null;\n    }\n  }\n\n  /**\n   * Add Extracted QEEG Data Section - Shows raw data extracted from uploaded PDFs\n   */\n  addExtractedDataSection(doc) {\n    // Create new page for data section\n    doc.addPage();\n    this.addWatermark(doc);\n\n    const y = doc.y;\n\n    // Section header\n    doc.roundedRect(50, y, 495, 35, 5)\n       .fill('#2C5282');\n\n    doc.fontSize(16)\n       .fillColor('#FFFFFF')\n       .font('Helvetica-Bold')\n       .text('ðŸ“Š Extracted QEEG Data', 60, y + 10);\n\n    doc.moveDown(2);\n\n    // Description\n    doc.fontSize(10)\n       .fillColor('#4A5568')\n       .font('Helvetica')\n       .text('This section shows the raw brainwave data extracted from your uploaded Eye Open (EO) and Eye Closed (EC) reports.', 50, doc.y, { width: 495, align: 'left' });\n\n    doc.moveDown(1);\n\n    // === EYES OPEN DATA ===\n    this.addDataTable(doc, 'Eyes Open (EO) - Absolute Power (Î¼VÂ²)', this.qeegData.EO?.absolute);\n    doc.moveDown(0.5);\n    this.addDataTable(doc, 'Eyes Open (EO) - Relative Power (%)', this.qeegData.EO?.relative);\n\n    // Check if we need new page\n    if (doc.y > 650) {\n      doc.addPage();\n      this.addWatermark(doc);\n    }\n\n    doc.moveDown(0.5);\n\n    // === EYES CLOSED DATA ===\n    this.addDataTable(doc, 'Eyes Closed (EC) - Absolute Power (Î¼VÂ²)', this.qeegData.EC?.absolute);\n    doc.moveDown(0.5);\n    this.addDataTable(doc, 'Eyes Closed (EC) - Relative Power (%)', this.qeegData.EC?.relative);\n\n    // === SPECIAL VALUES ===\n    if (this.qeegData.EC?.special) {\n      doc.moveDown(1);\n      doc.fontSize(12)\n         .fillColor('#323956')\n         .font('Helvetica-Bold')\n         .text('Special Values', 50, doc.y);\n\n      doc.moveDown(0.5);\n      doc.fontSize(9)\n         .fillColor('#2D3748')\n         .font('Helvetica');\n\n      if (this.qeegData.EC.special.alphaPeak) {\n        doc.text(`â€¢ Alpha Peak Frequency: ${this.qeegData.EC.special.alphaPeak} Hz`, 60, doc.y);\n      }\n    }\n  }\n\n  /**\n   * Helper method to add data table to PDF\n   */\n  addDataTable(doc, title, data) {\n    if (!data) return;\n\n    // Check if we need new page\n    if (doc.y > 680) {\n      doc.addPage();\n      this.addWatermark(doc);\n    }\n\n    // Title\n    doc.fontSize(12)\n       .fillColor('#323956')\n       .font('Helvetica-Bold')\n       .text(title, 50, doc.y);\n\n    doc.moveDown(0.5);\n\n    // Table header\n    const startY = doc.y;\n    const rowHeight = 14;\n    const colWidth = 65;\n\n    // Header row background\n    doc.rect(50, startY, 495, rowHeight)\n       .fill('#E2E8F0');\n\n    // Header text\n    doc.fontSize(8)\n       .fillColor('#2D3748')\n       .font('Helvetica-Bold');\n\n    doc.text('Channel', 55, startY + 3, { width: 55 });\n    doc.text('Delta', 115, startY + 3, { width: colWidth });\n    doc.text('Theta', 180, startY + 3, { width: colWidth });\n    doc.text('Alpha', 245, startY + 3, { width: colWidth });\n    doc.text('Beta', 310, startY + 3, { width: colWidth });\n    doc.text('HiBeta', 375, startY + 3, { width: colWidth });\n\n    let currentY = startY + rowHeight;\n\n    // Data rows\n    const channels = ['Fz', 'Cz', 'Pz', 'F3', 'F4', 'C3', 'C4', 'P3', 'P4'];\n    doc.fontSize(8).font('Helvetica').fillColor('#2D3748');\n\n    channels.forEach((channel, index) => {\n      const bands = data[channel];\n      if (!bands) return;\n\n      // Alternating row colors\n      if (index % 2 === 0) {\n        doc.rect(50, currentY, 495, rowHeight).fill('#F7FAFC');\n      }\n\n      doc.fillColor('#2D3748');\n      doc.text(channel, 55, currentY + 3, { width: 55 });\n      doc.text(bands.Delta?.toFixed(2) || '0.00', 115, currentY + 3, { width: colWidth });\n      doc.text(bands.Theta?.toFixed(2) || '0.00', 180, currentY + 3, { width: colWidth });\n      doc.text(bands.Alpha?.toFixed(2) || '0.00', 245, currentY + 3, { width: colWidth });\n      doc.text(bands.Beta?.toFixed(2) || '0.00', 310, currentY + 3, { width: colWidth });\n      doc.text(bands.HiBeta?.toFixed(2) || '0.00', 375, currentY + 3, { width: colWidth });\n\n      currentY += rowHeight;\n    });\n\n    // Update cursor position\n    doc.y = currentY + 5;\n  }\n\n  /**\n   * Add Detailed Calculations Section - Shows how scores were calculated\n   */\n  addCalculationsSection(doc) {\n    // Create new page for calculations\n    doc.addPage();\n    this.addWatermark(doc);\n\n    const y = doc.y;\n\n    // Section header\n    doc.roundedRect(50, y, 495, 35, 5)\n       .fill('#2C5282');\n\n    doc.fontSize(16)\n       .fillColor('#FFFFFF')\n       .font('Helvetica-Bold')\n       .text('ðŸ§® Detailed Calculations', 60, y + 10);\n\n    doc.moveDown(2);\n\n    // Description\n    doc.fontSize(10)\n       .fillColor('#4A5568')\n       .font('Helvetica')\n       .text('This section shows step-by-step calculations for each brain health parameter, including formulas, thresholds, and scoring logic.', 50, doc.y, { width: 495, align: 'left' });\n\n    doc.moveDown(1);\n\n    // Add calculation details for each parameter\n    if (this.algorithmResults.parameters) {\n      this.algorithmResults.parameters.forEach((param, index) => {\n        this.addParameterCalculation(doc, param, index + 1);\n      });\n    }\n  }\n\n  /**\n   * Add individual parameter calculation details\n   */\n  addParameterCalculation(doc, param, number) {\n    // Check if we need new page\n    if (doc.y > 650) {\n      doc.addPage();\n      this.addWatermark(doc);\n    }\n\n    // Parameter header\n    doc.fontSize(12)\n       .fillColor('#323956')\n       .font('Helvetica-Bold')\n       .text(`${number}. ${param.name} - Score: ${param.score}/3 (${param.classification})`, 50, doc.y);\n\n    doc.moveDown(0.5);\n\n    // Metrics/Sub-calculations\n    if (param.metrics && param.metrics.length > 0) {\n      param.metrics.forEach((metric, idx) => {\n        // Check if we need new page before each metric\n        if (doc.y > 720) {\n          doc.addPage();\n          this.addWatermark(doc);\n        }\n\n        // Metric box\n        const metricY = doc.y;\n        doc.roundedRect(55, metricY, 485, 'auto', 3)\n           .lineWidth(1)\n           .stroke('#CBD5E0');\n\n        doc.fontSize(10)\n           .fillColor('#2D3748')\n           .font('Helvetica-Bold')\n           .text(`   ${String.fromCharCode(97 + idx)}) ${metric.name}: ${metric.score} point`, 60, metricY + 5, { width: 475 });\n\n        doc.moveDown(0.3);\n\n        // Formula/Description\n        if (metric.description) {\n          doc.fontSize(9)\n             .fillColor('#4A5568')\n             .font('Helvetica')\n             .text(`      ${metric.description}`, 60, doc.y, { width: 475 });\n        }\n\n        // Value details\n        if (metric.value !== undefined && metric.value !== null) {\n          doc.fontSize(9)\n             .fillColor('#2D3748')\n             .font('Helvetica');\n\n          if (typeof metric.value === 'object') {\n            doc.text(`      Raw Values: ${JSON.stringify(metric.value)}`, 60, doc.y, { width: 475 });\n          } else {\n            doc.text(`      Calculated Value: ${typeof metric.value === 'number' ? metric.value.toFixed(3) : metric.value}`, 60, doc.y, { width: 475 });\n          }\n        }\n\n        // Interpretation\n        if (metric.score === 1) {\n          doc.fontSize(9)\n             .fillColor('#22543D')\n             .font('Helvetica-Bold')\n             .text('      âœ“ PASS - Within optimal range', 60, doc.y, { width: 475 });\n        } else {\n          doc.fontSize(9)\n             .fillColor('#742A2A')\n             .font('Helvetica-Bold')\n             .text('      âœ— FAIL - Outside optimal range', 60, doc.y, { width: 475 });\n        }\n\n        doc.moveDown(0.8);\n      });\n    }\n\n    doc.moveDown(0.5);\n  }\n}\n\nmodule.exports = GeminiPdfGenerator;\n","numLines":1111,"startLine":1,"totalLines":1111}}}
{"parentUuid":"12921409-d65c-434f-8c1f-77c452b5c4e6","isSidechain":true,"userType":"external","cwd":"D:\\Todays\\Neuro360","sessionId":"042556c2-8872-4445-8efb-d2658cbac4a7","version":"2.0.33","gitBranch":"main","agentId":"63bdb4e9","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01QvEcFS4mHKs9d6ZYqCAUKf","type":"tool_result","content":"     1â†’import React, { useState, useEffect } from 'react';\n     2â†’import { Upload, Play, Download, FileText, CheckCircle, Activity, User, Building2, Calendar, History, X, ArrowLeft, Search, Filter } from 'lucide-react';\n     3â†’import DatabaseService from '../../services/databaseService';\n     4â†’import toast from 'react-hot-toast';\n     5â†’\n     6â†’const AlgorithmDataProcessor = () => {\n     7â†’  const [patients, setPatients] = useState([]);\n     8â†’  const [clinics, setClinics] = useState([]);\n     9â†’  const [selectedPatient, setSelectedPatient] = useState(null);\n    10â†’  const [showProcessingUI, setShowProcessingUI] = useState(false);\n    11â†’  const [processingHistory, setProcessingHistory] = useState([]);\n    12â†’  const [loading, setLoading] = useState(true);\n    13â†’\n    14â†’  // Filter states\n    15â†’  const [searchTerm, setSearchTerm] = useState('');\n    16â†’  const [selectedClinicFilter, setSelectedClinicFilter] = useState('');\n    17â†’  const [dateFilter, setDateFilter] = useState('');\n    18â†’\n    19â†’  const [eyesOpenFile, setEyesOpenFile] = useState(null);\n    20â†’  const [eyesClosedFile, setEyesClosedFile] = useState(null);\n    21â†’  const [isProcessing, setIsProcessing] = useState(false);\n    22â†’  const [processingComplete, setProcessingComplete] = useState(false);\n    23â†’  const [consoleLog, setConsoleLog] = useState([]);\n    24â†’  const [progress, setProgress] = useState(0);\n    25â†’  const [results, setResults] = useState(null);\n    26â†’  const [isSaved, setIsSaved] = useState(false);\n    27â†’  const [isSaving, setIsSaving] = useState(false);\n    28â†’  const [pdfUrl, setPdfUrl] = useState(null);\n    29â†’  const [dataType, setDataType] = useState(null); // 'raw' or 'zscore'\n    30â†’\n    31â†’  // Debug function to check database contents\n    32â†’  useEffect(() => {\n    33â†’    window.debugAlgorithmResults = async () => {\n    34â†’      const allResults = await DatabaseService.get('algorithmResults');\n    35â†’      console.log('ðŸ” All Algorithm Results in Database:', allResults);\n    36â†’      console.log(`Total records: ${allResults.length}`);\n    37â†’      allResults.forEach((record, idx) => {\n    38â†’        console.log(`\\nðŸ“Š Record ${idx + 1}:`, {\n    39â†’          id: record.id,\n    40â†’          patientName: record.inputData?.patientName || record.patientName,\n    41â†’          processedAt: record.inputData?.processedAt || record.processedAt,\n    42â†’          pdfUrl: record.pdfUrl || 'âŒ MISSING',\n    43â†’          hasResults: !!(record.outputData || record.results)\n    44â†’        });\n    45â†’      });\n    46â†’    };\n    47â†’    console.log('ðŸ’¡ Debug: Type window.debugAlgorithmResults() in console to check database');\n    48â†’  }, []);\n    49â†’\n    50â†’  useEffect(() => {\n    51â†’    loadPatients();\n    52â†’  }, []);\n    53â†’\n    54â†’  useEffect(() => {\n    55â†’    if (selectedPatient && showProcessingUI) {\n    56â†’      loadProcessingHistory(selectedPatient.id);\n    57â†’    }\n    58â†’  }, [selectedPatient, showProcessingUI, isSaved]); // Re-load when saved\n    59â†’\n    60â†’  const loadPatients = async () => {\n    61â†’    try {\n    62â†’      const patientsData = await DatabaseService.get('patients');\n    63â†’      const clinicsData = await DatabaseService.get('clinics');\n    64â†’      const algorithmResults = await DatabaseService.get('algorithmResults') || [];\n    65â†’\n    66â†’      // Enrich patients with clinic names and algorithm status\n    67â†’      const enrichedPatients = patientsData.map(patient => {\n    68â†’        const patientResults = algorithmResults.filter(r => r.patientId === patient.id);\n    69â†’        const lastResult = patientResults.length > 0\n    70â†’          ? patientResults.sort((a, b) => {\n    71â†’              const aTime = a.inputData?.processedAt || a.processedAt || a.createdAt;\n    72â†’              const bTime = b.inputData?.processedAt || b.processedAt || b.createdAt;\n    73â†’              return new Date(bTime) - new Date(aTime);\n    74â†’            })[0]\n    75â†’          : null;\n    76â†’\n    77â†’        return {\n    78â†’          ...patient,\n    79â†’          clinicName: clinicsData.find(c => c.id === patient.clinicId)?.name || 'Unknown Clinic',\n    80â†’          algorithmStatus: lastResult ? 'completed' : 'pending',\n    81â†’          lastProcessed: lastResult?.inputData?.processedAt || lastResult?.processedAt || lastResult?.createdAt,\n    82â†’          totalScans: patientResults.length\n    83â†’        };\n    84â†’      });\n    85â†’\n    86â†’      setPatients(enrichedPatients);\n    87â†’      setClinics(clinicsData);\n    88â†’      setLoading(false);\n    89â†’    } catch (error) {\n    90â†’      console.error('Error loading patients:', error);\n    91â†’      toast.error('Failed to load patients');\n    92â†’      setLoading(false);\n    93â†’    }\n    94â†’  };\n    95â†’\n    96â†’  const loadProcessingHistory = async (patientId) => {\n    97â†’    try {\n    98â†’      // Load algorithm results for this patient\n    99â†’      const results = await DatabaseService.get('algorithmResults');\n   100â†’      const patientResults = results.filter(r => r.patientId === patientId);\n   101â†’\n   102â†’      console.log(`ðŸ“‹ Loaded ${patientResults.length} records for patient ${patientId}`);\n   103â†’\n   104â†’      // Log all records for debugging\n   105â†’      console.log('ðŸ“Š All records for this patient:');\n   106â†’      patientResults.forEach((rec, idx) => {\n   107â†’        const processedTime = rec.inputData?.processedAt || rec.processedAt || rec.createdAt;\n   108â†’        console.log(`   ${idx + 1}. ${new Date(processedTime).toLocaleString()} - PDF: ${rec.pdfUrl ? 'âœ“' : 'âœ—'}`);\n   109â†’      });\n   110â†’\n   111â†’      // Check for records without pdfUrl and try to fix them\n   112â†’      const recordsWithoutPdf = patientResults.filter(r => !r.pdfUrl);\n   113â†’      if (recordsWithoutPdf.length > 0) {\n   114â†’        console.log(`\\nâš ï¸ Found ${recordsWithoutPdf.length} records without PDF URL - attempting auto-fix...`);\n   115â†’\n   116â†’        let updatedCount = 0;\n   117â†’\n   118â†’        // Step 1: Try to fetch PDFs from Supabase bucket\n   119â†’        try {\n   120â†’          const apiUrl = import.meta.env.VITE_API_URL || 'http://localhost:3001/api';\n   121â†’          const response = await fetch(`${apiUrl}/qeeg/supabase-pdfs`);\n   122â†’\n   123â†’          if (response.ok) {\n   124â†’            const data = await response.json();\n   125â†’            console.log(`\\nâ˜ï¸ Found ${data.count} PDFs in Supabase bucket:`);\n   126â†’            data.pdfs.forEach(pdf => console.log(`   - ${pdf.name}`));\n   127â†’\n   128â†’            // Match PDFs with database records using smart matching\n   129â†’            console.log(`\\nðŸ” Attempting to match ${recordsWithoutPdf.length} records...`);\n   130â†’            for (const record of recordsWithoutPdf) {\n   131â†’              const processedTime = record.inputData?.processedAt || record.processedAt || record.createdAt;\n   132â†’              const patientName = record.inputData?.patientName || record.patientName || 'unknown';\n   133â†’              const recordTimestamp = new Date(processedTime).getTime();\n   134â†’              const sanitizedName = patientName.replace(/[^a-z0-9]/gi, '_').toLowerCase();\n   135â†’\n   136â†’              console.log(`\\n   Record: ${patientName} @ ${new Date(processedTime).toLocaleString()}`);\n   137â†’              console.log(`   Searching for PDFs matching: neurosense-report-${sanitizedName}-*.pdf`);\n   138â†’\n   139â†’              // Find PDFs matching patient name\n   140â†’              const matchingPdfs = data.pdfs.filter(pdf => {\n   141â†’                const pdfNameLower = pdf.name.toLowerCase();\n   142â†’                return pdfNameLower.includes(`neurosense-report-${sanitizedName}-`) &&\n   143â†’                       pdfNameLower.endsWith('.pdf');\n   144â†’              });\n   145â†’\n   146â†’              console.log(`   Found ${matchingPdfs.length} PDFs for this patient`);\n   147â†’\n   148â†’              if (matchingPdfs.length > 0) {\n   149â†’                // Find PDF with closest timestamp (within 60 seconds)\n   150â†’                let bestMatch = null;\n   151â†’                let smallestDiff = Infinity;\n   152â†’\n   153â†’                for (const pdf of matchingPdfs) {\n   154â†’                  // Extract timestamp from filename: neurosense-report-name-TIMESTAMP.pdf\n   155â†’                  const match = pdf.name.match(/-(\\d+)\\.pdf$/);\n   156â†’                  if (match) {\n   157â†’                    const pdfTimestamp = parseInt(match[1]);\n   158â†’                    const diff = Math.abs(pdfTimestamp - recordTimestamp);\n   159â†’                    console.log(`      ${pdf.name}: timestamp diff = ${diff}ms (${(diff/1000).toFixed(1)}s)`);\n   160â†’\n   161â†’                    // Accept if within 60 seconds (60000ms)\n   162â†’                    if (diff < 60000 && diff < smallestDiff) {\n   163â†’                      smallestDiff = diff;\n   164â†’                      bestMatch = pdf;\n   165â†’                    }\n   166â†’                  }\n   167â†’                }\n   168â†’\n   169â†’                if (bestMatch) {\n   170â†’                  console.log(`   âœ… MATCH FOUND! ${bestMatch.name} (${(smallestDiff/1000).toFixed(1)}s difference)`);\n   171â†’                  console.log(`   URL: ${bestMatch.url}`);\n   172â†’                  record.pdfUrl = bestMatch.url;\n   173â†’                  await DatabaseService.update('algorithmResults', record.id, record);\n   174â†’                  updatedCount++;\n   175â†’                } else {\n   176â†’                  console.log(`   âš ï¸ PDFs found but timestamp difference too large (>60s)`);\n   177â†’                }\n   178â†’              } else {\n   179â†’                console.log(`   âŒ No PDFs found for patient: ${sanitizedName}`);\n   180â†’              }\n   181â†’            }\n   182â†’          }\n   183â†’        } catch (supabaseErr) {\n   184â†’          console.log('âš ï¸ Could not fetch from Supabase, trying local storage...');\n   185â†’        }\n   186â†’\n   187â†’        // Step 2: If Supabase fails, try local storage\n   188â†’        for (const record of recordsWithoutPdf) {\n   189â†’          if (record.pdfUrl) continue; // Already updated from Supabase\n   190â†’\n   191â†’          try {\n   192â†’            const processedTime = record.inputData?.processedAt || record.processedAt || record.createdAt;\n   193â†’            const patientName = record.inputData?.patientName || record.patientName || 'unknown';\n   194â†’            const timestamp = new Date(processedTime).getTime();\n   195â†’            const sanitizedName = patientName.replace(/[^a-z0-9]/gi, '_').toLowerCase();\n   196â†’            const possibleFilename = `neurosense-report-${sanitizedName}-${timestamp}.pdf`;\n   197â†’            const apiUrl = import.meta.env.VITE_API_URL || 'http://localhost:3001/api';\n   198â†’            const backendBaseUrl = apiUrl.replace('/api', '');\n   199â†’            const testUrl = `${backendBaseUrl}/uploads/${possibleFilename}`;\n   200â†’\n   201â†’            // Test if file exists locally\n   202â†’            const response = await fetch(testUrl, { method: 'HEAD' });\n   203â†’            if (response.ok) {\n   204â†’              console.log(`âœ… Found local PDF for record ${record.id}: ${testUrl}`);\n   205â†’              record.pdfUrl = `/uploads/${possibleFilename}`;\n   206â†’              await DatabaseService.update('algorithmResults', record.id, record);\n   207â†’              updatedCount++;\n   208â†’            }\n   209â†’          } catch (err) {\n   210â†’            console.log(`âŒ Could not find PDF for record ${record.id}`);\n   211â†’          }\n   212â†’        }\n   213â†’\n   214â†’        if (updatedCount > 0) {\n   215â†’          console.log(`âœ… Auto-fixed ${updatedCount} records with PDF URLs`);\n   216â†’          // Reload the results after updating\n   217â†’          const updatedResults = await DatabaseService.get('algorithmResults');\n   218â†’          const updatedPatientResults = updatedResults.filter(r => r.patientId === patientId);\n   219â†’          setProcessingHistory(updatedPatientResults);\n   220â†’\n   221â†’          updatedPatientResults.forEach((record, idx) => {\n   222â†’            const processedTime = record.inputData?.processedAt || record.processedAt || record.createdAt;\n   223â†’            console.log(`   Record ${idx + 1}:`, {\n   224â†’              processedAt: processedTime,\n   225â†’              hasPdfUrl: !!record.pdfUrl,\n   226â†’              pdfUrl: record.pdfUrl || 'NOT SET',\n   227â†’              pdfType: record.pdfUrl ? (record.pdfUrl.startsWith('http') ? 'Supabase' : 'Local') : 'None'\n   228â†’            });\n   229â†’          });\n   230â†’          return;\n   231â†’        }\n   232â†’      }\n   233â†’\n   234â†’      patientResults.forEach((record, idx) => {\n   235â†’        const processedTime = record.inputData?.processedAt || record.processedAt || record.createdAt;\n   236â†’        console.log(`   Record ${idx + 1}:`, {\n   237â†’          processedAt: processedTime,\n   238â†’          hasPdfUrl: !!record.pdfUrl,\n   239â†’          pdfUrl: record.pdfUrl || 'NOT SET',\n   240â†’          pdfType: record.pdfUrl ? (record.pdfUrl.startsWith('http') ? 'Supabase' : 'Local') : 'None'\n   241â†’        });\n   242â†’      });\n   243â†’\n   244â†’      setProcessingHistory(patientResults);\n   245â†’    } catch (error) {\n   246â†’      console.error('Error loading processing history:', error);\n   247â†’      setProcessingHistory([]);\n   248â†’    }\n   249â†’  };\n   250â†’\n   251â†’  const handleGenerateReport = (patient) => {\n   252â†’    setSelectedPatient(patient);\n   253â†’    setShowProcessingUI(true);\n   254â†’    // Reset upload states\n   255â†’    setEyesOpenFile(null);\n   256â†’    setEyesClosedFile(null);\n   257â†’    setResults(null);\n   258â†’    setProcessingComplete(false);\n   259â†’    setConsoleLog([]);\n   260â†’    setIsSaved(false);\n   261â†’    setPdfUrl(null);\n   262â†’    setIsSaving(false);\n   263â†’  };\n   264â†’\n   265â†’  const handleBackToList = () => {\n   266â†’    setShowProcessingUI(false);\n   267â†’    setSelectedPatient(null);\n   268â†’    setEyesOpenFile(null);\n   269â†’    setEyesClosedFile(null);\n   270â†’    setResults(null);\n   271â†’    setProcessingComplete(false);\n   272â†’    setConsoleLog([]);\n   273â†’    setProcessingHistory([]);\n   274â†’    setIsSaved(false);\n   275â†’    setIsSaving(false);\n   276â†’    // Reload patients to update status\n   277â†’    loadPatients();\n   278â†’  };\n   279â†’\n   280â†’  // Helper function to get patient name (handles different field names)\n   281â†’  const getPatientName = (patient) => {\n   282â†’    return patient?.fullName || patient?.full_name || patient?.name || patient?.email || 'Unknown Patient';\n   283â†’  };\n   284â†’\n   285â†’  // Helper function to get status badge\n   286â†’  const getStatusBadge = (status, lastProcessed) => {\n   287â†’    if (status === 'completed') {\n   288â†’      return (\n   289â†’        <div className=\"flex flex-col items-start\">\n   290â†’          <span className=\"inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-400\">\n   291â†’            <CheckCircle className=\"h-3 w-3 mr-1\" />\n   292â†’            Completed\n   293â†’          </span>\n   294â†’          {lastProcessed && (\n   295â†’            <span className=\"text-xs text-gray-500 dark:text-gray-400 mt-1\">\n   296â†’              {new Date(lastProcessed).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}\n   297â†’            </span>\n   298â†’          )}\n   299â†’        </div>\n   300â†’      );\n   301â†’    }\n   302â†’    return (\n   303â†’      <span className=\"inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800 dark:bg-yellow-900/30 dark:text-yellow-400\">\n   304â†’        <Activity className=\"h-3 w-3 mr-1\" />\n   305â†’        Pending\n   306â†’      </span>\n   307â†’    );\n   308â†’  };\n   309â†’\n   310â†’  // Filter patients based on search and filters\n   311â†’  const filteredPatients = patients.filter(patient => {\n   312â†’    const matchesSearch = searchTerm === '' ||\n   313â†’      getPatientName(patient).toLowerCase().includes(searchTerm.toLowerCase()) ||\n   314â†’      patient.email?.toLowerCase().includes(searchTerm.toLowerCase());\n   315â†’\n   316â†’    const matchesClinic = selectedClinicFilter === '' || patient.clinicId === selectedClinicFilter;\n   317â†’\n   318â†’    const matchesDate = dateFilter === '' ||\n   319â†’      (patient.lastProcessed && new Date(patient.lastProcessed).toISOString().split('T')[0] === dateFilter);\n   320â†’\n   321â†’    return matchesSearch && matchesClinic && matchesDate;\n   322â†’  });\n   323â†’\n   324â†’  // Group filtered patients by clinic\n   325â†’  const groupedPatients = clinics.map(clinic => ({\n   326â†’    clinic,\n   327â†’    patients: filteredPatients.filter(p => p.clinicId === clinic.id)\n   328â†’  })).filter(group => group.patients.length > 0);\n   329â†’\n   330â†’  const clearFilters = () => {\n   331â†’    setSearchTerm('');\n   332â†’    setSelectedClinicFilter('');\n   333â†’    setDateFilter('');\n   334â†’  };\n   335â†’\n   336â†’  const handleFileUpload = (type, event) => {\n   337â†’    const file = event.target.files[0];\n   338â†’    if (file) {\n   339â†’      if (type === 'eo') {\n   340â†’        setEyesOpenFile(file);\n   341â†’      } else {\n   342â†’        setEyesClosedFile(file);\n   343â†’      }\n   344â†’      // Reset processing state when new files are uploaded\n   345â†’      setProcessingComplete(false);\n   346â†’      setResults(null);\n   347â†’      setConsoleLog([]);\n   348â†’      setProgress(0);\n   349â†’      setIsSaved(false);\n   350â†’      setIsSaving(false);\n   351â†’      setPdfUrl(null);\n   352â†’    }\n   353â†’  };\n   354â†’\n   355â†’  const processQEEGFiles = async () => {\n   356â†’    setIsProcessing(true);\n   357â†’    setConsoleLog([]);\n   358â†’    setProgress(0);\n   359â†’\n   360â†’    try {\n   361â†’      // Console log: Starting process\n   362â†’      setConsoleLog(prev => [...prev, 'ðŸš€ Starting QEEG analysis...']);\n   363â†’      setProgress(10);\n   364â†’\n   365â†’      // Create FormData to send files\n   366â†’      const formData = new FormData();\n   367â†’      formData.append('eyesOpen', eyesOpenFile);\n   368â†’      formData.append('eyesClosed', eyesClosedFile);\n   369â†’      formData.append('patientId', selectedPatient.id);\n   370â†’      formData.append('patientName', getPatientName(selectedPatient));\n   371â†’      formData.append('clinicName', selectedPatient.clinicName);\n   372â†’      // Add complete patient data for PDF\n   373â†’      formData.append('dateOfBirth', selectedPatient.dateOfBirth || selectedPatient.date_of_birth || 'Not specified');\n   374â†’      formData.append('age', selectedPatient.age || calculateAge(selectedPatient.dateOfBirth || selectedPatient.date_of_birth) || 'N/A');\n   375â†’      formData.append('gender', selectedPatient.gender || 'Not specified');\n   376â†’      formData.append('handedness', selectedPatient.handedness || 'Right');\n   377â†’\n   378â†’      setConsoleLog(prev => [...prev, 'ðŸ“¤ Uploading files to server...']);\n   379â†’      setProgress(20);\n   380â†’\n   381â†’      // Validate file sizes before upload (50MB limit)\n   382â†’      const maxFileSize = 50 * 1024 * 1024; // 50MB\n   383â†’      if (eyesOpenFile.size > maxFileSize || eyesClosedFile.size > maxFileSize) {\n   384â†’        const oversizedFile = eyesOpenFile.size > maxFileSize ? eyesOpenFile : eyesClosedFile;\n   385â†’        const fileSizeMB = (oversizedFile.size / (1024 * 1024)).toFixed(2);\n   386â†’        throw new Error(`File \"${oversizedFile.name}\" is too large (${fileSizeMB}MB). Maximum file size is 50MB. Please compress or split the file.`);\n   387â†’      }\n   388â†’\n   389â†’      // Call backend API with timeout\n   390â†’      const apiUrl = import.meta.env.VITE_API_URL || 'http://localhost:3001/api';\n   391â†’      const controller = new AbortController();\n   392â†’      const timeoutId = setTimeout(() => controller.abort(), 120000); // 2 minute timeout for large files\n   393â†’\n   394â†’      let response;\n   395â†’      try {\n   396â†’        response = await fetch(`${apiUrl}/qeeg/process`, {\n   397â†’          method: 'POST',\n   398â†’          body: formData,\n   399â†’          signal: controller.signal\n   400â†’        });\n   401â†’        clearTimeout(timeoutId);\n   402â†’      } catch (fetchError) {\n   403â†’        clearTimeout(timeoutId);\n   404â†’        if (fetchError.name === 'AbortError') {\n   405â†’          throw new Error('Upload timed out. The file may be too large or the server is busy. Please try again.');\n   406â†’        }\n   407â†’        // Check if it's a network error (backend not running)\n   408â†’        if (fetchError.message.includes('Failed to fetch') || fetchError.message.includes('fetch')) {\n   409â†’          throw new Error('Cannot connect to backend server. Please ensure the backend is running on port 3001. Run \"npm run dev:backend\" to start the server.');\n   410â†’        }\n   411â†’        throw fetchError;\n   412â†’      }\n   413â†’\n   414â†’      setConsoleLog(prev => [...prev, 'ðŸ“Š Parsing QEEG data tables...']);\n   415â†’      setProgress(40);\n   416â†’\n   417â†’      if (!response.ok) {\n   418â†’        let errorMessage = 'Failed to process QEEG files';\n   419â†’        try {\n   420â†’          const errorData = await response.json();\n   421â†’          errorMessage = errorData.message || errorMessage;\n   422â†’\n   423â†’          // Add specific error messages based on error code\n   424â†’          if (errorData.code === 'LIMIT_FILE_SIZE') {\n   425â†’            errorMessage = 'File size exceeds the maximum limit of 50MB. Please compress your files or split them into smaller parts.';\n   426â†’          } else if (errorData.code === 'GEMINI_QUOTA_EXCEEDED' || response.status === 429) {\n   427â†’            // Extract retry time if available in error message\n   428â†’            let retryTime = null;\n   429â†’            const retryMatch = errorData.message?.match(/retry in ([\\d.]+)s/i);\n   430â†’            if (retryMatch) {\n   431â†’              retryTime = Math.ceil(parseFloat(retryMatch[1]));\n   432â†’            }\n   433â†’\n   434â†’            errorMessage = 'âš ï¸ API Quota Exceeded\\n\\n' +\n   435â†’                         'The Gemini AI service has reached its daily limit (20 requests/day).\\n\\n' +\n   436â†’                         'âœ… Quick Solutions:\\n' +\n   437â†’                         (retryTime ? `â€¢ Wait ${retryTime} seconds and try again (quota will reset)\\n` : 'â€¢ Wait a few minutes and try again\\n') +\n   438â†’                         'â€¢ Re-upload the SAME files you processed before (uses cache, no quota needed)\\n' +\n   439â†’                         'â€¢ Contact administrator to upgrade API plan\\n\\n' +\n   440â†’                         'ðŸ’¡ Tip: The system remembers files you\\'ve already processed!';\n   441â†’          } else if (response.status === 503) {\n   442â†’            errorMessage = 'Backend service is unavailable. Please ensure the server is running.';\n   443â†’          } else if (response.status === 413) {\n   444â†’            errorMessage = 'File payload is too large. Maximum allowed size is 50MB.';\n   445â†’          } else if (response.status === 500) {\n   446â†’            // Parse detailed error from server for 500 errors\n   447â†’            if (errorData.message && (errorData.message.includes('Gemini') || errorData.message.includes('quota') || errorData.message.includes('429'))) {\n   448â†’              // Extract retry time from detailed error\n   449â†’              let retryTime = null;\n   450â†’              const retryMatch = errorData.message.match(/retry in ([\\d.]+)s/i);\n   451â†’              if (retryMatch) {\n   452â†’                retryTime = Math.ceil(parseFloat(retryMatch[1]));\n   453â†’              }\n   454â†’\n   455â†’              // Check if it's specifically a quota error\n   456â†’              if (errorData.message.includes('quota') || errorData.message.includes('429')) {\n   457â†’                errorMessage = 'âš ï¸ API Quota Exceeded\\n\\n' +\n   458â†’                             'Google Gemini API has reached its free tier limit.\\n\\n' +\n   459â†’                             'âœ… What to do:\\n' +\n   460â†’                             (retryTime ? `1. Wait ${retryTime} seconds and try again\\n` : '1. Wait a few minutes and try again\\n') +\n   461â†’                             '2. Or re-upload the SAME files (cached, no quota used)\\n' +\n   462â†’                             '3. Or contact admin to upgrade API plan\\n\\n' +\n   463â†’                             'ðŸ“Š Free tier: 20 requests per day\\n' +\n   464â†’                             'ðŸ’° Upgrade: https://ai.google.dev/pricing';\n   465â†’              } else {\n   466â†’                errorMessage = 'âš ï¸ Gemini AI Service Error\\n\\n' +\n   467â†’                             'There was an issue with the AI service.\\n\\n' +\n   468â†’                             'Please try again in a moment or contact support if the issue persists.';\n   469â†’              }\n   470â†’            }\n   471â†’          }\n   472â†’        } catch (e) {\n   473â†’          // If error response is not JSON, use status text\n   474â†’          errorMessage = `Server error (${response.status}): ${response.statusText}`;\n   475â†’        }\n   476â†’        throw new Error(errorMessage);\n   477â†’      }\n   478â†’\n   479â†’      const data = await response.json();\n   480â†’\n   481â†’      // Capture data type (raw or zscore)\n   482â†’      if (data.data.dataType) {\n   483â†’        setDataType(data.data.dataType);\n   484â†’        console.log('ðŸ“Š Data type:', data.data.dataType);\n   485â†’        if (data.data.dataType === 'zscore') {\n   486â†’          setConsoleLog(prev => [...prev, 'ðŸ”¬ Z-Score mode detected']);\n   487â†’        }\n   488â†’      }\n   489â†’\n   490â†’      // Auto-set PDF URL if returned from backend\n   491â†’      if (data.data.pdfUrl) {\n   492â†’        setPdfUrl(data.data.pdfUrl);\n   493â†’        console.log('âœ… PDF auto-generated:', data.data.pdfUrl);\n   494â†’        setConsoleLog(prev => [...prev, 'ðŸ“„ PDF report generated automatically']);\n   495â†’      }\n   496â†’\n   497â†’      setConsoleLog(prev => [...prev, 'ðŸ§® Calculating 7 brain health parameters...']);\n   498â†’      setProgress(60);\n   499â†’\n   500â†’      // Simulate calculation steps for better UX\n   501â†’      await new Promise(resolve => setTimeout(resolve, 500));\n   502â†’      setConsoleLog(prev => [...prev, '  âœ“ Cognition parameter calculated']);\n   503â†’      setProgress(65);\n   504â†’\n   505â†’      await new Promise(resolve => setTimeout(resolve, 400));\n   506â†’      setConsoleLog(prev => [...prev, '  âœ“ Stress parameter calculated']);\n   507â†’      setProgress(70);\n   508â†’\n   509â†’      await new Promise(resolve => setTimeout(resolve, 400));\n   510â†’      setConsoleLog(prev => [...prev, '  âœ“ Focus & Attention parameter calculated']);\n   511â†’      setProgress(75);\n   512â†’\n   513â†’      await new Promise(resolve => setTimeout(resolve, 400));\n   514â†’      setConsoleLog(prev => [...prev, '  âœ“ Burnout & Fatigue parameter calculated']);\n   515â†’      setProgress(80);\n   516â†’\n   517â†’      await new Promise(resolve => setTimeout(resolve, 400));\n   518â†’      setConsoleLog(prev => [...prev, '  âœ“ Emotional Regulation parameter calculated']);\n   519â†’      setProgress(85);\n   520â†’\n   521â†’      await new Promise(resolve => setTimeout(resolve, 400));\n   522â†’      setConsoleLog(prev => [...prev, '  âœ“ Learning parameter calculated']);\n   523â†’      setProgress(90);\n   524â†’\n   525â†’      await new Promise(resolve => setTimeout(resolve, 400));\n   526â†’      setConsoleLog(prev => [...prev, '  âœ“ Creativity parameter calculated']);\n   527â†’      setProgress(95);\n   528â†’\n   529â†’      // Convert API results to display format\n   530â†’      const finalResults = data.data.results.map(param => ({\n   531â†’        parameter: param.name,\n   532â†’        score: Math.round((param.score / param.maxScore) * 100), // Convert to percentage\n   533â†’        rawScore: `${param.score}/${param.maxScore}`,\n   534â†’        status: param.classification,\n   535â†’        color: param.classification === 'High' ? 'green' :\n   536â†’               param.classification === 'Medium' ? 'blue' : 'orange',\n   537â†’        metrics: param.metrics\n   538â†’      }));\n   539â†’\n   540â†’      setConsoleLog(prev => [...prev, 'âœ… Analysis complete!']);\n   541â†’      setConsoleLog(prev => [...prev, `ðŸ“ˆ Overall Score: ${data.data.overallScore}/${data.data.maxScore}`]);\n   542â†’      setProgress(100);\n   543â†’\n   544â†’      setResults(finalResults);\n   545â†’      setIsProcessing(false);\n   546â†’      setProcessingComplete(true);\n   547â†’      setIsSaved(false); // Mark as not saved yet\n   548â†’\n   549â†’      toast.success('QEEG analysis completed successfully!');\n   550â†’\n   551â†’    } catch (error) {\n   552â†’      console.error('Error processing QEEG files:', error);\n   553â†’      setConsoleLog(prev => [...prev, `âŒ Error: ${error.message}`]);\n   554â†’      setIsProcessing(false);\n   555â†’      toast.error(error.message || 'Failed to process QEEG files');\n   556â†’    }\n   557â†’  };\n   558â†’\n   559â†’  const saveResultsToDatabase = async (resultData) => {\n   560â†’    if (!resultData) {\n   561â†’      toast.error('No results to save');\n   562â†’      return;\n   563â†’    }\n   564â†’\n   565â†’    try {\n   566â†’      setIsSaving(true);\n   567â†’      toast.loading('Saving results to database...', { id: 'save-results' });\n   568â†’\n   569â†’      console.log('ðŸ’¾ Saving results to database...');\n   570â†’\n   571â†’      // PDF should already exist from auto-generation\n   572â†’      if (!pdfUrl) {\n   573â†’        console.warn('âš ï¸ No PDF URL available - PDF may not have been generated');\n   574â†’      }\n   575â†’\n   576â†’      const algorithmResult = {\n   577â†’        // Don't specify ID - let database auto-generate UUID\n   578â†’        patientId: selectedPatient.id,\n   579â†’        clinicId: selectedPatient.clinicId,\n   580â†’        algorithmName: 'Algorithm 1 - 7 Parameters',\n   581â†’        inputData: {\n   582â†’          patientName: getPatientName(selectedPatient),\n   583â†’          clinicName: selectedPatient.clinicName,\n   584â†’          eyesOpenFile: eyesOpenFile?.name,\n   585â†’          eyesClosedFile: eyesClosedFile?.name,\n   586â†’          processedAt: new Date().toISOString(),\n   587â†’          processedBy: 'super_admin'\n   588â†’        },\n   589â†’        outputData: resultData,\n   590â†’        pdfUrl: pdfUrl || null,\n   591â†’        status: 'completed',\n   592â†’        errorMessage: null\n   593â†’      };\n   594â†’\n   595â†’      console.log('ðŸ’¾ Saving to database...');\n   596â†’      console.log('   Patient:', algorithmResult.inputData.patientName);\n   597â†’      console.log('   PDF URL:', pdfUrl || 'NOT SET');\n   598â†’      console.log('   PDF Type:', pdfUrl ? (pdfUrl.startsWith('http') ? 'Supabase' : 'Local') : 'None');\n   599â†’\n   600â†’      await DatabaseService.add('algorithmResults', algorithmResult);\n   601â†’\n   602â†’      setIsSaved(true);\n   603â†’      setIsSaving(false);\n   604â†’\n   605â†’      toast.success('âœ… Results saved successfully!', { id: 'save-results' });\n   606â†’\n   607â†’      // Reload history and patient list to update status\n   608â†’      loadProcessingHistory(selectedPatient.id);\n   609â†’      loadPatients();\n   610â†’    } catch (error) {\n   611â†’      console.error('âŒ Error saving results:', error);\n   612â†’      setIsSaving(false);\n   613â†’      toast.error('âŒ Failed to save results: ' + error.message, { id: 'save-results' });\n   614â†’    }\n   615â†’  };\n   616â†’\n   617â†’  const handleSaveResults = async () => {\n   618â†’    if (results) {\n   619â†’      await saveResultsToDatabase(results);\n   620â†’      // After saving, automatically download PDF if available\n   621â†’      if (pdfUrl) {\n   622â†’        setTimeout(() => {\n   623â†’          handleDownloadPDF();\n   624â†’        }, 500); // Small delay to let save complete\n   625â†’      }\n   626â†’    }\n   627â†’  };\n   628â†’\n   629â†’  const handleExecuteCalculation = () => {\n   630â†’    if (eyesOpenFile && eyesClosedFile) {\n   631â†’      processQEEGFiles();\n   632â†’    } else {\n   633â†’      toast.error('Please upload both QEEG data files');\n   634â†’    }\n   635â†’  };\n   636â†’\n   637â†’  const handleExportResults = () => {\n   638â†’    if (results) {\n   639â†’      // Create CSV content\n   640â†’      const csvContent = [\n   641â†’        ['Parameter', 'Score (%)', 'Status'],\n   642â†’        ...results.map(r => [r.parameter, r.score, r.status])\n   643â†’      ].map(row => row.join(',')).join('\\n');\n   644â†’\n   645â†’      // Create and download file\n   646â†’      const blob = new Blob([csvContent], { type: 'text/csv' });\n   647â†’      const url = window.URL.createObjectURL(blob);\n   648â†’      const a = document.createElement('a');\n   649â†’      a.href = url;\n   650â†’      a.download = 'neurosense-algorithm-results.csv';\n   651â†’      a.click();\n   652â†’      window.URL.revokeObjectURL(url);\n   653â†’    }\n   654â†’  };\n   655â†’\n   656â†’  const generatePDFReport = async (resultData) => {\n   657â†’    if (!resultData || !selectedPatient) {\n   658â†’      console.error('âŒ Cannot generate PDF: Missing resultData or selectedPatient');\n   659â†’      toast.error('Cannot generate PDF: Missing data');\n   660â†’      return null;\n   661â†’    }\n   662â†’\n   663â†’    try {\n   664â†’      console.log('ðŸ”§ Preparing patient data...');\n   665â†’\n   666â†’      // Prepare patient data - FIXED: Use current date for recording, not DOB\n   667â†’      const patientData = {\n   668â†’        name: getPatientName(selectedPatient),\n   669â†’        dateOfRecording: new Date().toISOString().split('T')[0], // TODAY'S DATE, not DOB!\n   670â†’        dateOfBirth: selectedPatient.dateOfBirth || selectedPatient.date_of_birth || 'Not specified',\n   671â†’        age: selectedPatient.age || calculateAge(selectedPatient.dateOfBirth || selectedPatient.date_of_birth) || 'N/A',\n   672â†’        gender: selectedPatient.gender || 'Not specified',\n   673â†’        handedness: selectedPatient.handedness || 'Right', // Default to Right if not specified\n   674â†’        patientId: selectedPatient.id,\n   675â†’        occupation: selectedPatient.occupation || 'Not specified',\n   676â†’        symptoms: selectedPatient.symptoms || []\n   677â†’      };\n   678â†’\n   679â†’      console.log('ðŸ‘¤ Patient Data (Fixed):', patientData);\n   680â†’      console.log('   Name:', patientData.name);\n   681â†’      console.log('   Recording Date:', patientData.dateOfRecording);\n   682â†’      console.log('   DOB:', patientData.dateOfBirth);\n   683â†’      console.log('   Age:', patientData.age);\n   684â†’      console.log('   Gender:', patientData.gender);\n   685â†’      console.log('   Handedness:', patientData.handedness);\n   686â†’\n   687â†’      // Prepare algorithm results\n   688â†’      const algorithmResults = {\n   689â†’        parameters: resultData.map(result => ({\n   690â†’          name: result.parameter,\n   691â†’          score: parseInt(result.rawScore.split('/')[0]),\n   692â†’          maxScore: parseInt(result.rawScore.split('/')[1]),\n   693â†’          classification: result.status,\n   694â†’          metrics: result.metrics || []\n   695â†’        })),\n   696â†’        overallScore: resultData.reduce((sum, r) => sum + parseInt(r.rawScore.split('/')[0]), 0)\n   697â†’      };\n   698â†’\n   699â†’      console.log('ðŸ“Š Algorithm Results:', algorithmResults);\n   700â†’\n   701â†’      // Prepare QEEG data (use sample data if not available)\n   702â†’      const qeegData = {\n   703â†’        EC: {\n   704â†’          absolute: { Fz: { Delta: 5.2, Theta: 4.1, Alpha: 8.3, Beta: 6.2, HiBeta: 3.1 } },\n   705â†’          relative: { Pz: { Alpha: 45.2 } },\n   706â†’          special: { alphaPeak: 10.3, O1: 10.1 }\n   707â†’        },\n   708â†’        EO: {\n   709â†’          absolute: { Fz: { Theta: 3.8, Beta: 3.2, HiBeta: 2.5 } },\n   710â†’          relative: { Pz: { Alpha: 28.7 } }\n   711â†’        }\n   712â†’      };\n   713â†’\n   714â†’      // Call backend API to generate PDF\n   715â†’      const apiUrl = import.meta.env.VITE_API_URL || 'http://localhost:3001/api';\n   716â†’      const pdfEndpoint = `${apiUrl}/qeeg/generate-pdf`;\n   717â†’\n   718â†’      console.log('ðŸŒ Calling backend API:', pdfEndpoint);\n   719â†’      console.log('ðŸ“¡ Request payload size:', JSON.stringify({ patientData, algorithmResults, qeegData }).length, 'bytes');\n   720â†’\n   721â†’      // Add timeout handling\n   722â†’      const controller = new AbortController();\n   723â†’      const timeoutId = setTimeout(() => controller.abort(), 30000); // 30 second timeout\n   724â†’\n   725â†’      const response = await fetch(pdfEndpoint, {\n   726â†’        method: 'POST',\n   727â†’        headers: {\n   728â†’          'Content-Type': 'application/json',\n   729â†’        },\n   730â†’        body: JSON.stringify({\n   731â†’          patientData,\n   732â†’          algorithmResults,\n   733â†’          qeegData\n   734â†’        }),\n   735â†’        signal: controller.signal\n   736â†’      }).catch(error => {\n   737â†’        clearTimeout(timeoutId);\n   738â†’        if (error.name === 'AbortError') {\n   739â†’          throw new Error('PDF generation timed out after 30 seconds. Server might be slow or not responding.');\n   740â†’        }\n   741â†’        throw error;\n   742â†’      });\n   743â†’\n   744â†’      clearTimeout(timeoutId);\n   745â†’\n   746â†’      console.log('ðŸ“¡ Backend response status:', response.status);\n   747â†’      console.log('ðŸ“¡ Backend response headers:', Object.fromEntries(response.headers.entries()));\n   748â†’\n   749â†’      if (!response.ok) {\n   750â†’        let errorMessage = `Server returned ${response.status}`;\n   751â†’        try {\n   752â†’          const errorData = await response.json();\n   753â†’          errorMessage = errorData.message || errorMessage;\n   754â†’          console.error('âŒ Backend error data:', errorData);\n   755â†’        } catch (e) {\n   756â†’          const errorText = await response.text();\n   757â†’          errorMessage = errorText || errorMessage;\n   758â†’          console.error('âŒ Backend error text:', errorText);\n   759â†’        }\n   760â†’        throw new Error(`Failed to generate PDF: ${errorMessage}`);\n   761â†’      }\n   762â†’\n   763â†’      const data = await response.json();\n   764â†’      console.log('ðŸ“¦ Backend response data:', data);\n   765â†’\n   766â†’      if (!data || !data.success || !data.data) {\n   767â†’        console.error('âŒ Invalid response format:', data);\n   768â†’        throw new Error('Invalid response from server');\n   769â†’      }\n   770â†’\n   771â†’      // Use the complete URL from backend instead of constructing it\n   772â†’      const pdfResult = {\n   773â†’        url: data.data.url, // Backend already provides complete URL\n   774â†’        path: data.data.path,\n   775â†’        filename: data.data.filename\n   776â†’      };\n   777â†’\n   778â†’      console.log('âœ… PDF generated successfully!', pdfResult);\n   779â†’      console.log('âœ… PDF URL:', pdfResult.url);\n   780â†’\n   781â†’      return pdfResult;\n   782â†’\n   783â†’    } catch (error) {\n   784â†’      console.error('âŒ Error generating PDF:', error);\n   785â†’      console.error('âŒ Error name:', error.name);\n   786â†’      console.error('âŒ Error message:', error.message);\n   787â†’\n   788â†’      if (error.message && error.stack) {\n   789â†’        console.error('âŒ Error stack:', error.stack);\n   790â†’      }\n   791â†’\n   792â†’      // Provide specific error messages based on error type\n   793â†’      if (error.name === 'TypeError' && error.message.includes('Failed to fetch')) {\n   794â†’        console.error('âŒ NETWORK ERROR: Cannot connect to backend server');\n   795â†’        console.error('âŒ Please ensure backend server is running on http://localhost:3001');\n   796â†’        toast.error('Cannot connect to server. Please ensure backend is running on port 3001.');\n   797â†’      } else if (error.name === 'AbortError') {\n   798â†’        console.error('âŒ TIMEOUT ERROR: PDF generation took too long');\n   799â†’        toast.error('PDF generation timed out. Server might be overloaded.');\n   800â†’      } else {\n   801â†’        console.error('âŒ PDF GENERATION ERROR:', error.message);\n   802â†’        toast.error(`PDF generation failed: ${error.message}`);\n   803â†’      }\n   804â†’\n   805â†’      return null;\n   806â†’    }\n   807â†’  };\n   808â†’\n   809â†’  const handleDownloadPDF = async () => {\n   810â†’    if (!pdfUrl) {\n   811â†’      toast.error('PDF not available. Please save results first.');\n   812â†’      return;\n   813â†’    }\n   814â†’\n   815â†’    try {\n   816â†’      toast.loading('Downloading PDF...', { id: 'download-pdf' });\n   817â†’\n   818â†’      // Construct full backend URL\n   819â†’      const apiUrl = import.meta.env.VITE_API_URL || 'http://localhost:3001/api';\n   820â†’      const backendBaseUrl = apiUrl.replace('/api', ''); // Remove /api to get base URL\n   821â†’\n   822â†’      // Handle both Supabase URLs and local URLs\n   823â†’      let fullPdfUrl;\n   824â†’      if (pdfUrl.startsWith('http')) {\n   825â†’        // It's already a full URL (Supabase)\n   826â†’        fullPdfUrl = pdfUrl;\n   827â†’      } else {\n   828â†’        // It's a local path, construct full URL\n   829â†’        fullPdfUrl = `${backendBaseUrl}${pdfUrl}`;\n   830â†’      }\n   831â†’\n   832â†’      console.log('ðŸ”½ Download Info:', {\n   833â†’        originalPdfUrl: pdfUrl,\n   834â†’        backendBaseUrl,\n   835â†’        fullPdfUrl,\n   836â†’        isSupabase: pdfUrl.startsWith('http')\n   837â†’      });\n   838â†’\n   839â†’      // For local files, try direct window.open first (simpler approach)\n   840â†’      if (!pdfUrl.startsWith('http')) {\n   841â†’        console.log('ðŸ“¥ Using direct download method for local file');\n   842â†’\n   843â†’        // Create a hidden link and click it\n   844â†’        const link = document.createElement('a');\n   845â†’        link.href = fullPdfUrl;\n   846â†’        link.download = pdfUrl.split('/').pop() || 'neurosense-report.pdf';\n   847â†’        link.target = '_blank';\n   848â†’\n   849â†’        document.body.appendChild(link);\n   850â†’        link.click();\n   851â†’        document.body.removeChild(link);\n   852â†’\n   853â†’        toast.success('PDF download started!', { id: 'download-pdf' });\n   854â†’        return;\n   855â†’      }\n   856â†’\n   857â†’      // For Supabase URLs, use fetch method\n   858â†’      console.log('ðŸ“¥ Using fetch method for Supabase URL');\n   859â†’\n   860â†’      const response = await fetch(fullPdfUrl);\n   861â†’\n   862â†’      if (!response.ok) {\n   863â†’        console.error('âŒ Download failed:', {\n   864â†’          status: response.status,\n   865â†’          statusText: response.statusText\n   866â†’        });\n   867â†’        throw new Error(`Server returned ${response.status}: ${response.statusText}`);\n   868â†’      }\n   869â†’\n   870â†’      // Convert to blob\n   871â†’      const blob = await response.blob();\n   872â†’\n   873â†’      // Verify blob is valid\n   874â†’      if (!blob || blob.size === 0) {\n   875â†’        throw new Error('Downloaded file is empty');\n   876â†’      }\n   877â†’\n   878â†’      console.log('âœ… PDF fetched successfully, size:', (blob.size / 1024).toFixed(2), 'KB');\n   879â†’\n   880â†’      // Create download link\n   881â†’      const downloadUrl = window.URL.createObjectURL(blob);\n   882â†’      const link = document.createElement('a');\n   883â†’      link.href = downloadUrl;\n   884â†’      link.download = pdfUrl.split('/').pop() || 'neurosense-report.pdf';\n   885â†’\n   886â†’      // Trigger download\n   887â†’      document.body.appendChild(link);\n   888â†’      link.click();\n   889â†’\n   890â†’      // Cleanup\n   891â†’      setTimeout(() => {\n   892â†’        document.body.removeChild(link);\n   893â†’        window.URL.revokeObjectURL(downloadUrl);\n   894â†’      }, 100);\n   895â†’\n   896â†’      toast.success('PDF downloaded successfully!', { id: 'download-pdf' });\n   897â†’\n   898â†’    } catch (error) {\n   899â†’      console.error('âŒ Download error:', {\n   900â†’        error: error.message,\n   901â†’        pdfUrl,\n   902â†’        stack: error.stack\n   903â†’      });\n   904â†’\n   905â†’      // Provide more helpful error messages\n   906â†’      let errorMessage = 'Failed to download PDF';\n   907â†’      if (error.message.includes('404')) {\n   908â†’        errorMessage = 'PDF file not found on server';\n   909â†’      } else if (error.message.includes('Failed to fetch')) {\n   910â†’        errorMessage = 'Network error. Please check your connection.';\n   911â†’      } else {\n   912â†’        errorMessage = `Download failed: ${error.message}`;\n   913â†’      }\n   914â†’\n   915â†’      toast.error(errorMessage, { id: 'download-pdf' });\n   916â†’    }\n   917â†’  };\n   918â†’\n   919â†’  const calculateAge = (dateOfBirth) => {\n   920â†’    if (!dateOfBirth) return 'N/A';\n   921â†’    const today = new Date();\n   922â†’    const birthDate = new Date(dateOfBirth);\n   923â†’    let age = today.getFullYear() - birthDate.getFullYear();\n   924â†’    const monthDiff = today.getMonth() - birthDate.getMonth();\n   925â†’    if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {\n   926â†’      age--;\n   927â†’    }\n   928â†’    return age;\n   929â†’  };\n   930â†’\n   931â†’  // Helper function to get color based on score\n   932â†’  // 1/3 = Red, 2/3 = Yellow, 3/3 = Green\n   933â†’  const getScoreColor = (rawScore) => {\n   934â†’    if (!rawScore) return 'gray';\n   935â†’\n   936â†’    const [score, maxScore] = rawScore.split('/').map(Number);\n   937â†’\n   938â†’    if (score === 1) return 'red';      // 1/3\n   939â†’    if (score === 2) return 'yellow';   // 2/3\n   940â†’    if (score === 3) return 'green';    // 3/3\n   941â†’\n   942â†’    return 'gray';\n   943â†’  };\n   944â†’\n   945â†’  const getStatusColor = (rawScore) => {\n   946â†’    const color = getScoreColor(rawScore);\n   947â†’    switch (color) {\n   948â†’      case 'red': return 'text-red-500';\n   949â†’      case 'yellow': return 'text-yellow-500';\n   950â†’      case 'green': return 'text-green-500';\n   951â†’      default: return 'text-gray-500';\n   952â†’    }\n   953â†’  };\n   954â†’\n   955â†’  const getStatusBgColor = (rawScore) => {\n   956â†’    const color = getScoreColor(rawScore);\n   957â†’    if (color === 'green') return 'bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-400';\n   958â†’    if (color === 'yellow') return 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900/30 dark:text-yellow-400';\n   959â†’    if (color === 'red') return 'bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-400';\n   960â†’    return 'bg-gray-100 text-gray-800 dark:bg-gray-900/30 dark:text-gray-400';\n   961â†’  };\n   962â†’\n   963â†’  const getProgressBarColor = (rawScore) => {\n   964â†’    const color = getScoreColor(rawScore);\n   965â†’    switch (color) {\n   966â†’      case 'red': return 'bg-red-500';\n   967â†’      case 'yellow': return 'bg-yellow-500';\n   968â†’      case 'green': return 'bg-green-500';\n   969â†’      default: return 'bg-gray-500';\n   970â†’    }\n   971â†’  };\n   972â†’\n   973â†’  if (loading) {\n   974â†’    return (\n   975â†’      <div className=\"flex items-center justify-center h-64\">\n   976â†’        <div className=\"text-center\">\n   977â†’          <div className=\"animate-spin rounded-full h-12 w-12 border-b-2 border-primary mx-auto\"></div>\n   978â†’          <p className=\"mt-4 text-gray-600 dark:text-gray-400\">Loading patients...</p>\n   979â†’        </div>\n   980â†’      </div>\n   981â†’    );\n   982â†’  }\n   983â†’\n   984â†’  // Patient List View\n   985â†’  if (!showProcessingUI) {\n   986â†’    return (\n   987â†’      <div className=\"space-y-6\">\n   988â†’        {/* Header */}\n   989â†’        <div className=\"bg-gradient-to-r from-primary to-navy-700 rounded-lg p-6 text-white shadow-lg\">\n   990â†’          <h1 className=\"text-2xl font-bold\">NeuroSense - Algorithm 1 Data Processor</h1>\n   991â†’          <p className=\"text-primary-light mt-2\">Select a patient to generate Algorithm 1 report</p>\n   992â†’        </div>\n   993â†’\n   994â†’        {/* Filter Bar */}\n   995â†’        <div className=\"bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 p-4\">\n   996â†’          <div className=\"flex flex-col lg:flex-row gap-4\">\n   997â†’            {/* Patient Search */}\n   998â†’            <div className=\"flex-1\">\n   999â†’              <label className=\"block text-xs font-medium text-gray-700 dark:text-gray-300 mb-1\">\n  1000â†’                Search Patient\n  1001â†’              </label>\n  1002â†’              <div className=\"relative\">\n  1003â†’                <Search className=\"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-gray-400 dark:text-gray-500\" />\n  1004â†’                <input\n  1005â†’                  type=\"text\"\n  1006â†’                  placeholder=\"Search by name or email...\"\n  1007â†’                  value={searchTerm}\n  1008â†’                  onChange={(e) => setSearchTerm(e.target.value)}\n  1009â†’                  className=\"w-full pl-10 pr-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-sm focus:outline-none focus:ring-2 focus:ring-primary\"\n  1010â†’                />\n  1011â†’              </div>\n  1012â†’            </div>\n  1013â†’\n  1014â†’            {/* Clinic Filter */}\n  1015â†’            <div className=\"flex-1\">\n  1016â†’              <label className=\"block text-xs font-medium text-gray-700 dark:text-gray-300 mb-1\">\n  1017â†’                Filter by Clinic\n  1018â†’              </label>\n  1019â†’              <div className=\"relative\">\n  1020â†’                <Building2 className=\"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-gray-400 dark:text-gray-500\" />\n  1021â†’                <select\n  1022â†’                  value={selectedClinicFilter}\n  1023â†’                  onChange={(e) => setSelectedClinicFilter(e.target.value)}\n  1024â†’                  className=\"w-full pl-10 pr-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-sm focus:outline-none focus:ring-2 focus:ring-primary appearance-none\"\n  1025â†’                >\n  1026â†’                  <option value=\"\">All Clinics</option>\n  1027â†’                  {clinics.map(clinic => (\n  1028â†’                    <option key={clinic.id} value={clinic.id}>\n  1029â†’                      {clinic.name}\n  1030â†’                    </option>\n  1031â†’                  ))}\n  1032â†’                </select>\n  1033â†’              </div>\n  1034â†’            </div>\n  1035â†’\n  1036â†’            {/* Date Filter */}\n  1037â†’            <div className=\"flex-1\">\n  1038â†’              <label className=\"block text-xs font-medium text-gray-700 dark:text-gray-300 mb-1\">\n  1039â†’                Filter by Date\n  1040â†’              </label>\n  1041â†’              <div className=\"relative\">\n  1042â†’                <Calendar className=\"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-gray-400 dark:text-gray-500\" />\n  1043â†’                <input\n  1044â†’                  type=\"date\"\n  1045â†’                  value={dateFilter}\n  1046â†’                  onChange={(e) => setDateFilter(e.target.value)}\n  1047â†’                  className=\"w-full pl-10 pr-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-sm focus:outline-none focus:ring-2 focus:ring-primary\"\n  1048â†’                />\n  1049â†’              </div>\n  1050â†’            </div>\n  1051â†’\n  1052â†’            {/* Clear Filters Button */}\n  1053â†’            {(searchTerm || selectedClinicFilter || dateFilter) && (\n  1054â†’              <div className=\"flex items-end\">\n  1055â†’                <button\n  1056â†’                  onClick={clearFilters}\n  1057â†’                  className=\"px-4 py-2 bg-gray-100 hover:bg-gray-200 dark:bg-gray-700 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-300 rounded-lg text-sm font-medium transition-colors flex items-center space-x-2\"\n  1058â†’                >\n  1059â†’                  <X className=\"h-4 w-4\" />\n  1060â†’                  <span>Clear</span>\n  1061â†’                </button>\n  1062â†’              </div>\n  1063â†’            )}\n  1064â†’          </div>\n  1065â†’\n  1066â†’          {/* Active Filters Display */}\n  1067â†’          {(searchTerm || selectedClinicFilter || dateFilter) && (\n  1068â†’            <div className=\"mt-3 flex flex-wrap gap-2\">\n  1069â†’              {searchTerm && (\n  1070â†’                <span className=\"inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-400\">\n  1071â†’                  Search: \"{searchTerm}\"\n  1072â†’                </span>\n  1073â†’              )}\n  1074â†’              {selectedClinicFilter && (\n  1075â†’                <span className=\"inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-purple-100 text-purple-800 dark:bg-purple-900/30 dark:text-purple-400\">\n  1076â†’                  Clinic: {clinics.find(c => c.id === selectedClinicFilter)?.name}\n  1077â†’                </span>\n  1078â†’              )}\n  1079â†’              {dateFilter && (\n  1080â†’                <span className=\"inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-400\">\n  1081â†’                  Date: {new Date(dateFilter).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}\n  1082â†’                </span>\n  1083â†’              )}\n  1084â†’              <span className=\"text-xs text-gray-500 dark:text-gray-400 self-center\">\n  1085â†’                ({filteredPatients.length} {filteredPatients.length === 1 ? 'patient' : 'patients'} found)\n  1086â†’              </span>\n  1087â†’            </div>\n  1088â†’          )}\n  1089â†’        </div>\n  1090â†’\n  1091â†’        {/* Patient List - Clinic-wise */}\n  1092â†’        <div className=\"space-y-4\">\n  1093â†’          {groupedPatients.length > 0 ? (\n  1094â†’            groupedPatients.map(({ clinic, patients: clinicPatients }) => (\n  1095â†’            <div key={clinic.id} className=\"bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700\">\n  1096â†’              {/* Clinic Header */}\n  1097â†’              <div className=\"bg-accent-light dark:bg-primary/20 border-b border-primary-light dark:border-primary px-6 py-3\">\n  1098â†’                <div className=\"flex items-center\">\n  1099â†’                  <Building2 className=\"h-5 w-5 text-primary mr-2\" />\n  1100â†’                  <h3 className=\"text-lg font-semibold text-gray-900 dark:text-white\">\n  1101â†’                    {clinic.name}\n  1102â†’                  </h3>\n  1103â†’                  <span className=\"ml-3 text-sm text-gray-600 dark:text-gray-400\">\n  1104â†’                    ({clinicPatients.length} {clinicPatients.length === 1 ? 'patient' : 'patients'})\n  1105â†’                  </span>\n  1106â†’                </div>\n  1107â†’              </div>\n  1108â†’\n  1109â†’              {/* Patient Table */}\n  1110â†’              <div className=\"overflow-x-auto\">\n  1111â†’                <table className=\"w-full\">\n  1112â†’                  <thead className=\"bg-gray-50 dark:bg-gray-700\">\n  1113â†’                    <tr>\n  1114â†’                      <th className=\"px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider\">\n  1115â†’                        Patient Name\n  1116â†’                      </th>\n  1117â†’                      <th className=\"px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider\">\n  1118â†’                        Email\n  1119â†’                      </th>\n  1120â†’                      <th className=\"px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider\">\n  1121â†’                        Previous Scans\n  1122â†’                      </th>\n  1123â†’                      <th className=\"px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider\">\n  1124â†’                        Status\n  1125â†’                      </th>\n  1126â†’                      <th className=\"px-6 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider\">\n  1127â†’                        Action\n  1128â†’                      </th>\n  1129â†’                    </tr>\n  1130â†’                  </thead>\n  1131â†’                  <tbody className=\"divide-y divide-gray-200 dark:divide-gray-700\">\n  1132â†’                    {clinicPatients.map(patient => (\n  1133â†’                      <tr key={patient.id} className=\"hover:bg-gray-50 dark:hover:bg-gray-700/50\">\n  1134â†’                        <td className=\"px-6 py-4 whitespace-nowrap\">\n  1135â†’                          <div className=\"flex items-center\">\n  1136â†’                            <User className=\"h-4 w-4 text-gray-400 dark:text-gray-500 mr-2\" />\n  1137â†’                            <span className=\"text-sm font-medium text-gray-900 dark:text-white\">\n  1138â†’                              {getPatientName(patient)}\n  1139â†’                            </span>\n  1140â†’                          </div>\n  1141â†’                        </td>\n  1142â†’                        <td className=\"px-6 py-4 whitespace-nowrap text-sm text-gray-600 dark:text-gray-400\">\n  1143â†’                          {patient.email || 'N/A'}\n  1144â†’                        </td>\n  1145â†’                        <td className=\"px-6 py-4 whitespace-nowrap text-sm text-gray-600 dark:text-gray-400\">\n  1146â†’                          <span className=\"flex items-center\">\n  1147â†’                            <History className=\"h-4 w-4 mr-1\" />\n  1148â†’                            {patient.totalScans || 0} {patient.totalScans === 1 ? 'scan' : 'scans'}\n  1149â†’                          </span>\n  1150â†’                        </td>\n  1151â†’                        <td className=\"px-6 py-4 whitespace-nowrap\">\n  1152â†’                          {getStatusBadge(patient.algorithmStatus, patient.lastProcessed)}\n  1153â†’                        </td>\n  1154â†’                        <td className=\"px-6 py-4 whitespace-nowrap text-right\">\n  1155â†’                          <button\n  1156â†’                            onClick={() => handleGenerateReport(patient)}\n  1157â†’                            className=\"bg-primary hover:bg-navy-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors shadow-md flex items-center ml-auto\"\n  1158â†’                          >\n  1159â†’                            <FileText className=\"h-4 w-4 mr-2\" />\n  1160â†’                            {patient.algorithmStatus === 'completed' ? 'View/Generate' : 'Generate Report'}\n  1161â†’                          </button>\n  1162â†’                        </td>\n  1163â†’                      </tr>\n  1164â†’                    ))}\n  1165â†’                  </tbody>\n  1166â†’                </table>\n  1167â†’              </div>\n  1168â†’            </div>\n  1169â†’            ))\n  1170â†’          ) : (\n  1171â†’            <div className=\"bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 p-12 text-center\">\n  1172â†’              <Filter className=\"h-16 w-16 text-gray-400 dark:text-gray-500 mx-auto mb-4\" />\n  1173â†’              <p className=\"text-gray-600 dark:text-gray-400 font-medium\">\n  1174â†’                {searchTerm || selectedClinicFilter || dateFilter\n  1175â†’                  ? 'No patients match your filters'\n  1176â†’                  : 'No patients found'\n  1177â†’                }\n  1178â†’              </p>\n  1179â†’              <p className=\"text-sm text-gray-500 dark:text-gray-500 mt-2\">\n  1180â†’                {searchTerm || selectedClinicFilter || dateFilter\n  1181â†’                  ? 'Try adjusting your search criteria or clear filters'\n  1182â†’                  : 'Patients will appear here once they are registered in the system'\n  1183â†’                }\n  1184â†’              </p>\n  1185â†’              {(searchTerm || selectedClinicFilter || dateFilter) && (\n  1186â†’                <button\n  1187â†’                  onClick={clearFilters}\n  1188â†’                  className=\"mt-4 px-4 py-2 bg-primary hover:bg-navy-700 text-white rounded-lg text-sm font-medium transition-colors\"\n  1189â†’                >\n  1190â†’                  Clear Filters\n  1191â†’                </button>\n  1192â†’              )}\n  1193â†’            </div>\n  1194â†’          )}\n  1195â†’        </div>\n  1196â†’      </div>\n  1197â†’    );\n  1198â†’  }\n  1199â†’\n  1200â†’  // Processing UI View\n  1201â†’  return (\n  1202â†’    <div className=\"space-y-6\">\n  1203â†’      {/* Header with Back Button */}\n  1204â†’      <div className=\"bg-gradient-to-r from-primary to-navy-700 rounded-lg p-6 text-white shadow-lg\">\n  1205â†’        <button\n  1206â†’          onClick={handleBackToList}\n  1207â†’          className=\"flex items-center text-primary-light hover:text-white mb-3 transition-colors\"\n  1208â†’        >\n  1209â†’          <ArrowLeft className=\"h-5 w-5 mr-2\" />\n  1210â†’          Back to Patient List\n  1211â†’        </button>\n  1212â†’        <h1 className=\"text-2xl font-bold\">NeuroSense - Algorithm 1 Data Processor</h1>\n  1213â†’        <div className=\"flex items-center gap-3 mt-2\">\n  1214â†’          <p className=\"text-primary-light\">\n  1215â†’            Processing for: <span className=\"font-semibold\">{getPatientName(selectedPatient)}</span> | {selectedPatient?.clinicName}\n  1216â†’          </p>\n  1217â†’          {dataType === 'zscore' && (\n  1218â†’            <span className=\"inline-flex items-center px-3 py-1 bg-purple-500/20 text-purple-200 text-xs font-medium rounded-full border border-purple-400/30\">\n  1219â†’              ðŸ”¬ Z-Score Mode\n  1220â†’            </span>\n  1221â†’          )}\n  1222â†’        </div>\n  1223â†’      </div>\n  1224â†’\n  1225â†’      {/* Main Content Grid */}\n  1226â†’      <div className=\"grid grid-cols-1 lg:grid-cols-3 gap-6\">\n  1227â†’        {/* Left Panel - QEEG Data Input */}\n  1228â†’        <div className=\"bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 p-6\">\n  1229â†’          <h2 className=\"text-lg font-semibold text-gray-900 dark:text-white mb-4\">\n  1230â†’            QEEG Data Input (Pages 13 & 24)\n  1231â†’          </h2>\n  1232â†’\n  1233â†’          {/* Eyes Open Upload */}\n  1234â†’          <div className=\"mb-6\">\n  1235â†’            <label className=\"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2\">\n  1236â†’              Page 13 (EO - Eyes Open)\n  1237â†’            </label>\n  1238â†’            <div className=\"relative border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-lg p-6 text-center hover:border-primary dark:hover:border-primary-light transition-colors\">\n  1239â†’              <input\n  1240â†’                type=\"file\"\n  1241â†’                accept=\".csv,.txt,.dat,.pdf\"\n  1242â†’                onChange={(e) => handleFileUpload('eo', e)}\n  1243â†’                className=\"absolute inset-0 w-full h-full opacity-0 cursor-pointer\"\n  1244â†’              />\n  1245â†’              <Upload className=\"h-12 w-12 text-gray-400 dark:text-gray-500 mx-auto mb-2\" />\n  1246â†’              <p className=\"text-sm text-gray-600 dark:text-gray-400\">\n  1247â†’                {eyesOpenFile ? eyesOpenFile.name : 'Drag & Drop or Click to Upload'}\n  1248â†’              </p>\n  1249â†’              {eyesOpenFile && (\n  1250â†’                <CheckCircle className=\"h-6 w-6 text-green-500 mx-auto mt-2\" />\n  1251â†’              )}\n  1252â†’            </div>\n  1253â†’          </div>\n  1254â†’\n  1255â†’          {/* Eyes Closed Upload */}\n  1256â†’          <div className=\"mb-6\">\n  1257â†’            <label className=\"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2\">\n  1258â†’              Page 24 (EC - Eyes Closed)\n  1259â†’            </label>\n  1260â†’            <div className=\"relative border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-lg p-6 text-center hover:border-primary dark:hover:border-primary-light transition-colors\">\n  1261â†’              <input\n  1262â†’                type=\"file\"\n  1263â†’                accept=\".csv,.txt,.dat,.pdf\"\n  1264â†’                onChange={(e) => handleFileUpload('ec', e)}\n  1265â†’                className=\"absolute inset-0 w-full h-full opacity-0 cursor-pointer\"\n  1266â†’              />\n  1267â†’              <Upload className=\"h-12 w-12 text-gray-400 dark:text-gray-500 mx-auto mb-2\" />\n  1268â†’              <p className=\"text-sm text-gray-600 dark:text-gray-400\">\n  1269â†’                {eyesClosedFile ? eyesClosedFile.name : 'Drag & Drop or Click to Upload'}\n  1270â†’              </p>\n  1271â†’              {eyesClosedFile && (\n  1272â†’                <CheckCircle className=\"h-6 w-6 text-green-500 mx-auto mt-2\" />\n  1273â†’              )}\n  1274â†’            </div>\n  1275â†’          </div>\n  1276â†’\n  1277â†’          {/* Data Loaded Progress */}\n  1278â†’          <div>\n  1279â†’            <label className=\"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2\">\n  1280â†’              Data Loaded\n  1281â†’            </label>\n  1282â†’            <div className=\"w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2.5\">\n  1283â†’              <div\n  1284â†’                className=\"bg-green-500 h-2.5 rounded-full transition-all duration-300\"\n  1285â†’                style={{ width: `${eyesOpenFile && eyesClosedFile ? 100 : eyesOpenFile || eyesClosedFile ? 50 : 0}%` }}\n  1286â†’              ></div>\n  1287â†’            </div>\n  1288â†’          </div>\n  1289â†’        </div>\n  1290â†’\n  1291â†’        {/* Middle Panel - Algorithm Processing */}\n  1292â†’        <div className=\"bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 p-6\">\n  1293â†’          <h2 className=\"text-lg font-semibold text-gray-900 dark:text-white mb-4\">\n  1294â†’            Algorithm 1 Processing\n  1295â†’          </h2>\n  1296â†’\n  1297â†’          {/* Execute Button */}\n  1298â†’          <button\n  1299â†’            onClick={handleExecuteCalculation}\n  1300â†’            disabled={!eyesOpenFile || !eyesClosedFile || isProcessing || isSaved}\n  1301â†’            className={`w-full mb-6 py-3 px-4 rounded-lg font-medium flex items-center justify-center space-x-2 transition-colors shadow-md ${\n  1302â†’              eyesOpenFile && eyesClosedFile && !isProcessing && !isSaved\n  1303â†’                ? 'bg-primary hover:bg-navy-700 text-white'\n  1304â†’                : 'bg-gray-300 dark:bg-gray-600 text-gray-500 dark:text-gray-400 cursor-not-allowed'\n  1305â†’            }`}\n  1306â†’          >\n  1307â†’            <Play className=\"h-5 w-5\" />\n  1308â†’            <span>Execute Calculation</span>\n  1309â†’          </button>\n  1310â†’\n  1311â†’          {/* Processing Animation */}\n  1312â†’          {isProcessing && (\n  1313â†’            <div className=\"bg-gradient-to-r from-primary to-navy-700 rounded-lg p-6 text-center mb-6 shadow-lg\">\n  1314â†’              <div className=\"relative inline-block\">\n  1315â†’                <Activity className=\"h-16 w-16 text-white animate-pulse\" />\n  1316â†’                <div className=\"absolute inset-0 flex items-center justify-center\">\n  1317â†’                  <div className=\"w-20 h-20 border-4 border-white/30 border-t-white rounded-full animate-spin\"></div>\n  1318â†’                </div>\n  1319â†’              </div>\n  1320â†’              <p className=\"text-white font-medium mt-4\">Processing...</p>\n  1321â†’              <p className=\"text-primary-light text-sm\">{consoleLog.length} actions done</p>\n  1322â†’            </div>\n  1323â†’          )}\n  1324â†’\n  1325â†’          {/* Processing Complete */}\n  1326â†’          {processingComplete && (\n  1327â†’            <div className=\"bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 rounded-lg p-4 text-center mb-6\">\n  1328â†’              <CheckCircle className=\"h-12 w-12 text-green-500 mx-auto mb-2\" />\n  1329â†’              <p className=\"text-green-800 dark:text-green-400 font-medium\">Processing Complete!</p>\n  1330â†’            </div>\n  1331â†’          )}\n  1332â†’\n  1333â†’          {/* Console */}\n  1334â†’          <div className=\"bg-gray-900 dark:bg-black rounded-lg p-4 min-h-[200px] max-h-[300px] overflow-y-auto\">\n  1335â†’            <div className=\"flex items-center justify-between mb-2 pb-2 border-b border-gray-700\">\n  1336â†’              <h3 className=\"text-sm font-medium text-gray-300\">Console</h3>\n  1337â†’              <button\n  1338â†’                onClick={() => setConsoleLog([])}\n  1339â†’                className=\"text-xs text-gray-400 hover:text-gray-200\"\n  1340â†’              >\n  1341â†’                Clear\n  1342â†’              </button>\n  1343â†’            </div>\n  1344â†’            <div className=\"space-y-1 font-mono text-xs\">\n  1345â†’              {consoleLog.length > 0 ? (\n  1346â†’                consoleLog.map((log, index) => (\n  1347â†’                  <div key={index} className=\"text-green-400\">\n  1348â†’                    &gt; {log}\n  1349â†’                  </div>\n  1350â†’                ))\n  1351â†’              ) : (\n  1352â†’                <div className=\"text-gray-500 italic\">Console output will appear here...</div>\n  1353â†’              )}\n  1354â†’            </div>\n  1355â†’          </div>\n  1356â†’        </div>\n  1357â†’\n  1358â†’        {/* Right Panel - Final 7 Parameter Scores */}\n  1359â†’        <div className=\"bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 p-6\">\n  1360â†’          <h2 className=\"text-lg font-semibold text-gray-900 dark:text-white mb-4\">\n  1361â†’            Final 7 Parameter Scores\n  1362â†’          </h2>\n  1363â†’\n  1364â†’          {results ? (\n  1365â†’            <>\n  1366â†’              <div className=\"space-y-4 mb-6\">\n  1367â†’                {results.map((result, index) => (\n  1368â†’                  <div key={index} className=\"border border-gray-200 dark:border-gray-700 rounded-lg p-3\">\n  1369â†’                    {/* Main Parameter */}\n  1370â†’                    <div className=\"flex items-center justify-between mb-2\">\n  1371â†’                      <span className=\"text-sm font-semibold text-gray-800 dark:text-gray-200\">\n  1372â†’                        {result.parameter}\n  1373â†’                      </span>\n  1374â†’                      <div className=\"flex items-center space-x-3\">\n  1375â†’                        <span className={`text-base font-bold ${getStatusColor(result.rawScore)}`}>\n  1376â†’                          {result.rawScore}\n  1377â†’                        </span>\n  1378â†’                        <span className={`text-xs px-2.5 py-1 rounded-full font-medium ${getStatusBgColor(result.rawScore)}`}>\n  1379â†’                          {result.status}\n  1380â†’                        </span>\n  1381â†’                      </div>\n  1382â†’                    </div>\n  1383â†’\n  1384â†’                    {/* Progress Bar */}\n  1385â†’                    <div className=\"flex-1 bg-gray-200 dark:bg-gray-700 rounded-full h-2 mb-3\">\n  1386â†’                      <div\n  1387â†’                        className={`h-2 rounded-full ${getProgressBarColor(result.rawScore)}`}\n  1388â†’                        style={{ width: `${result.score}%` }}\n  1389â†’                      ></div>\n  1390â†’                    </div>\n  1391â†’\n  1392â†’                    {/* Sub-Parameters */}\n  1393â†’                    {result.metrics && result.metrics.length > 0 && (\n  1394â†’                      <div className=\"mt-3 pt-3 border-t border-gray-200 dark:border-gray-700\">\n  1395â†’                        <div className=\"text-xs font-medium text-gray-600 dark:text-gray-400 mb-2\">\n  1396â†’                          Sub-Parameters:\n  1397â†’                        </div>\n  1398â†’                        <div className=\"space-y-2\">\n  1399â†’                          {result.metrics.map((metric, mIndex) => (\n  1400â†’                            <div key={mIndex} className=\"flex items-center justify-between text-xs pl-2\">\n  1401â†’                              <span className=\"text-gray-600 dark:text-gray-400 flex-1\">\n  1402â†’                                {metric.name}\n  1403â†’                              </span>\n  1404â†’                              <div className=\"flex items-center space-x-2\">\n  1405â†’                                {metric.score === 1 ? (\n  1406â†’                                  <CheckCircle className=\"h-3.5 w-3.5 text-green-500\" />\n  1407â†’                                ) : (\n  1408â†’                                  <X className=\"h-3.5 w-3.5 text-red-500\" />\n  1409â†’                                )}\n  1410â†’                                <span className={`font-medium ${metric.score === 1 ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400'}`}>\n  1411â†’                                  {metric.score}/1\n  1412â†’                                </span>\n  1413â†’                              </div>\n  1414â†’                            </div>\n  1415â†’                          ))}\n  1416â†’                        </div>\n  1417â†’                      </div>\n  1418â†’                    )}\n  1419â†’                  </div>\n  1420â†’                ))}\n  1421â†’              </div>\n  1422â†’\n  1423â†’              {/* Action Buttons */}\n  1424â†’              <div className=\"space-y-3\">\n  1425â†’                {/* Save and Download PDF Button */}\n  1426â†’                <button\n  1427â†’                  onClick={handleSaveResults}\n  1428â†’                  disabled={isSaving || isSaved}\n  1429â†’                  className={`w-full py-3 px-4 rounded-lg font-medium flex items-center justify-center space-x-2 transition-colors shadow-md ${\n  1430â†’                    isSaved\n  1431â†’                      ? 'bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-400 cursor-not-allowed'\n  1432â†’                      : isSaving\n  1433â†’                      ? 'bg-blue-400 text-white cursor-wait'\n  1434â†’                      : 'bg-primary hover:bg-navy-700 text-white'\n  1435â†’                  }`}\n  1436â†’                >\n  1437â†’                  {isSaving ? (\n  1438â†’                    <>\n  1439â†’                      <Activity className=\"h-5 w-5 animate-spin\" />\n  1440â†’                      <span>Saving...</span>\n  1441â†’                    </>\n  1442â†’                  ) : isSaved ? (\n  1443â†’                    <>\n  1444â†’                      <CheckCircle className=\"h-5 w-5\" />\n  1445â†’                      <span>Saved âœ“</span>\n  1446â†’                    </>\n  1447â†’                  ) : (\n  1448â†’                    <>\n  1449â†’                      <Download className=\"h-5 w-5\" />\n  1450â†’                      <span>NeuroSense Report Download</span>\n  1451â†’                    </>\n  1452â†’                  )}\n  1453â†’                </button>\n  1454â†’\n  1455â†’                {/* Export CSV Button */}\n  1456â†’                <button\n  1457â†’                  onClick={handleExportResults}\n  1458â†’                  className=\"w-full bg-green-600 hover:bg-green-700 text-white py-3 px-4 rounded-lg font-medium flex items-center justify-center space-x-2 transition-colors shadow-md\"\n  1459â†’                >\n  1460â†’                  <Download className=\"h-5 w-5\" />\n  1461â†’                  <span>Export CSV</span>\n  1462â†’                </button>\n  1463â†’              </div>\n  1464â†’            </>\n  1465â†’          ) : (\n  1466â†’            <div className=\"flex flex-col items-center justify-center py-12 text-center\">\n  1467â†’              <FileText className=\"h-16 w-16 text-gray-400 dark:text-gray-500 mb-4\" />\n  1468â†’              <p className=\"text-sm text-gray-600 dark:text-gray-400\">\n  1469â†’                Upload data files and execute calculation to see results\n  1470â†’              </p>\n  1471â†’            </div>\n  1472â†’          )}\n  1473â†’        </div>\n  1474â†’      </div>\n  1475â†’\n  1476â†’      {/* Processing History */}\n  1477â†’      {selectedPatient && processingHistory.length > 0 && (\n  1478â†’        <div className=\"bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 p-6\">\n  1479â†’          <div className=\"flex items-center justify-between mb-4\">\n  1480â†’            <h2 className=\"text-lg font-semibold text-gray-900 dark:text-white flex items-center\">\n  1481â†’              <History className=\"h-5 w-5 mr-2\" />\n  1482â†’              Processing History for {getPatientName(selectedPatient)}\n  1483â†’            </h2>\n  1484â†’            <button\n  1485â†’              onClick={async () => {\n  1486â†’                console.log('ðŸ”„ Manual sync triggered...');\n  1487â†’                toast.loading('Syncing PDFs from Supabase...', { id: 'sync-pdfs' });\n  1488â†’\n  1489â†’                try {\n  1490â†’                  // Force reload from database and sync\n  1491â†’                  await loadProcessingHistory(selectedPatient.id);\n  1492â†’\n  1493â†’                  // Count how many PDFs were found\n  1494â†’                  const results = await DatabaseService.get('algorithmResults');\n  1495â†’                  const patientResults = results.filter(r => r.patientId === selectedPatient.id);\n  1496â†’                  const pdfCount = patientResults.filter(r => r.pdfUrl).length;\n  1497â†’                  const totalCount = patientResults.length;\n  1498â†’\n  1499â†’                  toast.success(`âœ… Synced! ${pdfCount}/${totalCount} PDFs available`, { id: 'sync-pdfs' });\n  1500â†’                  console.log(`âœ… Sync complete: ${pdfCount}/${totalCount} records have PDFs`);\n  1501â†’                } catch (error) {\n  1502â†’                  console.error('âŒ Sync failed:', error);\n  1503â†’                  toast.error('Failed to sync PDFs', { id: 'sync-pdfs' });\n  1504â†’                }\n  1505â†’              }}\n  1506â†’              className=\"px-3 py-1.5 text-xs bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors flex items-center space-x-1\"\n  1507â†’              title=\"Fetch PDFs from Supabase bucket and update database\"\n  1508â†’            >\n  1509â†’              <Download className=\"h-3 w-3\" />\n  1510â†’              <span>Sync PDFs</span>\n  1511â†’            </button>\n  1512â†’          </div>\n  1513â†’          <div className=\"space-y-3\">\n  1514â†’            {processingHistory.map((record, index) => (\n  1515â†’              <div\n  1516â†’                key={record.id}\n  1517â†’                className=\"border border-gray-200 dark:border-gray-700 rounded-lg p-4 hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors\"\n  1518â†’              >\n  1519â†’                <div className=\"flex items-center justify-between\">\n  1520â†’                  <div className=\"flex-1\">\n  1521â†’                    <div className=\"flex items-center space-x-2 mb-2\">\n  1522â†’                      <Calendar className=\"h-4 w-4 text-primary\" />\n  1523â†’                      <span className=\"text-sm font-medium text-gray-900 dark:text-white\">\n  1524â†’                        {new Date(record.processedAt).toLocaleDateString('en-US', {\n  1525â†’                          year: 'numeric',\n  1526â†’                          month: 'short',\n  1527â†’                          day: 'numeric',\n  1528â†’                          hour: '2-digit',\n  1529â†’                          minute: '2-digit'\n  1530â†’                        })}\n  1531â†’                      </span>\n  1532â†’                      {/* PDF Status Badge */}\n  1533â†’                      {record.pdfUrl ? (\n  1534â†’                        <span className=\"px-2 py-0.5 text-xs bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-400 rounded-full flex items-center space-x-1\">\n  1535â†’                          <CheckCircle className=\"h-3 w-3\" />\n  1536â†’                          <span>PDF Available</span>\n  1537â†’                        </span>\n  1538â†’                      ) : (\n  1539â†’                        <span className=\"px-2 py-0.5 text-xs bg-gray-100 text-gray-600 dark:bg-gray-700 dark:text-gray-400 rounded-full\">\n  1540â†’                          No PDF\n  1541â†’                        </span>\n  1542â†’                      )}\n  1543â†’                    </div>\n  1544â†’                    <div className=\"text-xs text-gray-600 dark:text-gray-400 space-y-1 mb-3\">\n  1545â†’                      <p>ðŸ“ Files: {record.eyesOpenFile}, {record.eyesClosedFile}</p>\n  1546â†’                      <p>ðŸ‘¤ Processed by: {record.processedBy}</p>\n  1547â†’                      {record.pdfUrl && (\n  1548â†’                        <p className=\"text-green-600 dark:text-green-400\">\n  1549â†’                          ðŸ“„ PDF: {record.pdfUrl.startsWith('http') ? 'Supabase âœ“' : 'Local âœ“'}\n  1550â†’                        </p>\n  1551â†’                      )}\n  1552â†’                      {!record.pdfUrl && (\n  1553â†’                        <p className=\"text-red-600 dark:text-red-400\">ðŸ“„ PDF: Not available</p>\n  1554â†’                      )}\n  1555â†’                    </div>\n  1556â†’\n  1557â†’                    {/* Quick Summary of Results */}\n  1558â†’                    {record.results && record.results.length > 0 && (\n  1559â†’                      <div className=\"mt-3 grid grid-cols-2 gap-2\">\n  1560â†’                        {record.results.slice(0, 4).map((result, idx) => (\n  1561â†’                          <div key={idx} className=\"text-xs bg-gray-50 dark:bg-gray-700 rounded p-2\">\n  1562â†’                            <span className=\"text-gray-600 dark:text-gray-400\">{result.parameter}:</span>\n  1563â†’                            <span className={`ml-2 font-semibold ${getStatusColor(result.rawScore)}`}>\n  1564â†’                              {result.rawScore}\n  1565â†’                            </span>\n  1566â†’                          </div>\n  1567â†’                        ))}\n  1568â†’                      </div>\n  1569â†’                    )}\n  1570â†’                  </div>\n  1571â†’                  <div className=\"flex flex-col space-y-2\">\n  1572â†’                    {/* View Full Results Button */}\n  1573â†’                    <button\n  1574â†’                      onClick={() => {\n  1575â†’                        setResults(record.results);\n  1576â†’                        setProcessingComplete(true);\n  1577â†’                        setIsSaved(true);\n  1578â†’                        // Set PDF URL if available\n  1579â†’                        if (record.pdfUrl) {\n  1580â†’                          setPdfUrl(record.pdfUrl);\n  1581â†’                        }\n  1582â†’                        toast.success('Previous results loaded');\n  1583â†’                      }}\n  1584â†’                      className=\"px-3 py-2 text-sm bg-primary hover:bg-navy-700 text-white rounded-lg transition-colors flex items-center justify-center space-x-1\"\n  1585â†’                    >\n  1586â†’                      <FileText className=\"h-4 w-4\" />\n  1587â†’                      <span>View Results</span>\n  1588â†’                    </button>\n  1589â†’\n  1590â†’                    {/* Download PDF Button - Always visible */}\n  1591â†’                    <button\n  1592â†’                      onClick={async () => {\n  1593â†’                        if (!record.pdfUrl) {\n  1594â†’                          toast.error('No PDF available for this record');\n  1595â†’                          console.log('âŒ No PDF URL in record:', record);\n  1596â†’                          return;\n  1597â†’                        }\n  1598â†’\n  1599â†’                        console.log('ðŸ“¥ Downloading PDF from record:', {\n  1600â†’                          processedAt: record.processedAt,\n  1601â†’                          pdfUrl: record.pdfUrl\n  1602â†’                        });\n  1603â†’\n  1604â†’                        try {\n  1605â†’                          toast.loading('Downloading PDF...', { id: 'history-download' });\n  1606â†’\n  1607â†’                          // Construct full URL (works with both local and Supabase URLs)\n  1608â†’                          const apiUrl = import.meta.env.VITE_API_URL || 'http://localhost:3001/api';\n  1609â†’                          const backendBaseUrl = apiUrl.replace('/api', '');\n  1610â†’                          const fullPdfUrl = record.pdfUrl.startsWith('http') ? record.pdfUrl : `${backendBaseUrl}${record.pdfUrl}`;\n  1611â†’\n  1612â†’                          console.log('ðŸ“¥ Downloading from:', fullPdfUrl);\n  1613â†’\n  1614â†’                          // Fetch the PDF file\n  1615â†’                          const response = await fetch(fullPdfUrl);\n  1616â†’                          if (!response.ok) throw new Error('Failed to fetch PDF');\n  1617â†’\n  1618â†’                          // Convert to blob\n  1619â†’                          const blob = await response.blob();\n  1620â†’\n  1621â†’                          // Create download link\n  1622â†’                          const downloadUrl = window.URL.createObjectURL(blob);\n  1623â†’                          const link = document.createElement('a');\n  1624â†’                          link.href = downloadUrl;\n  1625â†’                          link.download = record.pdfUrl.split('/').pop() || 'neurosense-report.pdf';\n  1626â†’\n  1627â†’                          // Trigger download\n  1628â†’                          document.body.appendChild(link);\n  1629â†’                          link.click();\n  1630â†’\n  1631â†’                          // Cleanup\n  1632â†’                          document.body.removeChild(link);\n  1633â†’                          window.URL.revokeObjectURL(downloadUrl);\n  1634â†’\n  1635â†’                          toast.success('PDF downloaded successfully!', { id: 'history-download' });\n  1636â†’                        } catch (error) {\n  1637â†’                          console.error('Download error:', error);\n  1638â†’                          toast.error('Failed to download PDF', { id: 'history-download' });\n  1639â†’                        }\n  1640â†’                      }}\n  1641â†’                      disabled={!record.pdfUrl}\n  1642â†’                      className={`px-3 py-2 text-sm rounded-lg transition-colors flex items-center justify-center space-x-1 ${\n  1643â†’                        record.pdfUrl\n  1644â†’                          ? 'bg-blue-600 hover:bg-blue-700 text-white cursor-pointer'\n  1645â†’                          : 'bg-gray-300 dark:bg-gray-600 text-gray-500 dark:text-gray-400 cursor-not-allowed'\n  1646â†’                      }`}\n  1647â†’                      title={record.pdfUrl ? 'Download PDF Report' : 'No PDF available'}\n  1648â†’                    >\n  1649â†’                      <Download className=\"h-4 w-4\" />\n  1650â†’                      <span>NeuroSense Report</span>\n  1651â†’                    </button>\n  1652â†’                  </div>\n  1653â†’                </div>\n  1654â†’\n  1655â†’                {/* Expandable Details */}\n  1656â†’                {record.results && record.results.length > 4 && (\n  1657â†’                  <div className=\"mt-2 grid grid-cols-3 gap-2\">\n  1658â†’                    {record.results.slice(4).map((result, idx) => (\n  1659â†’                      <div key={idx} className=\"text-xs bg-gray-50 dark:bg-gray-700 rounded p-2\">\n  1660â†’                        <span className=\"text-gray-600 dark:text-gray-400\">{result.parameter}:</span>\n  1661â†’                        <span className={`ml-2 font-semibold ${getStatusColor(result.rawScore)}`}>\n  1662â†’                          {result.rawScore}\n  1663â†’                        </span>\n  1664â†’                      </div>\n  1665â†’                    ))}\n  1666â†’                  </div>\n  1667â†’                )}\n  1668â†’              </div>\n  1669â†’            ))}\n  1670â†’          </div>\n  1671â†’        </div>\n  1672â†’      )}\n  1673â†’\n  1674â†’      {/* Info Section */}\n  1675â†’      <div className=\"bg-accent-light dark:bg-primary/20 border border-primary-light dark:border-primary rounded-lg p-4 shadow-sm\">\n  1676â†’        <h3 className=\"text-sm font-medium text-primary dark:text-primary-light mb-2\">\n  1677â†’          About Algorithm 1 Processing\n  1678â†’        </h3>\n  1679â†’        <p className=\"text-sm text-navy-800 dark:text-gray-300\">\n  1680â†’          This processor analyzes QEEG data files (Eyes Open and Eyes Closed) and generates 7 key parameters using proprietary\n  1681â†’          binary scoring logic. The algorithm evaluates brain activity patterns to assess cognitive and emotional health markers.\n  1682â†’        </p>\n  1683â†’      </div>\n  1684â†’    </div>\n  1685â†’  );\n  1686â†’};\n  1687â†’\n  1688â†’export default AlgorithmDataProcessor;\n  1689â†’\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"34483089-50ca-4301-a72f-19294d528c10","timestamp":"2025-12-09T06:11:11.649Z","toolUseResult":{"type":"text","file":{"filePath":"D:\\Todays\\Neuro360\\src\\components\\admin\\AlgorithmDataProcessor.jsx","content":"import React, { useState, useEffect } from 'react';\nimport { Upload, Play, Download, FileText, CheckCircle, Activity, User, Building2, Calendar, History, X, ArrowLeft, Search, Filter } from 'lucide-react';\nimport DatabaseService from '../../services/databaseService';\nimport toast from 'react-hot-toast';\n\nconst AlgorithmDataProcessor = () => {\n  const [patients, setPatients] = useState([]);\n  const [clinics, setClinics] = useState([]);\n  const [selectedPatient, setSelectedPatient] = useState(null);\n  const [showProcessingUI, setShowProcessingUI] = useState(false);\n  const [processingHistory, setProcessingHistory] = useState([]);\n  const [loading, setLoading] = useState(true);\n\n  // Filter states\n  const [searchTerm, setSearchTerm] = useState('');\n  const [selectedClinicFilter, setSelectedClinicFilter] = useState('');\n  const [dateFilter, setDateFilter] = useState('');\n\n  const [eyesOpenFile, setEyesOpenFile] = useState(null);\n  const [eyesClosedFile, setEyesClosedFile] = useState(null);\n  const [isProcessing, setIsProcessing] = useState(false);\n  const [processingComplete, setProcessingComplete] = useState(false);\n  const [consoleLog, setConsoleLog] = useState([]);\n  const [progress, setProgress] = useState(0);\n  const [results, setResults] = useState(null);\n  const [isSaved, setIsSaved] = useState(false);\n  const [isSaving, setIsSaving] = useState(false);\n  const [pdfUrl, setPdfUrl] = useState(null);\n  const [dataType, setDataType] = useState(null); // 'raw' or 'zscore'\n\n  // Debug function to check database contents\n  useEffect(() => {\n    window.debugAlgorithmResults = async () => {\n      const allResults = await DatabaseService.get('algorithmResults');\n      console.log('ðŸ” All Algorithm Results in Database:', allResults);\n      console.log(`Total records: ${allResults.length}`);\n      allResults.forEach((record, idx) => {\n        console.log(`\\nðŸ“Š Record ${idx + 1}:`, {\n          id: record.id,\n          patientName: record.inputData?.patientName || record.patientName,\n          processedAt: record.inputData?.processedAt || record.processedAt,\n          pdfUrl: record.pdfUrl || 'âŒ MISSING',\n          hasResults: !!(record.outputData || record.results)\n        });\n      });\n    };\n    console.log('ðŸ’¡ Debug: Type window.debugAlgorithmResults() in console to check database');\n  }, []);\n\n  useEffect(() => {\n    loadPatients();\n  }, []);\n\n  useEffect(() => {\n    if (selectedPatient && showProcessingUI) {\n      loadProcessingHistory(selectedPatient.id);\n    }\n  }, [selectedPatient, showProcessingUI, isSaved]); // Re-load when saved\n\n  const loadPatients = async () => {\n    try {\n      const patientsData = await DatabaseService.get('patients');\n      const clinicsData = await DatabaseService.get('clinics');\n      const algorithmResults = await DatabaseService.get('algorithmResults') || [];\n\n      // Enrich patients with clinic names and algorithm status\n      const enrichedPatients = patientsData.map(patient => {\n        const patientResults = algorithmResults.filter(r => r.patientId === patient.id);\n        const lastResult = patientResults.length > 0\n          ? patientResults.sort((a, b) => {\n              const aTime = a.inputData?.processedAt || a.processedAt || a.createdAt;\n              const bTime = b.inputData?.processedAt || b.processedAt || b.createdAt;\n              return new Date(bTime) - new Date(aTime);\n            })[0]\n          : null;\n\n        return {\n          ...patient,\n          clinicName: clinicsData.find(c => c.id === patient.clinicId)?.name || 'Unknown Clinic',\n          algorithmStatus: lastResult ? 'completed' : 'pending',\n          lastProcessed: lastResult?.inputData?.processedAt || lastResult?.processedAt || lastResult?.createdAt,\n          totalScans: patientResults.length\n        };\n      });\n\n      setPatients(enrichedPatients);\n      setClinics(clinicsData);\n      setLoading(false);\n    } catch (error) {\n      console.error('Error loading patients:', error);\n      toast.error('Failed to load patients');\n      setLoading(false);\n    }\n  };\n\n  const loadProcessingHistory = async (patientId) => {\n    try {\n      // Load algorithm results for this patient\n      const results = await DatabaseService.get('algorithmResults');\n      const patientResults = results.filter(r => r.patientId === patientId);\n\n      console.log(`ðŸ“‹ Loaded ${patientResults.length} records for patient ${patientId}`);\n\n      // Log all records for debugging\n      console.log('ðŸ“Š All records for this patient:');\n      patientResults.forEach((rec, idx) => {\n        const processedTime = rec.inputData?.processedAt || rec.processedAt || rec.createdAt;\n        console.log(`   ${idx + 1}. ${new Date(processedTime).toLocaleString()} - PDF: ${rec.pdfUrl ? 'âœ“' : 'âœ—'}`);\n      });\n\n      // Check for records without pdfUrl and try to fix them\n      const recordsWithoutPdf = patientResults.filter(r => !r.pdfUrl);\n      if (recordsWithoutPdf.length > 0) {\n        console.log(`\\nâš ï¸ Found ${recordsWithoutPdf.length} records without PDF URL - attempting auto-fix...`);\n\n        let updatedCount = 0;\n\n        // Step 1: Try to fetch PDFs from Supabase bucket\n        try {\n          const apiUrl = import.meta.env.VITE_API_URL || 'http://localhost:3001/api';\n          const response = await fetch(`${apiUrl}/qeeg/supabase-pdfs`);\n\n          if (response.ok) {\n            const data = await response.json();\n            console.log(`\\nâ˜ï¸ Found ${data.count} PDFs in Supabase bucket:`);\n            data.pdfs.forEach(pdf => console.log(`   - ${pdf.name}`));\n\n            // Match PDFs with database records using smart matching\n            console.log(`\\nðŸ” Attempting to match ${recordsWithoutPdf.length} records...`);\n            for (const record of recordsWithoutPdf) {\n              const processedTime = record.inputData?.processedAt || record.processedAt || record.createdAt;\n              const patientName = record.inputData?.patientName || record.patientName || 'unknown';\n              const recordTimestamp = new Date(processedTime).getTime();\n              const sanitizedName = patientName.replace(/[^a-z0-9]/gi, '_').toLowerCase();\n\n              console.log(`\\n   Record: ${patientName} @ ${new Date(processedTime).toLocaleString()}`);\n              console.log(`   Searching for PDFs matching: neurosense-report-${sanitizedName}-*.pdf`);\n\n              // Find PDFs matching patient name\n              const matchingPdfs = data.pdfs.filter(pdf => {\n                const pdfNameLower = pdf.name.toLowerCase();\n                return pdfNameLower.includes(`neurosense-report-${sanitizedName}-`) &&\n                       pdfNameLower.endsWith('.pdf');\n              });\n\n              console.log(`   Found ${matchingPdfs.length} PDFs for this patient`);\n\n              if (matchingPdfs.length > 0) {\n                // Find PDF with closest timestamp (within 60 seconds)\n                let bestMatch = null;\n                let smallestDiff = Infinity;\n\n                for (const pdf of matchingPdfs) {\n                  // Extract timestamp from filename: neurosense-report-name-TIMESTAMP.pdf\n                  const match = pdf.name.match(/-(\\d+)\\.pdf$/);\n                  if (match) {\n                    const pdfTimestamp = parseInt(match[1]);\n                    const diff = Math.abs(pdfTimestamp - recordTimestamp);\n                    console.log(`      ${pdf.name}: timestamp diff = ${diff}ms (${(diff/1000).toFixed(1)}s)`);\n\n                    // Accept if within 60 seconds (60000ms)\n                    if (diff < 60000 && diff < smallestDiff) {\n                      smallestDiff = diff;\n                      bestMatch = pdf;\n                    }\n                  }\n                }\n\n                if (bestMatch) {\n                  console.log(`   âœ… MATCH FOUND! ${bestMatch.name} (${(smallestDiff/1000).toFixed(1)}s difference)`);\n                  console.log(`   URL: ${bestMatch.url}`);\n                  record.pdfUrl = bestMatch.url;\n                  await DatabaseService.update('algorithmResults', record.id, record);\n                  updatedCount++;\n                } else {\n                  console.log(`   âš ï¸ PDFs found but timestamp difference too large (>60s)`);\n                }\n              } else {\n                console.log(`   âŒ No PDFs found for patient: ${sanitizedName}`);\n              }\n            }\n          }\n        } catch (supabaseErr) {\n          console.log('âš ï¸ Could not fetch from Supabase, trying local storage...');\n        }\n\n        // Step 2: If Supabase fails, try local storage\n        for (const record of recordsWithoutPdf) {\n          if (record.pdfUrl) continue; // Already updated from Supabase\n\n          try {\n            const processedTime = record.inputData?.processedAt || record.processedAt || record.createdAt;\n            const patientName = record.inputData?.patientName || record.patientName || 'unknown';\n            const timestamp = new Date(processedTime).getTime();\n            const sanitizedName = patientName.replace(/[^a-z0-9]/gi, '_').toLowerCase();\n            const possibleFilename = `neurosense-report-${sanitizedName}-${timestamp}.pdf`;\n            const apiUrl = import.meta.env.VITE_API_URL || 'http://localhost:3001/api';\n            const backendBaseUrl = apiUrl.replace('/api', '');\n            const testUrl = `${backendBaseUrl}/uploads/${possibleFilename}`;\n\n            // Test if file exists locally\n            const response = await fetch(testUrl, { method: 'HEAD' });\n            if (response.ok) {\n              console.log(`âœ… Found local PDF for record ${record.id}: ${testUrl}`);\n              record.pdfUrl = `/uploads/${possibleFilename}`;\n              await DatabaseService.update('algorithmResults', record.id, record);\n              updatedCount++;\n            }\n          } catch (err) {\n            console.log(`âŒ Could not find PDF for record ${record.id}`);\n          }\n        }\n\n        if (updatedCount > 0) {\n          console.log(`âœ… Auto-fixed ${updatedCount} records with PDF URLs`);\n          // Reload the results after updating\n          const updatedResults = await DatabaseService.get('algorithmResults');\n          const updatedPatientResults = updatedResults.filter(r => r.patientId === patientId);\n          setProcessingHistory(updatedPatientResults);\n\n          updatedPatientResults.forEach((record, idx) => {\n            const processedTime = record.inputData?.processedAt || record.processedAt || record.createdAt;\n            console.log(`   Record ${idx + 1}:`, {\n              processedAt: processedTime,\n              hasPdfUrl: !!record.pdfUrl,\n              pdfUrl: record.pdfUrl || 'NOT SET',\n              pdfType: record.pdfUrl ? (record.pdfUrl.startsWith('http') ? 'Supabase' : 'Local') : 'None'\n            });\n          });\n          return;\n        }\n      }\n\n      patientResults.forEach((record, idx) => {\n        const processedTime = record.inputData?.processedAt || record.processedAt || record.createdAt;\n        console.log(`   Record ${idx + 1}:`, {\n          processedAt: processedTime,\n          hasPdfUrl: !!record.pdfUrl,\n          pdfUrl: record.pdfUrl || 'NOT SET',\n          pdfType: record.pdfUrl ? (record.pdfUrl.startsWith('http') ? 'Supabase' : 'Local') : 'None'\n        });\n      });\n\n      setProcessingHistory(patientResults);\n    } catch (error) {\n      console.error('Error loading processing history:', error);\n      setProcessingHistory([]);\n    }\n  };\n\n  const handleGenerateReport = (patient) => {\n    setSelectedPatient(patient);\n    setShowProcessingUI(true);\n    // Reset upload states\n    setEyesOpenFile(null);\n    setEyesClosedFile(null);\n    setResults(null);\n    setProcessingComplete(false);\n    setConsoleLog([]);\n    setIsSaved(false);\n    setPdfUrl(null);\n    setIsSaving(false);\n  };\n\n  const handleBackToList = () => {\n    setShowProcessingUI(false);\n    setSelectedPatient(null);\n    setEyesOpenFile(null);\n    setEyesClosedFile(null);\n    setResults(null);\n    setProcessingComplete(false);\n    setConsoleLog([]);\n    setProcessingHistory([]);\n    setIsSaved(false);\n    setIsSaving(false);\n    // Reload patients to update status\n    loadPatients();\n  };\n\n  // Helper function to get patient name (handles different field names)\n  const getPatientName = (patient) => {\n    return patient?.fullName || patient?.full_name || patient?.name || patient?.email || 'Unknown Patient';\n  };\n\n  // Helper function to get status badge\n  const getStatusBadge = (status, lastProcessed) => {\n    if (status === 'completed') {\n      return (\n        <div className=\"flex flex-col items-start\">\n          <span className=\"inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-400\">\n            <CheckCircle className=\"h-3 w-3 mr-1\" />\n            Completed\n          </span>\n          {lastProcessed && (\n            <span className=\"text-xs text-gray-500 dark:text-gray-400 mt-1\">\n              {new Date(lastProcessed).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}\n            </span>\n          )}\n        </div>\n      );\n    }\n    return (\n      <span className=\"inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800 dark:bg-yellow-900/30 dark:text-yellow-400\">\n        <Activity className=\"h-3 w-3 mr-1\" />\n        Pending\n      </span>\n    );\n  };\n\n  // Filter patients based on search and filters\n  const filteredPatients = patients.filter(patient => {\n    const matchesSearch = searchTerm === '' ||\n      getPatientName(patient).toLowerCase().includes(searchTerm.toLowerCase()) ||\n      patient.email?.toLowerCase().includes(searchTerm.toLowerCase());\n\n    const matchesClinic = selectedClinicFilter === '' || patient.clinicId === selectedClinicFilter;\n\n    const matchesDate = dateFilter === '' ||\n      (patient.lastProcessed && new Date(patient.lastProcessed).toISOString().split('T')[0] === dateFilter);\n\n    return matchesSearch && matchesClinic && matchesDate;\n  });\n\n  // Group filtered patients by clinic\n  const groupedPatients = clinics.map(clinic => ({\n    clinic,\n    patients: filteredPatients.filter(p => p.clinicId === clinic.id)\n  })).filter(group => group.patients.length > 0);\n\n  const clearFilters = () => {\n    setSearchTerm('');\n    setSelectedClinicFilter('');\n    setDateFilter('');\n  };\n\n  const handleFileUpload = (type, event) => {\n    const file = event.target.files[0];\n    if (file) {\n      if (type === 'eo') {\n        setEyesOpenFile(file);\n      } else {\n        setEyesClosedFile(file);\n      }\n      // Reset processing state when new files are uploaded\n      setProcessingComplete(false);\n      setResults(null);\n      setConsoleLog([]);\n      setProgress(0);\n      setIsSaved(false);\n      setIsSaving(false);\n      setPdfUrl(null);\n    }\n  };\n\n  const processQEEGFiles = async () => {\n    setIsProcessing(true);\n    setConsoleLog([]);\n    setProgress(0);\n\n    try {\n      // Console log: Starting process\n      setConsoleLog(prev => [...prev, 'ðŸš€ Starting QEEG analysis...']);\n      setProgress(10);\n\n      // Create FormData to send files\n      const formData = new FormData();\n      formData.append('eyesOpen', eyesOpenFile);\n      formData.append('eyesClosed', eyesClosedFile);\n      formData.append('patientId', selectedPatient.id);\n      formData.append('patientName', getPatientName(selectedPatient));\n      formData.append('clinicName', selectedPatient.clinicName);\n      // Add complete patient data for PDF\n      formData.append('dateOfBirth', selectedPatient.dateOfBirth || selectedPatient.date_of_birth || 'Not specified');\n      formData.append('age', selectedPatient.age || calculateAge(selectedPatient.dateOfBirth || selectedPatient.date_of_birth) || 'N/A');\n      formData.append('gender', selectedPatient.gender || 'Not specified');\n      formData.append('handedness', selectedPatient.handedness || 'Right');\n\n      setConsoleLog(prev => [...prev, 'ðŸ“¤ Uploading files to server...']);\n      setProgress(20);\n\n      // Validate file sizes before upload (50MB limit)\n      const maxFileSize = 50 * 1024 * 1024; // 50MB\n      if (eyesOpenFile.size > maxFileSize || eyesClosedFile.size > maxFileSize) {\n        const oversizedFile = eyesOpenFile.size > maxFileSize ? eyesOpenFile : eyesClosedFile;\n        const fileSizeMB = (oversizedFile.size / (1024 * 1024)).toFixed(2);\n        throw new Error(`File \"${oversizedFile.name}\" is too large (${fileSizeMB}MB). Maximum file size is 50MB. Please compress or split the file.`);\n      }\n\n      // Call backend API with timeout\n      const apiUrl = import.meta.env.VITE_API_URL || 'http://localhost:3001/api';\n      const controller = new AbortController();\n      const timeoutId = setTimeout(() => controller.abort(), 120000); // 2 minute timeout for large files\n\n      let response;\n      try {\n        response = await fetch(`${apiUrl}/qeeg/process`, {\n          method: 'POST',\n          body: formData,\n          signal: controller.signal\n        });\n        clearTimeout(timeoutId);\n      } catch (fetchError) {\n        clearTimeout(timeoutId);\n        if (fetchError.name === 'AbortError') {\n          throw new Error('Upload timed out. The file may be too large or the server is busy. Please try again.');\n        }\n        // Check if it's a network error (backend not running)\n        if (fetchError.message.includes('Failed to fetch') || fetchError.message.includes('fetch')) {\n          throw new Error('Cannot connect to backend server. Please ensure the backend is running on port 3001. Run \"npm run dev:backend\" to start the server.');\n        }\n        throw fetchError;\n      }\n\n      setConsoleLog(prev => [...prev, 'ðŸ“Š Parsing QEEG data tables...']);\n      setProgress(40);\n\n      if (!response.ok) {\n        let errorMessage = 'Failed to process QEEG files';\n        try {\n          const errorData = await response.json();\n          errorMessage = errorData.message || errorMessage;\n\n          // Add specific error messages based on error code\n          if (errorData.code === 'LIMIT_FILE_SIZE') {\n            errorMessage = 'File size exceeds the maximum limit of 50MB. Please compress your files or split them into smaller parts.';\n          } else if (errorData.code === 'GEMINI_QUOTA_EXCEEDED' || response.status === 429) {\n            // Extract retry time if available in error message\n            let retryTime = null;\n            const retryMatch = errorData.message?.match(/retry in ([\\d.]+)s/i);\n            if (retryMatch) {\n              retryTime = Math.ceil(parseFloat(retryMatch[1]));\n            }\n\n            errorMessage = 'âš ï¸ API Quota Exceeded\\n\\n' +\n                         'The Gemini AI service has reached its daily limit (20 requests/day).\\n\\n' +\n                         'âœ… Quick Solutions:\\n' +\n                         (retryTime ? `â€¢ Wait ${retryTime} seconds and try again (quota will reset)\\n` : 'â€¢ Wait a few minutes and try again\\n') +\n                         'â€¢ Re-upload the SAME files you processed before (uses cache, no quota needed)\\n' +\n                         'â€¢ Contact administrator to upgrade API plan\\n\\n' +\n                         'ðŸ’¡ Tip: The system remembers files you\\'ve already processed!';\n          } else if (response.status === 503) {\n            errorMessage = 'Backend service is unavailable. Please ensure the server is running.';\n          } else if (response.status === 413) {\n            errorMessage = 'File payload is too large. Maximum allowed size is 50MB.';\n          } else if (response.status === 500) {\n            // Parse detailed error from server for 500 errors\n            if (errorData.message && (errorData.message.includes('Gemini') || errorData.message.includes('quota') || errorData.message.includes('429'))) {\n              // Extract retry time from detailed error\n              let retryTime = null;\n              const retryMatch = errorData.message.match(/retry in ([\\d.]+)s/i);\n              if (retryMatch) {\n                retryTime = Math.ceil(parseFloat(retryMatch[1]));\n              }\n\n              // Check if it's specifically a quota error\n              if (errorData.message.includes('quota') || errorData.message.includes('429')) {\n                errorMessage = 'âš ï¸ API Quota Exceeded\\n\\n' +\n                             'Google Gemini API has reached its free tier limit.\\n\\n' +\n                             'âœ… What to do:\\n' +\n                             (retryTime ? `1. Wait ${retryTime} seconds and try again\\n` : '1. Wait a few minutes and try again\\n') +\n                             '2. Or re-upload the SAME files (cached, no quota used)\\n' +\n                             '3. Or contact admin to upgrade API plan\\n\\n' +\n                             'ðŸ“Š Free tier: 20 requests per day\\n' +\n                             'ðŸ’° Upgrade: https://ai.google.dev/pricing';\n              } else {\n                errorMessage = 'âš ï¸ Gemini AI Service Error\\n\\n' +\n                             'There was an issue with the AI service.\\n\\n' +\n                             'Please try again in a moment or contact support if the issue persists.';\n              }\n            }\n          }\n        } catch (e) {\n          // If error response is not JSON, use status text\n          errorMessage = `Server error (${response.status}): ${response.statusText}`;\n        }\n        throw new Error(errorMessage);\n      }\n\n      const data = await response.json();\n\n      // Capture data type (raw or zscore)\n      if (data.data.dataType) {\n        setDataType(data.data.dataType);\n        console.log('ðŸ“Š Data type:', data.data.dataType);\n        if (data.data.dataType === 'zscore') {\n          setConsoleLog(prev => [...prev, 'ðŸ”¬ Z-Score mode detected']);\n        }\n      }\n\n      // Auto-set PDF URL if returned from backend\n      if (data.data.pdfUrl) {\n        setPdfUrl(data.data.pdfUrl);\n        console.log('âœ… PDF auto-generated:', data.data.pdfUrl);\n        setConsoleLog(prev => [...prev, 'ðŸ“„ PDF report generated automatically']);\n      }\n\n      setConsoleLog(prev => [...prev, 'ðŸ§® Calculating 7 brain health parameters...']);\n      setProgress(60);\n\n      // Simulate calculation steps for better UX\n      await new Promise(resolve => setTimeout(resolve, 500));\n      setConsoleLog(prev => [...prev, '  âœ“ Cognition parameter calculated']);\n      setProgress(65);\n\n      await new Promise(resolve => setTimeout(resolve, 400));\n      setConsoleLog(prev => [...prev, '  âœ“ Stress parameter calculated']);\n      setProgress(70);\n\n      await new Promise(resolve => setTimeout(resolve, 400));\n      setConsoleLog(prev => [...prev, '  âœ“ Focus & Attention parameter calculated']);\n      setProgress(75);\n\n      await new Promise(resolve => setTimeout(resolve, 400));\n      setConsoleLog(prev => [...prev, '  âœ“ Burnout & Fatigue parameter calculated']);\n      setProgress(80);\n\n      await new Promise(resolve => setTimeout(resolve, 400));\n      setConsoleLog(prev => [...prev, '  âœ“ Emotional Regulation parameter calculated']);\n      setProgress(85);\n\n      await new Promise(resolve => setTimeout(resolve, 400));\n      setConsoleLog(prev => [...prev, '  âœ“ Learning parameter calculated']);\n      setProgress(90);\n\n      await new Promise(resolve => setTimeout(resolve, 400));\n      setConsoleLog(prev => [...prev, '  âœ“ Creativity parameter calculated']);\n      setProgress(95);\n\n      // Convert API results to display format\n      const finalResults = data.data.results.map(param => ({\n        parameter: param.name,\n        score: Math.round((param.score / param.maxScore) * 100), // Convert to percentage\n        rawScore: `${param.score}/${param.maxScore}`,\n        status: param.classification,\n        color: param.classification === 'High' ? 'green' :\n               param.classification === 'Medium' ? 'blue' : 'orange',\n        metrics: param.metrics\n      }));\n\n      setConsoleLog(prev => [...prev, 'âœ… Analysis complete!']);\n      setConsoleLog(prev => [...prev, `ðŸ“ˆ Overall Score: ${data.data.overallScore}/${data.data.maxScore}`]);\n      setProgress(100);\n\n      setResults(finalResults);\n      setIsProcessing(false);\n      setProcessingComplete(true);\n      setIsSaved(false); // Mark as not saved yet\n\n      toast.success('QEEG analysis completed successfully!');\n\n    } catch (error) {\n      console.error('Error processing QEEG files:', error);\n      setConsoleLog(prev => [...prev, `âŒ Error: ${error.message}`]);\n      setIsProcessing(false);\n      toast.error(error.message || 'Failed to process QEEG files');\n    }\n  };\n\n  const saveResultsToDatabase = async (resultData) => {\n    if (!resultData) {\n      toast.error('No results to save');\n      return;\n    }\n\n    try {\n      setIsSaving(true);\n      toast.loading('Saving results to database...', { id: 'save-results' });\n\n      console.log('ðŸ’¾ Saving results to database...');\n\n      // PDF should already exist from auto-generation\n      if (!pdfUrl) {\n        console.warn('âš ï¸ No PDF URL available - PDF may not have been generated');\n      }\n\n      const algorithmResult = {\n        // Don't specify ID - let database auto-generate UUID\n        patientId: selectedPatient.id,\n        clinicId: selectedPatient.clinicId,\n        algorithmName: 'Algorithm 1 - 7 Parameters',\n        inputData: {\n          patientName: getPatientName(selectedPatient),\n          clinicName: selectedPatient.clinicName,\n          eyesOpenFile: eyesOpenFile?.name,\n          eyesClosedFile: eyesClosedFile?.name,\n          processedAt: new Date().toISOString(),\n          processedBy: 'super_admin'\n        },\n        outputData: resultData,\n        pdfUrl: pdfUrl || null,\n        status: 'completed',\n        errorMessage: null\n      };\n\n      console.log('ðŸ’¾ Saving to database...');\n      console.log('   Patient:', algorithmResult.inputData.patientName);\n      console.log('   PDF URL:', pdfUrl || 'NOT SET');\n      console.log('   PDF Type:', pdfUrl ? (pdfUrl.startsWith('http') ? 'Supabase' : 'Local') : 'None');\n\n      await DatabaseService.add('algorithmResults', algorithmResult);\n\n      setIsSaved(true);\n      setIsSaving(false);\n\n      toast.success('âœ… Results saved successfully!', { id: 'save-results' });\n\n      // Reload history and patient list to update status\n      loadProcessingHistory(selectedPatient.id);\n      loadPatients();\n    } catch (error) {\n      console.error('âŒ Error saving results:', error);\n      setIsSaving(false);\n      toast.error('âŒ Failed to save results: ' + error.message, { id: 'save-results' });\n    }\n  };\n\n  const handleSaveResults = async () => {\n    if (results) {\n      await saveResultsToDatabase(results);\n      // After saving, automatically download PDF if available\n      if (pdfUrl) {\n        setTimeout(() => {\n          handleDownloadPDF();\n        }, 500); // Small delay to let save complete\n      }\n    }\n  };\n\n  const handleExecuteCalculation = () => {\n    if (eyesOpenFile && eyesClosedFile) {\n      processQEEGFiles();\n    } else {\n      toast.error('Please upload both QEEG data files');\n    }\n  };\n\n  const handleExportResults = () => {\n    if (results) {\n      // Create CSV content\n      const csvContent = [\n        ['Parameter', 'Score (%)', 'Status'],\n        ...results.map(r => [r.parameter, r.score, r.status])\n      ].map(row => row.join(',')).join('\\n');\n\n      // Create and download file\n      const blob = new Blob([csvContent], { type: 'text/csv' });\n      const url = window.URL.createObjectURL(blob);\n      const a = document.createElement('a');\n      a.href = url;\n      a.download = 'neurosense-algorithm-results.csv';\n      a.click();\n      window.URL.revokeObjectURL(url);\n    }\n  };\n\n  const generatePDFReport = async (resultData) => {\n    if (!resultData || !selectedPatient) {\n      console.error('âŒ Cannot generate PDF: Missing resultData or selectedPatient');\n      toast.error('Cannot generate PDF: Missing data');\n      return null;\n    }\n\n    try {\n      console.log('ðŸ”§ Preparing patient data...');\n\n      // Prepare patient data - FIXED: Use current date for recording, not DOB\n      const patientData = {\n        name: getPatientName(selectedPatient),\n        dateOfRecording: new Date().toISOString().split('T')[0], // TODAY'S DATE, not DOB!\n        dateOfBirth: selectedPatient.dateOfBirth || selectedPatient.date_of_birth || 'Not specified',\n        age: selectedPatient.age || calculateAge(selectedPatient.dateOfBirth || selectedPatient.date_of_birth) || 'N/A',\n        gender: selectedPatient.gender || 'Not specified',\n        handedness: selectedPatient.handedness || 'Right', // Default to Right if not specified\n        patientId: selectedPatient.id,\n        occupation: selectedPatient.occupation || 'Not specified',\n        symptoms: selectedPatient.symptoms || []\n      };\n\n      console.log('ðŸ‘¤ Patient Data (Fixed):', patientData);\n      console.log('   Name:', patientData.name);\n      console.log('   Recording Date:', patientData.dateOfRecording);\n      console.log('   DOB:', patientData.dateOfBirth);\n      console.log('   Age:', patientData.age);\n      console.log('   Gender:', patientData.gender);\n      console.log('   Handedness:', patientData.handedness);\n\n      // Prepare algorithm results\n      const algorithmResults = {\n        parameters: resultData.map(result => ({\n          name: result.parameter,\n          score: parseInt(result.rawScore.split('/')[0]),\n          maxScore: parseInt(result.rawScore.split('/')[1]),\n          classification: result.status,\n          metrics: result.metrics || []\n        })),\n        overallScore: resultData.reduce((sum, r) => sum + parseInt(r.rawScore.split('/')[0]), 0)\n      };\n\n      console.log('ðŸ“Š Algorithm Results:', algorithmResults);\n\n      // Prepare QEEG data (use sample data if not available)\n      const qeegData = {\n        EC: {\n          absolute: { Fz: { Delta: 5.2, Theta: 4.1, Alpha: 8.3, Beta: 6.2, HiBeta: 3.1 } },\n          relative: { Pz: { Alpha: 45.2 } },\n          special: { alphaPeak: 10.3, O1: 10.1 }\n        },\n        EO: {\n          absolute: { Fz: { Theta: 3.8, Beta: 3.2, HiBeta: 2.5 } },\n          relative: { Pz: { Alpha: 28.7 } }\n        }\n      };\n\n      // Call backend API to generate PDF\n      const apiUrl = import.meta.env.VITE_API_URL || 'http://localhost:3001/api';\n      const pdfEndpoint = `${apiUrl}/qeeg/generate-pdf`;\n\n      console.log('ðŸŒ Calling backend API:', pdfEndpoint);\n      console.log('ðŸ“¡ Request payload size:', JSON.stringify({ patientData, algorithmResults, qeegData }).length, 'bytes');\n\n      // Add timeout handling\n      const controller = new AbortController();\n      const timeoutId = setTimeout(() => controller.abort(), 30000); // 30 second timeout\n\n      const response = await fetch(pdfEndpoint, {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n        },\n        body: JSON.stringify({\n          patientData,\n          algorithmResults,\n          qeegData\n        }),\n        signal: controller.signal\n      }).catch(error => {\n        clearTimeout(timeoutId);\n        if (error.name === 'AbortError') {\n          throw new Error('PDF generation timed out after 30 seconds. Server might be slow or not responding.');\n        }\n        throw error;\n      });\n\n      clearTimeout(timeoutId);\n\n      console.log('ðŸ“¡ Backend response status:', response.status);\n      console.log('ðŸ“¡ Backend response headers:', Object.fromEntries(response.headers.entries()));\n\n      if (!response.ok) {\n        let errorMessage = `Server returned ${response.status}`;\n        try {\n          const errorData = await response.json();\n          errorMessage = errorData.message || errorMessage;\n          console.error('âŒ Backend error data:', errorData);\n        } catch (e) {\n          const errorText = await response.text();\n          errorMessage = errorText || errorMessage;\n          console.error('âŒ Backend error text:', errorText);\n        }\n        throw new Error(`Failed to generate PDF: ${errorMessage}`);\n      }\n\n      const data = await response.json();\n      console.log('ðŸ“¦ Backend response data:', data);\n\n      if (!data || !data.success || !data.data) {\n        console.error('âŒ Invalid response format:', data);\n        throw new Error('Invalid response from server');\n      }\n\n      // Use the complete URL from backend instead of constructing it\n      const pdfResult = {\n        url: data.data.url, // Backend already provides complete URL\n        path: data.data.path,\n        filename: data.data.filename\n      };\n\n      console.log('âœ… PDF generated successfully!', pdfResult);\n      console.log('âœ… PDF URL:', pdfResult.url);\n\n      return pdfResult;\n\n    } catch (error) {\n      console.error('âŒ Error generating PDF:', error);\n      console.error('âŒ Error name:', error.name);\n      console.error('âŒ Error message:', error.message);\n\n      if (error.message && error.stack) {\n        console.error('âŒ Error stack:', error.stack);\n      }\n\n      // Provide specific error messages based on error type\n      if (error.name === 'TypeError' && error.message.includes('Failed to fetch')) {\n        console.error('âŒ NETWORK ERROR: Cannot connect to backend server');\n        console.error('âŒ Please ensure backend server is running on http://localhost:3001');\n        toast.error('Cannot connect to server. Please ensure backend is running on port 3001.');\n      } else if (error.name === 'AbortError') {\n        console.error('âŒ TIMEOUT ERROR: PDF generation took too long');\n        toast.error('PDF generation timed out. Server might be overloaded.');\n      } else {\n        console.error('âŒ PDF GENERATION ERROR:', error.message);\n        toast.error(`PDF generation failed: ${error.message}`);\n      }\n\n      return null;\n    }\n  };\n\n  const handleDownloadPDF = async () => {\n    if (!pdfUrl) {\n      toast.error('PDF not available. Please save results first.');\n      return;\n    }\n\n    try {\n      toast.loading('Downloading PDF...', { id: 'download-pdf' });\n\n      // Construct full backend URL\n      const apiUrl = import.meta.env.VITE_API_URL || 'http://localhost:3001/api';\n      const backendBaseUrl = apiUrl.replace('/api', ''); // Remove /api to get base URL\n\n      // Handle both Supabase URLs and local URLs\n      let fullPdfUrl;\n      if (pdfUrl.startsWith('http')) {\n        // It's already a full URL (Supabase)\n        fullPdfUrl = pdfUrl;\n      } else {\n        // It's a local path, construct full URL\n        fullPdfUrl = `${backendBaseUrl}${pdfUrl}`;\n      }\n\n      console.log('ðŸ”½ Download Info:', {\n        originalPdfUrl: pdfUrl,\n        backendBaseUrl,\n        fullPdfUrl,\n        isSupabase: pdfUrl.startsWith('http')\n      });\n\n      // For local files, try direct window.open first (simpler approach)\n      if (!pdfUrl.startsWith('http')) {\n        console.log('ðŸ“¥ Using direct download method for local file');\n\n        // Create a hidden link and click it\n        const link = document.createElement('a');\n        link.href = fullPdfUrl;\n        link.download = pdfUrl.split('/').pop() || 'neurosense-report.pdf';\n        link.target = '_blank';\n\n        document.body.appendChild(link);\n        link.click();\n        document.body.removeChild(link);\n\n        toast.success('PDF download started!', { id: 'download-pdf' });\n        return;\n      }\n\n      // For Supabase URLs, use fetch method\n      console.log('ðŸ“¥ Using fetch method for Supabase URL');\n\n      const response = await fetch(fullPdfUrl);\n\n      if (!response.ok) {\n        console.error('âŒ Download failed:', {\n          status: response.status,\n          statusText: response.statusText\n        });\n        throw new Error(`Server returned ${response.status}: ${response.statusText}`);\n      }\n\n      // Convert to blob\n      const blob = await response.blob();\n\n      // Verify blob is valid\n      if (!blob || blob.size === 0) {\n        throw new Error('Downloaded file is empty');\n      }\n\n      console.log('âœ… PDF fetched successfully, size:', (blob.size / 1024).toFixed(2), 'KB');\n\n      // Create download link\n      const downloadUrl = window.URL.createObjectURL(blob);\n      const link = document.createElement('a');\n      link.href = downloadUrl;\n      link.download = pdfUrl.split('/').pop() || 'neurosense-report.pdf';\n\n      // Trigger download\n      document.body.appendChild(link);\n      link.click();\n\n      // Cleanup\n      setTimeout(() => {\n        document.body.removeChild(link);\n        window.URL.revokeObjectURL(downloadUrl);\n      }, 100);\n\n      toast.success('PDF downloaded successfully!', { id: 'download-pdf' });\n\n    } catch (error) {\n      console.error('âŒ Download error:', {\n        error: error.message,\n        pdfUrl,\n        stack: error.stack\n      });\n\n      // Provide more helpful error messages\n      let errorMessage = 'Failed to download PDF';\n      if (error.message.includes('404')) {\n        errorMessage = 'PDF file not found on server';\n      } else if (error.message.includes('Failed to fetch')) {\n        errorMessage = 'Network error. Please check your connection.';\n      } else {\n        errorMessage = `Download failed: ${error.message}`;\n      }\n\n      toast.error(errorMessage, { id: 'download-pdf' });\n    }\n  };\n\n  const calculateAge = (dateOfBirth) => {\n    if (!dateOfBirth) return 'N/A';\n    const today = new Date();\n    const birthDate = new Date(dateOfBirth);\n    let age = today.getFullYear() - birthDate.getFullYear();\n    const monthDiff = today.getMonth() - birthDate.getMonth();\n    if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {\n      age--;\n    }\n    return age;\n  };\n\n  // Helper function to get color based on score\n  // 1/3 = Red, 2/3 = Yellow, 3/3 = Green\n  const getScoreColor = (rawScore) => {\n    if (!rawScore) return 'gray';\n\n    const [score, maxScore] = rawScore.split('/').map(Number);\n\n    if (score === 1) return 'red';      // 1/3\n    if (score === 2) return 'yellow';   // 2/3\n    if (score === 3) return 'green';    // 3/3\n\n    return 'gray';\n  };\n\n  const getStatusColor = (rawScore) => {\n    const color = getScoreColor(rawScore);\n    switch (color) {\n      case 'red': return 'text-red-500';\n      case 'yellow': return 'text-yellow-500';\n      case 'green': return 'text-green-500';\n      default: return 'text-gray-500';\n    }\n  };\n\n  const getStatusBgColor = (rawScore) => {\n    const color = getScoreColor(rawScore);\n    if (color === 'green') return 'bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-400';\n    if (color === 'yellow') return 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900/30 dark:text-yellow-400';\n    if (color === 'red') return 'bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-400';\n    return 'bg-gray-100 text-gray-800 dark:bg-gray-900/30 dark:text-gray-400';\n  };\n\n  const getProgressBarColor = (rawScore) => {\n    const color = getScoreColor(rawScore);\n    switch (color) {\n      case 'red': return 'bg-red-500';\n      case 'yellow': return 'bg-yellow-500';\n      case 'green': return 'bg-green-500';\n      default: return 'bg-gray-500';\n    }\n  };\n\n  if (loading) {\n    return (\n      <div className=\"flex items-center justify-center h-64\">\n        <div className=\"text-center\">\n          <div className=\"animate-spin rounded-full h-12 w-12 border-b-2 border-primary mx-auto\"></div>\n          <p className=\"mt-4 text-gray-600 dark:text-gray-400\">Loading patients...</p>\n        </div>\n      </div>\n    );\n  }\n\n  // Patient List View\n  if (!showProcessingUI) {\n    return (\n      <div className=\"space-y-6\">\n        {/* Header */}\n        <div className=\"bg-gradient-to-r from-primary to-navy-700 rounded-lg p-6 text-white shadow-lg\">\n          <h1 className=\"text-2xl font-bold\">NeuroSense - Algorithm 1 Data Processor</h1>\n          <p className=\"text-primary-light mt-2\">Select a patient to generate Algorithm 1 report</p>\n        </div>\n\n        {/* Filter Bar */}\n        <div className=\"bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 p-4\">\n          <div className=\"flex flex-col lg:flex-row gap-4\">\n            {/* Patient Search */}\n            <div className=\"flex-1\">\n              <label className=\"block text-xs font-medium text-gray-700 dark:text-gray-300 mb-1\">\n                Search Patient\n              </label>\n              <div className=\"relative\">\n                <Search className=\"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-gray-400 dark:text-gray-500\" />\n                <input\n                  type=\"text\"\n                  placeholder=\"Search by name or email...\"\n                  value={searchTerm}\n                  onChange={(e) => setSearchTerm(e.target.value)}\n                  className=\"w-full pl-10 pr-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-sm focus:outline-none focus:ring-2 focus:ring-primary\"\n                />\n              </div>\n            </div>\n\n            {/* Clinic Filter */}\n            <div className=\"flex-1\">\n              <label className=\"block text-xs font-medium text-gray-700 dark:text-gray-300 mb-1\">\n                Filter by Clinic\n              </label>\n              <div className=\"relative\">\n                <Building2 className=\"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-gray-400 dark:text-gray-500\" />\n                <select\n                  value={selectedClinicFilter}\n                  onChange={(e) => setSelectedClinicFilter(e.target.value)}\n                  className=\"w-full pl-10 pr-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-sm focus:outline-none focus:ring-2 focus:ring-primary appearance-none\"\n                >\n                  <option value=\"\">All Clinics</option>\n                  {clinics.map(clinic => (\n                    <option key={clinic.id} value={clinic.id}>\n                      {clinic.name}\n                    </option>\n                  ))}\n                </select>\n              </div>\n            </div>\n\n            {/* Date Filter */}\n            <div className=\"flex-1\">\n              <label className=\"block text-xs font-medium text-gray-700 dark:text-gray-300 mb-1\">\n                Filter by Date\n              </label>\n              <div className=\"relative\">\n                <Calendar className=\"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-gray-400 dark:text-gray-500\" />\n                <input\n                  type=\"date\"\n                  value={dateFilter}\n                  onChange={(e) => setDateFilter(e.target.value)}\n                  className=\"w-full pl-10 pr-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-sm focus:outline-none focus:ring-2 focus:ring-primary\"\n                />\n              </div>\n            </div>\n\n            {/* Clear Filters Button */}\n            {(searchTerm || selectedClinicFilter || dateFilter) && (\n              <div className=\"flex items-end\">\n                <button\n                  onClick={clearFilters}\n                  className=\"px-4 py-2 bg-gray-100 hover:bg-gray-200 dark:bg-gray-700 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-300 rounded-lg text-sm font-medium transition-colors flex items-center space-x-2\"\n                >\n                  <X className=\"h-4 w-4\" />\n                  <span>Clear</span>\n                </button>\n              </div>\n            )}\n          </div>\n\n          {/* Active Filters Display */}\n          {(searchTerm || selectedClinicFilter || dateFilter) && (\n            <div className=\"mt-3 flex flex-wrap gap-2\">\n              {searchTerm && (\n                <span className=\"inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-400\">\n                  Search: \"{searchTerm}\"\n                </span>\n              )}\n              {selectedClinicFilter && (\n                <span className=\"inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-purple-100 text-purple-800 dark:bg-purple-900/30 dark:text-purple-400\">\n                  Clinic: {clinics.find(c => c.id === selectedClinicFilter)?.name}\n                </span>\n              )}\n              {dateFilter && (\n                <span className=\"inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-400\">\n                  Date: {new Date(dateFilter).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}\n                </span>\n              )}\n              <span className=\"text-xs text-gray-500 dark:text-gray-400 self-center\">\n                ({filteredPatients.length} {filteredPatients.length === 1 ? 'patient' : 'patients'} found)\n              </span>\n            </div>\n          )}\n        </div>\n\n        {/* Patient List - Clinic-wise */}\n        <div className=\"space-y-4\">\n          {groupedPatients.length > 0 ? (\n            groupedPatients.map(({ clinic, patients: clinicPatients }) => (\n            <div key={clinic.id} className=\"bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700\">\n              {/* Clinic Header */}\n              <div className=\"bg-accent-light dark:bg-primary/20 border-b border-primary-light dark:border-primary px-6 py-3\">\n                <div className=\"flex items-center\">\n                  <Building2 className=\"h-5 w-5 text-primary mr-2\" />\n                  <h3 className=\"text-lg font-semibold text-gray-900 dark:text-white\">\n                    {clinic.name}\n                  </h3>\n                  <span className=\"ml-3 text-sm text-gray-600 dark:text-gray-400\">\n                    ({clinicPatients.length} {clinicPatients.length === 1 ? 'patient' : 'patients'})\n                  </span>\n                </div>\n              </div>\n\n              {/* Patient Table */}\n              <div className=\"overflow-x-auto\">\n                <table className=\"w-full\">\n                  <thead className=\"bg-gray-50 dark:bg-gray-700\">\n                    <tr>\n                      <th className=\"px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider\">\n                        Patient Name\n                      </th>\n                      <th className=\"px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider\">\n                        Email\n                      </th>\n                      <th className=\"px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider\">\n                        Previous Scans\n                      </th>\n                      <th className=\"px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider\">\n                        Status\n                      </th>\n                      <th className=\"px-6 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider\">\n                        Action\n                      </th>\n                    </tr>\n                  </thead>\n                  <tbody className=\"divide-y divide-gray-200 dark:divide-gray-700\">\n                    {clinicPatients.map(patient => (\n                      <tr key={patient.id} className=\"hover:bg-gray-50 dark:hover:bg-gray-700/50\">\n                        <td className=\"px-6 py-4 whitespace-nowrap\">\n                          <div className=\"flex items-center\">\n                            <User className=\"h-4 w-4 text-gray-400 dark:text-gray-500 mr-2\" />\n                            <span className=\"text-sm font-medium text-gray-900 dark:text-white\">\n                              {getPatientName(patient)}\n                            </span>\n                          </div>\n                        </td>\n                        <td className=\"px-6 py-4 whitespace-nowrap text-sm text-gray-600 dark:text-gray-400\">\n                          {patient.email || 'N/A'}\n                        </td>\n                        <td className=\"px-6 py-4 whitespace-nowrap text-sm text-gray-600 dark:text-gray-400\">\n                          <span className=\"flex items-center\">\n                            <History className=\"h-4 w-4 mr-1\" />\n                            {patient.totalScans || 0} {patient.totalScans === 1 ? 'scan' : 'scans'}\n                          </span>\n                        </td>\n                        <td className=\"px-6 py-4 whitespace-nowrap\">\n                          {getStatusBadge(patient.algorithmStatus, patient.lastProcessed)}\n                        </td>\n                        <td className=\"px-6 py-4 whitespace-nowrap text-right\">\n                          <button\n                            onClick={() => handleGenerateReport(patient)}\n                            className=\"bg-primary hover:bg-navy-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors shadow-md flex items-center ml-auto\"\n                          >\n                            <FileText className=\"h-4 w-4 mr-2\" />\n                            {patient.algorithmStatus === 'completed' ? 'View/Generate' : 'Generate Report'}\n                          </button>\n                        </td>\n                      </tr>\n                    ))}\n                  </tbody>\n                </table>\n              </div>\n            </div>\n            ))\n          ) : (\n            <div className=\"bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 p-12 text-center\">\n              <Filter className=\"h-16 w-16 text-gray-400 dark:text-gray-500 mx-auto mb-4\" />\n              <p className=\"text-gray-600 dark:text-gray-400 font-medium\">\n                {searchTerm || selectedClinicFilter || dateFilter\n                  ? 'No patients match your filters'\n                  : 'No patients found'\n                }\n              </p>\n              <p className=\"text-sm text-gray-500 dark:text-gray-500 mt-2\">\n                {searchTerm || selectedClinicFilter || dateFilter\n                  ? 'Try adjusting your search criteria or clear filters'\n                  : 'Patients will appear here once they are registered in the system'\n                }\n              </p>\n              {(searchTerm || selectedClinicFilter || dateFilter) && (\n                <button\n                  onClick={clearFilters}\n                  className=\"mt-4 px-4 py-2 bg-primary hover:bg-navy-700 text-white rounded-lg text-sm font-medium transition-colors\"\n                >\n                  Clear Filters\n                </button>\n              )}\n            </div>\n          )}\n        </div>\n      </div>\n    );\n  }\n\n  // Processing UI View\n  return (\n    <div className=\"space-y-6\">\n      {/* Header with Back Button */}\n      <div className=\"bg-gradient-to-r from-primary to-navy-700 rounded-lg p-6 text-white shadow-lg\">\n        <button\n          onClick={handleBackToList}\n          className=\"flex items-center text-primary-light hover:text-white mb-3 transition-colors\"\n        >\n          <ArrowLeft className=\"h-5 w-5 mr-2\" />\n          Back to Patient List\n        </button>\n        <h1 className=\"text-2xl font-bold\">NeuroSense - Algorithm 1 Data Processor</h1>\n        <div className=\"flex items-center gap-3 mt-2\">\n          <p className=\"text-primary-light\">\n            Processing for: <span className=\"font-semibold\">{getPatientName(selectedPatient)}</span> | {selectedPatient?.clinicName}\n          </p>\n          {dataType === 'zscore' && (\n            <span className=\"inline-flex items-center px-3 py-1 bg-purple-500/20 text-purple-200 text-xs font-medium rounded-full border border-purple-400/30\">\n              ðŸ”¬ Z-Score Mode\n            </span>\n          )}\n        </div>\n      </div>\n\n      {/* Main Content Grid */}\n      <div className=\"grid grid-cols-1 lg:grid-cols-3 gap-6\">\n        {/* Left Panel - QEEG Data Input */}\n        <div className=\"bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 p-6\">\n          <h2 className=\"text-lg font-semibold text-gray-900 dark:text-white mb-4\">\n            QEEG Data Input (Pages 13 & 24)\n          </h2>\n\n          {/* Eyes Open Upload */}\n          <div className=\"mb-6\">\n            <label className=\"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2\">\n              Page 13 (EO - Eyes Open)\n            </label>\n            <div className=\"relative border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-lg p-6 text-center hover:border-primary dark:hover:border-primary-light transition-colors\">\n              <input\n                type=\"file\"\n                accept=\".csv,.txt,.dat,.pdf\"\n                onChange={(e) => handleFileUpload('eo', e)}\n                className=\"absolute inset-0 w-full h-full opacity-0 cursor-pointer\"\n              />\n              <Upload className=\"h-12 w-12 text-gray-400 dark:text-gray-500 mx-auto mb-2\" />\n              <p className=\"text-sm text-gray-600 dark:text-gray-400\">\n                {eyesOpenFile ? eyesOpenFile.name : 'Drag & Drop or Click to Upload'}\n              </p>\n              {eyesOpenFile && (\n                <CheckCircle className=\"h-6 w-6 text-green-500 mx-auto mt-2\" />\n              )}\n            </div>\n          </div>\n\n          {/* Eyes Closed Upload */}\n          <div className=\"mb-6\">\n            <label className=\"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2\">\n              Page 24 (EC - Eyes Closed)\n            </label>\n            <div className=\"relative border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-lg p-6 text-center hover:border-primary dark:hover:border-primary-light transition-colors\">\n              <input\n                type=\"file\"\n                accept=\".csv,.txt,.dat,.pdf\"\n                onChange={(e) => handleFileUpload('ec', e)}\n                className=\"absolute inset-0 w-full h-full opacity-0 cursor-pointer\"\n              />\n              <Upload className=\"h-12 w-12 text-gray-400 dark:text-gray-500 mx-auto mb-2\" />\n              <p className=\"text-sm text-gray-600 dark:text-gray-400\">\n                {eyesClosedFile ? eyesClosedFile.name : 'Drag & Drop or Click to Upload'}\n              </p>\n              {eyesClosedFile && (\n                <CheckCircle className=\"h-6 w-6 text-green-500 mx-auto mt-2\" />\n              )}\n            </div>\n          </div>\n\n          {/* Data Loaded Progress */}\n          <div>\n            <label className=\"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2\">\n              Data Loaded\n            </label>\n            <div className=\"w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2.5\">\n              <div\n                className=\"bg-green-500 h-2.5 rounded-full transition-all duration-300\"\n                style={{ width: `${eyesOpenFile && eyesClosedFile ? 100 : eyesOpenFile || eyesClosedFile ? 50 : 0}%` }}\n              ></div>\n            </div>\n          </div>\n        </div>\n\n        {/* Middle Panel - Algorithm Processing */}\n        <div className=\"bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 p-6\">\n          <h2 className=\"text-lg font-semibold text-gray-900 dark:text-white mb-4\">\n            Algorithm 1 Processing\n          </h2>\n\n          {/* Execute Button */}\n          <button\n            onClick={handleExecuteCalculation}\n            disabled={!eyesOpenFile || !eyesClosedFile || isProcessing || isSaved}\n            className={`w-full mb-6 py-3 px-4 rounded-lg font-medium flex items-center justify-center space-x-2 transition-colors shadow-md ${\n              eyesOpenFile && eyesClosedFile && !isProcessing && !isSaved\n                ? 'bg-primary hover:bg-navy-700 text-white'\n                : 'bg-gray-300 dark:bg-gray-600 text-gray-500 dark:text-gray-400 cursor-not-allowed'\n            }`}\n          >\n            <Play className=\"h-5 w-5\" />\n            <span>Execute Calculation</span>\n          </button>\n\n          {/* Processing Animation */}\n          {isProcessing && (\n            <div className=\"bg-gradient-to-r from-primary to-navy-700 rounded-lg p-6 text-center mb-6 shadow-lg\">\n              <div className=\"relative inline-block\">\n                <Activity className=\"h-16 w-16 text-white animate-pulse\" />\n                <div className=\"absolute inset-0 flex items-center justify-center\">\n                  <div className=\"w-20 h-20 border-4 border-white/30 border-t-white rounded-full animate-spin\"></div>\n                </div>\n              </div>\n              <p className=\"text-white font-medium mt-4\">Processing...</p>\n              <p className=\"text-primary-light text-sm\">{consoleLog.length} actions done</p>\n            </div>\n          )}\n\n          {/* Processing Complete */}\n          {processingComplete && (\n            <div className=\"bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 rounded-lg p-4 text-center mb-6\">\n              <CheckCircle className=\"h-12 w-12 text-green-500 mx-auto mb-2\" />\n              <p className=\"text-green-800 dark:text-green-400 font-medium\">Processing Complete!</p>\n            </div>\n          )}\n\n          {/* Console */}\n          <div className=\"bg-gray-900 dark:bg-black rounded-lg p-4 min-h-[200px] max-h-[300px] overflow-y-auto\">\n            <div className=\"flex items-center justify-between mb-2 pb-2 border-b border-gray-700\">\n              <h3 className=\"text-sm font-medium text-gray-300\">Console</h3>\n              <button\n                onClick={() => setConsoleLog([])}\n                className=\"text-xs text-gray-400 hover:text-gray-200\"\n              >\n                Clear\n              </button>\n            </div>\n            <div className=\"space-y-1 font-mono text-xs\">\n              {consoleLog.length > 0 ? (\n                consoleLog.map((log, index) => (\n                  <div key={index} className=\"text-green-400\">\n                    &gt; {log}\n                  </div>\n                ))\n              ) : (\n                <div className=\"text-gray-500 italic\">Console output will appear here...</div>\n              )}\n            </div>\n          </div>\n        </div>\n\n        {/* Right Panel - Final 7 Parameter Scores */}\n        <div className=\"bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 p-6\">\n          <h2 className=\"text-lg font-semibold text-gray-900 dark:text-white mb-4\">\n            Final 7 Parameter Scores\n          </h2>\n\n          {results ? (\n            <>\n              <div className=\"space-y-4 mb-6\">\n                {results.map((result, index) => (\n                  <div key={index} className=\"border border-gray-200 dark:border-gray-700 rounded-lg p-3\">\n                    {/* Main Parameter */}\n                    <div className=\"flex items-center justify-between mb-2\">\n                      <span className=\"text-sm font-semibold text-gray-800 dark:text-gray-200\">\n                        {result.parameter}\n                      </span>\n                      <div className=\"flex items-center space-x-3\">\n                        <span className={`text-base font-bold ${getStatusColor(result.rawScore)}`}>\n                          {result.rawScore}\n                        </span>\n                        <span className={`text-xs px-2.5 py-1 rounded-full font-medium ${getStatusBgColor(result.rawScore)}`}>\n                          {result.status}\n                        </span>\n                      </div>\n                    </div>\n\n                    {/* Progress Bar */}\n                    <div className=\"flex-1 bg-gray-200 dark:bg-gray-700 rounded-full h-2 mb-3\">\n                      <div\n                        className={`h-2 rounded-full ${getProgressBarColor(result.rawScore)}`}\n                        style={{ width: `${result.score}%` }}\n                      ></div>\n                    </div>\n\n                    {/* Sub-Parameters */}\n                    {result.metrics && result.metrics.length > 0 && (\n                      <div className=\"mt-3 pt-3 border-t border-gray-200 dark:border-gray-700\">\n                        <div className=\"text-xs font-medium text-gray-600 dark:text-gray-400 mb-2\">\n                          Sub-Parameters:\n                        </div>\n                        <div className=\"space-y-2\">\n                          {result.metrics.map((metric, mIndex) => (\n                            <div key={mIndex} className=\"flex items-center justify-between text-xs pl-2\">\n                              <span className=\"text-gray-600 dark:text-gray-400 flex-1\">\n                                {metric.name}\n                              </span>\n                              <div className=\"flex items-center space-x-2\">\n                                {metric.score === 1 ? (\n                                  <CheckCircle className=\"h-3.5 w-3.5 text-green-500\" />\n                                ) : (\n                                  <X className=\"h-3.5 w-3.5 text-red-500\" />\n                                )}\n                                <span className={`font-medium ${metric.score === 1 ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400'}`}>\n                                  {metric.score}/1\n                                </span>\n                              </div>\n                            </div>\n                          ))}\n                        </div>\n                      </div>\n                    )}\n                  </div>\n                ))}\n              </div>\n\n              {/* Action Buttons */}\n              <div className=\"space-y-3\">\n                {/* Save and Download PDF Button */}\n                <button\n                  onClick={handleSaveResults}\n                  disabled={isSaving || isSaved}\n                  className={`w-full py-3 px-4 rounded-lg font-medium flex items-center justify-center space-x-2 transition-colors shadow-md ${\n                    isSaved\n                      ? 'bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-400 cursor-not-allowed'\n                      : isSaving\n                      ? 'bg-blue-400 text-white cursor-wait'\n                      : 'bg-primary hover:bg-navy-700 text-white'\n                  }`}\n                >\n                  {isSaving ? (\n                    <>\n                      <Activity className=\"h-5 w-5 animate-spin\" />\n                      <span>Saving...</span>\n                    </>\n                  ) : isSaved ? (\n                    <>\n                      <CheckCircle className=\"h-5 w-5\" />\n                      <span>Saved âœ“</span>\n                    </>\n                  ) : (\n                    <>\n                      <Download className=\"h-5 w-5\" />\n                      <span>NeuroSense Report Download</span>\n                    </>\n                  )}\n                </button>\n\n                {/* Export CSV Button */}\n                <button\n                  onClick={handleExportResults}\n                  className=\"w-full bg-green-600 hover:bg-green-700 text-white py-3 px-4 rounded-lg font-medium flex items-center justify-center space-x-2 transition-colors shadow-md\"\n                >\n                  <Download className=\"h-5 w-5\" />\n                  <span>Export CSV</span>\n                </button>\n              </div>\n            </>\n          ) : (\n            <div className=\"flex flex-col items-center justify-center py-12 text-center\">\n              <FileText className=\"h-16 w-16 text-gray-400 dark:text-gray-500 mb-4\" />\n              <p className=\"text-sm text-gray-600 dark:text-gray-400\">\n                Upload data files and execute calculation to see results\n              </p>\n            </div>\n          )}\n        </div>\n      </div>\n\n      {/* Processing History */}\n      {selectedPatient && processingHistory.length > 0 && (\n        <div className=\"bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 p-6\">\n          <div className=\"flex items-center justify-between mb-4\">\n            <h2 className=\"text-lg font-semibold text-gray-900 dark:text-white flex items-center\">\n              <History className=\"h-5 w-5 mr-2\" />\n              Processing History for {getPatientName(selectedPatient)}\n            </h2>\n            <button\n              onClick={async () => {\n                console.log('ðŸ”„ Manual sync triggered...');\n                toast.loading('Syncing PDFs from Supabase...', { id: 'sync-pdfs' });\n\n                try {\n                  // Force reload from database and sync\n                  await loadProcessingHistory(selectedPatient.id);\n\n                  // Count how many PDFs were found\n                  const results = await DatabaseService.get('algorithmResults');\n                  const patientResults = results.filter(r => r.patientId === selectedPatient.id);\n                  const pdfCount = patientResults.filter(r => r.pdfUrl).length;\n                  const totalCount = patientResults.length;\n\n                  toast.success(`âœ… Synced! ${pdfCount}/${totalCount} PDFs available`, { id: 'sync-pdfs' });\n                  console.log(`âœ… Sync complete: ${pdfCount}/${totalCount} records have PDFs`);\n                } catch (error) {\n                  console.error('âŒ Sync failed:', error);\n                  toast.error('Failed to sync PDFs', { id: 'sync-pdfs' });\n                }\n              }}\n              className=\"px-3 py-1.5 text-xs bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors flex items-center space-x-1\"\n              title=\"Fetch PDFs from Supabase bucket and update database\"\n            >\n              <Download className=\"h-3 w-3\" />\n              <span>Sync PDFs</span>\n            </button>\n          </div>\n          <div className=\"space-y-3\">\n            {processingHistory.map((record, index) => (\n              <div\n                key={record.id}\n                className=\"border border-gray-200 dark:border-gray-700 rounded-lg p-4 hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors\"\n              >\n                <div className=\"flex items-center justify-between\">\n                  <div className=\"flex-1\">\n                    <div className=\"flex items-center space-x-2 mb-2\">\n                      <Calendar className=\"h-4 w-4 text-primary\" />\n                      <span className=\"text-sm font-medium text-gray-900 dark:text-white\">\n                        {new Date(record.processedAt).toLocaleDateString('en-US', {\n                          year: 'numeric',\n                          month: 'short',\n                          day: 'numeric',\n                          hour: '2-digit',\n                          minute: '2-digit'\n                        })}\n                      </span>\n                      {/* PDF Status Badge */}\n                      {record.pdfUrl ? (\n                        <span className=\"px-2 py-0.5 text-xs bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-400 rounded-full flex items-center space-x-1\">\n                          <CheckCircle className=\"h-3 w-3\" />\n                          <span>PDF Available</span>\n                        </span>\n                      ) : (\n                        <span className=\"px-2 py-0.5 text-xs bg-gray-100 text-gray-600 dark:bg-gray-700 dark:text-gray-400 rounded-full\">\n                          No PDF\n                        </span>\n                      )}\n                    </div>\n                    <div className=\"text-xs text-gray-600 dark:text-gray-400 space-y-1 mb-3\">\n                      <p>ðŸ“ Files: {record.eyesOpenFile}, {record.eyesClosedFile}</p>\n                      <p>ðŸ‘¤ Processed by: {record.processedBy}</p>\n                      {record.pdfUrl && (\n                        <p className=\"text-green-600 dark:text-green-400\">\n                          ðŸ“„ PDF: {record.pdfUrl.startsWith('http') ? 'Supabase âœ“' : 'Local âœ“'}\n                        </p>\n                      )}\n                      {!record.pdfUrl && (\n                        <p className=\"text-red-600 dark:text-red-400\">ðŸ“„ PDF: Not available</p>\n                      )}\n                    </div>\n\n                    {/* Quick Summary of Results */}\n                    {record.results && record.results.length > 0 && (\n                      <div className=\"mt-3 grid grid-cols-2 gap-2\">\n                        {record.results.slice(0, 4).map((result, idx) => (\n                          <div key={idx} className=\"text-xs bg-gray-50 dark:bg-gray-700 rounded p-2\">\n                            <span className=\"text-gray-600 dark:text-gray-400\">{result.parameter}:</span>\n                            <span className={`ml-2 font-semibold ${getStatusColor(result.rawScore)}`}>\n                              {result.rawScore}\n                            </span>\n                          </div>\n                        ))}\n                      </div>\n                    )}\n                  </div>\n                  <div className=\"flex flex-col space-y-2\">\n                    {/* View Full Results Button */}\n                    <button\n                      onClick={() => {\n                        setResults(record.results);\n                        setProcessingComplete(true);\n                        setIsSaved(true);\n                        // Set PDF URL if available\n                        if (record.pdfUrl) {\n                          setPdfUrl(record.pdfUrl);\n                        }\n                        toast.success('Previous results loaded');\n                      }}\n                      className=\"px-3 py-2 text-sm bg-primary hover:bg-navy-700 text-white rounded-lg transition-colors flex items-center justify-center space-x-1\"\n                    >\n                      <FileText className=\"h-4 w-4\" />\n                      <span>View Results</span>\n                    </button>\n\n                    {/* Download PDF Button - Always visible */}\n                    <button\n                      onClick={async () => {\n                        if (!record.pdfUrl) {\n                          toast.error('No PDF available for this record');\n                          console.log('âŒ No PDF URL in record:', record);\n                          return;\n                        }\n\n                        console.log('ðŸ“¥ Downloading PDF from record:', {\n                          processedAt: record.processedAt,\n                          pdfUrl: record.pdfUrl\n                        });\n\n                        try {\n                          toast.loading('Downloading PDF...', { id: 'history-download' });\n\n                          // Construct full URL (works with both local and Supabase URLs)\n                          const apiUrl = import.meta.env.VITE_API_URL || 'http://localhost:3001/api';\n                          const backendBaseUrl = apiUrl.replace('/api', '');\n                          const fullPdfUrl = record.pdfUrl.startsWith('http') ? record.pdfUrl : `${backendBaseUrl}${record.pdfUrl}`;\n\n                          console.log('ðŸ“¥ Downloading from:', fullPdfUrl);\n\n                          // Fetch the PDF file\n                          const response = await fetch(fullPdfUrl);\n                          if (!response.ok) throw new Error('Failed to fetch PDF');\n\n                          // Convert to blob\n                          const blob = await response.blob();\n\n                          // Create download link\n                          const downloadUrl = window.URL.createObjectURL(blob);\n                          const link = document.createElement('a');\n                          link.href = downloadUrl;\n                          link.download = record.pdfUrl.split('/').pop() || 'neurosense-report.pdf';\n\n                          // Trigger download\n                          document.body.appendChild(link);\n                          link.click();\n\n                          // Cleanup\n                          document.body.removeChild(link);\n                          window.URL.revokeObjectURL(downloadUrl);\n\n                          toast.success('PDF downloaded successfully!', { id: 'history-download' });\n                        } catch (error) {\n                          console.error('Download error:', error);\n                          toast.error('Failed to download PDF', { id: 'history-download' });\n                        }\n                      }}\n                      disabled={!record.pdfUrl}\n                      className={`px-3 py-2 text-sm rounded-lg transition-colors flex items-center justify-center space-x-1 ${\n                        record.pdfUrl\n                          ? 'bg-blue-600 hover:bg-blue-700 text-white cursor-pointer'\n                          : 'bg-gray-300 dark:bg-gray-600 text-gray-500 dark:text-gray-400 cursor-not-allowed'\n                      }`}\n                      title={record.pdfUrl ? 'Download PDF Report' : 'No PDF available'}\n                    >\n                      <Download className=\"h-4 w-4\" />\n                      <span>NeuroSense Report</span>\n                    </button>\n                  </div>\n                </div>\n\n                {/* Expandable Details */}\n                {record.results && record.results.length > 4 && (\n                  <div className=\"mt-2 grid grid-cols-3 gap-2\">\n                    {record.results.slice(4).map((result, idx) => (\n                      <div key={idx} className=\"text-xs bg-gray-50 dark:bg-gray-700 rounded p-2\">\n                        <span className=\"text-gray-600 dark:text-gray-400\">{result.parameter}:</span>\n                        <span className={`ml-2 font-semibold ${getStatusColor(result.rawScore)}`}>\n                          {result.rawScore}\n                        </span>\n                      </div>\n                    ))}\n                  </div>\n                )}\n              </div>\n            ))}\n          </div>\n        </div>\n      )}\n\n      {/* Info Section */}\n      <div className=\"bg-accent-light dark:bg-primary/20 border border-primary-light dark:border-primary rounded-lg p-4 shadow-sm\">\n        <h3 className=\"text-sm font-medium text-primary dark:text-primary-light mb-2\">\n          About Algorithm 1 Processing\n        </h3>\n        <p className=\"text-sm text-navy-800 dark:text-gray-300\">\n          This processor analyzes QEEG data files (Eyes Open and Eyes Closed) and generates 7 key parameters using proprietary\n          binary scoring logic. The algorithm evaluates brain activity patterns to assess cognitive and emotional health markers.\n        </p>\n      </div>\n    </div>\n  );\n};\n\nexport default AlgorithmDataProcessor;\n","numLines":1689,"startLine":1,"totalLines":1689}}}
{"parentUuid":"34483089-50ca-4301-a72f-19294d528c10","isSidechain":true,"userType":"external","cwd":"D:\\Todays\\Neuro360","sessionId":"042556c2-8872-4445-8efb-d2658cbac4a7","version":"2.0.33","gitBranch":"main","agentId":"63bdb4e9","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01EeHZCs1EXu9EvqFEtKya49","type":"message","role":"assistant","content":[{"type":"text","text":"Now let me check the environment files and the Gemini service to understand the API configuration:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":16374,"cache_creation_input_tokens":27838,"cache_read_input_tokens":9033,"cache_creation":{"ephemeral_5m_input_tokens":27838,"ephemeral_1h_input_tokens":0},"output_tokens":215,"service_tier":"standard"}},"requestId":"req_011CVvcm1KXMzYNMvLiBfnrb","type":"assistant","uuid":"c2c7cdf1-3656-4a7d-ae05-01d8d3465222","timestamp":"2025-12-09T06:11:16.681Z"}
{"parentUuid":"c2c7cdf1-3656-4a7d-ae05-01d8d3465222","isSidechain":true,"userType":"external","cwd":"D:\\Todays\\Neuro360","sessionId":"042556c2-8872-4445-8efb-d2658cbac4a7","version":"2.0.33","gitBranch":"main","agentId":"63bdb4e9","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01EeHZCs1EXu9EvqFEtKya49","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01Co7oqqNC2hr9zrFTeatGVP","name":"Glob","input":{"pattern":"**/.env*"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":16374,"cache_creation_input_tokens":27838,"cache_read_input_tokens":9033,"cache_creation":{"ephemeral_5m_input_tokens":27838,"ephemeral_1h_input_tokens":0},"output_tokens":215,"service_tier":"standard"}},"requestId":"req_011CVvcm1KXMzYNMvLiBfnrb","type":"assistant","uuid":"d50f9d3b-ee9d-42c9-970f-233bfb631afb","timestamp":"2025-12-09T06:11:17.051Z"}
{"parentUuid":"d50f9d3b-ee9d-42c9-970f-233bfb631afb","isSidechain":true,"userType":"external","cwd":"D:\\Todays\\Neuro360","sessionId":"042556c2-8872-4445-8efb-d2658cbac4a7","version":"2.0.33","gitBranch":"main","agentId":"63bdb4e9","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01EeHZCs1EXu9EvqFEtKya49","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01TJSzDEjUb3ioiCLRZQXHZt","name":"Read","input":{"file_path":"D:\\Todays\\Neuro360\\server\\services\\geminiService.js"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":16374,"cache_creation_input_tokens":27838,"cache_read_input_tokens":9033,"cache_creation":{"ephemeral_5m_input_tokens":27838,"ephemeral_1h_input_tokens":0},"output_tokens":215,"service_tier":"standard"}},"requestId":"req_011CVvcm1KXMzYNMvLiBfnrb","type":"assistant","uuid":"0dbf72d8-db83-4008-99c6-52418959efbe","timestamp":"2025-12-09T06:11:17.990Z"}
{"parentUuid":"0dbf72d8-db83-4008-99c6-52418959efbe","isSidechain":true,"userType":"external","cwd":"D:\\Todays\\Neuro360","sessionId":"042556c2-8872-4445-8efb-d2658cbac4a7","version":"2.0.33","gitBranch":"main","agentId":"63bdb4e9","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01EeHZCs1EXu9EvqFEtKya49","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01USLzCKABm8wq1BfLVk7XMx","name":"Grep","input":{"pattern":"GEMINI_API_KEY|gemini|quota|429","output_mode":"content","-i":true}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":16374,"cache_creation_input_tokens":27838,"cache_read_input_tokens":9033,"cache_creation":{"ephemeral_5m_input_tokens":27838,"ephemeral_1h_input_tokens":0},"output_tokens":215,"service_tier":"standard"}},"requestId":"req_011CVvcm1KXMzYNMvLiBfnrb","type":"assistant","uuid":"a1fdef04-6650-4cd1-a73e-c45a074c0469","timestamp":"2025-12-09T06:11:19.126Z"}
{"parentUuid":"a1fdef04-6650-4cd1-a73e-c45a074c0469","isSidechain":true,"userType":"external","cwd":"D:\\Todays\\Neuro360","sessionId":"042556c2-8872-4445-8efb-d2658cbac4a7","version":"2.0.33","gitBranch":"main","agentId":"63bdb4e9","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01TJSzDEjUb3ioiCLRZQXHZt","type":"tool_result","content":"     1â†’const { GoogleGenerativeAI } = require('@google/generative-ai');\n     2â†’\n     3â†’class GeminiService {\n     4â†’  constructor() {\n     5â†’    console.log('\\nðŸ”§ Initializing Gemini Service...');\n     6â†’    this.apiKey = process.env.GEMINI_API_KEY;\n     7â†’\n     8â†’    if (!this.apiKey) {\n     9â†’      console.error('âŒ CRITICAL: GEMINI_API_KEY not found in environment variables!');\n    10â†’      console.error('   Please check your .env file');\n    11â†’    } else {\n    12â†’      console.log('âœ… Gemini API Key found');\n    13â†’      console.log('   Key length:', this.apiKey.length);\n    14â†’      console.log('   Key preview:', `${this.apiKey.substring(0, 15)}...`);\n    15â†’    }\n    16â†’\n    17â†’    this.genAI = this.apiKey ? new GoogleGenerativeAI(this.apiKey) : null;\n    18â†’    this.model = null;\n    19â†’    console.log('âœ… Gemini Service initialized\\n');\n    20â†’  }\n    21â†’\n    22â†’  /**\n    23â†’   * Fetch available Gemini models\n    24â†’   */\n    25â†’  async fetchAvailableModels() {\n    26â†’    try {\n    27â†’      console.log('ðŸ” Fetching available Gemini models for PDF generation...');\n    28â†’\n    29â†’      const response = await fetch(\n    30â†’        `https://generativelanguage.googleapis.com/v1/models?key=${this.apiKey}`\n    31â†’      );\n    32â†’\n    33â†’      if (!response.ok) {\n    34â†’        throw new Error(`API returned ${response.status}: ${response.statusText}`);\n    35â†’      }\n    36â†’\n    37â†’      const data = await response.json();\n    38â†’\n    39â†’      const supportedModels = (data.models || []).filter(model =>\n    40â†’        model.supportedGenerationMethods?.includes('generateContent')\n    41â†’      );\n    42â†’\n    43â†’      console.log(`âœ… Found ${supportedModels.length} models for PDF generation`);\n    44â†’      return supportedModels;\n    45â†’    } catch (error) {\n    46â†’      console.error('âŒ Failed to fetch models:', error.message);\n    47â†’      return [];\n    48â†’    }\n    49â†’  }\n    50â†’\n    51â†’  /**\n    52â†’   * Select best model for PDF generation\n    53â†’   */\n    54â†’  selectBestModel(models) {\n    55â†’    if (!models || models.length === 0) return null;\n    56â†’\n    57â†’    // Prefer Gemini 3 Pro Preview (latest model, best reasoning)\n    58â†’    // Fallback to Flash models for speed if 3 Pro unavailable\n    59â†’    const preferences = ['3-pro-preview', 'flash', 'pro'];\n    60â†’\n    61â†’    for (const preference of preferences) {\n    62â†’      const found = models.find(m =>\n    63â†’        m.name.toLowerCase().includes(preference)\n    64â†’      );\n    65â†’      if (found) {\n    66â†’        console.log(`âœ… Selected model for PDF: ${found.name}`);\n    67â†’        if (found.name.includes('3-pro')) {\n    68â†’          console.log('   ðŸš€ Using Gemini 3 Pro - Latest model with advanced reasoning');\n    69â†’        }\n    70â†’        return found.name;\n    71â†’      }\n    72â†’    }\n    73â†’\n    74â†’    console.log(`âœ… Using first available model: ${models[0].name}`);\n    75â†’    return models[0].name;\n    76â†’  }\n    77â†’\n    78â†’  /**\n    79â†’   * Initialize the Gemini model\n    80â†’   */\n    81â†’  async initModel() {\n    82â†’    if (!this.genAI) {\n    83â†’      throw new Error('Gemini API not initialized. Please check GEMINI_API_KEY.');\n    84â†’    }\n    85â†’\n    86â†’    console.log('ðŸ”§ Initializing Gemini model for PDF generation...');\n    87â†’    console.log('ðŸ”‘ API Key status:', this.apiKey ? 'Present' : 'MISSING');\n    88â†’\n    89â†’    // Fetch available models dynamically\n    90â†’    const availableModels = await this.fetchAvailableModels();\n    91â†’\n    92â†’    if (availableModels.length === 0) {\n    93â†’      console.error('\\nâŒ No models available for PDF generation!');\n    94â†’      console.error('Please check your GEMINI_API_KEY at https://aistudio.google.com/apikey\\n');\n    95â†’      throw new Error('No Gemini models available. Check your API key.');\n    96â†’    }\n    97â†’\n    98â†’    // Select best model\n    99â†’    const modelName = this.selectBestModel(availableModels);\n   100â†’\n   101â†’    if (!modelName) {\n   102â†’      throw new Error('Could not select a valid model for PDF generation');\n   103â†’    }\n   104â†’\n   105â†’    // Initialize model with full path and deterministic config\n   106â†’    console.log(`ðŸ”§ Initializing model: ${modelName}`);\n   107â†’    this.model = this.genAI.getGenerativeModel({\n   108â†’      model: modelName,\n   109â†’      generationConfig: {\n   110â†’        temperature: 0,      // Minimum randomness for deterministic generation\n   111â†’        topK: 1,            // Only pick most likely token\n   112â†’        topP: 1             // No nucleus sampling\n   113â†’      }\n   114â†’    });\n   115â†’\n   116â†’    // Test the model\n   117â†’    console.log('ðŸ“ž Testing model...');\n   118â†’    try {\n   119â†’      const testResult = await this.model.generateContent('Hello');\n   120â†’      const testResponse = await testResult.response;\n   121â†’      testResponse.text();\n   122â†’      console.log('âœ… Model initialized and tested successfully for PDF generation');\n   123â†’    } catch (testError) {\n   124â†’      console.error(`âŒ Model test failed:`, testError.message);\n   125â†’      throw new Error(`Failed to test model ${modelName}: ${testError.message}`);\n   126â†’    }\n   127â†’\n   128â†’    return this.model;\n   129â†’  }\n   130â†’\n   131â†’  /**\n   132â†’   * System prompt for brain performance report generation\n   133â†’   */\n   134â†’  getReportGenerationPrompt() {\n   135â†’    return `You are an expert neuroscience INFOGRAPHIC report generator powered by Gemini AI. Your primary task is to create a stunning, comprehensive, and visually captivating brain performance INFOGRAPHIC for patients.\n   136â†’\n   137â†’âš ï¸ CRITICAL INSTRUCTION BEFORE YOU START:\n   138â†’YOU MUST USE THE EXACT SCORES PROVIDED IN THE INPUT DATA. DO NOT generate or invent your own scores. The scores are calculated from real patient brain data and MUST be preserved EXACTLY as provided. Your job is ONLY to create interpretations and visualizations - NOT to calculate or modify scores.\n   139â†’\n   140â†’ðŸŽ¯ YOUR ROLE:\n   141â†’Generate a professional single-page A4 INFOGRAPHIC-STYLE brain health report based on QEEG (Quantitative Electroencephalography) analysis results. This is an INFOGRAPHIC, not a text document - prioritize visual presentation, clarity, and engaging design. The infographic must be informative yet accessible to non-medical readers.\n   142â†’\n   143â†’ðŸ“Š INPUT DATA:\n   144â†’You will receive 7 brain performance parameters with their ACTUAL CALCULATED SCORES, classifications, and sub-metrics:\n   145â†’1. **Cognition** - Mental processing, focus ability, and alpha-theta balance\n   146â†’2. **Stress** - Arousal levels, relaxation capacity, and regeneration ability\n   147â†’3. **Focus & Attention** - Concentration ability, theta levels, and mental alertness\n   148â†’4. **Burnout & Fatigue** - Energy levels, exhaustion markers, and delta wave patterns\n   149â†’5. **Emotional Regulation** - Mood stability, frontal alpha asymmetry, and emotional control\n   150â†’6. **Learning** - Cognitive flexibility, memory formation, and neural plasticity\n   151â†’7. **Creativity** - Divergent thinking, relaxation state, and innovative capacity\n   152â†’\n   153â†’ðŸ“‹ SCORING SYSTEM:\n   154â†’- Each parameter is scored from 0-3 points\n   155â†’- Classification: Low (0-1), Medium (2), High (3)\n   156â†’- Sub-metrics contribute individual points to the total score\n   157â†’- **Special Note**: For Stress and Burnout parameters, LOWER scores are BETTER (0/3 = Healthy, 3/3 = High Problem)\n   158â†’\n   159â†’ðŸŽ¨ INFOGRAPHIC DESIGN REQUIREMENTS:\n   160â†’\n   161â†’**REMEMBER: This is an INFOGRAPHIC - Visual Appeal is CRITICAL!**\n   162â†’\n   163â†’1. **Infographic Visual Design**:\n   164â†’   - INFOGRAPHIC-STYLE: Modern, clean, colorful, and engaging layout\n   165â†’   - Use vibrant but professional color palette throughout\n   166â†’   - Each parameter MUST have a distinct visual identity with unique colors\n   167â†’   - Bold, eye-catching icons and graphical elements for each brain function\n   168â†’   - Large, prominent score displays with visual progress indicators\n   169â†’   - Color-coded scoring badges/banners (Green = Optimal, Yellow = Moderate, Red = Needs Attention)\n   170â†’   - Think: Magazine infographic quality, not medical report\n   171â†’   - Visual hierarchy: Big scores â†’ Clear icons â†’ Short summaries â†’ Details\n   172â†’\n   173â†’2. **Content Structure**:\n   174â†’   - Patient-friendly language (avoid heavy medical jargon)\n   175â†’   - One-line impactful summary for each parameter\n   176â†’   - Clear explanation of what each metric means in daily life\n   177â†’   - Practical interpretation of scores\n   178â†’   - Holistic overall summary\n   179â†’\n   180â†’3. **Infographic Parameter Presentation**:\n   181â†’   - Parameter name in BOLD, LARGE font with matching icon\n   182â†’   - Score displayed PROMINENTLY (e.g., \"2/3 - Medium\") with colored background badge\n   183â†’   - Eye-catching color-coded badge/banner based on classification\n   184â†’   - Visual progress bar or circular indicator for scores\n   185â†’   - List all sub-metrics with bold checkmarks (âœ“) or crosses (âœ—)\n   186â†’   - Ultra-concise explanation for each sub-metric (1 sentence max)\n   187â†’   - Use boxes, borders, and visual separators for clarity\n   188â†’\n   189â†’4. **Color Coding Guidelines**:\n   190â†’   For HEALTH parameters (Cognition, Focus, Emotional Regulation, Learning, Creativity):\n   191â†’   - High (3/3): #38A169 (Green) - Excellent performance\n   192â†’   - Medium (2/3): #F59E0B (Amber) - Good, room for improvement\n   193â†’   - Low (0-1/3): #E53E3E (Red) - Needs attention\n   194â†’\n   195â†’   For PROBLEM parameters (Stress, Burnout):\n   196â†’   - Low (0/3): #38A169 (Green) - Healthy, no issues\n   197â†’   - Medium (1-2/3): #F59E0B (Amber) - Moderate concern\n   198â†’   - High (3/3): #E53E3E (Red) - High concern\n   199â†’\n   200â†’5. **Interpretations Guidelines**:\n   201â†’   - Explain what HIGH scores mean for each parameter\n   202â†’   - Explain what LOW scores mean\n   203â†’   - Connect brain metrics to real-life implications\n   204â†’   - Examples:\n   205â†’     * \"High Focus & Attention (3/3): Your brain shows excellent concentration ability and minimal distracting theta activity\"\n   206â†’     * \"Low Stress (0/3): Great news! Your brain shows healthy relaxation patterns and low arousal\"\n   207â†’     * \"Medium Cognition (2/3): Good cognitive function with room for optimization in alpha-theta balance\"\n   208â†’\n   209â†’6. **Sub-Metrics Explanation Examples**:\n   210â†’   - \"Focus Score (Theta:Beta Ratio): âœ“ Optimal - Your frontal brain regions show balanced activity for sustained attention\"\n   211â†’   - \"Relaxation Score: âœ— Below threshold - Your brain may have difficulty shifting into relaxed states\"\n   212â†’   - \"Alpha Peak: âœ“ Normal - Healthy alpha rhythm frequency indicates good brain maturation\"\n   213â†’\n   214â†’7. **Overall Summary Requirements**:\n   215â†’   - Synthesize all 7 parameters into a cohesive narrative\n   216â†’   - Highlight strengths and areas for improvement\n   217â†’   - Provide context about what the overall pattern suggests\n   218â†’   - Maintain encouraging and constructive tone\n   219â†’   - 3-5 sentences maximum\n   220â†’\n   221â†’8. **Recommendations**:\n   222â†’   - Provide 4-6 actionable, personalized recommendations\n   223â†’   - Base suggestions on the actual scores received\n   224â†’   - Include lifestyle, cognitive training, or mindfulness suggestions\n   225â†’   - Keep recommendations practical and achievable\n   226â†’\n   227â†’ðŸ“¤ OUTPUT FORMAT FOR INFOGRAPHIC:\n   228â†’\n   229â†’âš ï¸ REMEMBER: Use the EXACT score, maxScore, and bucket values from the INPUT DATA. Do not modify them!\n   230â†’\n   231â†’Return ONLY a valid JSON object (no markdown, no code blocks, no explanations) with this EXACT structure optimized for INFOGRAPHIC design:\n   232â†’\n   233â†’{\n   234â†’  \"title\": \"Brain Performance Infographic\",\n   235â†’  \"subtitle\": \"Visual Analysis of Your Brain Health Metrics\",\n   236â†’  \"patientSummary\": \"A comprehensive 3-5 sentence summary synthesizing all parameters, highlighting key strengths and areas for growth, with an encouraging and engaging tone suitable for an infographic\",\n   237â†’  \"parameters\": [\n   238â†’    {\n   239â†’      \"name\": \"Cognition\",\n   240â†’      \"score\": 2,  /* âš ï¸ USE EXACT SCORE FROM INPUT - this is just an example */\n   241â†’      \"maxScore\": 3,  /* âš ï¸ USE EXACT maxScore FROM INPUT */\n   242â†’      \"bucket\": \"Medium\",  /* âš ï¸ USE EXACT bucket FROM INPUT */\n   243â†’      \"bucketColor\": \"#F59E0B\",\n   244â†’      \"icon\": \"ðŸ§ \",\n   245â†’      \"summary\": \"One ultra-impactful, short sentence summarizing this parameter (infographic-style: punchy and clear)\",\n   246â†’      \"subparameters\": [\n   247â†’        {\n   248â†’          \"name\": \"Focus Score (Theta:Beta Ratio)\",\n   249â†’          \"score\": 1,  /* âš ï¸ USE EXACT SUBPARAMETER SCORE FROM INPUT */\n   250â†’          \"interpretation\": \"Clear, concise explanation (max 15 words) of what this score means\",\n   251â†’          \"details\": \"Technical detail: actual value and threshold\"\n   252â†’        }\n   253â†’      ]\n   254â†’    }\n   255â†’  ],\n   256â†’  \"recommendations\": [\n   257â†’    \"Specific actionable recommendation (concise, infographic-friendly)\",\n   258â†’    \"Another personalized suggestion (short and clear)\",\n   259â†’    \"Lifestyle tip (engaging and practical)\",\n   260â†’    \"Cognitive exercise or mindfulness practice (action-oriented)\"\n   261â†’  ],\n   262â†’  \"layoutSuggestions\": {\n   263â†’    \"colorScheme\": \"Vibrant infographic palette: Deep blue header (#323956), colorful parameter badges, white background (#FFFFFF), accent colors for visual interest\",\n   264â†’    \"structure\": \"Infographic grid layout: 2 columns for parameters with visual cards, bold header with title and patient info, eye-catching summary and recommendations section at bottom with icons\"\n   265â†’  }\n   266â†’}\n   267â†’\n   268â†’ðŸš¨ CRITICAL INFOGRAPHIC REQUIREMENTS:\n   269â†’1. THIS IS AN INFOGRAPHIC - Keep all text concise, punchy, and visual-friendly\n   270â†’2. Return PURE JSON only - no code blocks, no markdown, no extra text\n   271â†’3. Include ALL subparameters from input data - don't skip any\n   272â†’4. âš ï¸ CRITICAL: Use the EXACT score values from the input data - DO NOT generate your own scores\n   273â†’5. âš ï¸ CRITICAL: Copy the score, maxScore, and bucket values EXACTLY as provided in the input\n   274â†’6. Remember: For Stress and Burnout, LOW scores are GOOD, HIGH scores are CONCERNING\n   275â†’7. Each subparameter must have the EXACT score (0 or 1) from the input data\n   276â†’8. Icons should be colorful brain-related emojis: ðŸ§  ðŸ’¡ ðŸŽ¯ âš¡ ðŸ˜Œ ðŸ“š ðŸŽ¨ ðŸŒŸ âš–ï¸ ðŸ”¥ or similar\n   277â†’9. Make interpretations ultra-relatable - focus on real-world meaning, avoid EEG jargon\n   278â†’10. Ensure bucketColor uses VIBRANT, DISTINCT hex codes for infographic appeal\n   279â†’11. Overall tone: Engaging, visual, magazine-quality infographic style\n   280â†’12. Summaries: Short, impactful, easy to scan (think social media infographic)\n   281â†’13. âš ï¸ DO NOT INVENT OR MODIFY SCORES - Use input data scores verbatim!\n   282â†’\n   283â†’âœ¨ INFOGRAPHIC QUALITY CHECKLIST:\n   284â†’- âš ï¸ Did you copy the EXACT score values from the input data without modification?\n   285â†’- âš ï¸ Did you use the EXACT bucket/classification from the input data?\n   286â†’- Are all 7 parameters included with distinct visual identities?\n   287â†’- Do all parameters have their sub-metrics listed with visual indicators?\n   288â†’- Are interpretations ultra-concise and infographic-friendly (no long paragraphs)?\n   289â†’- Is the color coding vibrant and correct (especially for Stress/Burnout inverse scoring)?\n   290â†’- Does the summary provide a holistic view in an engaging, scannable format?\n   291â†’- Are recommendations specific, actionable, and infographic-ready?\n   292â†’- Is the overall design ready for a beautiful, magazine-quality infographic?\n   293â†’\n   294â†’âš ï¸ FINAL REMINDER: Your ONLY job is to create interpretations and visual suggestions. The scores are ALREADY CALCULATED from real brain data. Copy them EXACTLY as provided!\n   295â†’\n   296â†’Generate the INFOGRAPHIC report now based on the brain parameters data provided below. Remember: INFOGRAPHIC = Visual, Colorful, Concise, Engaging!`;\n   297â†’  }\n   298â†’\n   299â†’  /**\n   300â†’   * Generate brain performance report using Gemini AI\n   301â†’   * @param {Object} brainParameters - The 7 brain parameters with scores and buckets\n   302â†’   * @returns {Promise<Object>} Generated report structure\n   303â†’   */\n   304â†’  async generateBrainPerformanceReport(brainParameters) {\n   305â†’    try {\n   306â†’      console.log('\\nðŸ”‘ Checking Gemini API configuration...');\n   307â†’      console.log('   API Key exists:', !!this.apiKey);\n   308â†’      console.log('   API Key length:', this.apiKey ? this.apiKey.length : 0);\n   309â†’      console.log('   API Key preview:', this.apiKey ? `${this.apiKey.substring(0, 10)}...` : 'MISSING');\n   310â†’\n   311â†’      if (!this.model) {\n   312â†’        console.log('ðŸ“± Initializing Gemini model...');\n   313â†’        await this.initModel();\n   314â†’      }\n   315â†’\n   316â†’      console.log('\\nðŸ¤– Generating brain performance report with Gemini AI...');\n   317â†’      console.log('ðŸ“Š Input parameters count:', Object.keys(brainParameters).length);\n   318â†’\n   319â†’      // Log actual scores being sent\n   320â†’      console.log('ðŸ“Š ACTUAL SCORES BEING SENT TO GEMINI:');\n   321â†’      Object.keys(brainParameters).forEach(key => {\n   322â†’        const param = brainParameters[key];\n   323â†’        if (param && param.score !== undefined) {\n   324â†’          console.log(`   ${key}: ${param.score}/${param.maxScore} (${param.bucket})`);\n   325â†’        }\n   326â†’      });\n   327â†’\n   328â†’      // Create the prompt with system instructions and data\n   329â†’      const systemPrompt = this.getReportGenerationPrompt();\n   330â†’      const dataPrompt = `\\n\\nâš ï¸ CRITICAL: Use these EXACT scores - do not modify them!\\n\\nBrain Parameters Data:\\n${JSON.stringify(brainParameters, null, 2)}\\n\\nâš ï¸ REMINDER: Copy the score, maxScore, and bucket values EXACTLY as shown above. Do not generate your own scores!\\n\\nPlease generate the infographic report description in JSON format as specified.`;\n   331â†’\n   332â†’      const fullPrompt = systemPrompt + dataPrompt;\n   333â†’      console.log('ðŸ“ Prompt length:', fullPrompt.length, 'characters');\n   334â†’\n   335â†’      // Generate content\n   336â†’      console.log('â³ Calling Gemini API...');\n   337â†’      const result = await this.model.generateContent(fullPrompt);\n   338â†’      const response = await result.response;\n   339â†’      const text = response.text();\n   340â†’\n   341â†’      console.log('âœ… Gemini response received!');\n   342â†’      console.log('   Response length:', text.length, 'characters');\n   343â†’\n   344â†’      // Try to parse JSON from the response\n   345â†’      let reportData;\n   346â†’      try {\n   347â†’        // Remove markdown code blocks if present\n   348â†’        const jsonText = text.replace(/```json\\n?/g, '').replace(/```\\n?/g, '').trim();\n   349â†’        reportData = JSON.parse(jsonText);\n   350â†’\n   351â†’        // Log what Gemini returned\n   352â†’        console.log('\\nðŸ“Š SCORES RETURNED BY GEMINI:');\n   353â†’        if (reportData.parameters) {\n   354â†’          reportData.parameters.forEach(param => {\n   355â†’            console.log(`   ${param.name}: ${param.score}/${param.maxScore} (${param.bucket})`);\n   356â†’          });\n   357â†’\n   358â†’          // VALIDATION: Check if Gemini changed the scores\n   359â†’          console.log('\\nðŸ” VALIDATING SCORES (Input vs Gemini Output):');\n   360â†’          reportData.parameters.forEach(param => {\n   361â†’            const paramKey = param.name.replace(/\\s+/g, '');\n   362â†’            const inputParam = brainParameters[paramKey];\n   363â†’            if (inputParam) {\n   364â†’              const scoreMatch = inputParam.score === param.score;\n   365â†’              const bucketMatch = inputParam.bucket === param.bucket;\n   366â†’              if (!scoreMatch || !bucketMatch) {\n   367â†’                console.log(`   âš ï¸ MISMATCH for ${param.name}:`);\n   368â†’                console.log(`      Input:  score=${inputParam.score}, bucket=${inputParam.bucket}`);\n   369â†’                console.log(`      Gemini: score=${param.score}, bucket=${param.bucket}`);\n   370â†’              } else {\n   371â†’                console.log(`   âœ… ${param.name}: Scores match correctly`);\n   372â†’              }\n   373â†’            }\n   374â†’          });\n   375â†’        }\n   376â†’      } catch (parseError) {\n   377â†’        console.error('Failed to parse JSON response:', parseError);\n   378â†’        // Return raw text if JSON parsing fails\n   379â†’        reportData = {\n   380â†’          title: 'Brain Performance Report',\n   381â†’          rawContent: text,\n   382â†’          parameters: [],\n   383â†’          error: 'Failed to parse structured response'\n   384â†’        };\n   385â†’      }\n   386â†’\n   387â†’      return {\n   388â†’        success: true,\n   389â†’        data: reportData,\n   390â†’        rawResponse: text\n   391â†’      };\n   392â†’\n   393â†’    } catch (error) {\n   394â†’      console.error('\\nâŒ === GEMINI API ERROR ===');\n   395â†’      console.error('Error Type:', error.constructor.name);\n   396â†’      console.error('Error Message:', error.message);\n   397â†’      console.error('Error Code:', error.code || 'N/A');\n   398â†’      console.error('Error Status:', error.status || 'N/A');\n   399â†’      console.error('Full Error:', JSON.stringify(error, null, 2));\n   400â†’      console.error('Stack:', error.stack);\n   401â†’      console.error('==========================\\n');\n   402â†’\n   403â†’      return {\n   404â†’        success: false,\n   405â†’        error: error.message,\n   406â†’        errorDetails: {\n   407â†’          type: error.constructor.name,\n   408â†’          code: error.code,\n   409â†’          status: error.status\n   410â†’        },\n   411â†’        data: null\n   412â†’      };\n   413â†’    }\n   414â†’  }\n   415â†’\n   416â†’  /**\n   417â†’   * Generate simple text completion\n   418â†’   * @param {string} prompt - The prompt text\n   419â†’   * @returns {Promise<string>} Generated text\n   420â†’   */\n   421â†’  async generateText(prompt) {\n   422â†’    try {\n   423â†’      if (!this.model) {\n   424â†’        await this.initModel();\n   425â†’      }\n   426â†’\n   427â†’      const result = await this.model.generateContent(prompt);\n   428â†’      const response = await result.response;\n   429â†’      return response.text();\n   430â†’\n   431â†’    } catch (error) {\n   432â†’      console.error('Error generating text with Gemini:', error);\n   433â†’      throw error;\n   434â†’    }\n   435â†’  }\n   436â†’\n   437â†’  /**\n   438â†’   * Test Gemini API connection\n   439â†’   */\n   440â†’  async testConnection() {\n   441â†’    try {\n   442â†’      const response = await this.generateText('Hello! Please respond with \"OK\" if you can read this.');\n   443â†’      console.log('Gemini API test response:', response);\n   444â†’      return { success: true, response };\n   445â†’    } catch (error) {\n   446â†’      console.error('Gemini API test failed:', error);\n   447â†’      return { success: false, error: error.message };\n   448â†’    }\n   449â†’  }\n   450â†’}\n   451â†’\n   452â†’module.exports = new GeminiService();\n   453â†’\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"13d8dd00-ffe8-4300-8793-10f9ab699dd6","timestamp":"2025-12-09T06:11:25.860Z","toolUseResult":{"type":"text","file":{"filePath":"D:\\Todays\\Neuro360\\server\\services\\geminiService.js","content":"const { GoogleGenerativeAI } = require('@google/generative-ai');\n\nclass GeminiService {\n  constructor() {\n    console.log('\\nðŸ”§ Initializing Gemini Service...');\n    this.apiKey = process.env.GEMINI_API_KEY;\n\n    if (!this.apiKey) {\n      console.error('âŒ CRITICAL: GEMINI_API_KEY not found in environment variables!');\n      console.error('   Please check your .env file');\n    } else {\n      console.log('âœ… Gemini API Key found');\n      console.log('   Key length:', this.apiKey.length);\n      console.log('   Key preview:', `${this.apiKey.substring(0, 15)}...`);\n    }\n\n    this.genAI = this.apiKey ? new GoogleGenerativeAI(this.apiKey) : null;\n    this.model = null;\n    console.log('âœ… Gemini Service initialized\\n');\n  }\n\n  /**\n   * Fetch available Gemini models\n   */\n  async fetchAvailableModels() {\n    try {\n      console.log('ðŸ” Fetching available Gemini models for PDF generation...');\n\n      const response = await fetch(\n        `https://generativelanguage.googleapis.com/v1/models?key=${this.apiKey}`\n      );\n\n      if (!response.ok) {\n        throw new Error(`API returned ${response.status}: ${response.statusText}`);\n      }\n\n      const data = await response.json();\n\n      const supportedModels = (data.models || []).filter(model =>\n        model.supportedGenerationMethods?.includes('generateContent')\n      );\n\n      console.log(`âœ… Found ${supportedModels.length} models for PDF generation`);\n      return supportedModels;\n    } catch (error) {\n      console.error('âŒ Failed to fetch models:', error.message);\n      return [];\n    }\n  }\n\n  /**\n   * Select best model for PDF generation\n   */\n  selectBestModel(models) {\n    if (!models || models.length === 0) return null;\n\n    // Prefer Gemini 3 Pro Preview (latest model, best reasoning)\n    // Fallback to Flash models for speed if 3 Pro unavailable\n    const preferences = ['3-pro-preview', 'flash', 'pro'];\n\n    for (const preference of preferences) {\n      const found = models.find(m =>\n        m.name.toLowerCase().includes(preference)\n      );\n      if (found) {\n        console.log(`âœ… Selected model for PDF: ${found.name}`);\n        if (found.name.includes('3-pro')) {\n          console.log('   ðŸš€ Using Gemini 3 Pro - Latest model with advanced reasoning');\n        }\n        return found.name;\n      }\n    }\n\n    console.log(`âœ… Using first available model: ${models[0].name}`);\n    return models[0].name;\n  }\n\n  /**\n   * Initialize the Gemini model\n   */\n  async initModel() {\n    if (!this.genAI) {\n      throw new Error('Gemini API not initialized. Please check GEMINI_API_KEY.');\n    }\n\n    console.log('ðŸ”§ Initializing Gemini model for PDF generation...');\n    console.log('ðŸ”‘ API Key status:', this.apiKey ? 'Present' : 'MISSING');\n\n    // Fetch available models dynamically\n    const availableModels = await this.fetchAvailableModels();\n\n    if (availableModels.length === 0) {\n      console.error('\\nâŒ No models available for PDF generation!');\n      console.error('Please check your GEMINI_API_KEY at https://aistudio.google.com/apikey\\n');\n      throw new Error('No Gemini models available. Check your API key.');\n    }\n\n    // Select best model\n    const modelName = this.selectBestModel(availableModels);\n\n    if (!modelName) {\n      throw new Error('Could not select a valid model for PDF generation');\n    }\n\n    // Initialize model with full path and deterministic config\n    console.log(`ðŸ”§ Initializing model: ${modelName}`);\n    this.model = this.genAI.getGenerativeModel({\n      model: modelName,\n      generationConfig: {\n        temperature: 0,      // Minimum randomness for deterministic generation\n        topK: 1,            // Only pick most likely token\n        topP: 1             // No nucleus sampling\n      }\n    });\n\n    // Test the model\n    console.log('ðŸ“ž Testing model...');\n    try {\n      const testResult = await this.model.generateContent('Hello');\n      const testResponse = await testResult.response;\n      testResponse.text();\n      console.log('âœ… Model initialized and tested successfully for PDF generation');\n    } catch (testError) {\n      console.error(`âŒ Model test failed:`, testError.message);\n      throw new Error(`Failed to test model ${modelName}: ${testError.message}`);\n    }\n\n    return this.model;\n  }\n\n  /**\n   * System prompt for brain performance report generation\n   */\n  getReportGenerationPrompt() {\n    return `You are an expert neuroscience INFOGRAPHIC report generator powered by Gemini AI. Your primary task is to create a stunning, comprehensive, and visually captivating brain performance INFOGRAPHIC for patients.\n\nâš ï¸ CRITICAL INSTRUCTION BEFORE YOU START:\nYOU MUST USE THE EXACT SCORES PROVIDED IN THE INPUT DATA. DO NOT generate or invent your own scores. The scores are calculated from real patient brain data and MUST be preserved EXACTLY as provided. Your job is ONLY to create interpretations and visualizations - NOT to calculate or modify scores.\n\nðŸŽ¯ YOUR ROLE:\nGenerate a professional single-page A4 INFOGRAPHIC-STYLE brain health report based on QEEG (Quantitative Electroencephalography) analysis results. This is an INFOGRAPHIC, not a text document - prioritize visual presentation, clarity, and engaging design. The infographic must be informative yet accessible to non-medical readers.\n\nðŸ“Š INPUT DATA:\nYou will receive 7 brain performance parameters with their ACTUAL CALCULATED SCORES, classifications, and sub-metrics:\n1. **Cognition** - Mental processing, focus ability, and alpha-theta balance\n2. **Stress** - Arousal levels, relaxation capacity, and regeneration ability\n3. **Focus & Attention** - Concentration ability, theta levels, and mental alertness\n4. **Burnout & Fatigue** - Energy levels, exhaustion markers, and delta wave patterns\n5. **Emotional Regulation** - Mood stability, frontal alpha asymmetry, and emotional control\n6. **Learning** - Cognitive flexibility, memory formation, and neural plasticity\n7. **Creativity** - Divergent thinking, relaxation state, and innovative capacity\n\nðŸ“‹ SCORING SYSTEM:\n- Each parameter is scored from 0-3 points\n- Classification: Low (0-1), Medium (2), High (3)\n- Sub-metrics contribute individual points to the total score\n- **Special Note**: For Stress and Burnout parameters, LOWER scores are BETTER (0/3 = Healthy, 3/3 = High Problem)\n\nðŸŽ¨ INFOGRAPHIC DESIGN REQUIREMENTS:\n\n**REMEMBER: This is an INFOGRAPHIC - Visual Appeal is CRITICAL!**\n\n1. **Infographic Visual Design**:\n   - INFOGRAPHIC-STYLE: Modern, clean, colorful, and engaging layout\n   - Use vibrant but professional color palette throughout\n   - Each parameter MUST have a distinct visual identity with unique colors\n   - Bold, eye-catching icons and graphical elements for each brain function\n   - Large, prominent score displays with visual progress indicators\n   - Color-coded scoring badges/banners (Green = Optimal, Yellow = Moderate, Red = Needs Attention)\n   - Think: Magazine infographic quality, not medical report\n   - Visual hierarchy: Big scores â†’ Clear icons â†’ Short summaries â†’ Details\n\n2. **Content Structure**:\n   - Patient-friendly language (avoid heavy medical jargon)\n   - One-line impactful summary for each parameter\n   - Clear explanation of what each metric means in daily life\n   - Practical interpretation of scores\n   - Holistic overall summary\n\n3. **Infographic Parameter Presentation**:\n   - Parameter name in BOLD, LARGE font with matching icon\n   - Score displayed PROMINENTLY (e.g., \"2/3 - Medium\") with colored background badge\n   - Eye-catching color-coded badge/banner based on classification\n   - Visual progress bar or circular indicator for scores\n   - List all sub-metrics with bold checkmarks (âœ“) or crosses (âœ—)\n   - Ultra-concise explanation for each sub-metric (1 sentence max)\n   - Use boxes, borders, and visual separators for clarity\n\n4. **Color Coding Guidelines**:\n   For HEALTH parameters (Cognition, Focus, Emotional Regulation, Learning, Creativity):\n   - High (3/3): #38A169 (Green) - Excellent performance\n   - Medium (2/3): #F59E0B (Amber) - Good, room for improvement\n   - Low (0-1/3): #E53E3E (Red) - Needs attention\n\n   For PROBLEM parameters (Stress, Burnout):\n   - Low (0/3): #38A169 (Green) - Healthy, no issues\n   - Medium (1-2/3): #F59E0B (Amber) - Moderate concern\n   - High (3/3): #E53E3E (Red) - High concern\n\n5. **Interpretations Guidelines**:\n   - Explain what HIGH scores mean for each parameter\n   - Explain what LOW scores mean\n   - Connect brain metrics to real-life implications\n   - Examples:\n     * \"High Focus & Attention (3/3): Your brain shows excellent concentration ability and minimal distracting theta activity\"\n     * \"Low Stress (0/3): Great news! Your brain shows healthy relaxation patterns and low arousal\"\n     * \"Medium Cognition (2/3): Good cognitive function with room for optimization in alpha-theta balance\"\n\n6. **Sub-Metrics Explanation Examples**:\n   - \"Focus Score (Theta:Beta Ratio): âœ“ Optimal - Your frontal brain regions show balanced activity for sustained attention\"\n   - \"Relaxation Score: âœ— Below threshold - Your brain may have difficulty shifting into relaxed states\"\n   - \"Alpha Peak: âœ“ Normal - Healthy alpha rhythm frequency indicates good brain maturation\"\n\n7. **Overall Summary Requirements**:\n   - Synthesize all 7 parameters into a cohesive narrative\n   - Highlight strengths and areas for improvement\n   - Provide context about what the overall pattern suggests\n   - Maintain encouraging and constructive tone\n   - 3-5 sentences maximum\n\n8. **Recommendations**:\n   - Provide 4-6 actionable, personalized recommendations\n   - Base suggestions on the actual scores received\n   - Include lifestyle, cognitive training, or mindfulness suggestions\n   - Keep recommendations practical and achievable\n\nðŸ“¤ OUTPUT FORMAT FOR INFOGRAPHIC:\n\nâš ï¸ REMEMBER: Use the EXACT score, maxScore, and bucket values from the INPUT DATA. Do not modify them!\n\nReturn ONLY a valid JSON object (no markdown, no code blocks, no explanations) with this EXACT structure optimized for INFOGRAPHIC design:\n\n{\n  \"title\": \"Brain Performance Infographic\",\n  \"subtitle\": \"Visual Analysis of Your Brain Health Metrics\",\n  \"patientSummary\": \"A comprehensive 3-5 sentence summary synthesizing all parameters, highlighting key strengths and areas for growth, with an encouraging and engaging tone suitable for an infographic\",\n  \"parameters\": [\n    {\n      \"name\": \"Cognition\",\n      \"score\": 2,  /* âš ï¸ USE EXACT SCORE FROM INPUT - this is just an example */\n      \"maxScore\": 3,  /* âš ï¸ USE EXACT maxScore FROM INPUT */\n      \"bucket\": \"Medium\",  /* âš ï¸ USE EXACT bucket FROM INPUT */\n      \"bucketColor\": \"#F59E0B\",\n      \"icon\": \"ðŸ§ \",\n      \"summary\": \"One ultra-impactful, short sentence summarizing this parameter (infographic-style: punchy and clear)\",\n      \"subparameters\": [\n        {\n          \"name\": \"Focus Score (Theta:Beta Ratio)\",\n          \"score\": 1,  /* âš ï¸ USE EXACT SUBPARAMETER SCORE FROM INPUT */\n          \"interpretation\": \"Clear, concise explanation (max 15 words) of what this score means\",\n          \"details\": \"Technical detail: actual value and threshold\"\n        }\n      ]\n    }\n  ],\n  \"recommendations\": [\n    \"Specific actionable recommendation (concise, infographic-friendly)\",\n    \"Another personalized suggestion (short and clear)\",\n    \"Lifestyle tip (engaging and practical)\",\n    \"Cognitive exercise or mindfulness practice (action-oriented)\"\n  ],\n  \"layoutSuggestions\": {\n    \"colorScheme\": \"Vibrant infographic palette: Deep blue header (#323956), colorful parameter badges, white background (#FFFFFF), accent colors for visual interest\",\n    \"structure\": \"Infographic grid layout: 2 columns for parameters with visual cards, bold header with title and patient info, eye-catching summary and recommendations section at bottom with icons\"\n  }\n}\n\nðŸš¨ CRITICAL INFOGRAPHIC REQUIREMENTS:\n1. THIS IS AN INFOGRAPHIC - Keep all text concise, punchy, and visual-friendly\n2. Return PURE JSON only - no code blocks, no markdown, no extra text\n3. Include ALL subparameters from input data - don't skip any\n4. âš ï¸ CRITICAL: Use the EXACT score values from the input data - DO NOT generate your own scores\n5. âš ï¸ CRITICAL: Copy the score, maxScore, and bucket values EXACTLY as provided in the input\n6. Remember: For Stress and Burnout, LOW scores are GOOD, HIGH scores are CONCERNING\n7. Each subparameter must have the EXACT score (0 or 1) from the input data\n8. Icons should be colorful brain-related emojis: ðŸ§  ðŸ’¡ ðŸŽ¯ âš¡ ðŸ˜Œ ðŸ“š ðŸŽ¨ ðŸŒŸ âš–ï¸ ðŸ”¥ or similar\n9. Make interpretations ultra-relatable - focus on real-world meaning, avoid EEG jargon\n10. Ensure bucketColor uses VIBRANT, DISTINCT hex codes for infographic appeal\n11. Overall tone: Engaging, visual, magazine-quality infographic style\n12. Summaries: Short, impactful, easy to scan (think social media infographic)\n13. âš ï¸ DO NOT INVENT OR MODIFY SCORES - Use input data scores verbatim!\n\nâœ¨ INFOGRAPHIC QUALITY CHECKLIST:\n- âš ï¸ Did you copy the EXACT score values from the input data without modification?\n- âš ï¸ Did you use the EXACT bucket/classification from the input data?\n- Are all 7 parameters included with distinct visual identities?\n- Do all parameters have their sub-metrics listed with visual indicators?\n- Are interpretations ultra-concise and infographic-friendly (no long paragraphs)?\n- Is the color coding vibrant and correct (especially for Stress/Burnout inverse scoring)?\n- Does the summary provide a holistic view in an engaging, scannable format?\n- Are recommendations specific, actionable, and infographic-ready?\n- Is the overall design ready for a beautiful, magazine-quality infographic?\n\nâš ï¸ FINAL REMINDER: Your ONLY job is to create interpretations and visual suggestions. The scores are ALREADY CALCULATED from real brain data. Copy them EXACTLY as provided!\n\nGenerate the INFOGRAPHIC report now based on the brain parameters data provided below. Remember: INFOGRAPHIC = Visual, Colorful, Concise, Engaging!`;\n  }\n\n  /**\n   * Generate brain performance report using Gemini AI\n   * @param {Object} brainParameters - The 7 brain parameters with scores and buckets\n   * @returns {Promise<Object>} Generated report structure\n   */\n  async generateBrainPerformanceReport(brainParameters) {\n    try {\n      console.log('\\nðŸ”‘ Checking Gemini API configuration...');\n      console.log('   API Key exists:', !!this.apiKey);\n      console.log('   API Key length:', this.apiKey ? this.apiKey.length : 0);\n      console.log('   API Key preview:', this.apiKey ? `${this.apiKey.substring(0, 10)}...` : 'MISSING');\n\n      if (!this.model) {\n        console.log('ðŸ“± Initializing Gemini model...');\n        await this.initModel();\n      }\n\n      console.log('\\nðŸ¤– Generating brain performance report with Gemini AI...');\n      console.log('ðŸ“Š Input parameters count:', Object.keys(brainParameters).length);\n\n      // Log actual scores being sent\n      console.log('ðŸ“Š ACTUAL SCORES BEING SENT TO GEMINI:');\n      Object.keys(brainParameters).forEach(key => {\n        const param = brainParameters[key];\n        if (param && param.score !== undefined) {\n          console.log(`   ${key}: ${param.score}/${param.maxScore} (${param.bucket})`);\n        }\n      });\n\n      // Create the prompt with system instructions and data\n      const systemPrompt = this.getReportGenerationPrompt();\n      const dataPrompt = `\\n\\nâš ï¸ CRITICAL: Use these EXACT scores - do not modify them!\\n\\nBrain Parameters Data:\\n${JSON.stringify(brainParameters, null, 2)}\\n\\nâš ï¸ REMINDER: Copy the score, maxScore, and bucket values EXACTLY as shown above. Do not generate your own scores!\\n\\nPlease generate the infographic report description in JSON format as specified.`;\n\n      const fullPrompt = systemPrompt + dataPrompt;\n      console.log('ðŸ“ Prompt length:', fullPrompt.length, 'characters');\n\n      // Generate content\n      console.log('â³ Calling Gemini API...');\n      const result = await this.model.generateContent(fullPrompt);\n      const response = await result.response;\n      const text = response.text();\n\n      console.log('âœ… Gemini response received!');\n      console.log('   Response length:', text.length, 'characters');\n\n      // Try to parse JSON from the response\n      let reportData;\n      try {\n        // Remove markdown code blocks if present\n        const jsonText = text.replace(/```json\\n?/g, '').replace(/```\\n?/g, '').trim();\n        reportData = JSON.parse(jsonText);\n\n        // Log what Gemini returned\n        console.log('\\nðŸ“Š SCORES RETURNED BY GEMINI:');\n        if (reportData.parameters) {\n          reportData.parameters.forEach(param => {\n            console.log(`   ${param.name}: ${param.score}/${param.maxScore} (${param.bucket})`);\n          });\n\n          // VALIDATION: Check if Gemini changed the scores\n          console.log('\\nðŸ” VALIDATING SCORES (Input vs Gemini Output):');\n          reportData.parameters.forEach(param => {\n            const paramKey = param.name.replace(/\\s+/g, '');\n            const inputParam = brainParameters[paramKey];\n            if (inputParam) {\n              const scoreMatch = inputParam.score === param.score;\n              const bucketMatch = inputParam.bucket === param.bucket;\n              if (!scoreMatch || !bucketMatch) {\n                console.log(`   âš ï¸ MISMATCH for ${param.name}:`);\n                console.log(`      Input:  score=${inputParam.score}, bucket=${inputParam.bucket}`);\n                console.log(`      Gemini: score=${param.score}, bucket=${param.bucket}`);\n              } else {\n                console.log(`   âœ… ${param.name}: Scores match correctly`);\n              }\n            }\n          });\n        }\n      } catch (parseError) {\n        console.error('Failed to parse JSON response:', parseError);\n        // Return raw text if JSON parsing fails\n        reportData = {\n          title: 'Brain Performance Report',\n          rawContent: text,\n          parameters: [],\n          error: 'Failed to parse structured response'\n        };\n      }\n\n      return {\n        success: true,\n        data: reportData,\n        rawResponse: text\n      };\n\n    } catch (error) {\n      console.error('\\nâŒ === GEMINI API ERROR ===');\n      console.error('Error Type:', error.constructor.name);\n      console.error('Error Message:', error.message);\n      console.error('Error Code:', error.code || 'N/A');\n      console.error('Error Status:', error.status || 'N/A');\n      console.error('Full Error:', JSON.stringify(error, null, 2));\n      console.error('Stack:', error.stack);\n      console.error('==========================\\n');\n\n      return {\n        success: false,\n        error: error.message,\n        errorDetails: {\n          type: error.constructor.name,\n          code: error.code,\n          status: error.status\n        },\n        data: null\n      };\n    }\n  }\n\n  /**\n   * Generate simple text completion\n   * @param {string} prompt - The prompt text\n   * @returns {Promise<string>} Generated text\n   */\n  async generateText(prompt) {\n    try {\n      if (!this.model) {\n        await this.initModel();\n      }\n\n      const result = await this.model.generateContent(prompt);\n      const response = await result.response;\n      return response.text();\n\n    } catch (error) {\n      console.error('Error generating text with Gemini:', error);\n      throw error;\n    }\n  }\n\n  /**\n   * Test Gemini API connection\n   */\n  async testConnection() {\n    try {\n      const response = await this.generateText('Hello! Please respond with \"OK\" if you can read this.');\n      console.log('Gemini API test response:', response);\n      return { success: true, response };\n    } catch (error) {\n      console.error('Gemini API test failed:', error);\n      return { success: false, error: error.message };\n    }\n  }\n}\n\nmodule.exports = new GeminiService();\n","numLines":453,"startLine":1,"totalLines":453}}}
{"parentUuid":"13d8dd00-ffe8-4300-8793-10f9ab699dd6","isSidechain":true,"userType":"external","cwd":"D:\\Todays\\Neuro360","sessionId":"042556c2-8872-4445-8efb-d2658cbac4a7","version":"2.0.33","gitBranch":"main","agentId":"63bdb4e9","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01Co7oqqNC2hr9zrFTeatGVP","type":"tool_result","content":"D:\\Todays\\Neuro360\\.env.example\nD:\\Todays\\Neuro360\\.env.template\nD:\\Todays\\Neuro360\\server\\.env.template\nD:\\Todays\\Neuro360\\.env\nD:\\Todays\\Neuro360\\server\\.env"}]},"uuid":"09bab6dd-113f-47b3-a07b-f47aeb0d99f3","timestamp":"2025-12-09T06:11:26.533Z","toolUseResult":{"filenames":["D:\\Todays\\Neuro360\\.env.example","D:\\Todays\\Neuro360\\.env.template","D:\\Todays\\Neuro360\\server\\.env.template","D:\\Todays\\Neuro360\\.env","D:\\Todays\\Neuro360\\server\\.env"],"durationMs":741,"numFiles":5,"truncated":false}}
{"parentUuid":"09bab6dd-113f-47b3-a07b-f47aeb0d99f3","isSidechain":true,"userType":"external","cwd":"D:\\Todays\\Neuro360","sessionId":"042556c2-8872-4445-8efb-d2658cbac4a7","version":"2.0.33","gitBranch":"main","agentId":"63bdb4e9","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01USLzCKABm8wq1BfLVk7XMx","type":"tool_result","content":"D:\\Todays\\Neuro360\\docs\\features\\FEATURE_COMPLETENESS_REPORT.md:139:#### 2. Usage Alerts â†’ Trigger when report quota near end âœ…\r\nD:\\Todays\\Neuro360\\docs\\features\\FEATURE_COMPLETENESS_REPORT.md:154:  - âœ… Usage quota increases\r\nD:\\Todays\\Neuro360\\ERROR_FIX_GUIDE.md:97:2. **Quota Exceeded:**\r\nD:\\Todays\\Neuro360\\ERROR_FIX_GUIDE.md:98:   - Error: `429 Too Many Requests`\r\nD:\\Todays\\Neuro360\\ERROR_FIX_GUIDE.md:102:   - Error: `429 Rate limit exceeded`\r\nD:\\Todays\\Neuro360\\FIX_401_ERROR_FINAL_SOLUTION.md:335:âœ… Quota increases after payment\r\nD:\\Todays\\Neuro360\\FIX_RAZORPAY_401_ERROR.md:233:âœ… Quota increases after payment\r\nD:\\Todays\\Neuro360\\GEMINI_QUOTA_FIX.md:1:# Gemini API Quota Error - Fixed âœ…\r\nD:\\Todays\\Neuro360\\GEMINI_QUOTA_FIX.md:4:The console was showing error 429 (Too Many Requests) when trying to process QEEG files because the Gemini API free tier quota (20 requests/day) was exceeded.\r\nD:\\Todays\\Neuro360\\GEMINI_QUOTA_FIX.md:9:- âœ… Added specific error handling for 429 (quota exceeded) errors\r\nD:\\Todays\\Neuro360\\GEMINI_QUOTA_FIX.md:11:- âœ… Handles both quota errors and general Gemini API errors\r\nD:\\Todays\\Neuro360\\GEMINI_QUOTA_FIX.md:15:- âœ… Enhanced error detection for quota-related errors\r\nD:\\Todays\\Neuro360\\GEMINI_QUOTA_FIX.md:16:- âœ… Automatically categorizes quota errors (429 status code)\r\nD:\\Todays\\Neuro360\\GEMINI_QUOTA_FIX.md:18:- âœ… Provides cache information to help users avoid quota consumption\r\nD:\\Todays\\Neuro360\\GEMINI_QUOTA_FIX.md:22:- âœ… Properly throws GEMINI_QUOTA_EXCEEDED error after max retries\r\nD:\\Todays\\Neuro360\\GEMINI_QUOTA_FIX.md:28:1. **Wait for Quota Reset**\r\nD:\\Todays\\Neuro360\\GEMINI_QUOTA_FIX.md:29:   - Quota resets daily at midnight PST\r\nD:\\Todays\\Neuro360\\GEMINI_QUOTA_FIX.md:35:   - Cached files don't consume quota!\r\nD:\\Todays\\Neuro360\\GEMINI_QUOTA_FIX.md:39:   - If you see \"CACHE HIT\", no quota was used\r\nD:\\Todays\\Neuro360\\GEMINI_QUOTA_FIX.md:42:1. **Upgrade Gemini API Plan**\r\n\n[Showing results with pagination = limit: 20, offset: 0]"}]},"uuid":"74edb848-9fe5-49d0-be4a-49f4ae5ca53a","timestamp":"2025-12-09T06:11:32.437Z","toolUseResult":{"mode":"content","numFiles":0,"filenames":[],"content":"D:\\Todays\\Neuro360\\docs\\features\\FEATURE_COMPLETENESS_REPORT.md:139:#### 2. Usage Alerts â†’ Trigger when report quota near end âœ…\r\nD:\\Todays\\Neuro360\\docs\\features\\FEATURE_COMPLETENESS_REPORT.md:154:  - âœ… Usage quota increases\r\nD:\\Todays\\Neuro360\\ERROR_FIX_GUIDE.md:97:2. **Quota Exceeded:**\r\nD:\\Todays\\Neuro360\\ERROR_FIX_GUIDE.md:98:   - Error: `429 Too Many Requests`\r\nD:\\Todays\\Neuro360\\ERROR_FIX_GUIDE.md:102:   - Error: `429 Rate limit exceeded`\r\nD:\\Todays\\Neuro360\\FIX_401_ERROR_FINAL_SOLUTION.md:335:âœ… Quota increases after payment\r\nD:\\Todays\\Neuro360\\FIX_RAZORPAY_401_ERROR.md:233:âœ… Quota increases after payment\r\nD:\\Todays\\Neuro360\\GEMINI_QUOTA_FIX.md:1:# Gemini API Quota Error - Fixed âœ…\r\nD:\\Todays\\Neuro360\\GEMINI_QUOTA_FIX.md:4:The console was showing error 429 (Too Many Requests) when trying to process QEEG files because the Gemini API free tier quota (20 requests/day) was exceeded.\r\nD:\\Todays\\Neuro360\\GEMINI_QUOTA_FIX.md:9:- âœ… Added specific error handling for 429 (quota exceeded) errors\r\nD:\\Todays\\Neuro360\\GEMINI_QUOTA_FIX.md:11:- âœ… Handles both quota errors and general Gemini API errors\r\nD:\\Todays\\Neuro360\\GEMINI_QUOTA_FIX.md:15:- âœ… Enhanced error detection for quota-related errors\r\nD:\\Todays\\Neuro360\\GEMINI_QUOTA_FIX.md:16:- âœ… Automatically categorizes quota errors (429 status code)\r\nD:\\Todays\\Neuro360\\GEMINI_QUOTA_FIX.md:18:- âœ… Provides cache information to help users avoid quota consumption\r\nD:\\Todays\\Neuro360\\GEMINI_QUOTA_FIX.md:22:- âœ… Properly throws GEMINI_QUOTA_EXCEEDED error after max retries\r\nD:\\Todays\\Neuro360\\GEMINI_QUOTA_FIX.md:28:1. **Wait for Quota Reset**\r\nD:\\Todays\\Neuro360\\GEMINI_QUOTA_FIX.md:29:   - Quota resets daily at midnight PST\r\nD:\\Todays\\Neuro360\\GEMINI_QUOTA_FIX.md:35:   - Cached files don't consume quota!\r\nD:\\Todays\\Neuro360\\GEMINI_QUOTA_FIX.md:39:   - If you see \"CACHE HIT\", no quota was used\r\nD:\\Todays\\Neuro360\\GEMINI_QUOTA_FIX.md:42:1. **Upgrade Gemini API Plan**\r","numLines":20,"appliedLimit":20}}
{"parentUuid":"74edb848-9fe5-49d0-be4a-49f4ae5ca53a","isSidechain":true,"userType":"external","cwd":"D:\\Todays\\Neuro360","sessionId":"042556c2-8872-4445-8efb-d2658cbac4a7","version":"2.0.33","gitBranch":"main","agentId":"63bdb4e9","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01W8hvKxZwrg9uQS8vijiFWT","type":"message","role":"assistant","content":[{"type":"text","text":"Now let me check the .env files and the qeegRoutes to see how the API is being called:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":7,"cache_creation_input_tokens":24892,"cache_read_input_tokens":36871,"cache_creation":{"ephemeral_5m_input_tokens":24892,"ephemeral_1h_input_tokens":0},"output_tokens":206,"service_tier":"standard"}},"requestId":"req_011CVvcnWQ2ebPAxFm4oGq2D","type":"assistant","uuid":"6e4a9b10-2cc6-4a6d-879a-25b29592670d","timestamp":"2025-12-09T06:11:37.037Z"}
{"parentUuid":"6e4a9b10-2cc6-4a6d-879a-25b29592670d","isSidechain":true,"userType":"external","cwd":"D:\\Todays\\Neuro360","sessionId":"042556c2-8872-4445-8efb-d2658cbac4a7","version":"2.0.33","gitBranch":"main","agentId":"63bdb4e9","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01W8hvKxZwrg9uQS8vijiFWT","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01N3hpXhdvGtHcVb4P9s2Z3P","name":"Read","input":{"file_path":"D:\\Todays\\Neuro360\\server\\.env"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":7,"cache_creation_input_tokens":24892,"cache_read_input_tokens":36871,"cache_creation":{"ephemeral_5m_input_tokens":24892,"ephemeral_1h_input_tokens":0},"output_tokens":206,"service_tier":"standard"}},"requestId":"req_011CVvcnWQ2ebPAxFm4oGq2D","type":"assistant","uuid":"1eeedff4-1146-4d06-a863-a0c78a2d1f6b","timestamp":"2025-12-09T06:11:37.614Z"}
{"parentUuid":"1eeedff4-1146-4d06-a863-a0c78a2d1f6b","isSidechain":true,"userType":"external","cwd":"D:\\Todays\\Neuro360","sessionId":"042556c2-8872-4445-8efb-d2658cbac4a7","version":"2.0.33","gitBranch":"main","agentId":"63bdb4e9","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01W8hvKxZwrg9uQS8vijiFWT","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_011efDsj1oXuRVvNux4ZKVSY","name":"Read","input":{"file_path":"D:\\Todays\\Neuro360\\server\\routes\\qeegRoutes.js"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":7,"cache_creation_input_tokens":24892,"cache_read_input_tokens":36871,"cache_creation":{"ephemeral_5m_input_tokens":24892,"ephemeral_1h_input_tokens":0},"output_tokens":206,"service_tier":"standard"}},"requestId":"req_011CVvcnWQ2ebPAxFm4oGq2D","type":"assistant","uuid":"cffd9345-5cec-402b-a5b2-8b47cb85e3da","timestamp":"2025-12-09T06:11:38.460Z"}
{"parentUuid":"cffd9345-5cec-402b-a5b2-8b47cb85e3da","isSidechain":true,"userType":"external","cwd":"D:\\Todays\\Neuro360","sessionId":"042556c2-8872-4445-8efb-d2658cbac4a7","version":"2.0.33","gitBranch":"main","agentId":"63bdb4e9","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01W8hvKxZwrg9uQS8vijiFWT","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01JYimCyW8c19GYgCVvdvheJ","name":"Read","input":{"file_path":"D:\\Todays\\Neuro360\\GEMINI_QUOTA_FIX.md"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":7,"cache_creation_input_tokens":24892,"cache_read_input_tokens":36871,"cache_creation":{"ephemeral_5m_input_tokens":24892,"ephemeral_1h_input_tokens":0},"output_tokens":206,"service_tier":"standard"}},"requestId":"req_011CVvcnWQ2ebPAxFm4oGq2D","type":"assistant","uuid":"024cc636-857a-4ad9-80c5-21ae1356954d","timestamp":"2025-12-09T06:11:38.503Z"}
{"parentUuid":"024cc636-857a-4ad9-80c5-21ae1356954d","isSidechain":true,"userType":"external","cwd":"D:\\Todays\\Neuro360","sessionId":"042556c2-8872-4445-8efb-d2658cbac4a7","version":"2.0.33","gitBranch":"main","agentId":"63bdb4e9","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01N3hpXhdvGtHcVb4P9s2Z3P","type":"tool_result","content":"     1â†’# Backend Server Environment Configuration\n     2â†’\n     3â†’# Server Port\n     4â†’PORT=5000\n     5â†’\n     6â†’# OpenAI API Configuration\n     7â†’OPENAI_API_KEY=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\n     8â†’\n     9â†’# Google Gemini API Configuration\n    10â†’GEMINI_API_KEY=AIzaSyAu3OFmfKDGG7Ur7nuiWMbC7dnMqk5tZ-Q\n    11â†’\n    12â†’# Supabase Configuration\n    13â†’SUPABASE_URL=https://wqykofpjpaytjuqsessf.supabase.co \n    14â†’SUPABASE_SERVICE_ROLE_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndxeWtvZnBqcGF5dGp1cXNlc3NmIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2NTE4MTE2OSwiZXhwIjoyMDgwNzU3MTY5fQ.NZsbCkvfSs7Kz9Bnr_aa_B5wmSo0eTQBm54Vvil_GRA\n    15â†’# Environment\n    16â†’\n    17â†’\n    18â†’NODE_ENV=development\n    19â†’\n    20â†’# Frontend URL (for CORS)\n    21â†’FRONTEND_URL=http://localhost:3000\n    22â†’\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"941ba43c-243e-4ac8-ac54-4c19d00ecd57","timestamp":"2025-12-09T06:11:45.372Z","toolUseResult":{"type":"text","file":{"filePath":"D:\\Todays\\Neuro360\\server\\.env","content":"# Backend Server Environment Configuration\n\n# Server Port\nPORT=5000\n\n# OpenAI API Configuration\nOPENAI_API_KEY=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\n\n# Google Gemini API Configuration\nGEMINI_API_KEY=AIzaSyAu3OFmfKDGG7Ur7nuiWMbC7dnMqk5tZ-Q\n\n# Supabase Configuration\nSUPABASE_URL=https://wqykofpjpaytjuqsessf.supabase.co \nSUPABASE_SERVICE_ROLE_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndxeWtvZnBqcGF5dGp1cXNlc3NmIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2NTE4MTE2OSwiZXhwIjoyMDgwNzU3MTY5fQ.NZsbCkvfSs7Kz9Bnr_aa_B5wmSo0eTQBm54Vvil_GRA\n# Environment\n\n\nNODE_ENV=development\n\n# Frontend URL (for CORS)\nFRONTEND_URL=http://localhost:3000\n","numLines":22,"startLine":1,"totalLines":22}}}
{"parentUuid":"941ba43c-243e-4ac8-ac54-4c19d00ecd57","isSidechain":true,"userType":"external","cwd":"D:\\Todays\\Neuro360","sessionId":"042556c2-8872-4445-8efb-d2658cbac4a7","version":"2.0.33","gitBranch":"main","agentId":"63bdb4e9","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01JYimCyW8c19GYgCVvdvheJ","type":"tool_result","content":"     1â†’# Gemini API Quota Error - Fixed âœ…\n     2â†’\n     3â†’## Problem\n     4â†’The console was showing error 429 (Too Many Requests) when trying to process QEEG files because the Gemini API free tier quota (20 requests/day) was exceeded.\n     5â†’\n     6â†’## What Was Fixed\n     7â†’\n     8â†’### 1. Frontend Error Handling (`AlgorithmDataProcessor.jsx`)\n     9â†’- âœ… Added specific error handling for 429 (quota exceeded) errors\n    10â†’- âœ… Displays user-friendly message with solutions\n    11â†’- âœ… Handles both quota errors and general Gemini API errors\n    12â†’- âœ… Provides clear instructions on how to resolve the issue\n    13â†’\n    14â†’### 2. Backend Error Handling (`qeegRoutes.js`)\n    15â†’- âœ… Enhanced error detection for quota-related errors\n    16â†’- âœ… Automatically categorizes quota errors (429 status code)\n    17â†’- âœ… Returns detailed error messages with actionable solutions\n    18â†’- âœ… Provides cache information to help users avoid quota consumption\n    19â†’\n    20â†’### 3. Parser Error Handling (`qeegParser.js`)\n    21â†’- âœ… Already had retry logic with exponential backoff (5s, 10s, 20s delays)\n    22â†’- âœ… Properly throws GEMINI_QUOTA_EXCEEDED error after max retries\n    23â†’- âœ… Includes file caching to avoid re-processing same files\n    24â†’\n    25â†’## Solutions for Users\n    26â†’\n    27â†’### Immediate Solutions (No Cost)\n    28â†’1. **Wait for Quota Reset**\n    29â†’   - Quota resets daily at midnight PST\n    30â†’   - Usually takes a few hours to reset\n    31â†’\n    32â†’2. **Use File Cache**\n    33â†’   - Re-upload the SAME files you processed before\n    34â†’   - The system caches them by MD5 hash\n    35â†’   - Cached files don't consume quota!\n    36â†’\n    37â†’3. **Check Cache Stats**\n    38â†’   - Look at backend console for cache hit/miss statistics\n    39â†’   - If you see \"CACHE HIT\", no quota was used\n    40â†’\n    41â†’### Long-term Solutions\n    42â†’1. **Upgrade Gemini API Plan**\n    43â†’   - Visit: https://ai.google.dev/pricing\n    44â†’   - Paid plans have much higher quotas\n    45â†’\n    46â†’2. **Alternative: Use Multiple API Keys**\n    47â†’   - Rotate between different API keys\n    48â†’   - Each key gets 20 free requests/day\n    49â†’\n    50â†’## Error Message Users Will See\n    51â†’\n    52â†’```\n    53â†’âš ï¸ API Quota Exceeded\n    54â†’\n    55â†’The Gemini AI service has reached its daily request limit.\n    56â†’\n    57â†’Solutions:\n    58â†’â€¢ Wait for quota reset (usually resets at midnight PST)\n    59â†’â€¢ Re-upload the same files (cached, no quota used)\n    60â†’â€¢ Contact administrator to upgrade API plan\n    61â†’\n    62â†’Technical Details: [error details here]\n    63â†’```\n    64â†’\n    65â†’## How to Monitor Quota Usage\n    66â†’\n    67â†’### Backend Console\n    68â†’Check the server console for messages like:\n    69â†’- `âœ… CACHE HIT! Using cached extraction result` â† No quota used\n    70â†’- `âš ï¸ Cache miss - extracting data with Gemini AI...` â† Quota consumed\n    71â†’- `ðŸ“Š Cache Stats: X hits, Y misses, Z% hit rate`\n    72â†’\n    73â†’### Cache Statistics\n    74â†’The system tracks:\n    75â†’- Total extractions\n    76â†’- Cache hits (no quota used)\n    77â†’- Cache misses (quota consumed)\n    78â†’- Hit rate percentage\n    79â†’\n    80â†’## Testing the Fix\n    81â†’\n    82â†’1. Try uploading QEEG files\n    83â†’2. If quota exceeded:\n    84â†’   - You'll see a user-friendly error message\n    85â†’   - Message explains what happened\n    86â†’   - Message provides clear solutions\n    87â†’\n    88â†’3. Try uploading the same files again:\n    89â†’   - Should use cache (no quota consumed)\n    90â†’   - Console shows \"CACHE HIT!\"\n    91â†’\n    92â†’## Technical Details\n    93â†’\n    94â†’### Files Modified\n    95â†’1. `src/components/admin/AlgorithmDataProcessor.jsx` (lines 426-443)\n    96â†’2. `server/routes/qeegRoutes.js` (lines 551-596)\n    97â†’\n    98â†’### Error Codes\n    99â†’- `GEMINI_QUOTA_EXCEEDED` - Quota limit reached\n   100â†’- Status 429 - Too Many Requests (HTTP standard)\n   101â†’\n   102â†’### Cache Mechanism\n   103â†’- Files are cached by MD5 hash + condition + report type\n   104â†’- Cache key format: `{md5hash}_{EO/EC}_{raw/zscore}`\n   105â†’- Cache persists in memory (resets on server restart)\n   106â†’\n   107â†’## Next Steps\n   108â†’\n   109â†’1. âœ… Error handling improved\n   110â†’2. âœ… User messages are clear and helpful\n   111â†’3. â³ Wait for quota reset OR upgrade API plan\n   112â†’4. âœ… System will automatically use cache for previously processed files\n   113â†’\n   114â†’## Questions?\n   115â†’\n   116â†’If users ask about the error:\n   117â†’1. Explain it's a daily limit from Google\n   118â†’2. Suggest waiting a few hours\n   119â†’3. Mention that re-uploading same files won't use quota\n   120â†’4. Provide link to upgrade: https://ai.google.dev/pricing\n   121â†’\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"b4f3e2b0-3bfa-422d-9cb0-65f596a6e287","timestamp":"2025-12-09T06:11:45.376Z","toolUseResult":{"type":"text","file":{"filePath":"D:\\Todays\\Neuro360\\GEMINI_QUOTA_FIX.md","content":"# Gemini API Quota Error - Fixed âœ…\n\n## Problem\nThe console was showing error 429 (Too Many Requests) when trying to process QEEG files because the Gemini API free tier quota (20 requests/day) was exceeded.\n\n## What Was Fixed\n\n### 1. Frontend Error Handling (`AlgorithmDataProcessor.jsx`)\n- âœ… Added specific error handling for 429 (quota exceeded) errors\n- âœ… Displays user-friendly message with solutions\n- âœ… Handles both quota errors and general Gemini API errors\n- âœ… Provides clear instructions on how to resolve the issue\n\n### 2. Backend Error Handling (`qeegRoutes.js`)\n- âœ… Enhanced error detection for quota-related errors\n- âœ… Automatically categorizes quota errors (429 status code)\n- âœ… Returns detailed error messages with actionable solutions\n- âœ… Provides cache information to help users avoid quota consumption\n\n### 3. Parser Error Handling (`qeegParser.js`)\n- âœ… Already had retry logic with exponential backoff (5s, 10s, 20s delays)\n- âœ… Properly throws GEMINI_QUOTA_EXCEEDED error after max retries\n- âœ… Includes file caching to avoid re-processing same files\n\n## Solutions for Users\n\n### Immediate Solutions (No Cost)\n1. **Wait for Quota Reset**\n   - Quota resets daily at midnight PST\n   - Usually takes a few hours to reset\n\n2. **Use File Cache**\n   - Re-upload the SAME files you processed before\n   - The system caches them by MD5 hash\n   - Cached files don't consume quota!\n\n3. **Check Cache Stats**\n   - Look at backend console for cache hit/miss statistics\n   - If you see \"CACHE HIT\", no quota was used\n\n### Long-term Solutions\n1. **Upgrade Gemini API Plan**\n   - Visit: https://ai.google.dev/pricing\n   - Paid plans have much higher quotas\n\n2. **Alternative: Use Multiple API Keys**\n   - Rotate between different API keys\n   - Each key gets 20 free requests/day\n\n## Error Message Users Will See\n\n```\nâš ï¸ API Quota Exceeded\n\nThe Gemini AI service has reached its daily request limit.\n\nSolutions:\nâ€¢ Wait for quota reset (usually resets at midnight PST)\nâ€¢ Re-upload the same files (cached, no quota used)\nâ€¢ Contact administrator to upgrade API plan\n\nTechnical Details: [error details here]\n```\n\n## How to Monitor Quota Usage\n\n### Backend Console\nCheck the server console for messages like:\n- `âœ… CACHE HIT! Using cached extraction result` â† No quota used\n- `âš ï¸ Cache miss - extracting data with Gemini AI...` â† Quota consumed\n- `ðŸ“Š Cache Stats: X hits, Y misses, Z% hit rate`\n\n### Cache Statistics\nThe system tracks:\n- Total extractions\n- Cache hits (no quota used)\n- Cache misses (quota consumed)\n- Hit rate percentage\n\n## Testing the Fix\n\n1. Try uploading QEEG files\n2. If quota exceeded:\n   - You'll see a user-friendly error message\n   - Message explains what happened\n   - Message provides clear solutions\n\n3. Try uploading the same files again:\n   - Should use cache (no quota consumed)\n   - Console shows \"CACHE HIT!\"\n\n## Technical Details\n\n### Files Modified\n1. `src/components/admin/AlgorithmDataProcessor.jsx` (lines 426-443)\n2. `server/routes/qeegRoutes.js` (lines 551-596)\n\n### Error Codes\n- `GEMINI_QUOTA_EXCEEDED` - Quota limit reached\n- Status 429 - Too Many Requests (HTTP standard)\n\n### Cache Mechanism\n- Files are cached by MD5 hash + condition + report type\n- Cache key format: `{md5hash}_{EO/EC}_{raw/zscore}`\n- Cache persists in memory (resets on server restart)\n\n## Next Steps\n\n1. âœ… Error handling improved\n2. âœ… User messages are clear and helpful\n3. â³ Wait for quota reset OR upgrade API plan\n4. âœ… System will automatically use cache for previously processed files\n\n## Questions?\n\nIf users ask about the error:\n1. Explain it's a daily limit from Google\n2. Suggest waiting a few hours\n3. Mention that re-uploading same files won't use quota\n4. Provide link to upgrade: https://ai.google.dev/pricing\n","numLines":121,"startLine":1,"totalLines":121}}}
{"parentUuid":"b4f3e2b0-3bfa-422d-9cb0-65f596a6e287","isSidechain":true,"userType":"external","cwd":"D:\\Todays\\Neuro360","sessionId":"042556c2-8872-4445-8efb-d2658cbac4a7","version":"2.0.33","gitBranch":"main","agentId":"63bdb4e9","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_011efDsj1oXuRVvNux4ZKVSY","type":"tool_result","content":"     1â†’const express = require('express');\n     2â†’const multer = require('multer');\n     3â†’const path = require('path');\n     4â†’const fs = require('fs');\n     5â†’const QEEGParser = require('../services/qeegParser');\n     6â†’const AlgorithmCalculator = require('../services/algorithmCalculator');\n     7â†’const ZScoreCalculator = require('../services/zscoreCalculator');\n     8â†’// OLD generators (keeping for fallback)\n     9â†’const PDFReportGenerator = require('../services/pdfGenerator');\n    10â†’const TemplateBasedPDFGenerator = require('../services/pdfGeneratorTemplate');\n    11â†’const templateManager = require('../services/pdf/templateManager');\n    12â†’const AIPdfGenerator = require('../services/aiPdfGenerator');\n    13â†’const SupabaseStorage = require('../services/supabaseStorage');\n    14â†’\n    15â†’// NEW: Gemini AI Service for report generation\n    16â†’let GeminiService = null;\n    17â†’try {\n    18â†’  GeminiService = require('../services/geminiService');\n    19â†’  console.log('âœ… Gemini AI Service loaded successfully');\n    20â†’} catch (error) {\n    21â†’  console.error('âŒ CRITICAL: Gemini AI Service failed to load!');\n    22â†’  console.error('   Error:', error.message);\n    23â†’  console.error('   Stack:', error.stack);\n    24â†’}\n    25â†’\n    26â†’// NEW: Gemini PDF Generator - Uses Gemini AI for content generation\n    27â†’let GeminiPdfGenerator = null;\n    28â†’try {\n    29â†’  GeminiPdfGenerator = require('../services/geminiPdfGenerator');\n    30â†’  console.log('âœ… Gemini PDF Generator loaded successfully');\n    31â†’  console.log('   Generator available:', !!GeminiPdfGenerator);\n    32â†’} catch (error) {\n    33â†’  console.error('âŒ CRITICAL: Gemini PDF Generator failed to load!');\n    34â†’  console.error('   Error:', error.message);\n    35â†’  console.error('   Stack:', error.stack);\n    36â†’}\n    37â†’\n    38â†’// OLD: Enhanced AI PDF Generator with OpenAI (keeping as fallback)\n    39â†’let EnhancedAIPdfGenerator = null;\n    40â†’try {\n    41â†’  EnhancedAIPdfGenerator = require('../services/aiPdfGeneratorEnhanced');\n    42â†’  console.log('âœ… Enhanced AI PDF Generator loaded successfully');\n    43â†’} catch (error) {\n    44â†’  console.warn('âš ï¸  Enhanced AI PDF Generator failed to load:', error.message);\n    45â†’  console.warn('   Will use fallback PDF generator');\n    46â†’}\n    47â†’\n    48â†’const router = express.Router();\n    49â†’\n    50â†’// Configure multer for file uploads\n    51â†’const storage = multer.diskStorage({\n    52â†’  destination: function (req, file, cb) {\n    53â†’    const uploadDir = path.join(__dirname, '../uploads');\n    54â†’    // Ensure upload directory exists\n    55â†’    if (!fs.existsSync(uploadDir)) {\n    56â†’      fs.mkdirSync(uploadDir, { recursive: true });\n    57â†’    }\n    58â†’    cb(null, uploadDir);\n    59â†’  },\n    60â†’  filename: function (req, file, cb) {\n    61â†’    const uniqueSuffix = Date.now() + '-' + Math.round(Math.random() * 1E9);\n    62â†’    cb(null, file.fieldname + '-' + uniqueSuffix + path.extname(file.originalname));\n    63â†’  }\n    64â†’});\n    65â†’\n    66â†’const upload = multer({\n    67â†’  storage: storage,\n    68â†’  limits: {\n    69â†’    fileSize: 50 * 1024 * 1024 // 50MB limit - increased to handle larger QEEG files\n    70â†’  },\n    71â†’  fileFilter: function (req, file, cb) {\n    72â†’    const allowedExtensions = ['.pdf', '.csv', '.xlsx', '.xls'];\n    73â†’    const ext = path.extname(file.originalname).toLowerCase();\n    74â†’    if (allowedExtensions.includes(ext)) {\n    75â†’      cb(null, true);\n    76â†’    } else {\n    77â†’      cb(new Error(`Only ${allowedExtensions.join(', ')} files are allowed`));\n    78â†’    }\n    79â†’  }\n    80â†’});\n    81â†’\n    82â†’/**\n    83â†’ * POST /api/qeeg/process\n    84â†’ * Process QEEG files and calculate 7 brain health parameters\n    85â†’ */\n    86â†’router.post('/process', upload.fields([\n    87â†’  { name: 'eyesOpen', maxCount: 1 },\n    88â†’  { name: 'eyesClosed', maxCount: 1 }\n    89â†’]), async (req, res) => {\n    90â†’  let eyesOpenFile = null;\n    91â†’  let eyesClosedFile = null;\n    92â†’\n    93â†’  try {\n    94â†’    console.log('\\nðŸ”¬ === QEEG Processing Started ===\\n');\n    95â†’\n    96â†’    // Get uploaded files\n    97â†’    const files = req.files;\n    98â†’    if (!files || !files.eyesOpen || !files.eyesClosed) {\n    99â†’      return res.status(400).json({\n   100â†’        error: true,\n   101â†’        message: 'Both Eyes Open and Eyes Closed files are required'\n   102â†’      });\n   103â†’    }\n   104â†’\n   105â†’    eyesOpenFile = files.eyesOpen[0];\n   106â†’    eyesClosedFile = files.eyesClosed[0];\n   107â†’\n   108â†’    console.log('ðŸ“ Files received:');\n   109â†’    console.log('  - Eyes Open:', eyesOpenFile.originalname, `(${(eyesOpenFile.size / 1024).toFixed(2)} KB)`);\n   110â†’    console.log('  - Eyes Closed:', eyesClosedFile.originalname, `(${(eyesClosedFile.size / 1024).toFixed(2)} KB)`);\n   111â†’\n   112â†’    // Get patient info from request body\n   113â†’    const {\n   114â†’      patientId,\n   115â†’      patientName,\n   116â†’      clinicName,\n   117â†’      dateOfBirth,\n   118â†’      age,\n   119â†’      gender,\n   120â†’      handedness\n   121â†’    } = req.body;\n   122â†’\n   123â†’    console.log('\\nðŸ‘¤ Patient Information:');\n   124â†’    console.log('  - Patient ID:', patientId);\n   125â†’    console.log('  - Patient Name:', patientName);\n   126â†’    console.log('  - Clinic:', clinicName);\n   127â†’    console.log('  - Date of Birth:', dateOfBirth);\n   128â†’    console.log('  - Age:', age);\n   129â†’    console.log('  - Gender:', gender);\n   130â†’    console.log('  - Handedness:', handedness);\n   131â†’\n   132â†’    // Validate OpenAI API configuration before processing (OPTIONAL - don't fail if missing)\n   133â†’    console.log('\\nðŸ” Checking OpenAI API configuration...');\n   134â†’    try {\n   135â†’      await QEEGParser.testAPIConnection();\n   136â†’      console.log('âœ… OpenAI API configured properly');\n   137â†’    } catch (apiError) {\n   138â†’      console.warn('âš ï¸  OpenAI API not configured or failed test:', apiError.message);\n   139â†’      console.warn('   Continuing with processing anyway...');\n   140â†’      // Don't throw error - allow processing to continue without OpenAI\n   141â†’    }\n   142â†’\n   143â†’    // Step 1: Parse QEEG files\n   144â†’    console.log('\\nðŸ“Š Step 1: Parsing QEEG files...');\n   145â†’\n   146â†’    // Show cache stats before parsing\n   147â†’    const cacheStatsBefore = QEEGParser.getCacheStats();\n   148â†’    console.log('ðŸ“Š Cache Statistics (Before):');\n   149â†’    console.log(`   - Cache hits: ${cacheStatsBefore.hits}`);\n   150â†’    console.log(`   - Cache misses: ${cacheStatsBefore.misses}`);\n   151â†’    console.log(`   - Hit rate: ${cacheStatsBefore.hitRate}`);\n   152â†’    console.log(`   - Cache size: ${cacheStatsBefore.cacheSize} entries`);\n   153â†’\n   154â†’    const qeegData = await QEEGParser.parse(eyesOpenFile, eyesClosedFile);\n   155â†’\n   156â†’    // Show cache stats after parsing\n   157â†’    const cacheStatsAfter = QEEGParser.getCacheStats();\n   158â†’    console.log('\\nðŸ“Š Cache Statistics (After):');\n   159â†’    console.log(`   - Cache hits: ${cacheStatsAfter.hits}`);\n   160â†’    console.log(`   - Cache misses: ${cacheStatsAfter.misses}`);\n   161â†’    console.log(`   - Hit rate: ${cacheStatsAfter.hitRate}`);\n   162â†’    console.log(`   - Cache size: ${cacheStatsAfter.cacheSize} entries`);\n   163â†’\n   164â†’    if (cacheStatsAfter.hits > cacheStatsBefore.hits) {\n   165â†’      console.log('   âœ… CACHE HIT! Data retrieved from cache (no API quota used)');\n   166â†’    } else {\n   167â†’      console.log('   âš ï¸  CACHE MISS - Gemini API was called (quota consumed)');\n   168â†’    }\n   169â†’\n   170â†’    // Validate that we got real patient data\n   171â†’    console.log('\\nðŸ“Š QEEG Data Validation:');\n   172â†’    console.log('  - Eyes Open (EO) channels:', Object.keys(qeegData.EO?.absolute || {}).length);\n   173â†’    console.log('  - Eyes Closed (EC) channels:', Object.keys(qeegData.EC?.absolute || {}).length);\n   174â†’    console.log('  - Using REAL PATIENT DATA (not sample data)');\n   175â†’    console.log('  - Patient:', patientName, `(ID: ${patientId})`);\n   176â†’\n   177â†’    // Verify non-zero values (proof of real data extraction)\n   178â†’    const eoFzTheta = qeegData.EO?.absolute?.Fz?.Theta || 0;\n   179â†’    const ecPzAlpha = qeegData.EC?.absolute?.Pz?.Alpha || 0;\n   180â†’    console.log('  - Sample Values (proof of extraction):');\n   181â†’    console.log(`    * EO Fz Theta: ${eoFzTheta}`);\n   182â†’    console.log(`    * EC Pz Alpha: ${ecPzAlpha}`);\n   183â†’\n   184â†’    // Warn if all values are zero (indicates parsing failure)\n   185â†’    if (eoFzTheta === 0 && ecPzAlpha === 0) {\n   186â†’      console.warn('  âš ï¸  WARNING: Sample values are zero - possible parsing issue!');\n   187â†’    }\n   188â†’\n   189â†’    // COMPREHENSIVE VALIDATION CHECKS\n   190â†’    console.log('\\nðŸ” Comprehensive Data Validation:');\n   191â†’\n   192â†’    // Check 1: Verify key channels have data\n   193â†’    const requiredChannels = ['Fz', 'Cz', 'Pz', 'F3', 'F4'];\n   194â†’    let missingChannels = 0;\n   195â†’    requiredChannels.forEach(ch => {\n   196â†’      const hasEO = qeegData.EO?.absolute?.[ch]?.Theta !== undefined;\n   197â†’      const hasEC = qeegData.EC?.absolute?.[ch]?.Alpha !== undefined;\n   198â†’      if (!hasEO || !hasEC) {\n   199â†’        console.warn(`  âš ï¸  Missing data for channel ${ch}`);\n   200â†’        missingChannels++;\n   201â†’      }\n   202â†’    });\n   203â†’    if (missingChannels === 0) {\n   204â†’      console.log('  âœ… All required channels have data');\n   205â†’    }\n   206â†’\n   207â†’    // Check 2: Verify values are in reasonable ranges (not all zeros or defaults)\n   208â†’    const testValues = [\n   209â†’      qeegData.EO?.absolute?.Fz?.Theta,\n   210â†’      qeegData.EO?.absolute?.Fz?.Beta,\n   211â†’      qeegData.EC?.absolute?.Pz?.Alpha,\n   212â†’      qeegData.EC?.relative?.Pz?.Alpha,\n   213â†’      qeegData.EC?.relative?.Pz?.Beta\n   214â†’    ];\n   215â†’    const uniqueValues = new Set(testValues.filter(v => v !== null && v !== undefined));\n   216â†’    if (uniqueValues.size <= 1) {\n   217â†’      console.warn('  âš ï¸  WARNING: All test values are the same - possible static data!');\n   218â†’    } else {\n   219â†’      console.log(`  âœ… Data shows ${uniqueValues.size} unique values (not static)`);\n   220â†’    }\n   221â†’\n   222â†’    // Check 3: Verify relative power sums to ~100% for a sample channel\n   223â†’    if (qeegData.EO?.relative?.Fz) {\n   224â†’      const fzBands = qeegData.EO.relative.Fz;\n   225â†’      const sum = (fzBands.Delta || 0) + (fzBands.Theta || 0) +\n   226â†’                  (fzBands.Alpha || 0) + (fzBands.Beta || 0) +\n   227â†’                  (fzBands.HiBeta || 0);\n   228â†’      console.log(`  ðŸ“Š Relative power sum (EO Fz): ${sum.toFixed(1)}%`);\n   229â†’      if (sum < 80 || sum > 120) {\n   230â†’        console.warn(`  âš ï¸  WARNING: Relative power sum is ${sum.toFixed(1)}% (expected ~100%)`);\n   231â†’      } else {\n   232â†’        console.log('  âœ… Relative power validation passed');\n   233â†’      }\n   234â†’    }\n   235â†’\n   236â†’    // Check 4: Verify critical values for calculations exist\n   237â†’    const criticalValues = {\n   238â†’      'Relaxation (Pz EC Relative Alpha)': qeegData.EC?.relative?.Pz?.Alpha,\n   239â†’      'Relaxation (Pz EC Relative Beta)': qeegData.EC?.relative?.Pz?.Beta,\n   240â†’      'Focus (Fz EO Theta)': qeegData.EO?.absolute?.Fz?.Theta,\n   241â†’      'Focus (Fz EO Beta)': qeegData.EO?.absolute?.Fz?.Beta,\n   242â†’      'Alpha Peak': qeegData.EC?.special?.alphaPeak || qeegData.EC?.special?.O1\n   243â†’    };\n   244â†’\n   245â†’    console.log('\\n  ðŸŽ¯ Critical Values Check:');\n   246â†’    let missingCritical = 0;\n   247â†’    Object.entries(criticalValues).forEach(([name, value]) => {\n   248â†’      if (value === null || value === undefined) {\n   249â†’        console.warn(`  âŒ MISSING: ${name}`);\n   250â†’        missingCritical++;\n   251â†’      } else {\n   252â†’        console.log(`  âœ… ${name}: ${value}`);\n   253â†’      }\n   254â†’    });\n   255â†’\n   256â†’    if (missingCritical > 0) {\n   257â†’      console.warn(`\\n  âš ï¸  WARNING: ${missingCritical} critical values missing - calculations may be inaccurate!`);\n   258â†’    } else {\n   259â†’      console.log('\\n  âœ… All critical values present - ready for calculation');\n   260â†’    }\n   261â†’\n   262â†’    // Step 2: Calculate parameters with appropriate calculator\n   263â†’    console.log('\\nðŸ§® Step 2: Calculating 7 brain health parameters...');\n   264â†’\n   265â†’    // Route to appropriate calculator based on data type\n   266â†’    const dataType = qeegData.dataType || 'raw';\n   267â†’    console.log(`ðŸ“Š Data Type: ${dataType.toUpperCase()} mode`);\n   268â†’\n   269â†’    let calculator;\n   270â†’    if (dataType === 'zscore') {\n   271â†’      console.log('   Using Z-Score Calculator');\n   272â†’      calculator = new ZScoreCalculator(qeegData);\n   273â†’    } else {\n   274â†’      console.log('   Using Raw Power Calculator');\n   275â†’      calculator = new AlgorithmCalculator(qeegData);\n   276â†’    }\n   277â†’\n   278â†’    const results = calculator.calculate();\n   279â†’\n   280â†’    console.log('\\nâœ… Calculation completed successfully!');\n   281â†’    console.log('ðŸ“ˆ Results Summary:');\n   282â†’    results.parameters.forEach(param => {\n   283â†’      console.log(`  - ${param.name}: ${param.score}/${param.maxScore} (${param.classification})`);\n   284â†’    });\n   285â†’    console.log(`  - Overall Score: ${results.overallScore}/21`);\n   286â†’\n   287â†’    // COMPREHENSIVE DEBUG SUMMARY\n   288â†’    console.log('\\n' + '='.repeat(80));\n   289â†’    console.log('ðŸ“‹ COMPREHENSIVE DEBUG SUMMARY - FULL PIPELINE');\n   290â†’    console.log('='.repeat(80));\n   291â†’\n   292â†’    console.log('\\n1ï¸âƒ£  DATA EXTRACTION PHASE:');\n   293â†’    console.log(`    Patient: ${patientName} (ID: ${patientId})`);\n   294â†’    console.log(`    Data Type: ${dataType.toUpperCase()} mode`);\n   295â†’    console.log(`    EO Channels: ${Object.keys(qeegData.EO?.absolute || {}).length}`);\n   296â†’    console.log(`    EC Channels: ${Object.keys(qeegData.EC?.absolute || {}).length}`);\n   297â†’\n   298â†’    console.log('\\n2ï¸âƒ£  SAMPLE EXTRACTED DATA:');\n   299â†’    console.log('    Key Values Used in Calculations:');\n   300â†’    console.log(`    - Fz EO Absolute Theta: ${qeegData.EO?.absolute?.Fz?.Theta || 'N/A'}`);\n   301â†’    console.log(`    - Fz EO Absolute Beta: ${qeegData.EO?.absolute?.Fz?.Beta || 'N/A'}`);\n   302â†’    console.log(`    - Pz EC Relative Alpha: ${qeegData.EC?.relative?.Pz?.Alpha || 'N/A'}`);\n   303â†’    console.log(`    - Pz EC Relative Beta: ${qeegData.EC?.relative?.Pz?.Beta || 'N/A'}`);\n   304â†’    console.log(`    - Alpha Peak: ${qeegData.EC?.special?.alphaPeak || qeegData.EC?.special?.O1 || 'N/A'} Hz`);\n   305â†’\n   306â†’    console.log('\\n3ï¸âƒ£  CALCULATION RESULTS:');\n   307â†’    results.parameters.forEach((param, idx) => {\n   308â†’      console.log(`    ${idx + 1}. ${param.name}: ${param.score}/${param.maxScore} (${param.classification})`);\n   309â†’      param.metrics.forEach(metric => {\n   310â†’        console.log(`       - ${metric.name}: ${metric.score} point`);\n   311â†’        if (metric.description) {\n   312â†’          console.log(`         ${metric.description}`);\n   313â†’        }\n   314â†’      });\n   315â†’    });\n   316â†’\n   317â†’    console.log('\\n4ï¸âƒ£  EXPECTED vs ACTUAL (for Rhea\\'s Report):');\n   318â†’    const expectedScores = {\n   319â†’      'Cognition': { expected: 2, actual: results.parameters.find(p => p.name === 'Cognition')?.score },\n   320â†’      'Stress': { expected: 0, actual: results.parameters.find(p => p.name === 'Stress')?.score },\n   321â†’      'Focus & Attention': { expected: 2, actual: results.parameters.find(p => p.name === 'Focus & Attention')?.score },\n   322â†’      'Burnout & Fatigue': { expected: 0, actual: results.parameters.find(p => p.name === 'Burnout & Fatigue')?.score },\n   323â†’      'Emotional Regulation': { expected: 3, actual: results.parameters.find(p => p.name === 'Emotional Regulation')?.score },\n   324â†’      'Learning': { expected: 2, actual: results.parameters.find(p => p.name === 'Learning')?.score },\n   325â†’      'Creativity': { expected: 2, actual: results.parameters.find(p => p.name === 'Creativity')?.score }\n   326â†’    };\n   327â†’\n   328â†’    console.log('    (Expected values are for Rhea\\'s Report only)');\n   329â†’    Object.entries(expectedScores).forEach(([name, scores]) => {\n   330â†’      const match = scores.expected === scores.actual ? 'âœ…' : 'âŒ';\n   331â†’      console.log(`    ${match} ${name}: Expected ${scores.expected}/3, Got ${scores.actual}/3`);\n   332â†’    });\n   333â†’\n   334â†’    console.log('\\n' + '='.repeat(80));\n   335â†’    console.log('END OF DEBUG SUMMARY');\n   336â†’    console.log('='.repeat(80) + '\\n');\n   337â†’\n   338â†’    // Step 3: Auto-generate PDF report\n   339â†’    console.log('\\nðŸ“„ Step 3: Auto-generating PDF report...');\n   340â†’    let pdfUrl = null;\n   341â†’    let pdfFilename = null;\n   342â†’\n   343â†’    try {\n   344â†’      // Prepare patient data for PDF\n   345â†’      const pdfPatientData = {\n   346â†’        name: patientName,\n   347â†’        dateOfBirth: dateOfBirth || 'N/A',\n   348â†’        age: age || 'N/A',\n   349â†’        gender: gender || 'Not specified',\n   350â†’        handedness: handedness || 'Not specified',\n   351â†’        patientId: patientId,\n   352â†’        clinicName: clinicName\n   353â†’      };\n   354â†’\n   355â†’      // Prepare algorithm results for PDF\n   356â†’      const pdfAlgorithmResults = {\n   357â†’        parameters: results.parameters,\n   358â†’        overallScore: results.overallScore\n   359â†’      };\n   360â†’\n   361â†’      // Debug: Log parameters being sent to PDF\n   362â†’      console.log('\\nðŸ“Š Parameters for PDF:');\n   363â†’      console.log('  - Total Parameters:', pdfAlgorithmResults.parameters.length);\n   364â†’      console.log('  - Overall Score:', pdfAlgorithmResults.overallScore);\n   365â†’      pdfAlgorithmResults.parameters.forEach((param, i) => {\n   366â†’        console.log(`  ${i + 1}. ${param.name}: ${param.score}/${param.maxScore} (${param.classification})`);\n   367â†’      });\n   368â†’\n   369â†’      // Create output filename\n   370â†’      const timestamp = Date.now();\n   371â†’      const sanitizedName = (patientName || 'patient').replace(/[^a-z0-9]/gi, '_').toLowerCase();\n   372â†’      pdfFilename = `neurosense-report-${sanitizedName}-${timestamp}.pdf`;\n   373â†’      const uploadsDir = path.join(__dirname, '../uploads');\n   374â†’      const pdfOutputPath = path.join(uploadsDir, pdfFilename);\n   375â†’\n   376â†’      // Ensure uploads directory exists\n   377â†’      if (!fs.existsSync(uploadsDir)) {\n   378â†’        console.log('ðŸ“ Creating uploads directory...');\n   379â†’        fs.mkdirSync(uploadsDir, { recursive: true });\n   380â†’      }\n   381â†’\n   382â†’      console.log('ðŸ“ Generating PDF to:', pdfFilename);\n   383â†’      console.log('   Full path:', pdfOutputPath);\n   384â†’\n   385â†’      // === USE GEMINI PDF GENERATOR (with fallback) ===\n   386â†’      console.log('\\nðŸ” Checking available PDF generators...');\n   387â†’      console.log('   GeminiPdfGenerator available:', !!GeminiPdfGenerator);\n   388â†’      console.log('   EnhancedAIPdfGenerator available:', !!EnhancedAIPdfGenerator);\n   389â†’      console.log('   PDFReportGenerator available:', !!PDFReportGenerator);\n   390â†’\n   391â†’      let pdfGenerator;\n   392â†’      // TEMPORARY: Use basic PDF generator since Gemini quota exceeded\n   393â†’      // Re-enable Gemini when quota resets (after 24 hours)\n   394â†’      const USE_GEMINI = false; // Set to true after quota resets\n   395â†’\n   396â†’      if (USE_GEMINI && GeminiPdfGenerator) {\n   397â†’        console.log('\\nðŸ¤– === USING GEMINI AI PDF GENERATOR ===');\n   398â†’        console.log('   Engine: Google Gemini + PDFKit');\n   399â†’        console.log('   Patient:', pdfPatientData.name);\n   400â†’        console.log('   Parameters:', pdfAlgorithmResults.parameters.length);\n   401â†’        try {\n   402â†’          pdfGenerator = new GeminiPdfGenerator(pdfPatientData, pdfAlgorithmResults, qeegData);\n   403â†’          console.log('âœ… Gemini PDF Generator instantiated successfully');\n   404â†’        } catch (instantiateError) {\n   405â†’          console.error('âŒ Failed to instantiate Gemini PDF Generator:', instantiateError.message);\n   406â†’          throw instantiateError;\n   407â†’        }\n   408â†’      } else if (EnhancedAIPdfGenerator) {\n   409â†’        console.log('ðŸ¤– Using Enhanced AI PDF Generator (OpenAI + PDFKit - Fallback)');\n   410â†’        pdfGenerator = new EnhancedAIPdfGenerator(pdfPatientData, pdfAlgorithmResults, qeegData);\n   411â†’      } else {\n   412â†’        console.log('ðŸ“„ Using Standard PDF Generator (Basic fallback)');\n   413â†’        pdfGenerator = new PDFReportGenerator(pdfPatientData, pdfAlgorithmResults, qeegData);\n   414â†’      }\n   415â†’\n   416â†’      // Generate the PDF\n   417â†’      console.log('\\nðŸ“ Calling pdfGenerator.generateReport()...');\n   418â†’      console.log('   Output path:', pdfOutputPath);\n   419â†’\n   420â†’      try {\n   421â†’        await pdfGenerator.generateReport(pdfOutputPath);\n   422â†’        console.log('âœ… PDF generation completed!');\n   423â†’      } catch (genError) {\n   424â†’        console.error('âŒ PDF generation threw error:', genError.message);\n   425â†’        console.error('   Stack:', genError.stack);\n   426â†’        throw genError;\n   427â†’      }\n   428â†’\n   429â†’      // Verify file was created\n   430â†’      if (!fs.existsSync(pdfOutputPath)) {\n   431â†’        throw new Error('PDF file was not created at expected path: ' + pdfOutputPath);\n   432â†’      }\n   433â†’\n   434â†’      console.log('âœ… PDF file verified at:', pdfOutputPath);\n   435â†’      console.log('ðŸ“„ File:', pdfFilename);\n   436â†’      console.log('ðŸ“Š Size:', (fs.statSync(pdfOutputPath).size / 1024).toFixed(2), 'KB');\n   437â†’\n   438â†’      // Upload to Supabase Storage\n   439â†’      try {\n   440â†’        console.log('\\nâ˜ï¸  Uploading PDF to Supabase storage...');\n   441â†’        const uploadResult = await SupabaseStorage.uploadFile(\n   442â†’          pdfOutputPath,\n   443â†’          'patient-reports', // bucket name - FIXED\n   444â†’          `reports/${pdfFilename}` // path in bucket\n   445â†’        );\n   446â†’\n   447â†’        // Verify upload was successful and URL is valid\n   448â†’        if (uploadResult && uploadResult.url) {\n   449â†’          pdfUrl = uploadResult.url;\n   450â†’          console.log('âœ… PDF uploaded to Supabase successfully');\n   451â†’          console.log('ðŸ”— Supabase URL:', pdfUrl);\n   452â†’\n   453â†’          // Delete local file after successful Supabase upload\n   454â†’          try {\n   455â†’            fs.unlinkSync(pdfOutputPath);\n   456â†’            console.log('ðŸ—‘ï¸  Local PDF file deleted after successful upload');\n   457â†’          } catch (deleteError) {\n   458â†’            console.warn('âš ï¸  Could not delete local PDF file:', deleteError.message);\n   459â†’          }\n   460â†’        } else {\n   461â†’          throw new Error('Supabase upload returned invalid result');\n   462â†’        }\n   463â†’      } catch (supabaseError) {\n   464â†’        console.error('âš ï¸  Supabase upload failed, using local storage');\n   465â†’        console.error('   Error message:', supabaseError.message);\n   466â†’        console.error('   Error stack:', supabaseError.stack);\n   467â†’        console.error('   Full error:', JSON.stringify(supabaseError, null, 2));\n   468â†’        // Fallback to local storage\n   469â†’        pdfUrl = `/uploads/${pdfFilename}`;\n   470â†’        console.log('ðŸ“ Using local file as fallback:', pdfUrl);\n   471â†’      }\n   472â†’\n   473â†’    } catch (pdfError) {\n   474â†’      console.error('\\nâŒ === PDF GENERATION FAILED ===');\n   475â†’      console.error('Error message:', pdfError.message);\n   476â†’      console.error('Error stack:', pdfError.stack);\n   477â†’      console.error('Full error:', pdfError);\n   478â†’      console.error('=================================\\n');\n   479â†’\n   480â†’      // Set pdfUrl to null so frontend knows PDF failed\n   481â†’      pdfUrl = null;\n   482â†’\n   483â†’      // Don't fail the whole request if PDF fails - processing still succeeded\n   484â†’      console.log('âš ï¸ Continuing without PDF - processing succeeded');\n   485â†’    }\n   486â†’\n   487â†’    // Clean up uploaded files\n   488â†’    try {\n   489â†’      fs.unlinkSync(eyesOpenFile.path);\n   490â†’      fs.unlinkSync(eyesClosedFile.path);\n   491â†’      console.log('\\nðŸ—‘ï¸  Temporary files cleaned up');\n   492â†’    } catch (cleanupError) {\n   493â†’      console.error('âš ï¸  Error cleaning up files:', cleanupError.message);\n   494â†’    }\n   495â†’\n   496â†’    console.log('\\nðŸ === QEEG Processing Completed ===\\n');\n   497â†’\n   498â†’    // Final check for PDF URL\n   499â†’    if (!pdfUrl) {\n   500â†’      console.warn('âš ï¸âš ï¸âš ï¸ WARNING: No PDF URL available in response!');\n   501â†’      console.warn('   pdfFilename was:', pdfFilename || 'NOT SET');\n   502â†’      console.warn('   This means PDF generation completely failed');\n   503â†’    } else {\n   504â†’      console.log('âœ… PDF URL ready:', pdfUrl);\n   505â†’      console.log('   Type:', pdfUrl.startsWith('http') ? 'Supabase' : 'Local');\n   506â†’    }\n   507â†’\n   508â†’    // Send response\n   509â†’    res.json({\n   510â†’      success: true,\n   511â†’      data: {\n   512â†’        patientId,\n   513â†’        patientName,\n   514â†’        clinicName,\n   515â†’        processedAt: new Date().toISOString(),\n   516â†’        dataType: dataType, // Add data type (raw or zscore)\n   517â†’        results: results.parameters,\n   518â†’        overallScore: results.overallScore,\n   519â†’        maxScore: 21,\n   520â†’        pdfUrl: pdfUrl,\n   521â†’        pdfFilename: pdfFilename\n   522â†’      }\n   523â†’    });\n   524â†’\n   525â†’  } catch (error) {\n   526â†’    console.error('\\nâŒ === QEEG Processing Failed ===');\n   527â†’    console.error('Error:', error.message);\n   528â†’    console.error('Error Code:', error.code || 'UNKNOWN');\n   529â†’    console.error('Stack:', error.stack);\n   530â†’\n   531â†’    // Clean up files on error\n   532â†’    if (eyesOpenFile && fs.existsSync(eyesOpenFile.path)) {\n   533â†’      try {\n   534â†’        fs.unlinkSync(eyesOpenFile.path);\n   535â†’      } catch (e) {\n   536â†’        console.error('Error deleting Eyes Open file:', e.message);\n   537â†’      }\n   538â†’    }\n   539â†’    if (eyesClosedFile && fs.existsSync(eyesClosedFile.path)) {\n   540â†’      try {\n   541â†’        fs.unlinkSync(eyesClosedFile.path);\n   542â†’      } catch (e) {\n   543â†’        console.error('Error deleting Eyes Closed file:', e.message);\n   544â†’      }\n   545â†’    }\n   546â†’\n   547â†’    // Categorize errors for better user feedback\n   548â†’    let statusCode = 500;\n   549â†’    let userMessage = error.message;\n   550â†’\n   551â†’    // Check for Gemini quota error in error message\n   552â†’    if (error.message && error.message.includes('429') && error.message.includes('quota')) {\n   553â†’      error.code = 'GEMINI_QUOTA_EXCEEDED';\n   554â†’    }\n   555â†’\n   556â†’    switch (error.code) {\n   557â†’      case 'MISSING_API_KEY':\n   558â†’      case 'INVALID_API_KEY':\n   559â†’      case 'INVALID_API_KEY_FORMAT':\n   560â†’      case 'API_CONNECTION_FAILED':\n   561â†’        statusCode = 503; // Service Unavailable\n   562â†’        userMessage = 'System configuration error: API key not properly configured. Please contact support.';\n   563â†’        break;\n   564â†’\n   565â†’      case 'PDF_EXTRACTION_FAILED':\n   566â†’        statusCode = 422; // Unprocessable Entity\n   567â†’        userMessage = 'Failed to extract QEEG data from PDF. Please ensure the PDF contains valid QEEG tables with absolute and relative power values.';\n   568â†’        break;\n   569â†’\n   570â†’      case 'GEMINI_QUOTA_EXCEEDED':\n   571â†’        statusCode = 429; // Too Many Requests\n   572â†’        userMessage = 'âš ï¸ API Quota Exceeded\\n\\n' +\n   573â†’                     'The Gemini API free tier limit has been reached.\\n\\n' +\n   574â†’                     'Solutions:\\n' +\n   575â†’                     '1. Wait a few hours for quota to reset (resets at midnight PST)\\n' +\n   576â†’                     '2. Try re-uploading previously processed files (uses cache, no quota consumed)\\n' +\n   577â†’                     '3. Upgrade to paid plan: https://ai.google.dev/pricing\\n' +\n   578â†’                     '4. Contact administrator for assistance\\n\\n' +\n   579â†’                     'Cache Info: The system remembers files you\\'ve uploaded before - those won\\'t use quota!';\n   580â†’        break;\n   581â†’\n   582â†’      default:\n   583â†’        // If error message contains Gemini quota keywords, classify it\n   584â†’        if (userMessage && (userMessage.includes('quota') || userMessage.includes('429') || userMessage.includes('Too Many Requests'))) {\n   585â†’          statusCode = 429;\n   586â†’          userMessage = 'âš ï¸ API Quota Exceeded\\n\\n' +\n   587â†’                       'The Gemini AI service has reached its daily request limit.\\n\\n' +\n   588â†’                       'Solutions:\\n' +\n   589â†’                       'â€¢ Wait for quota reset (usually resets at midnight PST)\\n' +\n   590â†’                       'â€¢ Re-upload the same files (cached, no quota used)\\n' +\n   591â†’                       'â€¢ Contact administrator to upgrade API plan\\n\\n' +\n   592â†’                       'Technical Details: ' + error.message;\n   593â†’        } else {\n   594â†’          userMessage = error.message || 'Failed to process QEEG files';\n   595â†’        }\n   596â†’    }\n   597â†’\n   598â†’    res.status(statusCode).json({\n   599â†’      error: true,\n   600â†’      message: userMessage,\n   601â†’      code: error.code || 'UNKNOWN_ERROR',\n   602â†’      technicalDetails: process.env.NODE_ENV === 'development' ? {\n   603â†’        originalMessage: error.message,\n   604â†’        stack: error.stack,\n   605â†’        condition: error.condition\n   606â†’      } : undefined\n   607â†’    });\n   608â†’  }\n   609â†’});\n   610â†’\n   611â†’/**\n   612â†’ * POST /api/qeeg/generate-pdf\n   613â†’ * Generate PDF report from algorithm results\n   614â†’ */\n   615â†’router.post('/generate-pdf', async (req, res) => {\n   616â†’  try {\n   617â†’    console.log('\\nðŸ“„ === PDF Report Generation Started ===\\n');\n   618â†’\n   619â†’    const { patientData, algorithmResults, qeegData } = req.body;\n   620â†’\n   621â†’    // Validate input\n   622â†’    if (!patientData || !algorithmResults || !qeegData) {\n   623â†’      return res.status(400).json({\n   624â†’        error: true,\n   625â†’        message: 'Missing required data: patientData, algorithmResults, and qeegData are required'\n   626â†’      });\n   627â†’    }\n   628â†’\n   629â†’    console.log('ðŸ‘¤ Patient:', patientData.name);\n   630â†’    console.log('ðŸ“Š Parameters:', algorithmResults.parameters?.length);\n   631â†’\n   632â†’    // === USE GEMINI PDF GENERATOR (if available) ===\n   633â†’    let generator;\n   634â†’    if (GeminiPdfGenerator) {\n   635â†’      console.log('ðŸ¤– Using Gemini AI PDF Generator (Google Gemini + PDFKit)');\n   636â†’      generator = new GeminiPdfGenerator(patientData, algorithmResults, qeegData);\n   637â†’    } else if (EnhancedAIPdfGenerator) {\n   638â†’      console.log('ðŸ¤– Using Enhanced AI PDF Generator (OpenAI + PDFKit - Fallback)');\n   639â†’      generator = new EnhancedAIPdfGenerator(patientData, algorithmResults, qeegData);\n   640â†’    } else {\n   641â†’      console.log('ðŸ“„ Using Standard PDF Generator (Basic fallback)');\n   642â†’      generator = new PDFReportGenerator(patientData, algorithmResults, qeegData);\n   643â†’    }\n   644â†’\n   645â†’    // Create output filename\n   646â†’    const timestamp = Date.now();\n   647â†’    const sanitizedName = (patientData.name || 'patient').replace(/[^a-z0-9]/gi, '_').toLowerCase();\n   648â†’    const filename = `neurosense-report-${sanitizedName}-${timestamp}.pdf`;\n   649â†’    const outputPath = path.join(__dirname, '../uploads', filename);\n   650â†’\n   651â†’    console.log('ðŸ“ Generating AI-powered PDF to:', filename);\n   652â†’\n   653â†’    // Generate the PDF with AI insights\n   654â†’    const pdfPath = await generator.generateReport(outputPath);\n   655â†’\n   656â†’    console.log('\\nâœ… PDF Report Generated Successfully!');\n   657â†’    console.log('ðŸ“„ File:', filename);\n   658â†’    console.log('ðŸ“Š Size:', (fs.statSync(pdfPath).size / 1024).toFixed(2), 'KB');\n   659â†’\n   660â†’    // Upload to Supabase Storage - TEMPORARILY DISABLED\n   661â†’    let supabaseUrl = null;\n   662â†’    let supabasePath = null;\n   663â†’    let uploadError = null;\n   664â†’\n   665â†’    // DISABLE SUPABASE UPLOAD FOR NOW - USE LOCAL STORAGE ONLY\n   666â†’    console.log('\\nðŸ“ Using local storage (Supabase upload disabled)');\n   667â†’    uploadError = 'Supabase upload disabled - using local storage';\n   668â†’\n   669â†’    /* COMMENTED OUT - Enable when Supabase is configured properly\n   670â†’    try {\n   671â†’      console.log('\\nâ˜ï¸  Uploading PDF to Supabase storage...');\n   672â†’      const uploadResult = await SupabaseStorage.uploadFile(\n   673â†’        pdfPath,\n   674â†’        'patient-reports', // bucket name\n   675â†’        `reports/${filename}` // path in bucket\n   676â†’      );\n   677â†’\n   678â†’      // Verify upload was successful and URL is valid\n   679â†’      if (uploadResult && uploadResult.url) {\n   680â†’        supabaseUrl = uploadResult.url;\n   681â†’        supabasePath = uploadResult.path;\n   682â†’\n   683â†’        console.log('âœ… PDF uploaded to Supabase successfully');\n   684â†’        console.log('ðŸ”— Supabase URL:', supabaseUrl);\n   685â†’\n   686â†’        // Only delete local file after SUCCESSFUL Supabase upload\n   687â†’        try {\n   688â†’          fs.unlinkSync(pdfPath);\n   689â†’          console.log('ðŸ—‘ï¸  Local PDF file deleted after successful upload');\n   690â†’        } catch (deleteError) {\n   691â†’          console.warn('âš ï¸  Could not delete local PDF file:', deleteError.message);\n   692â†’        }\n   693â†’      } else {\n   694â†’        throw new Error('Supabase upload returned invalid result');\n   695â†’      }\n   696â†’\n   697â†’    } catch (error) {\n   698â†’      console.error('âš ï¸  Supabase upload failed, using local storage:', error.message);\n   699â†’      uploadError = error.message;\n   700â†’      // Keep local file as fallback - DO NOT DELETE\n   701â†’      console.log('ðŸ“ Using local file as fallback');\n   702â†’    }\n   703â†’    */\n   704â†’\n   705â†’    console.log('\\nðŸ === PDF Generation Completed ===\\n');\n   706â†’\n   707â†’    // Return PDF info - prioritize Supabase URL\n   708â†’    res.json({\n   709â†’      success: true,\n   710â†’      data: {\n   711â†’        filename: filename,\n   712â†’        path: supabasePath || `/uploads/${filename}`,\n   713â†’        url: supabaseUrl || `${req.protocol}://${req.get('host')}/uploads/${filename}`,\n   714â†’        size: fs.existsSync(pdfPath) ? fs.statSync(pdfPath).size : 0,\n   715â†’        generatedAt: new Date().toISOString(),\n   716â†’        storage: supabaseUrl ? 'supabase' : 'local',\n   717â†’        uploadError: uploadError\n   718â†’      }\n   719â†’    });\n   720â†’\n   721â†’  } catch (error) {\n   722â†’    console.error('\\nâŒ === PDF Generation Failed ===');\n   723â†’    console.error('Error:', error.message);\n   724â†’    console.error('Stack:', error.stack);\n   725â†’\n   726â†’    res.status(500).json({\n   727â†’      error: true,\n   728â†’      message: error.message || 'Failed to generate PDF report',\n   729â†’      details: process.env.NODE_ENV === 'development' ? error.stack : undefined\n   730â†’    });\n   731â†’  }\n   732â†’});\n   733â†’\n   734â†’/**\n   735â†’ * POST /api/qeeg/generate-sample-pdf\n   736â†’ * Generate a sample PDF report for testing\n   737â†’ */\n   738â†’router.post('/generate-sample-pdf', async (req, res) => {\n   739â†’  try {\n   740â†’    console.log('\\nðŸ“„ === Sample PDF Generation Started ===\\n');\n   741â†’\n   742â†’    const pdfPath = await PDFReportGenerator.generateSampleReport();\n   743â†’\n   744â†’    console.log('âœ… Sample PDF Generated!');\n   745â†’    console.log('ðŸ“„ Path:', pdfPath);\n   746â†’\n   747â†’    const filename = path.basename(pdfPath);\n   748â†’\n   749â†’    res.json({\n   750â†’      success: true,\n   751â†’      data: {\n   752â†’        filename: filename,\n   753â†’        path: `/uploads/${filename}`,\n   754â†’        url: `${req.protocol}://${req.get('host')}/uploads/${filename}`,\n   755â†’        size: fs.statSync(pdfPath).size\n   756â†’      }\n   757â†’    });\n   758â†’\n   759â†’  } catch (error) {\n   760â†’    console.error('âŒ Sample PDF generation failed:', error);\n   761â†’\n   762â†’    res.status(500).json({\n   763â†’      error: true,\n   764â†’      message: error.message\n   765â†’    });\n   766â†’  }\n   767â†’});\n   768â†’\n   769â†’/**\n   770â†’ * POST /api/qeeg/generate-ai-pdf\n   771â†’ * Generate AI-powered PDF report with enhanced design and content\n   772â†’ */\n   773â†’router.post('/generate-ai-pdf', async (req, res) => {\n   774â†’  try {\n   775â†’    console.log('\\nðŸ¤– === AI PDF Report Generation Started ===\\n');\n   776â†’\n   777â†’    const { patientData, algorithmResults, qeegData } = req.body;\n   778â†’\n   779â†’    // Validate input\n   780â†’    if (!patientData || !algorithmResults || !qeegData) {\n   781â†’      return res.status(400).json({\n   782â†’        error: true,\n   783â†’        message: 'Missing required data: patientData, algorithmResults, and qeegData are required'\n   784â†’      });\n   785â†’    }\n   786â†’\n   787â†’    console.log('ðŸ‘¤ Patient:', patientData.name);\n   788â†’    console.log('ðŸ“Š Parameters:', algorithmResults.parameters?.length);\n   789â†’    console.log('ðŸŽ¯ Using AI-powered generation with enhanced prompt');\n   790â†’\n   791â†’    // Generate AI PDF\n   792â†’    const generator = new AIPdfGenerator(patientData, algorithmResults, qeegData);\n   793â†’\n   794â†’    // Create output filename\n   795â†’    const timestamp = Date.now();\n   796â†’    const sanitizedName = (patientData.name || 'patient').replace(/[^a-z0-9]/gi, '_').toLowerCase();\n   797â†’    const filename = `ai-neurosense-report-${sanitizedName}-${timestamp}.pdf`;\n   798â†’    const outputPath = path.join(__dirname, '../uploads', filename);\n   799â†’\n   800â†’    console.log('ðŸ“ Generating AI PDF to:', filename);\n   801â†’\n   802â†’    // Generate the PDF\n   803â†’    const result = await generator.generateReport(outputPath);\n   804â†’\n   805â†’    console.log('\\nâœ… AI NeuroSense Report Generated Successfully!');\n   806â†’    console.log('ðŸ“„ Text File:', path.basename(result.textOutputPath));\n   807â†’    console.log('ðŸ“„ JSON File:', path.basename(result.outputPath));\n   808â†’    console.log('ðŸ“Š Tokens Used:', result.tokensUsed);\n   809â†’    console.log('ðŸ“ Content Length:', result.contentLength, 'characters');\n   810â†’    console.log('\\nðŸ === AI PDF Generation Completed ===\\n');\n   811â†’\n   812â†’    // Return report info\n   813â†’    res.json({\n   814â†’      success: true,\n   815â†’      data: {\n   816â†’        textFile: {\n   817â†’          filename: path.basename(result.textOutputPath),\n   818â†’          path: `/uploads/${path.basename(result.textOutputPath)}`,\n   819â†’          url: `${req.protocol}://${req.get('host')}/uploads/${path.basename(result.textOutputPath)}`,\n   820â†’          type: 'Plain Text Report'\n   821â†’        },\n   822â†’        jsonFile: {\n   823â†’          filename: path.basename(result.outputPath),\n   824â†’          path: `/uploads/${path.basename(result.outputPath)}`,\n   825â†’          url: `${req.protocol}://${req.get('host')}/uploads/${path.basename(result.outputPath)}`,\n   826â†’          type: 'Structured Data (JSON)'\n   827â†’        },\n   828â†’        contentLength: result.contentLength,\n   829â†’        tokensUsed: result.tokensUsed,\n   830â†’        generatedAt: new Date().toISOString()\n   831â†’      },\n   832â†’      message: 'AI-powered NeuroSense report generated successfully. Text file contains formatted report ready for PDF conversion.'\n   833â†’    });\n   834â†’\n   835â†’  } catch (error) {\n   836â†’    console.error('\\nâŒ === AI PDF Generation Failed ===');\n   837â†’    console.error('Error:', error.message);\n   838â†’    console.error('Stack:', error.stack);\n   839â†’\n   840â†’    res.status(500).json({\n   841â†’      error: true,\n   842â†’      message: error.message || 'Failed to generate AI PDF report',\n   843â†’      details: process.env.NODE_ENV === 'development' ? error.stack : undefined\n   844â†’    });\n   845â†’  }\n   846â†’});\n   847â†’\n   848â†’/**\n   849â†’ * POST /api/qeeg/generate-ai-sample-pdf\n   850â†’ * Generate a sample AI-powered PDF report for testing\n   851â†’ */\n   852â†’router.post('/generate-ai-sample-pdf', async (req, res) => {\n   853â†’  try {\n   854â†’    console.log('\\nðŸ¤– === Sample AI PDF Generation Started ===\\n');\n   855â†’\n   856â†’    const result = await AIPdfGenerator.generateSampleReport();\n   857â†’\n   858â†’    console.log('âœ… Sample AI PDF Generated!');\n   859â†’    console.log('ðŸ“„ Path:', result.outputPath);\n   860â†’\n   861â†’    const filename = path.basename(result.outputPath);\n   862â†’\n   863â†’    res.json({\n   864â†’      success: true,\n   865â†’      data: {\n   866â†’        filename: filename,\n   867â†’        path: `/uploads/${filename}`,\n   868â†’        url: `${req.protocol}://${req.get('host')}/uploads/${filename}`,\n   869â†’        contentLength: result.contentLength,\n   870â†’        tokensUsed: result.tokensUsed,\n   871â†’        type: 'AI-Generated Sample (JSON format)'\n   872â†’      }\n   873â†’    });\n   874â†’\n   875â†’  } catch (error) {\n   876â†’    console.error('âŒ Sample AI PDF generation failed:', error);\n   877â†’\n   878â†’    res.status(500).json({\n   879â†’      error: true,\n   880â†’      message: error.message\n   881â†’    });\n   882â†’  }\n   883â†’});\n   884â†’\n   885â†’/**\n   886â†’ * GET /api/qeeg/supabase-pdfs\n   887â†’ * List all PDFs from Supabase bucket\n   888â†’ */\n   889â†’router.get('/supabase-pdfs', async (req, res) => {\n   890â†’  try {\n   891â†’    console.log('ðŸ“‹ Fetching PDFs from Supabase bucket...');\n   892â†’\n   893â†’    const files = await SupabaseStorage.listFiles('patient-reports', 'reports');\n   894â†’\n   895â†’    // Get public URLs for all files\n   896â†’    const pdfs = files.map(file => {\n   897â†’      const { createClient } = require('@supabase/supabase-js');\n   898â†’      const supabase = createClient(process.env.SUPABASE_URL, process.env.SUPABASE_SERVICE_ROLE_KEY);\n   899â†’      const { data: urlData } = supabase.storage\n   900â†’        .from('patient-reports')\n   901â†’        .getPublicUrl(`reports/${file.name}`);\n   902â†’\n   903â†’      return {\n   904â†’        name: file.name,\n   905â†’        url: urlData.publicUrl,\n   906â†’        created_at: file.created_at,\n   907â†’        size: file.metadata?.size\n   908â†’      };\n   909â†’    });\n   910â†’\n   911â†’    console.log(`âœ… Found ${pdfs.length} PDFs in Supabase bucket`);\n   912â†’\n   913â†’    res.json({\n   914â†’      success: true,\n   915â†’      count: pdfs.length,\n   916â†’      pdfs: pdfs\n   917â†’    });\n   918â†’\n   919â†’  } catch (error) {\n   920â†’    console.error('âŒ Error listing Supabase PDFs:', error);\n   921â†’    res.status(500).json({\n   922â†’      success: false,\n   923â†’      error: error.message\n   924â†’    });\n   925â†’  }\n   926â†’});\n   927â†’\n   928â†’/**\n   929â†’ * GET /api/qeeg/test\n   930â†’ * Test endpoint to verify API is working\n   931â†’ */\n   932â†’router.get('/test', (req, res) => {\n   933â†’  res.json({\n   934â†’    success: true,\n   935â†’    message: 'QEEG Processing API is working',\n   936â†’    endpoints: {\n   937â†’      process: 'POST /api/qeeg/process - Upload and process QEEG files',\n   938â†’      generatePdf: 'POST /api/qeeg/generate-pdf - Generate PDF report from results (PDFKit)',\n   939â†’      generateSamplePdf: 'POST /api/qeeg/generate-sample-pdf - Generate sample PDF report (PDFKit)',\n   940â†’      generateAiPdf: 'POST /api/qeeg/generate-ai-pdf - Generate AI-powered PDF report (OpenAI)',\n   941â†’      generateAiSamplePdf: 'POST /api/qeeg/generate-ai-sample-pdf - Generate AI sample PDF report (OpenAI)',\n   942â†’      generateGeminiReport: 'POST /api/qeeg/generate-gemini-report - Generate AI report structure using Gemini',\n   943â†’      supabasePdfs: 'GET /api/qeeg/supabase-pdfs - List all PDFs from Supabase bucket'\n   944â†’    }\n   945â†’  });\n   946â†’});\n   947â†’\n   948â†’/**\n   949â†’ * POST /api/qeeg/generate-gemini-report\n   950â†’ * Generate AI-powered report structure using Google Gemini\n   951â†’ */\n   952â†’router.post('/generate-gemini-report', async (req, res) => {\n   953â†’  try {\n   954â†’    console.log('\\nðŸ¤– === Gemini AI Report Generation Started ===\\n');\n   955â†’\n   956â†’    if (!GeminiService) {\n   957â†’      return res.status(503).json({\n   958â†’        error: true,\n   959â†’        message: 'Gemini AI service is not available. Please check server configuration.'\n   960â†’      });\n   961â†’    }\n   962â†’\n   963â†’    const { algorithmResults } = req.body;\n   964â†’\n   965â†’    // Validate input\n   966â†’    if (!algorithmResults || !algorithmResults.parameters) {\n   967â†’      return res.status(400).json({\n   968â†’        error: true,\n   969â†’        message: 'Missing required data: algorithmResults with parameters array is required'\n   970â†’      });\n   971â†’    }\n   972â†’\n   973â†’    console.log('ðŸ“Š Processing', algorithmResults.parameters.length, 'brain parameters');\n   974â†’\n   975â†’    // Transform algorithm results to the format expected by Gemini\n   976â†’    const brainParameters = {\n   977â†’      Cognition: null,\n   978â†’      Stress: null,\n   979â†’      FocusAndAttention: null,\n   980â†’      BurnoutAndFatigue: null,\n   981â†’      EmotionalRegulation: null,\n   982â†’      Learning: null,\n   983â†’      Creativity: null\n   984â†’    };\n   985â†’\n   986â†’    // Map the parameters from algorithm results\n   987â†’    algorithmResults.parameters.forEach(param => {\n   988â†’      const paramName = param.name.replace(/\\s+/g, '');\n   989â†’      if (brainParameters.hasOwnProperty(paramName)) {\n   990â†’        brainParameters[paramName] = {\n   991â†’          score: param.score,\n   992â†’          bucket: param.bucket,\n   993â†’          subparameters: param.subParameters || []\n   994â†’        };\n   995â†’      }\n   996â†’    });\n   997â†’\n   998â†’    console.log('ðŸ§  Brain Parameters prepared for Gemini');\n   999â†’\n  1000â†’    // Generate report using Gemini AI\n  1001â†’    const result = await GeminiService.generateBrainPerformanceReport(brainParameters);\n  1002â†’\n  1003â†’    if (!result.success) {\n  1004â†’      return res.status(500).json({\n  1005â†’        error: true,\n  1006â†’        message: 'Failed to generate report with Gemini AI',\n  1007â†’        details: result.error\n  1008â†’      });\n  1009â†’    }\n  1010â†’\n  1011â†’    console.log('âœ… Gemini AI report generated successfully');\n  1012â†’\n  1013â†’    res.json({\n  1014â†’      success: true,\n  1015â†’      message: 'AI-powered report structure generated successfully',\n  1016â†’      reportData: result.data,\n  1017â†’      rawResponse: result.rawResponse\n  1018â†’    });\n  1019â†’\n  1020â†’  } catch (error) {\n  1021â†’    console.error('âŒ Error generating Gemini report:', error);\n  1022â†’    res.status(500).json({\n  1023â†’      error: true,\n  1024â†’      message: 'Internal server error while generating Gemini report',\n  1025â†’      details: error.message\n  1026â†’    });\n  1027â†’  }\n  1028â†’});\n  1029â†’\n  1030â†’module.exports = router;\n  1031â†’\n  1032â†’\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"1169e498-4497-452f-9c28-d6fbbd895ab1","timestamp":"2025-12-09T06:11:46.295Z","toolUseResult":{"type":"text","file":{"filePath":"D:\\Todays\\Neuro360\\server\\routes\\qeegRoutes.js","content":"const express = require('express');\nconst multer = require('multer');\nconst path = require('path');\nconst fs = require('fs');\nconst QEEGParser = require('../services/qeegParser');\nconst AlgorithmCalculator = require('../services/algorithmCalculator');\nconst ZScoreCalculator = require('../services/zscoreCalculator');\n// OLD generators (keeping for fallback)\nconst PDFReportGenerator = require('../services/pdfGenerator');\nconst TemplateBasedPDFGenerator = require('../services/pdfGeneratorTemplate');\nconst templateManager = require('../services/pdf/templateManager');\nconst AIPdfGenerator = require('../services/aiPdfGenerator');\nconst SupabaseStorage = require('../services/supabaseStorage');\n\n// NEW: Gemini AI Service for report generation\nlet GeminiService = null;\ntry {\n  GeminiService = require('../services/geminiService');\n  console.log('âœ… Gemini AI Service loaded successfully');\n} catch (error) {\n  console.error('âŒ CRITICAL: Gemini AI Service failed to load!');\n  console.error('   Error:', error.message);\n  console.error('   Stack:', error.stack);\n}\n\n// NEW: Gemini PDF Generator - Uses Gemini AI for content generation\nlet GeminiPdfGenerator = null;\ntry {\n  GeminiPdfGenerator = require('../services/geminiPdfGenerator');\n  console.log('âœ… Gemini PDF Generator loaded successfully');\n  console.log('   Generator available:', !!GeminiPdfGenerator);\n} catch (error) {\n  console.error('âŒ CRITICAL: Gemini PDF Generator failed to load!');\n  console.error('   Error:', error.message);\n  console.error('   Stack:', error.stack);\n}\n\n// OLD: Enhanced AI PDF Generator with OpenAI (keeping as fallback)\nlet EnhancedAIPdfGenerator = null;\ntry {\n  EnhancedAIPdfGenerator = require('../services/aiPdfGeneratorEnhanced');\n  console.log('âœ… Enhanced AI PDF Generator loaded successfully');\n} catch (error) {\n  console.warn('âš ï¸  Enhanced AI PDF Generator failed to load:', error.message);\n  console.warn('   Will use fallback PDF generator');\n}\n\nconst router = express.Router();\n\n// Configure multer for file uploads\nconst storage = multer.diskStorage({\n  destination: function (req, file, cb) {\n    const uploadDir = path.join(__dirname, '../uploads');\n    // Ensure upload directory exists\n    if (!fs.existsSync(uploadDir)) {\n      fs.mkdirSync(uploadDir, { recursive: true });\n    }\n    cb(null, uploadDir);\n  },\n  filename: function (req, file, cb) {\n    const uniqueSuffix = Date.now() + '-' + Math.round(Math.random() * 1E9);\n    cb(null, file.fieldname + '-' + uniqueSuffix + path.extname(file.originalname));\n  }\n});\n\nconst upload = multer({\n  storage: storage,\n  limits: {\n    fileSize: 50 * 1024 * 1024 // 50MB limit - increased to handle larger QEEG files\n  },\n  fileFilter: function (req, file, cb) {\n    const allowedExtensions = ['.pdf', '.csv', '.xlsx', '.xls'];\n    const ext = path.extname(file.originalname).toLowerCase();\n    if (allowedExtensions.includes(ext)) {\n      cb(null, true);\n    } else {\n      cb(new Error(`Only ${allowedExtensions.join(', ')} files are allowed`));\n    }\n  }\n});\n\n/**\n * POST /api/qeeg/process\n * Process QEEG files and calculate 7 brain health parameters\n */\nrouter.post('/process', upload.fields([\n  { name: 'eyesOpen', maxCount: 1 },\n  { name: 'eyesClosed', maxCount: 1 }\n]), async (req, res) => {\n  let eyesOpenFile = null;\n  let eyesClosedFile = null;\n\n  try {\n    console.log('\\nðŸ”¬ === QEEG Processing Started ===\\n');\n\n    // Get uploaded files\n    const files = req.files;\n    if (!files || !files.eyesOpen || !files.eyesClosed) {\n      return res.status(400).json({\n        error: true,\n        message: 'Both Eyes Open and Eyes Closed files are required'\n      });\n    }\n\n    eyesOpenFile = files.eyesOpen[0];\n    eyesClosedFile = files.eyesClosed[0];\n\n    console.log('ðŸ“ Files received:');\n    console.log('  - Eyes Open:', eyesOpenFile.originalname, `(${(eyesOpenFile.size / 1024).toFixed(2)} KB)`);\n    console.log('  - Eyes Closed:', eyesClosedFile.originalname, `(${(eyesClosedFile.size / 1024).toFixed(2)} KB)`);\n\n    // Get patient info from request body\n    const {\n      patientId,\n      patientName,\n      clinicName,\n      dateOfBirth,\n      age,\n      gender,\n      handedness\n    } = req.body;\n\n    console.log('\\nðŸ‘¤ Patient Information:');\n    console.log('  - Patient ID:', patientId);\n    console.log('  - Patient Name:', patientName);\n    console.log('  - Clinic:', clinicName);\n    console.log('  - Date of Birth:', dateOfBirth);\n    console.log('  - Age:', age);\n    console.log('  - Gender:', gender);\n    console.log('  - Handedness:', handedness);\n\n    // Validate OpenAI API configuration before processing (OPTIONAL - don't fail if missing)\n    console.log('\\nðŸ” Checking OpenAI API configuration...');\n    try {\n      await QEEGParser.testAPIConnection();\n      console.log('âœ… OpenAI API configured properly');\n    } catch (apiError) {\n      console.warn('âš ï¸  OpenAI API not configured or failed test:', apiError.message);\n      console.warn('   Continuing with processing anyway...');\n      // Don't throw error - allow processing to continue without OpenAI\n    }\n\n    // Step 1: Parse QEEG files\n    console.log('\\nðŸ“Š Step 1: Parsing QEEG files...');\n\n    // Show cache stats before parsing\n    const cacheStatsBefore = QEEGParser.getCacheStats();\n    console.log('ðŸ“Š Cache Statistics (Before):');\n    console.log(`   - Cache hits: ${cacheStatsBefore.hits}`);\n    console.log(`   - Cache misses: ${cacheStatsBefore.misses}`);\n    console.log(`   - Hit rate: ${cacheStatsBefore.hitRate}`);\n    console.log(`   - Cache size: ${cacheStatsBefore.cacheSize} entries`);\n\n    const qeegData = await QEEGParser.parse(eyesOpenFile, eyesClosedFile);\n\n    // Show cache stats after parsing\n    const cacheStatsAfter = QEEGParser.getCacheStats();\n    console.log('\\nðŸ“Š Cache Statistics (After):');\n    console.log(`   - Cache hits: ${cacheStatsAfter.hits}`);\n    console.log(`   - Cache misses: ${cacheStatsAfter.misses}`);\n    console.log(`   - Hit rate: ${cacheStatsAfter.hitRate}`);\n    console.log(`   - Cache size: ${cacheStatsAfter.cacheSize} entries`);\n\n    if (cacheStatsAfter.hits > cacheStatsBefore.hits) {\n      console.log('   âœ… CACHE HIT! Data retrieved from cache (no API quota used)');\n    } else {\n      console.log('   âš ï¸  CACHE MISS - Gemini API was called (quota consumed)');\n    }\n\n    // Validate that we got real patient data\n    console.log('\\nðŸ“Š QEEG Data Validation:');\n    console.log('  - Eyes Open (EO) channels:', Object.keys(qeegData.EO?.absolute || {}).length);\n    console.log('  - Eyes Closed (EC) channels:', Object.keys(qeegData.EC?.absolute || {}).length);\n    console.log('  - Using REAL PATIENT DATA (not sample data)');\n    console.log('  - Patient:', patientName, `(ID: ${patientId})`);\n\n    // Verify non-zero values (proof of real data extraction)\n    const eoFzTheta = qeegData.EO?.absolute?.Fz?.Theta || 0;\n    const ecPzAlpha = qeegData.EC?.absolute?.Pz?.Alpha || 0;\n    console.log('  - Sample Values (proof of extraction):');\n    console.log(`    * EO Fz Theta: ${eoFzTheta}`);\n    console.log(`    * EC Pz Alpha: ${ecPzAlpha}`);\n\n    // Warn if all values are zero (indicates parsing failure)\n    if (eoFzTheta === 0 && ecPzAlpha === 0) {\n      console.warn('  âš ï¸  WARNING: Sample values are zero - possible parsing issue!');\n    }\n\n    // COMPREHENSIVE VALIDATION CHECKS\n    console.log('\\nðŸ” Comprehensive Data Validation:');\n\n    // Check 1: Verify key channels have data\n    const requiredChannels = ['Fz', 'Cz', 'Pz', 'F3', 'F4'];\n    let missingChannels = 0;\n    requiredChannels.forEach(ch => {\n      const hasEO = qeegData.EO?.absolute?.[ch]?.Theta !== undefined;\n      const hasEC = qeegData.EC?.absolute?.[ch]?.Alpha !== undefined;\n      if (!hasEO || !hasEC) {\n        console.warn(`  âš ï¸  Missing data for channel ${ch}`);\n        missingChannels++;\n      }\n    });\n    if (missingChannels === 0) {\n      console.log('  âœ… All required channels have data');\n    }\n\n    // Check 2: Verify values are in reasonable ranges (not all zeros or defaults)\n    const testValues = [\n      qeegData.EO?.absolute?.Fz?.Theta,\n      qeegData.EO?.absolute?.Fz?.Beta,\n      qeegData.EC?.absolute?.Pz?.Alpha,\n      qeegData.EC?.relative?.Pz?.Alpha,\n      qeegData.EC?.relative?.Pz?.Beta\n    ];\n    const uniqueValues = new Set(testValues.filter(v => v !== null && v !== undefined));\n    if (uniqueValues.size <= 1) {\n      console.warn('  âš ï¸  WARNING: All test values are the same - possible static data!');\n    } else {\n      console.log(`  âœ… Data shows ${uniqueValues.size} unique values (not static)`);\n    }\n\n    // Check 3: Verify relative power sums to ~100% for a sample channel\n    if (qeegData.EO?.relative?.Fz) {\n      const fzBands = qeegData.EO.relative.Fz;\n      const sum = (fzBands.Delta || 0) + (fzBands.Theta || 0) +\n                  (fzBands.Alpha || 0) + (fzBands.Beta || 0) +\n                  (fzBands.HiBeta || 0);\n      console.log(`  ðŸ“Š Relative power sum (EO Fz): ${sum.toFixed(1)}%`);\n      if (sum < 80 || sum > 120) {\n        console.warn(`  âš ï¸  WARNING: Relative power sum is ${sum.toFixed(1)}% (expected ~100%)`);\n      } else {\n        console.log('  âœ… Relative power validation passed');\n      }\n    }\n\n    // Check 4: Verify critical values for calculations exist\n    const criticalValues = {\n      'Relaxation (Pz EC Relative Alpha)': qeegData.EC?.relative?.Pz?.Alpha,\n      'Relaxation (Pz EC Relative Beta)': qeegData.EC?.relative?.Pz?.Beta,\n      'Focus (Fz EO Theta)': qeegData.EO?.absolute?.Fz?.Theta,\n      'Focus (Fz EO Beta)': qeegData.EO?.absolute?.Fz?.Beta,\n      'Alpha Peak': qeegData.EC?.special?.alphaPeak || qeegData.EC?.special?.O1\n    };\n\n    console.log('\\n  ðŸŽ¯ Critical Values Check:');\n    let missingCritical = 0;\n    Object.entries(criticalValues).forEach(([name, value]) => {\n      if (value === null || value === undefined) {\n        console.warn(`  âŒ MISSING: ${name}`);\n        missingCritical++;\n      } else {\n        console.log(`  âœ… ${name}: ${value}`);\n      }\n    });\n\n    if (missingCritical > 0) {\n      console.warn(`\\n  âš ï¸  WARNING: ${missingCritical} critical values missing - calculations may be inaccurate!`);\n    } else {\n      console.log('\\n  âœ… All critical values present - ready for calculation');\n    }\n\n    // Step 2: Calculate parameters with appropriate calculator\n    console.log('\\nðŸ§® Step 2: Calculating 7 brain health parameters...');\n\n    // Route to appropriate calculator based on data type\n    const dataType = qeegData.dataType || 'raw';\n    console.log(`ðŸ“Š Data Type: ${dataType.toUpperCase()} mode`);\n\n    let calculator;\n    if (dataType === 'zscore') {\n      console.log('   Using Z-Score Calculator');\n      calculator = new ZScoreCalculator(qeegData);\n    } else {\n      console.log('   Using Raw Power Calculator');\n      calculator = new AlgorithmCalculator(qeegData);\n    }\n\n    const results = calculator.calculate();\n\n    console.log('\\nâœ… Calculation completed successfully!');\n    console.log('ðŸ“ˆ Results Summary:');\n    results.parameters.forEach(param => {\n      console.log(`  - ${param.name}: ${param.score}/${param.maxScore} (${param.classification})`);\n    });\n    console.log(`  - Overall Score: ${results.overallScore}/21`);\n\n    // COMPREHENSIVE DEBUG SUMMARY\n    console.log('\\n' + '='.repeat(80));\n    console.log('ðŸ“‹ COMPREHENSIVE DEBUG SUMMARY - FULL PIPELINE');\n    console.log('='.repeat(80));\n\n    console.log('\\n1ï¸âƒ£  DATA EXTRACTION PHASE:');\n    console.log(`    Patient: ${patientName} (ID: ${patientId})`);\n    console.log(`    Data Type: ${dataType.toUpperCase()} mode`);\n    console.log(`    EO Channels: ${Object.keys(qeegData.EO?.absolute || {}).length}`);\n    console.log(`    EC Channels: ${Object.keys(qeegData.EC?.absolute || {}).length}`);\n\n    console.log('\\n2ï¸âƒ£  SAMPLE EXTRACTED DATA:');\n    console.log('    Key Values Used in Calculations:');\n    console.log(`    - Fz EO Absolute Theta: ${qeegData.EO?.absolute?.Fz?.Theta || 'N/A'}`);\n    console.log(`    - Fz EO Absolute Beta: ${qeegData.EO?.absolute?.Fz?.Beta || 'N/A'}`);\n    console.log(`    - Pz EC Relative Alpha: ${qeegData.EC?.relative?.Pz?.Alpha || 'N/A'}`);\n    console.log(`    - Pz EC Relative Beta: ${qeegData.EC?.relative?.Pz?.Beta || 'N/A'}`);\n    console.log(`    - Alpha Peak: ${qeegData.EC?.special?.alphaPeak || qeegData.EC?.special?.O1 || 'N/A'} Hz`);\n\n    console.log('\\n3ï¸âƒ£  CALCULATION RESULTS:');\n    results.parameters.forEach((param, idx) => {\n      console.log(`    ${idx + 1}. ${param.name}: ${param.score}/${param.maxScore} (${param.classification})`);\n      param.metrics.forEach(metric => {\n        console.log(`       - ${metric.name}: ${metric.score} point`);\n        if (metric.description) {\n          console.log(`         ${metric.description}`);\n        }\n      });\n    });\n\n    console.log('\\n4ï¸âƒ£  EXPECTED vs ACTUAL (for Rhea\\'s Report):');\n    const expectedScores = {\n      'Cognition': { expected: 2, actual: results.parameters.find(p => p.name === 'Cognition')?.score },\n      'Stress': { expected: 0, actual: results.parameters.find(p => p.name === 'Stress')?.score },\n      'Focus & Attention': { expected: 2, actual: results.parameters.find(p => p.name === 'Focus & Attention')?.score },\n      'Burnout & Fatigue': { expected: 0, actual: results.parameters.find(p => p.name === 'Burnout & Fatigue')?.score },\n      'Emotional Regulation': { expected: 3, actual: results.parameters.find(p => p.name === 'Emotional Regulation')?.score },\n      'Learning': { expected: 2, actual: results.parameters.find(p => p.name === 'Learning')?.score },\n      'Creativity': { expected: 2, actual: results.parameters.find(p => p.name === 'Creativity')?.score }\n    };\n\n    console.log('    (Expected values are for Rhea\\'s Report only)');\n    Object.entries(expectedScores).forEach(([name, scores]) => {\n      const match = scores.expected === scores.actual ? 'âœ…' : 'âŒ';\n      console.log(`    ${match} ${name}: Expected ${scores.expected}/3, Got ${scores.actual}/3`);\n    });\n\n    console.log('\\n' + '='.repeat(80));\n    console.log('END OF DEBUG SUMMARY');\n    console.log('='.repeat(80) + '\\n');\n\n    // Step 3: Auto-generate PDF report\n    console.log('\\nðŸ“„ Step 3: Auto-generating PDF report...');\n    let pdfUrl = null;\n    let pdfFilename = null;\n\n    try {\n      // Prepare patient data for PDF\n      const pdfPatientData = {\n        name: patientName,\n        dateOfBirth: dateOfBirth || 'N/A',\n        age: age || 'N/A',\n        gender: gender || 'Not specified',\n        handedness: handedness || 'Not specified',\n        patientId: patientId,\n        clinicName: clinicName\n      };\n\n      // Prepare algorithm results for PDF\n      const pdfAlgorithmResults = {\n        parameters: results.parameters,\n        overallScore: results.overallScore\n      };\n\n      // Debug: Log parameters being sent to PDF\n      console.log('\\nðŸ“Š Parameters for PDF:');\n      console.log('  - Total Parameters:', pdfAlgorithmResults.parameters.length);\n      console.log('  - Overall Score:', pdfAlgorithmResults.overallScore);\n      pdfAlgorithmResults.parameters.forEach((param, i) => {\n        console.log(`  ${i + 1}. ${param.name}: ${param.score}/${param.maxScore} (${param.classification})`);\n      });\n\n      // Create output filename\n      const timestamp = Date.now();\n      const sanitizedName = (patientName || 'patient').replace(/[^a-z0-9]/gi, '_').toLowerCase();\n      pdfFilename = `neurosense-report-${sanitizedName}-${timestamp}.pdf`;\n      const uploadsDir = path.join(__dirname, '../uploads');\n      const pdfOutputPath = path.join(uploadsDir, pdfFilename);\n\n      // Ensure uploads directory exists\n      if (!fs.existsSync(uploadsDir)) {\n        console.log('ðŸ“ Creating uploads directory...');\n        fs.mkdirSync(uploadsDir, { recursive: true });\n      }\n\n      console.log('ðŸ“ Generating PDF to:', pdfFilename);\n      console.log('   Full path:', pdfOutputPath);\n\n      // === USE GEMINI PDF GENERATOR (with fallback) ===\n      console.log('\\nðŸ” Checking available PDF generators...');\n      console.log('   GeminiPdfGenerator available:', !!GeminiPdfGenerator);\n      console.log('   EnhancedAIPdfGenerator available:', !!EnhancedAIPdfGenerator);\n      console.log('   PDFReportGenerator available:', !!PDFReportGenerator);\n\n      let pdfGenerator;\n      // TEMPORARY: Use basic PDF generator since Gemini quota exceeded\n      // Re-enable Gemini when quota resets (after 24 hours)\n      const USE_GEMINI = false; // Set to true after quota resets\n\n      if (USE_GEMINI && GeminiPdfGenerator) {\n        console.log('\\nðŸ¤– === USING GEMINI AI PDF GENERATOR ===');\n        console.log('   Engine: Google Gemini + PDFKit');\n        console.log('   Patient:', pdfPatientData.name);\n        console.log('   Parameters:', pdfAlgorithmResults.parameters.length);\n        try {\n          pdfGenerator = new GeminiPdfGenerator(pdfPatientData, pdfAlgorithmResults, qeegData);\n          console.log('âœ… Gemini PDF Generator instantiated successfully');\n        } catch (instantiateError) {\n          console.error('âŒ Failed to instantiate Gemini PDF Generator:', instantiateError.message);\n          throw instantiateError;\n        }\n      } else if (EnhancedAIPdfGenerator) {\n        console.log('ðŸ¤– Using Enhanced AI PDF Generator (OpenAI + PDFKit - Fallback)');\n        pdfGenerator = new EnhancedAIPdfGenerator(pdfPatientData, pdfAlgorithmResults, qeegData);\n      } else {\n        console.log('ðŸ“„ Using Standard PDF Generator (Basic fallback)');\n        pdfGenerator = new PDFReportGenerator(pdfPatientData, pdfAlgorithmResults, qeegData);\n      }\n\n      // Generate the PDF\n      console.log('\\nðŸ“ Calling pdfGenerator.generateReport()...');\n      console.log('   Output path:', pdfOutputPath);\n\n      try {\n        await pdfGenerator.generateReport(pdfOutputPath);\n        console.log('âœ… PDF generation completed!');\n      } catch (genError) {\n        console.error('âŒ PDF generation threw error:', genError.message);\n        console.error('   Stack:', genError.stack);\n        throw genError;\n      }\n\n      // Verify file was created\n      if (!fs.existsSync(pdfOutputPath)) {\n        throw new Error('PDF file was not created at expected path: ' + pdfOutputPath);\n      }\n\n      console.log('âœ… PDF file verified at:', pdfOutputPath);\n      console.log('ðŸ“„ File:', pdfFilename);\n      console.log('ðŸ“Š Size:', (fs.statSync(pdfOutputPath).size / 1024).toFixed(2), 'KB');\n\n      // Upload to Supabase Storage\n      try {\n        console.log('\\nâ˜ï¸  Uploading PDF to Supabase storage...');\n        const uploadResult = await SupabaseStorage.uploadFile(\n          pdfOutputPath,\n          'patient-reports', // bucket name - FIXED\n          `reports/${pdfFilename}` // path in bucket\n        );\n\n        // Verify upload was successful and URL is valid\n        if (uploadResult && uploadResult.url) {\n          pdfUrl = uploadResult.url;\n          console.log('âœ… PDF uploaded to Supabase successfully');\n          console.log('ðŸ”— Supabase URL:', pdfUrl);\n\n          // Delete local file after successful Supabase upload\n          try {\n            fs.unlinkSync(pdfOutputPath);\n            console.log('ðŸ—‘ï¸  Local PDF file deleted after successful upload');\n          } catch (deleteError) {\n            console.warn('âš ï¸  Could not delete local PDF file:', deleteError.message);\n          }\n        } else {\n          throw new Error('Supabase upload returned invalid result');\n        }\n      } catch (supabaseError) {\n        console.error('âš ï¸  Supabase upload failed, using local storage');\n        console.error('   Error message:', supabaseError.message);\n        console.error('   Error stack:', supabaseError.stack);\n        console.error('   Full error:', JSON.stringify(supabaseError, null, 2));\n        // Fallback to local storage\n        pdfUrl = `/uploads/${pdfFilename}`;\n        console.log('ðŸ“ Using local file as fallback:', pdfUrl);\n      }\n\n    } catch (pdfError) {\n      console.error('\\nâŒ === PDF GENERATION FAILED ===');\n      console.error('Error message:', pdfError.message);\n      console.error('Error stack:', pdfError.stack);\n      console.error('Full error:', pdfError);\n      console.error('=================================\\n');\n\n      // Set pdfUrl to null so frontend knows PDF failed\n      pdfUrl = null;\n\n      // Don't fail the whole request if PDF fails - processing still succeeded\n      console.log('âš ï¸ Continuing without PDF - processing succeeded');\n    }\n\n    // Clean up uploaded files\n    try {\n      fs.unlinkSync(eyesOpenFile.path);\n      fs.unlinkSync(eyesClosedFile.path);\n      console.log('\\nðŸ—‘ï¸  Temporary files cleaned up');\n    } catch (cleanupError) {\n      console.error('âš ï¸  Error cleaning up files:', cleanupError.message);\n    }\n\n    console.log('\\nðŸ === QEEG Processing Completed ===\\n');\n\n    // Final check for PDF URL\n    if (!pdfUrl) {\n      console.warn('âš ï¸âš ï¸âš ï¸ WARNING: No PDF URL available in response!');\n      console.warn('   pdfFilename was:', pdfFilename || 'NOT SET');\n      console.warn('   This means PDF generation completely failed');\n    } else {\n      console.log('âœ… PDF URL ready:', pdfUrl);\n      console.log('   Type:', pdfUrl.startsWith('http') ? 'Supabase' : 'Local');\n    }\n\n    // Send response\n    res.json({\n      success: true,\n      data: {\n        patientId,\n        patientName,\n        clinicName,\n        processedAt: new Date().toISOString(),\n        dataType: dataType, // Add data type (raw or zscore)\n        results: results.parameters,\n        overallScore: results.overallScore,\n        maxScore: 21,\n        pdfUrl: pdfUrl,\n        pdfFilename: pdfFilename\n      }\n    });\n\n  } catch (error) {\n    console.error('\\nâŒ === QEEG Processing Failed ===');\n    console.error('Error:', error.message);\n    console.error('Error Code:', error.code || 'UNKNOWN');\n    console.error('Stack:', error.stack);\n\n    // Clean up files on error\n    if (eyesOpenFile && fs.existsSync(eyesOpenFile.path)) {\n      try {\n        fs.unlinkSync(eyesOpenFile.path);\n      } catch (e) {\n        console.error('Error deleting Eyes Open file:', e.message);\n      }\n    }\n    if (eyesClosedFile && fs.existsSync(eyesClosedFile.path)) {\n      try {\n        fs.unlinkSync(eyesClosedFile.path);\n      } catch (e) {\n        console.error('Error deleting Eyes Closed file:', e.message);\n      }\n    }\n\n    // Categorize errors for better user feedback\n    let statusCode = 500;\n    let userMessage = error.message;\n\n    // Check for Gemini quota error in error message\n    if (error.message && error.message.includes('429') && error.message.includes('quota')) {\n      error.code = 'GEMINI_QUOTA_EXCEEDED';\n    }\n\n    switch (error.code) {\n      case 'MISSING_API_KEY':\n      case 'INVALID_API_KEY':\n      case 'INVALID_API_KEY_FORMAT':\n      case 'API_CONNECTION_FAILED':\n        statusCode = 503; // Service Unavailable\n        userMessage = 'System configuration error: API key not properly configured. Please contact support.';\n        break;\n\n      case 'PDF_EXTRACTION_FAILED':\n        statusCode = 422; // Unprocessable Entity\n        userMessage = 'Failed to extract QEEG data from PDF. Please ensure the PDF contains valid QEEG tables with absolute and relative power values.';\n        break;\n\n      case 'GEMINI_QUOTA_EXCEEDED':\n        statusCode = 429; // Too Many Requests\n        userMessage = 'âš ï¸ API Quota Exceeded\\n\\n' +\n                     'The Gemini API free tier limit has been reached.\\n\\n' +\n                     'Solutions:\\n' +\n                     '1. Wait a few hours for quota to reset (resets at midnight PST)\\n' +\n                     '2. Try re-uploading previously processed files (uses cache, no quota consumed)\\n' +\n                     '3. Upgrade to paid plan: https://ai.google.dev/pricing\\n' +\n                     '4. Contact administrator for assistance\\n\\n' +\n                     'Cache Info: The system remembers files you\\'ve uploaded before - those won\\'t use quota!';\n        break;\n\n      default:\n        // If error message contains Gemini quota keywords, classify it\n        if (userMessage && (userMessage.includes('quota') || userMessage.includes('429') || userMessage.includes('Too Many Requests'))) {\n          statusCode = 429;\n          userMessage = 'âš ï¸ API Quota Exceeded\\n\\n' +\n                       'The Gemini AI service has reached its daily request limit.\\n\\n' +\n                       'Solutions:\\n' +\n                       'â€¢ Wait for quota reset (usually resets at midnight PST)\\n' +\n                       'â€¢ Re-upload the same files (cached, no quota used)\\n' +\n                       'â€¢ Contact administrator to upgrade API plan\\n\\n' +\n                       'Technical Details: ' + error.message;\n        } else {\n          userMessage = error.message || 'Failed to process QEEG files';\n        }\n    }\n\n    res.status(statusCode).json({\n      error: true,\n      message: userMessage,\n      code: error.code || 'UNKNOWN_ERROR',\n      technicalDetails: process.env.NODE_ENV === 'development' ? {\n        originalMessage: error.message,\n        stack: error.stack,\n        condition: error.condition\n      } : undefined\n    });\n  }\n});\n\n/**\n * POST /api/qeeg/generate-pdf\n * Generate PDF report from algorithm results\n */\nrouter.post('/generate-pdf', async (req, res) => {\n  try {\n    console.log('\\nðŸ“„ === PDF Report Generation Started ===\\n');\n\n    const { patientData, algorithmResults, qeegData } = req.body;\n\n    // Validate input\n    if (!patientData || !algorithmResults || !qeegData) {\n      return res.status(400).json({\n        error: true,\n        message: 'Missing required data: patientData, algorithmResults, and qeegData are required'\n      });\n    }\n\n    console.log('ðŸ‘¤ Patient:', patientData.name);\n    console.log('ðŸ“Š Parameters:', algorithmResults.parameters?.length);\n\n    // === USE GEMINI PDF GENERATOR (if available) ===\n    let generator;\n    if (GeminiPdfGenerator) {\n      console.log('ðŸ¤– Using Gemini AI PDF Generator (Google Gemini + PDFKit)');\n      generator = new GeminiPdfGenerator(patientData, algorithmResults, qeegData);\n    } else if (EnhancedAIPdfGenerator) {\n      console.log('ðŸ¤– Using Enhanced AI PDF Generator (OpenAI + PDFKit - Fallback)');\n      generator = new EnhancedAIPdfGenerator(patientData, algorithmResults, qeegData);\n    } else {\n      console.log('ðŸ“„ Using Standard PDF Generator (Basic fallback)');\n      generator = new PDFReportGenerator(patientData, algorithmResults, qeegData);\n    }\n\n    // Create output filename\n    const timestamp = Date.now();\n    const sanitizedName = (patientData.name || 'patient').replace(/[^a-z0-9]/gi, '_').toLowerCase();\n    const filename = `neurosense-report-${sanitizedName}-${timestamp}.pdf`;\n    const outputPath = path.join(__dirname, '../uploads', filename);\n\n    console.log('ðŸ“ Generating AI-powered PDF to:', filename);\n\n    // Generate the PDF with AI insights\n    const pdfPath = await generator.generateReport(outputPath);\n\n    console.log('\\nâœ… PDF Report Generated Successfully!');\n    console.log('ðŸ“„ File:', filename);\n    console.log('ðŸ“Š Size:', (fs.statSync(pdfPath).size / 1024).toFixed(2), 'KB');\n\n    // Upload to Supabase Storage - TEMPORARILY DISABLED\n    let supabaseUrl = null;\n    let supabasePath = null;\n    let uploadError = null;\n\n    // DISABLE SUPABASE UPLOAD FOR NOW - USE LOCAL STORAGE ONLY\n    console.log('\\nðŸ“ Using local storage (Supabase upload disabled)');\n    uploadError = 'Supabase upload disabled - using local storage';\n\n    /* COMMENTED OUT - Enable when Supabase is configured properly\n    try {\n      console.log('\\nâ˜ï¸  Uploading PDF to Supabase storage...');\n      const uploadResult = await SupabaseStorage.uploadFile(\n        pdfPath,\n        'patient-reports', // bucket name\n        `reports/${filename}` // path in bucket\n      );\n\n      // Verify upload was successful and URL is valid\n      if (uploadResult && uploadResult.url) {\n        supabaseUrl = uploadResult.url;\n        supabasePath = uploadResult.path;\n\n        console.log('âœ… PDF uploaded to Supabase successfully');\n        console.log('ðŸ”— Supabase URL:', supabaseUrl);\n\n        // Only delete local file after SUCCESSFUL Supabase upload\n        try {\n          fs.unlinkSync(pdfPath);\n          console.log('ðŸ—‘ï¸  Local PDF file deleted after successful upload');\n        } catch (deleteError) {\n          console.warn('âš ï¸  Could not delete local PDF file:', deleteError.message);\n        }\n      } else {\n        throw new Error('Supabase upload returned invalid result');\n      }\n\n    } catch (error) {\n      console.error('âš ï¸  Supabase upload failed, using local storage:', error.message);\n      uploadError = error.message;\n      // Keep local file as fallback - DO NOT DELETE\n      console.log('ðŸ“ Using local file as fallback');\n    }\n    */\n\n    console.log('\\nðŸ === PDF Generation Completed ===\\n');\n\n    // Return PDF info - prioritize Supabase URL\n    res.json({\n      success: true,\n      data: {\n        filename: filename,\n        path: supabasePath || `/uploads/${filename}`,\n        url: supabaseUrl || `${req.protocol}://${req.get('host')}/uploads/${filename}`,\n        size: fs.existsSync(pdfPath) ? fs.statSync(pdfPath).size : 0,\n        generatedAt: new Date().toISOString(),\n        storage: supabaseUrl ? 'supabase' : 'local',\n        uploadError: uploadError\n      }\n    });\n\n  } catch (error) {\n    console.error('\\nâŒ === PDF Generation Failed ===');\n    console.error('Error:', error.message);\n    console.error('Stack:', error.stack);\n\n    res.status(500).json({\n      error: true,\n      message: error.message || 'Failed to generate PDF report',\n      details: process.env.NODE_ENV === 'development' ? error.stack : undefined\n    });\n  }\n});\n\n/**\n * POST /api/qeeg/generate-sample-pdf\n * Generate a sample PDF report for testing\n */\nrouter.post('/generate-sample-pdf', async (req, res) => {\n  try {\n    console.log('\\nðŸ“„ === Sample PDF Generation Started ===\\n');\n\n    const pdfPath = await PDFReportGenerator.generateSampleReport();\n\n    console.log('âœ… Sample PDF Generated!');\n    console.log('ðŸ“„ Path:', pdfPath);\n\n    const filename = path.basename(pdfPath);\n\n    res.json({\n      success: true,\n      data: {\n        filename: filename,\n        path: `/uploads/${filename}`,\n        url: `${req.protocol}://${req.get('host')}/uploads/${filename}`,\n        size: fs.statSync(pdfPath).size\n      }\n    });\n\n  } catch (error) {\n    console.error('âŒ Sample PDF generation failed:', error);\n\n    res.status(500).json({\n      error: true,\n      message: error.message\n    });\n  }\n});\n\n/**\n * POST /api/qeeg/generate-ai-pdf\n * Generate AI-powered PDF report with enhanced design and content\n */\nrouter.post('/generate-ai-pdf', async (req, res) => {\n  try {\n    console.log('\\nðŸ¤– === AI PDF Report Generation Started ===\\n');\n\n    const { patientData, algorithmResults, qeegData } = req.body;\n\n    // Validate input\n    if (!patientData || !algorithmResults || !qeegData) {\n      return res.status(400).json({\n        error: true,\n        message: 'Missing required data: patientData, algorithmResults, and qeegData are required'\n      });\n    }\n\n    console.log('ðŸ‘¤ Patient:', patientData.name);\n    console.log('ðŸ“Š Parameters:', algorithmResults.parameters?.length);\n    console.log('ðŸŽ¯ Using AI-powered generation with enhanced prompt');\n\n    // Generate AI PDF\n    const generator = new AIPdfGenerator(patientData, algorithmResults, qeegData);\n\n    // Create output filename\n    const timestamp = Date.now();\n    const sanitizedName = (patientData.name || 'patient').replace(/[^a-z0-9]/gi, '_').toLowerCase();\n    const filename = `ai-neurosense-report-${sanitizedName}-${timestamp}.pdf`;\n    const outputPath = path.join(__dirname, '../uploads', filename);\n\n    console.log('ðŸ“ Generating AI PDF to:', filename);\n\n    // Generate the PDF\n    const result = await generator.generateReport(outputPath);\n\n    console.log('\\nâœ… AI NeuroSense Report Generated Successfully!');\n    console.log('ðŸ“„ Text File:', path.basename(result.textOutputPath));\n    console.log('ðŸ“„ JSON File:', path.basename(result.outputPath));\n    console.log('ðŸ“Š Tokens Used:', result.tokensUsed);\n    console.log('ðŸ“ Content Length:', result.contentLength, 'characters');\n    console.log('\\nðŸ === AI PDF Generation Completed ===\\n');\n\n    // Return report info\n    res.json({\n      success: true,\n      data: {\n        textFile: {\n          filename: path.basename(result.textOutputPath),\n          path: `/uploads/${path.basename(result.textOutputPath)}`,\n          url: `${req.protocol}://${req.get('host')}/uploads/${path.basename(result.textOutputPath)}`,\n          type: 'Plain Text Report'\n        },\n        jsonFile: {\n          filename: path.basename(result.outputPath),\n          path: `/uploads/${path.basename(result.outputPath)}`,\n          url: `${req.protocol}://${req.get('host')}/uploads/${path.basename(result.outputPath)}`,\n          type: 'Structured Data (JSON)'\n        },\n        contentLength: result.contentLength,\n        tokensUsed: result.tokensUsed,\n        generatedAt: new Date().toISOString()\n      },\n      message: 'AI-powered NeuroSense report generated successfully. Text file contains formatted report ready for PDF conversion.'\n    });\n\n  } catch (error) {\n    console.error('\\nâŒ === AI PDF Generation Failed ===');\n    console.error('Error:', error.message);\n    console.error('Stack:', error.stack);\n\n    res.status(500).json({\n      error: true,\n      message: error.message || 'Failed to generate AI PDF report',\n      details: process.env.NODE_ENV === 'development' ? error.stack : undefined\n    });\n  }\n});\n\n/**\n * POST /api/qeeg/generate-ai-sample-pdf\n * Generate a sample AI-powered PDF report for testing\n */\nrouter.post('/generate-ai-sample-pdf', async (req, res) => {\n  try {\n    console.log('\\nðŸ¤– === Sample AI PDF Generation Started ===\\n');\n\n    const result = await AIPdfGenerator.generateSampleReport();\n\n    console.log('âœ… Sample AI PDF Generated!');\n    console.log('ðŸ“„ Path:', result.outputPath);\n\n    const filename = path.basename(result.outputPath);\n\n    res.json({\n      success: true,\n      data: {\n        filename: filename,\n        path: `/uploads/${filename}`,\n        url: `${req.protocol}://${req.get('host')}/uploads/${filename}`,\n        contentLength: result.contentLength,\n        tokensUsed: result.tokensUsed,\n        type: 'AI-Generated Sample (JSON format)'\n      }\n    });\n\n  } catch (error) {\n    console.error('âŒ Sample AI PDF generation failed:', error);\n\n    res.status(500).json({\n      error: true,\n      message: error.message\n    });\n  }\n});\n\n/**\n * GET /api/qeeg/supabase-pdfs\n * List all PDFs from Supabase bucket\n */\nrouter.get('/supabase-pdfs', async (req, res) => {\n  try {\n    console.log('ðŸ“‹ Fetching PDFs from Supabase bucket...');\n\n    const files = await SupabaseStorage.listFiles('patient-reports', 'reports');\n\n    // Get public URLs for all files\n    const pdfs = files.map(file => {\n      const { createClient } = require('@supabase/supabase-js');\n      const supabase = createClient(process.env.SUPABASE_URL, process.env.SUPABASE_SERVICE_ROLE_KEY);\n      const { data: urlData } = supabase.storage\n        .from('patient-reports')\n        .getPublicUrl(`reports/${file.name}`);\n\n      return {\n        name: file.name,\n        url: urlData.publicUrl,\n        created_at: file.created_at,\n        size: file.metadata?.size\n      };\n    });\n\n    console.log(`âœ… Found ${pdfs.length} PDFs in Supabase bucket`);\n\n    res.json({\n      success: true,\n      count: pdfs.length,\n      pdfs: pdfs\n    });\n\n  } catch (error) {\n    console.error('âŒ Error listing Supabase PDFs:', error);\n    res.status(500).json({\n      success: false,\n      error: error.message\n    });\n  }\n});\n\n/**\n * GET /api/qeeg/test\n * Test endpoint to verify API is working\n */\nrouter.get('/test', (req, res) => {\n  res.json({\n    success: true,\n    message: 'QEEG Processing API is working',\n    endpoints: {\n      process: 'POST /api/qeeg/process - Upload and process QEEG files',\n      generatePdf: 'POST /api/qeeg/generate-pdf - Generate PDF report from results (PDFKit)',\n      generateSamplePdf: 'POST /api/qeeg/generate-sample-pdf - Generate sample PDF report (PDFKit)',\n      generateAiPdf: 'POST /api/qeeg/generate-ai-pdf - Generate AI-powered PDF report (OpenAI)',\n      generateAiSamplePdf: 'POST /api/qeeg/generate-ai-sample-pdf - Generate AI sample PDF report (OpenAI)',\n      generateGeminiReport: 'POST /api/qeeg/generate-gemini-report - Generate AI report structure using Gemini',\n      supabasePdfs: 'GET /api/qeeg/supabase-pdfs - List all PDFs from Supabase bucket'\n    }\n  });\n});\n\n/**\n * POST /api/qeeg/generate-gemini-report\n * Generate AI-powered report structure using Google Gemini\n */\nrouter.post('/generate-gemini-report', async (req, res) => {\n  try {\n    console.log('\\nðŸ¤– === Gemini AI Report Generation Started ===\\n');\n\n    if (!GeminiService) {\n      return res.status(503).json({\n        error: true,\n        message: 'Gemini AI service is not available. Please check server configuration.'\n      });\n    }\n\n    const { algorithmResults } = req.body;\n\n    // Validate input\n    if (!algorithmResults || !algorithmResults.parameters) {\n      return res.status(400).json({\n        error: true,\n        message: 'Missing required data: algorithmResults with parameters array is required'\n      });\n    }\n\n    console.log('ðŸ“Š Processing', algorithmResults.parameters.length, 'brain parameters');\n\n    // Transform algorithm results to the format expected by Gemini\n    const brainParameters = {\n      Cognition: null,\n      Stress: null,\n      FocusAndAttention: null,\n      BurnoutAndFatigue: null,\n      EmotionalRegulation: null,\n      Learning: null,\n      Creativity: null\n    };\n\n    // Map the parameters from algorithm results\n    algorithmResults.parameters.forEach(param => {\n      const paramName = param.name.replace(/\\s+/g, '');\n      if (brainParameters.hasOwnProperty(paramName)) {\n        brainParameters[paramName] = {\n          score: param.score,\n          bucket: param.bucket,\n          subparameters: param.subParameters || []\n        };\n      }\n    });\n\n    console.log('ðŸ§  Brain Parameters prepared for Gemini');\n\n    // Generate report using Gemini AI\n    const result = await GeminiService.generateBrainPerformanceReport(brainParameters);\n\n    if (!result.success) {\n      return res.status(500).json({\n        error: true,\n        message: 'Failed to generate report with Gemini AI',\n        details: result.error\n      });\n    }\n\n    console.log('âœ… Gemini AI report generated successfully');\n\n    res.json({\n      success: true,\n      message: 'AI-powered report structure generated successfully',\n      reportData: result.data,\n      rawResponse: result.rawResponse\n    });\n\n  } catch (error) {\n    console.error('âŒ Error generating Gemini report:', error);\n    res.status(500).json({\n      error: true,\n      message: 'Internal server error while generating Gemini report',\n      details: error.message\n    });\n  }\n});\n\nmodule.exports = router;\n\n","numLines":1032,"startLine":1,"totalLines":1032}}}
{"parentUuid":"1169e498-4497-452f-9c28-d6fbbd895ab1","isSidechain":true,"userType":"external","cwd":"D:\\Todays\\Neuro360","sessionId":"042556c2-8872-4445-8efb-d2658cbac4a7","version":"2.0.33","gitBranch":"main","agentId":"63bdb4e9","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01PV4fNk4shzPnBtKsQsVu7N","type":"message","role":"assistant","content":[{"type":"text","text":"Now let me check the qeegParser to understand how Gemini is being called:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1595,"cache_creation_input_tokens":16693,"cache_read_input_tokens":61763,"cache_creation":{"ephemeral_5m_input_tokens":16693,"ephemeral_1h_input_tokens":0},"output_tokens":110,"service_tier":"standard"}},"requestId":"req_011CVvcoZqvWftGNDeCw4m6w","type":"assistant","uuid":"a91619ba-5a5c-4ce9-ab80-01e1c26811ed","timestamp":"2025-12-09T06:11:51.681Z"}
{"parentUuid":"a91619ba-5a5c-4ce9-ab80-01e1c26811ed","isSidechain":true,"userType":"external","cwd":"D:\\Todays\\Neuro360","sessionId":"042556c2-8872-4445-8efb-d2658cbac4a7","version":"2.0.33","gitBranch":"main","agentId":"63bdb4e9","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01PV4fNk4shzPnBtKsQsVu7N","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_0175XLkP8ZRxKPjAB6MfWyew","name":"Read","input":{"file_path":"D:\\Todays\\Neuro360\\server\\services\\qeegParser.js","limit":300}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1595,"cache_creation_input_tokens":16693,"cache_read_input_tokens":61763,"cache_creation":{"ephemeral_5m_input_tokens":16693,"ephemeral_1h_input_tokens":0},"output_tokens":110,"service_tier":"standard"}},"requestId":"req_011CVvcoZqvWftGNDeCw4m6w","type":"assistant","uuid":"2d6a419b-9f30-44af-ae0d-32d12a8fe771","timestamp":"2025-12-09T06:11:52.709Z"}
{"parentUuid":"2d6a419b-9f30-44af-ae0d-32d12a8fe771","isSidechain":true,"userType":"external","cwd":"D:\\Todays\\Neuro360","sessionId":"042556c2-8872-4445-8efb-d2658cbac4a7","version":"2.0.33","gitBranch":"main","agentId":"63bdb4e9","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_0175XLkP8ZRxKPjAB6MfWyew","type":"tool_result","content":"     1â†’const fs = require('fs');\n     2â†’const path = require('path');\n     3â†’const crypto = require('crypto');\n     4â†’const { GoogleGenerativeAI } = require('@google/generative-ai');\n     5â†’const pdfParse = require('pdf-parse');\n     6â†’const XLSX = require('xlsx');\n     7â†’\n     8â†’// Initialize Gemini AI client\n     9â†’const genAI = new GoogleGenerativeAI(process.env.GEMINI_API_KEY);\n    10â†’let geminiModel = null;\n    11â†’\n    12â†’// In-memory cache for PDF extraction results (ensures deterministic behavior)\n    13â†’// Key: PDF MD5 hash â†’ Value: Extracted QEEG data\n    14â†’const extractionCache = new Map();\n    15â†’\n    16â†’// Cache statistics for monitoring\n    17â†’const cacheStats = {\n    18â†’  hits: 0,\n    19â†’  misses: 0,\n    20â†’  totalExtractions: 0\n    21â†’};\n    22â†’\n    23â†’class QEEGParser {\n    24â†’  /**\n    25â†’   * Fetch available Gemini models that support generateContent\n    26â†’   * @returns {Promise<Array>} List of available models\n    27â†’   */\n    28â†’  static async fetchAvailableModels() {\n    29â†’    try {\n    30â†’      console.log('ðŸ” Fetching available Gemini models...');\n    31â†’\n    32â†’      const response = await fetch(\n    33â†’        `https://generativelanguage.googleapis.com/v1/models?key=${process.env.GEMINI_API_KEY}`\n    34â†’      );\n    35â†’\n    36â†’      if (!response.ok) {\n    37â†’        throw new Error(`API returned ${response.status}: ${response.statusText}`);\n    38â†’      }\n    39â†’\n    40â†’      const data = await response.json();\n    41â†’\n    42â†’      // Filter models that support generateContent\n    43â†’      const supportedModels = (data.models || []).filter(model =>\n    44â†’        model.supportedGenerationMethods?.includes('generateContent')\n    45â†’      );\n    46â†’\n    47â†’      console.log(`âœ… Found ${supportedModels.length} models that support generateContent:`);\n    48â†’      supportedModels.forEach(model => {\n    49â†’        console.log(`   - ${model.name}`);\n    50â†’      });\n    51â†’\n    52â†’      return supportedModels;\n    53â†’    } catch (error) {\n    54â†’      console.error('âŒ Failed to fetch models:', error.message);\n    55â†’      return [];\n    56â†’    }\n    57â†’  }\n    58â†’\n    59â†’  /**\n    60â†’   * Select best available model from list\n    61â†’   * @param {Array} models - List of available models\n    62â†’   * @returns {string|null} Model name to use\n    63â†’   */\n    64â†’  static selectBestModel(models) {\n    65â†’    if (!models || models.length === 0) return null;\n    66â†’\n    67â†’    // Priority: flash models (fastest) > pro models > any other\n    68â†’    const preferences = ['flash', 'pro'];\n    69â†’\n    70â†’    for (const preference of preferences) {\n    71â†’      const found = models.find(m =>\n    72â†’        m.name.toLowerCase().includes(preference)\n    73â†’      );\n    74â†’      if (found) {\n    75â†’        console.log(`âœ… Selected model: ${found.name}`);\n    76â†’        return found.name;\n    77â†’      }\n    78â†’    }\n    79â†’\n    80â†’    // Fallback to first available\n    81â†’    console.log(`âœ… Using first available model: ${models[0].name}`);\n    82â†’    return models[0].name;\n    83â†’  }\n    84â†’\n    85â†’  /**\n    86â†’   * Validate Gemini API key is configured and appears valid\n    87â†’   * @throws {Error} if API key is missing or invalid format\n    88â†’   */\n    89â†’  static validateAPIKey() {\n    90â†’    const apiKey = process.env.GEMINI_API_KEY;\n    91â†’\n    92â†’    // Check if key exists\n    93â†’    if (!apiKey || apiKey.trim() === '') {\n    94â†’      const error = new Error('GEMINI_API_KEY environment variable is not set');\n    95â†’      error.code = 'MISSING_API_KEY';\n    96â†’      throw error;\n    97â†’    }\n    98â†’\n    99â†’    // Check if key is placeholder\n   100â†’    if (apiKey === 'your-gemini-api-key-here' || apiKey.includes('placeholder')) {\n   101â†’      const error = new Error('GEMINI_API_KEY is set to placeholder value. Please configure a valid Gemini API key.');\n   102â†’      error.code = 'INVALID_API_KEY';\n   103â†’      throw error;\n   104â†’    }\n   105â†’\n   106â†’    console.log('âœ… Gemini API key validation passed');\n   107â†’    return true;\n   108â†’  }\n   109â†’\n   110â†’  /**\n   111â†’   * Test Gemini API connection with a simple request\n   112â†’   * @returns {Promise<boolean>} true if connection successful\n   113â†’   * @throws {Error} if connection fails\n   114â†’   */\n   115â†’  static async testAPIConnection() {\n   116â†’    try {\n   117â†’      this.validateAPIKey();\n   118â†’\n   119â†’      console.log('ðŸ”Œ Testing Gemini API connection...');\n   120â†’\n   121â†’      if (!geminiModel) {\n   122â†’        console.log('ðŸ”‘ API Key check:', process.env.GEMINI_API_KEY ? 'Present' : 'MISSING');\n   123â†’\n   124â†’        // Fetch available models dynamically\n   125â†’        const availableModels = await this.fetchAvailableModels();\n   126â†’\n   127â†’        if (availableModels.length === 0) {\n   128â†’          throw new Error('No Gemini models available. Check your API key at https://aistudio.google.com/apikey');\n   129â†’        }\n   130â†’\n   131â†’        // Select best model\n   132â†’        const modelName = this.selectBestModel(availableModels);\n   133â†’\n   134â†’        if (!modelName) {\n   135â†’          throw new Error('Could not select a valid model');\n   136â†’        }\n   137â†’\n   138â†’        // Initialize model with full path\n   139â†’        console.log(`ðŸ”§ Initializing model: ${modelName}`);\n   140â†’        geminiModel = genAI.getGenerativeModel({ model: modelName });\n   141â†’\n   142â†’        // Test it with simple call\n   143â†’        console.log('ðŸ“ž Testing model with simple call...');\n   144â†’        const testResult = await geminiModel.generateContent('Hello');\n   145â†’        await testResult.response;\n   146â†’        console.log('âœ… Model initialized and tested successfully');\n   147â†’      }\n   148â†’\n   149â†’      const result = await geminiModel.generateContent('Reply with OK');\n   150â†’      const response = await result.response;\n   151â†’      const text = response.text();\n   152â†’\n   153â†’      if (text) {\n   154â†’        console.log('âœ… Gemini API connection successful');\n   155â†’        return true;\n   156â†’      } else {\n   157â†’        throw new Error('Gemini API returned unexpected response');\n   158â†’      }\n   159â†’\n   160â†’    } catch (error) {\n   161â†’      console.error('âŒ Gemini API connection test failed:', error.message);\n   162â†’      const enhancedError = new Error(`Gemini API connection test failed: ${error.message}`);\n   163â†’      enhancedError.code = 'API_CONNECTION_FAILED';\n   164â†’      enhancedError.originalError = error;\n   165â†’      throw enhancedError;\n   166â†’    }\n   167â†’  }\n   168â†’\n   169â†’  /**\n   170â†’   * Detect report type (raw power values or Z-scores)\n   171â†’   * @param {Object} file - Multer file object\n   172â†’   * @returns {Promise<string>} 'raw' or 'zscore'\n   173â†’   */\n   174â†’  static async detectReportType(file) {\n   175â†’    try {\n   176â†’      console.log(`ðŸ” Detecting report type for: ${file.originalname}`);\n   177â†’\n   178â†’      const dataBuffer = fs.readFileSync(file.path);\n   179â†’      const pdfData = await pdfParse(dataBuffer);\n   180â†’      const text = pdfData.text.toLowerCase();\n   181â†’\n   182â†’      // Keyword detection\n   183â†’      const zscoreKeywords = ['z-score', 'z score', 'z =', 'z=', 'standard deviation', 'sd from mean'];\n   184â†’      const rawKeywords = ['absolute power (Î¼vÂ²)', 'absolute power (uvÂ²)', 'relative power (%)', 'Î¼vÂ²', 'uvÂ²'];\n   185â†’\n   186â†’      let zscoreCount = 0;\n   187â†’      let rawCount = 0;\n   188â†’\n   189â†’      // Count keyword occurrences\n   190â†’      zscoreKeywords.forEach(keyword => {\n   191â†’        const matches = (text.match(new RegExp(keyword, 'g')) || []).length;\n   192â†’        zscoreCount += matches;\n   193â†’      });\n   194â†’\n   195â†’      rawKeywords.forEach(keyword => {\n   196â†’        const matches = (text.match(new RegExp(keyword, 'g')) || []).length;\n   197â†’        rawCount += matches;\n   198â†’      });\n   199â†’\n   200â†’      console.log(`   Z-score keywords found: ${zscoreCount}`);\n   201â†’      console.log(`   Raw power keywords found: ${rawCount}`);\n   202â†’\n   203â†’      // Decision logic\n   204â†’      if (zscoreCount > rawCount && zscoreCount >= 3) {\n   205â†’        console.log(`âœ… Detected: Z-SCORE report`);\n   206â†’        return 'zscore';\n   207â†’      } else if (rawCount > zscoreCount && rawCount >= 2) {\n   208â†’        console.log(`âœ… Detected: RAW POWER report`);\n   209â†’        return 'raw';\n   210â†’      } else if (zscoreCount > 0 && rawCount > 0) {\n   211â†’        // Mixed report - check for table structure\n   212â†’        if (text.includes('z-score table') || text.includes('z score table')) {\n   213â†’          console.log(`âš ï¸ Mixed report detected - preferring Z-SCORE`);\n   214â†’          return 'zscore';\n   215â†’        } else {\n   216â†’          console.log(`âš ï¸ Mixed report detected - preferring RAW POWER`);\n   217â†’          return 'raw';\n   218â†’        }\n   219â†’      } else {\n   220â†’        // Fallback: assume raw if unclear\n   221â†’        console.warn(`âš ï¸ Could not clearly detect report type - defaulting to RAW POWER`);\n   222â†’        return 'raw';\n   223â†’      }\n   224â†’\n   225â†’    } catch (error) {\n   226â†’      console.error(`âŒ Error detecting report type for ${file.originalname}:`, error.message);\n   227â†’      // Safe default\n   228â†’      console.warn(`   Defaulting to RAW POWER mode`);\n   229â†’      return 'raw';\n   230â†’    }\n   231â†’  }\n   232â†’\n   233â†’  /**\n   234â†’   * Main method to parse uploaded files\n   235â†’   * @param {Object} eyesOpenFile - Multer file object for Eyes Open data\n   236â†’   * @param {Object} eyesClosedFile - Multer file object for Eyes Closed data\n   237â†’   * @returns {Object} Parsed QEEG data\n   238â†’   */\n   239â†’  static async parse(eyesOpenFile, eyesClosedFile) {\n   240â†’    try {\n   241â†’      console.log('\\nðŸ“„ === QEEG File Parsing Started ===');\n   242â†’      console.log('  - Eyes Open:', eyesOpenFile?.originalname);\n   243â†’      console.log('  - Eyes Closed:', eyesClosedFile?.originalname);\n   244â†’\n   245â†’      // STEP 1: Detect report types\n   246â†’      console.log('\\nðŸ” STEP 1: Detecting report types...');\n   247â†’      const eoReportType = await this.detectReportType(eyesOpenFile);\n   248â†’      const ecReportType = await this.detectReportType(eyesClosedFile);\n   249â†’\n   250â†’      console.log(`\\nðŸ“Š Detection Results:`);\n   251â†’      console.log(`  - Eyes Open: ${eoReportType.toUpperCase()}`);\n   252â†’      console.log(`  - Eyes Closed: ${ecReportType.toUpperCase()}`);\n   253â†’\n   254â†’      // STEP 2: Validate matching types\n   255â†’      console.log('\\nâœ“ STEP 2: Validating report type consistency...');\n   256â†’      if (eoReportType !== ecReportType) {\n   257â†’        const error = new Error(\n   258â†’          `âŒ Mismatched report types detected!\\n\\n` +\n   259â†’          `Eyes Open is ${eoReportType.toUpperCase()}, but Eyes Closed is ${ecReportType.toUpperCase()}.\\n\\n` +\n   260â†’          `Both files must be the same type (either both RAW POWER or both Z-SCORE reports).\\n` +\n   261â†’          `Please upload matching report types and try again.`\n   262â†’        );\n   263â†’        error.code = 'REPORT_TYPE_MISMATCH';\n   264â†’        throw error;\n   265â†’      }\n   266â†’\n   267â†’      const reportType = eoReportType;\n   268â†’      console.log(`âœ… Report type validated: ${reportType.toUpperCase()} mode\\n`);\n   269â†’\n   270â†’      // STEP 3: Determine file formats (pdf, csv, excel)\n   271â†’      console.log('ðŸ“ STEP 3: Determining file formats...');\n   272â†’      const eoFileType = this.getFileType(eyesOpenFile.originalname);\n   273â†’      const ecFileType = this.getFileType(eyesClosedFile.originalname);\n   274â†’      console.log(`  - Eyes Open: ${eoFileType}`);\n   275â†’      console.log(`  - Eyes Closed: ${ecFileType}\\n`);\n   276â†’\n   277â†’      // STEP 4: Parse each file with appropriate method\n   278â†’      console.log('ðŸ“– STEP 4: Extracting data from files...');\n   279â†’      const eyesOpenData = await this.parseFile(eyesOpenFile, eoFileType, 'EO', reportType);\n   280â†’      const eyesClosedData = await this.parseFile(eyesClosedFile, ecFileType, 'EC', reportType);\n   281â†’\n   282â†’      // STEP 5: Combine data with metadata\n   283â†’      console.log('\\nðŸ”— STEP 5: Combining data...');\n   284â†’      const combinedData = {\n   285â†’        EO: eyesOpenData,\n   286â†’        EC: eyesClosedData,\n   287â†’        dataType: reportType // Add metadata\n   288â†’      };\n   289â†’\n   290â†’      console.log(`âœ… QEEG files parsed successfully in ${reportType.toUpperCase()} mode`);\n   291â†’      console.log('=== QEEG File Parsing Completed ===\\n');\n   292â†’      return combinedData;\n   293â†’\n   294â†’    } catch (error) {\n   295â†’      console.error('\\nâŒ === QEEG File Parsing Failed ===');\n   296â†’      console.error('Error:', error.message);\n   297â†’      if (error.code === 'REPORT_TYPE_MISMATCH') {\n   298â†’        // Re-throw mismatch errors with original message\n   299â†’        throw error;\n   300â†’      } else {\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"20096189-36bf-4050-a599-8059d78beaae","timestamp":"2025-12-09T06:11:55.194Z","toolUseResult":{"type":"text","file":{"filePath":"D:\\Todays\\Neuro360\\server\\services\\qeegParser.js","content":"const fs = require('fs');\nconst path = require('path');\nconst crypto = require('crypto');\nconst { GoogleGenerativeAI } = require('@google/generative-ai');\nconst pdfParse = require('pdf-parse');\nconst XLSX = require('xlsx');\n\n// Initialize Gemini AI client\nconst genAI = new GoogleGenerativeAI(process.env.GEMINI_API_KEY);\nlet geminiModel = null;\n\n// In-memory cache for PDF extraction results (ensures deterministic behavior)\n// Key: PDF MD5 hash â†’ Value: Extracted QEEG data\nconst extractionCache = new Map();\n\n// Cache statistics for monitoring\nconst cacheStats = {\n  hits: 0,\n  misses: 0,\n  totalExtractions: 0\n};\n\nclass QEEGParser {\n  /**\n   * Fetch available Gemini models that support generateContent\n   * @returns {Promise<Array>} List of available models\n   */\n  static async fetchAvailableModels() {\n    try {\n      console.log('ðŸ” Fetching available Gemini models...');\n\n      const response = await fetch(\n        `https://generativelanguage.googleapis.com/v1/models?key=${process.env.GEMINI_API_KEY}`\n      );\n\n      if (!response.ok) {\n        throw new Error(`API returned ${response.status}: ${response.statusText}`);\n      }\n\n      const data = await response.json();\n\n      // Filter models that support generateContent\n      const supportedModels = (data.models || []).filter(model =>\n        model.supportedGenerationMethods?.includes('generateContent')\n      );\n\n      console.log(`âœ… Found ${supportedModels.length} models that support generateContent:`);\n      supportedModels.forEach(model => {\n        console.log(`   - ${model.name}`);\n      });\n\n      return supportedModels;\n    } catch (error) {\n      console.error('âŒ Failed to fetch models:', error.message);\n      return [];\n    }\n  }\n\n  /**\n   * Select best available model from list\n   * @param {Array} models - List of available models\n   * @returns {string|null} Model name to use\n   */\n  static selectBestModel(models) {\n    if (!models || models.length === 0) return null;\n\n    // Priority: flash models (fastest) > pro models > any other\n    const preferences = ['flash', 'pro'];\n\n    for (const preference of preferences) {\n      const found = models.find(m =>\n        m.name.toLowerCase().includes(preference)\n      );\n      if (found) {\n        console.log(`âœ… Selected model: ${found.name}`);\n        return found.name;\n      }\n    }\n\n    // Fallback to first available\n    console.log(`âœ… Using first available model: ${models[0].name}`);\n    return models[0].name;\n  }\n\n  /**\n   * Validate Gemini API key is configured and appears valid\n   * @throws {Error} if API key is missing or invalid format\n   */\n  static validateAPIKey() {\n    const apiKey = process.env.GEMINI_API_KEY;\n\n    // Check if key exists\n    if (!apiKey || apiKey.trim() === '') {\n      const error = new Error('GEMINI_API_KEY environment variable is not set');\n      error.code = 'MISSING_API_KEY';\n      throw error;\n    }\n\n    // Check if key is placeholder\n    if (apiKey === 'your-gemini-api-key-here' || apiKey.includes('placeholder')) {\n      const error = new Error('GEMINI_API_KEY is set to placeholder value. Please configure a valid Gemini API key.');\n      error.code = 'INVALID_API_KEY';\n      throw error;\n    }\n\n    console.log('âœ… Gemini API key validation passed');\n    return true;\n  }\n\n  /**\n   * Test Gemini API connection with a simple request\n   * @returns {Promise<boolean>} true if connection successful\n   * @throws {Error} if connection fails\n   */\n  static async testAPIConnection() {\n    try {\n      this.validateAPIKey();\n\n      console.log('ðŸ”Œ Testing Gemini API connection...');\n\n      if (!geminiModel) {\n        console.log('ðŸ”‘ API Key check:', process.env.GEMINI_API_KEY ? 'Present' : 'MISSING');\n\n        // Fetch available models dynamically\n        const availableModels = await this.fetchAvailableModels();\n\n        if (availableModels.length === 0) {\n          throw new Error('No Gemini models available. Check your API key at https://aistudio.google.com/apikey');\n        }\n\n        // Select best model\n        const modelName = this.selectBestModel(availableModels);\n\n        if (!modelName) {\n          throw new Error('Could not select a valid model');\n        }\n\n        // Initialize model with full path\n        console.log(`ðŸ”§ Initializing model: ${modelName}`);\n        geminiModel = genAI.getGenerativeModel({ model: modelName });\n\n        // Test it with simple call\n        console.log('ðŸ“ž Testing model with simple call...');\n        const testResult = await geminiModel.generateContent('Hello');\n        await testResult.response;\n        console.log('âœ… Model initialized and tested successfully');\n      }\n\n      const result = await geminiModel.generateContent('Reply with OK');\n      const response = await result.response;\n      const text = response.text();\n\n      if (text) {\n        console.log('âœ… Gemini API connection successful');\n        return true;\n      } else {\n        throw new Error('Gemini API returned unexpected response');\n      }\n\n    } catch (error) {\n      console.error('âŒ Gemini API connection test failed:', error.message);\n      const enhancedError = new Error(`Gemini API connection test failed: ${error.message}`);\n      enhancedError.code = 'API_CONNECTION_FAILED';\n      enhancedError.originalError = error;\n      throw enhancedError;\n    }\n  }\n\n  /**\n   * Detect report type (raw power values or Z-scores)\n   * @param {Object} file - Multer file object\n   * @returns {Promise<string>} 'raw' or 'zscore'\n   */\n  static async detectReportType(file) {\n    try {\n      console.log(`ðŸ” Detecting report type for: ${file.originalname}`);\n\n      const dataBuffer = fs.readFileSync(file.path);\n      const pdfData = await pdfParse(dataBuffer);\n      const text = pdfData.text.toLowerCase();\n\n      // Keyword detection\n      const zscoreKeywords = ['z-score', 'z score', 'z =', 'z=', 'standard deviation', 'sd from mean'];\n      const rawKeywords = ['absolute power (Î¼vÂ²)', 'absolute power (uvÂ²)', 'relative power (%)', 'Î¼vÂ²', 'uvÂ²'];\n\n      let zscoreCount = 0;\n      let rawCount = 0;\n\n      // Count keyword occurrences\n      zscoreKeywords.forEach(keyword => {\n        const matches = (text.match(new RegExp(keyword, 'g')) || []).length;\n        zscoreCount += matches;\n      });\n\n      rawKeywords.forEach(keyword => {\n        const matches = (text.match(new RegExp(keyword, 'g')) || []).length;\n        rawCount += matches;\n      });\n\n      console.log(`   Z-score keywords found: ${zscoreCount}`);\n      console.log(`   Raw power keywords found: ${rawCount}`);\n\n      // Decision logic\n      if (zscoreCount > rawCount && zscoreCount >= 3) {\n        console.log(`âœ… Detected: Z-SCORE report`);\n        return 'zscore';\n      } else if (rawCount > zscoreCount && rawCount >= 2) {\n        console.log(`âœ… Detected: RAW POWER report`);\n        return 'raw';\n      } else if (zscoreCount > 0 && rawCount > 0) {\n        // Mixed report - check for table structure\n        if (text.includes('z-score table') || text.includes('z score table')) {\n          console.log(`âš ï¸ Mixed report detected - preferring Z-SCORE`);\n          return 'zscore';\n        } else {\n          console.log(`âš ï¸ Mixed report detected - preferring RAW POWER`);\n          return 'raw';\n        }\n      } else {\n        // Fallback: assume raw if unclear\n        console.warn(`âš ï¸ Could not clearly detect report type - defaulting to RAW POWER`);\n        return 'raw';\n      }\n\n    } catch (error) {\n      console.error(`âŒ Error detecting report type for ${file.originalname}:`, error.message);\n      // Safe default\n      console.warn(`   Defaulting to RAW POWER mode`);\n      return 'raw';\n    }\n  }\n\n  /**\n   * Main method to parse uploaded files\n   * @param {Object} eyesOpenFile - Multer file object for Eyes Open data\n   * @param {Object} eyesClosedFile - Multer file object for Eyes Closed data\n   * @returns {Object} Parsed QEEG data\n   */\n  static async parse(eyesOpenFile, eyesClosedFile) {\n    try {\n      console.log('\\nðŸ“„ === QEEG File Parsing Started ===');\n      console.log('  - Eyes Open:', eyesOpenFile?.originalname);\n      console.log('  - Eyes Closed:', eyesClosedFile?.originalname);\n\n      // STEP 1: Detect report types\n      console.log('\\nðŸ” STEP 1: Detecting report types...');\n      const eoReportType = await this.detectReportType(eyesOpenFile);\n      const ecReportType = await this.detectReportType(eyesClosedFile);\n\n      console.log(`\\nðŸ“Š Detection Results:`);\n      console.log(`  - Eyes Open: ${eoReportType.toUpperCase()}`);\n      console.log(`  - Eyes Closed: ${ecReportType.toUpperCase()}`);\n\n      // STEP 2: Validate matching types\n      console.log('\\nâœ“ STEP 2: Validating report type consistency...');\n      if (eoReportType !== ecReportType) {\n        const error = new Error(\n          `âŒ Mismatched report types detected!\\n\\n` +\n          `Eyes Open is ${eoReportType.toUpperCase()}, but Eyes Closed is ${ecReportType.toUpperCase()}.\\n\\n` +\n          `Both files must be the same type (either both RAW POWER or both Z-SCORE reports).\\n` +\n          `Please upload matching report types and try again.`\n        );\n        error.code = 'REPORT_TYPE_MISMATCH';\n        throw error;\n      }\n\n      const reportType = eoReportType;\n      console.log(`âœ… Report type validated: ${reportType.toUpperCase()} mode\\n`);\n\n      // STEP 3: Determine file formats (pdf, csv, excel)\n      console.log('ðŸ“ STEP 3: Determining file formats...');\n      const eoFileType = this.getFileType(eyesOpenFile.originalname);\n      const ecFileType = this.getFileType(eyesClosedFile.originalname);\n      console.log(`  - Eyes Open: ${eoFileType}`);\n      console.log(`  - Eyes Closed: ${ecFileType}\\n`);\n\n      // STEP 4: Parse each file with appropriate method\n      console.log('ðŸ“– STEP 4: Extracting data from files...');\n      const eyesOpenData = await this.parseFile(eyesOpenFile, eoFileType, 'EO', reportType);\n      const eyesClosedData = await this.parseFile(eyesClosedFile, ecFileType, 'EC', reportType);\n\n      // STEP 5: Combine data with metadata\n      console.log('\\nðŸ”— STEP 5: Combining data...');\n      const combinedData = {\n        EO: eyesOpenData,\n        EC: eyesClosedData,\n        dataType: reportType // Add metadata\n      };\n\n      console.log(`âœ… QEEG files parsed successfully in ${reportType.toUpperCase()} mode`);\n      console.log('=== QEEG File Parsing Completed ===\\n');\n      return combinedData;\n\n    } catch (error) {\n      console.error('\\nâŒ === QEEG File Parsing Failed ===');\n      console.error('Error:', error.message);\n      if (error.code === 'REPORT_TYPE_MISMATCH') {\n        // Re-throw mismatch errors with original message\n        throw error;\n      } else {","numLines":300,"startLine":1,"totalLines":1073}}}
{"parentUuid":"20096189-36bf-4050-a599-8059d78beaae","isSidechain":true,"userType":"external","cwd":"D:\\Todays\\Neuro360","sessionId":"042556c2-8872-4445-8efb-d2658cbac4a7","version":"2.0.33","gitBranch":"main","agentId":"63bdb4e9","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_014P6dwa5LHhXn6uzR4do2FV","type":"message","role":"assistant","content":[{"type":"text","text":"Let me read more of the qeegParser to see where Gemini API is actually called:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":5,"cache_creation_input_tokens":6163,"cache_read_input_tokens":78456,"cache_creation":{"ephemeral_5m_input_tokens":6163,"ephemeral_1h_input_tokens":0},"output_tokens":155,"service_tier":"standard"}},"requestId":"req_011CVvcpBw5U64uoQya4ydVR","type":"assistant","uuid":"273100f1-1fd0-406e-a23c-327fdd5f8df2","timestamp":"2025-12-09T06:11:59.289Z"}
{"parentUuid":"273100f1-1fd0-406e-a23c-327fdd5f8df2","isSidechain":true,"userType":"external","cwd":"D:\\Todays\\Neuro360","sessionId":"042556c2-8872-4445-8efb-d2658cbac4a7","version":"2.0.33","gitBranch":"main","agentId":"63bdb4e9","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_014P6dwa5LHhXn6uzR4do2FV","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01SMcRctEH5buYu8fmDc8p9m","name":"Grep","input":{"pattern":"generateContent|429|quota|retry","path":"D:\\Todays\\Neuro360\\server\\services\\qeegParser.js","output_mode":"content","-C":5}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":5,"cache_creation_input_tokens":6163,"cache_read_input_tokens":78456,"cache_creation":{"ephemeral_5m_input_tokens":6163,"ephemeral_1h_input_tokens":0},"output_tokens":155,"service_tier":"standard"}},"requestId":"req_011CVvcpBw5U64uoQya4ydVR","type":"assistant","uuid":"32de1c49-aa74-4937-80ed-263968863062","timestamp":"2025-12-09T06:12:01.206Z"}
{"parentUuid":"32de1c49-aa74-4937-80ed-263968863062","isSidechain":true,"userType":"external","cwd":"D:\\Todays\\Neuro360","sessionId":"042556c2-8872-4445-8efb-d2658cbac4a7","version":"2.0.33","gitBranch":"main","agentId":"63bdb4e9","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01SMcRctEH5buYu8fmDc8p9m","type":"tool_result","content":"20-  totalExtractions: 0\r\n21-};\r\n22-\r\n23-class QEEGParser {\r\n24-  /**\r\n25:   * Fetch available Gemini models that support generateContent\r\n26-   * @returns {Promise<Array>} List of available models\r\n27-   */\r\n28-  static async fetchAvailableModels() {\r\n29-    try {\r\n30-      console.log('ðŸ” Fetching available Gemini models...');\r\n--\n37-        throw new Error(`API returned ${response.status}: ${response.statusText}`);\r\n38-      }\r\n39-\r\n40-      const data = await response.json();\r\n41-\r\n42:      // Filter models that support generateContent\r\n43-      const supportedModels = (data.models || []).filter(model =>\r\n44:        model.supportedGenerationMethods?.includes('generateContent')\r\n\n[Showing results with pagination = limit: 20, offset: 0]"}]},"uuid":"4f02d9cb-a3e5-4c5f-9857-ad2b6ee2faf0","timestamp":"2025-12-09T06:12:03.407Z","toolUseResult":{"mode":"content","numFiles":0,"filenames":[],"content":"20-  totalExtractions: 0\r\n21-};\r\n22-\r\n23-class QEEGParser {\r\n24-  /**\r\n25:   * Fetch available Gemini models that support generateContent\r\n26-   * @returns {Promise<Array>} List of available models\r\n27-   */\r\n28-  static async fetchAvailableModels() {\r\n29-    try {\r\n30-      console.log('ðŸ” Fetching available Gemini models...');\r\n--\n37-        throw new Error(`API returned ${response.status}: ${response.statusText}`);\r\n38-      }\r\n39-\r\n40-      const data = await response.json();\r\n41-\r\n42:      // Filter models that support generateContent\r\n43-      const supportedModels = (data.models || []).filter(model =>\r\n44:        model.supportedGenerationMethods?.includes('generateContent')\r","numLines":20,"appliedLimit":20}}
{"parentUuid":"4f02d9cb-a3e5-4c5f-9857-ad2b6ee2faf0","isSidechain":true,"userType":"external","cwd":"D:\\Todays\\Neuro360","sessionId":"042556c2-8872-4445-8efb-d2658cbac4a7","version":"2.0.33","gitBranch":"main","agentId":"63bdb4e9","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01WKJvh734YRYzeFzurG19DD","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_019V7YNGsNSxS4Rb9itDb6jV","name":"Read","input":{"file_path":"D:\\Todays\\Neuro360\\server\\services\\qeegParser.js","offset":400,"limit":200}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":4,"cache_creation_input_tokens":706,"cache_read_input_tokens":84619,"cache_creation":{"ephemeral_5m_input_tokens":706,"ephemeral_1h_input_tokens":0},"output_tokens":107,"service_tier":"standard"}},"requestId":"req_011CVvcpn2gRgoN6f7Jxedzf","type":"assistant","uuid":"1b567920-c78c-42bc-b10b-9f6ead9acfda","timestamp":"2025-12-09T06:12:07.348Z"}
{"parentUuid":"1b567920-c78c-42bc-b10b-9f6ead9acfda","isSidechain":true,"userType":"external","cwd":"D:\\Todays\\Neuro360","sessionId":"042556c2-8872-4445-8efb-d2658cbac4a7","version":"2.0.33","gitBranch":"main","agentId":"63bdb4e9","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_019V7YNGsNSxS4Rb9itDb6jV","type":"tool_result","content":"   400â†’    \"alphaPeakZscore\": 0.0\n   401â†’  }\n   402â†’}\n   403â†’\n   404â†’PDF Content:\n   405â†’${pdfText.substring(0, 15000)}`;\n   406â†’\n   407â†’    } else {\n   408â†’      // RAW POWER extraction prompt (highly improved for complete extraction)\n   409â†’      return `You are an expert QEEG data extraction specialist. Your task is to extract COMPLETE frequency band data from this ${conditionName} QEEG report PDF.\n   410â†’\n   411â†’ðŸŽ¯ YOUR MISSION: Extract 100% COMPLETE DATA - No Missing Bands Allowed!\n   412â†’\n   413â†’ðŸ“Š WHAT TO EXTRACT:\n   414â†’Extract TWO complete tables:\n   415â†’1. **Absolute Power (Î¼VÂ²)** - Brain wave power in microvolts squared\n   416â†’2. **Relative Power (%)** - Percentage distribution (MUST sum to ~100% per channel)\n   417â†’\n   418â†’ðŸ“ WHERE TO LOOK IN THE PDF:\n   419â†’- Usually on Pages 13 & 24 (for Eyes Open & Eyes Closed)\n   420â†’- Look for table headers like:\n   421â†’  * \"Absolute Power\" / \"Absolute Spectral Power\" / \"Absolute\" / \"ABS\"\n   422â†’  * \"Relative Power\" / \"Relative Spectral Power\" / \"Relative\" / \"REL\"\n   423â†’  * \"Monopolar\" / \"Linked Ears\" / \"Average Reference\"\n   424â†’- Tables may span multiple pages - check thoroughly!\n   425â†’- Sometimes bands are in separate sections or sub-tables\n   426â†’\n   427â†’ðŸ§  CHANNELS TO EXTRACT (19 channels):\n   428â†’FP1, FP2, F7, F3, Fz, F4, F8, T3, C3, Cz, C4, T4, T5, P3, Pz, P4, T6, O1, O2\n   429â†’\n   430â†’ðŸ“Š FREQUENCY BANDS (ALL 5 REQUIRED):\n   431â†’For EACH channel, you MUST extract ALL 5 bands:\n   432â†’1. **Delta** (Î´) - 0.5-4 Hz - Usually highest power\n   433â†’2. **Theta** (Î¸) - 4-8 Hz\n   434â†’3. **Alpha** (Î±) - 8-13 Hz - Often dominant when relaxed\n   435â†’4. **Beta** (Î²) - 13-30 Hz\n   436â†’5. **HiBeta** (High Beta / Î²Î²) - 30-50 Hz - Usually smallest\n   437â†’\n   438â†’âš ï¸âš ï¸âš ï¸ ABSOLUTELY CRITICAL REQUIREMENTS âš ï¸âš ï¸âš ï¸\n   439â†’\n   440â†’1. **100% COMPLETENESS**: Extract ALL 5 bands for EVERY channel\n   441â†’   - If a band shows \"0\" or very small value (0.1, 0.01), INCLUDE IT\n   442â†’   - DO NOT leave any band as 0 unless it truly says 0 in the table\n   443â†’\n   444â†’2. **VALIDATION CHECK**: For Relative Power, EACH channel must sum to ~100%\n   445â†’   Example: Fz: Delta(30%) + Theta(20%) + Alpha(25%) + Beta(20%) + HiBeta(5%) = 100%\n   446â†’   - If your extracted data doesn't sum to ~100% for EACH channel, YOU MADE A MISTAKE\n   447â†’   - Go back and find the missing bands!\n   448â†’\n   449â†’3. **SEARCH THOROUGHLY**:\n   450â†’   - Check ALL pages of the PDF, not just the first page\n   451â†’   - Look for continuation of tables on next pages\n   452â†’   - Some PDFs have separate sub-tables for each band - combine them\n   453â†’   - Tables might be labeled \"Page 1/2\", \"Page 2/2\" - check both!\n   454â†’\n   455â†’4. **DON'T SKIP CHANNELS**: All 19 channels should have complete data\n   456â†’   - If some channels are truly missing from PDF, use 0 for those\n   457â†’   - But most standard QEEG reports have all 19 channels\n   458â†’\n   459â†’5. **PRESERVE EXACT VALUES**: Copy numbers exactly as they appear\n   460â†’   - Don't round or modify values\n   461â†’   - Include decimal places (e.g., 25.3, not 25)\n   462â†’\n   463â†’ðŸ“‹ EXAMPLE OF **CORRECT** EXTRACTION (Relative Power):\n   464â†’{\n   465â†’  \"Fz\": {\n   466â†’    \"Delta\": 28.5,   // âœ“ Has value\n   467â†’    \"Theta\": 22.3,   // âœ“ Has value\n   468â†’    \"Alpha\": 25.1,   // âœ“ Has value\n   469â†’    \"Beta\": 18.9,    // âœ“ Has value\n   470â†’    \"HiBeta\": 5.2    // âœ“ Has value\n   471â†’  }\n   472â†’  // Sum = 100% âœ“ CORRECT!\n   473â†’}\n   474â†’\n   475â†’âŒ EXAMPLE OF **WRONG** EXTRACTION:\n   476â†’{\n   477â†’  \"Fz\": {\n   478â†’    \"Delta\": 28.5,\n   479â†’    \"Theta\": 22.3,\n   480â†’    \"Alpha\": 0,      // âŒ WRONG - Missing!\n   481â†’    \"Beta\": 0,       // âŒ WRONG - Missing!\n   482â†’    \"HiBeta\": 0      // âŒ WRONG - Missing!\n   483â†’  }\n   484â†’  // Sum = 50.8% âŒ INCOMPLETE! Find the missing bands!\n   485â†’}\n   486â†’\n   487â†’ðŸ” EXTRACTION STRATEGY:\n   488â†’1. First, locate the Absolute Power table - extract all bands for all channels\n   489â†’2. Then, locate the Relative Power table - extract all bands for all channels\n   490â†’3. Double-check: Does each channel's relative power sum to ~100%?\n   491â†’4. If NO, go back and search for missing data in other pages/sections\n   492â†’5. Extract Alpha Peak Frequency (usually noted as \"Peak Alpha\" or \"APF\")\n   493â†’\n   494â†’Also extract Alpha Peak Frequency (APF) if available (typical range: 8-13 Hz).\n   495â†’\n   496â†’**OUTPUT FORMAT RULES**:\n   497â†’- Return ONLY the JSON object (no markdown, no explanations, no code blocks)\n   498â†’- Just pure JSON starting with { and ending with }\n   499â†’- No \\`\\`\\`json markers\n   500â†’- No text before or after the JSON\n   501â†’\n   502â†’Return the data in this EXACT JSON format:\n   503â†’{\n   504â†’  \"absolute\": {\n   505â†’    \"Fz\": { \"Delta\": 0.0, \"Theta\": 0.0, \"Alpha\": 0.0, \"Beta\": 0.0, \"HiBeta\": 0.0 },\n   506â†’    \"Cz\": { \"Delta\": 0.0, \"Theta\": 0.0, \"Alpha\": 0.0, \"Beta\": 0.0, \"HiBeta\": 0.0 },\n   507â†’    \"Pz\": { \"Delta\": 0.0, \"Theta\": 0.0, \"Alpha\": 0.0, \"Beta\": 0.0, \"HiBeta\": 0.0 },\n   508â†’    \"F3\": { \"Delta\": 0.0, \"Theta\": 0.0, \"Alpha\": 0.0, \"Beta\": 0.0, \"HiBeta\": 0.0 },\n   509â†’    \"F4\": { \"Delta\": 0.0, \"Theta\": 0.0, \"Alpha\": 0.0, \"Beta\": 0.0, \"HiBeta\": 0.0 },\n   510â†’    \"C3\": { \"Delta\": 0.0, \"Theta\": 0.0, \"Alpha\": 0.0, \"Beta\": 0.0, \"HiBeta\": 0.0 },\n   511â†’    \"C4\": { \"Delta\": 0.0, \"Theta\": 0.0, \"Alpha\": 0.0, \"Beta\": 0.0, \"HiBeta\": 0.0 },\n   512â†’    \"P3\": { \"Delta\": 0.0, \"Theta\": 0.0, \"Alpha\": 0.0, \"Beta\": 0.0, \"HiBeta\": 0.0 },\n   513â†’    \"P4\": { \"Delta\": 0.0, \"Theta\": 0.0, \"Alpha\": 0.0, \"Beta\": 0.0, \"HiBeta\": 0.0 }\n   514â†’  },\n   515â†’  \"relative\": {\n   516â†’    \"Fz\": { \"Delta\": 0.0, \"Theta\": 0.0, \"Alpha\": 0.0, \"Beta\": 0.0, \"HiBeta\": 0.0 },\n   517â†’    \"Cz\": { \"Delta\": 0.0, \"Theta\": 0.0, \"Alpha\": 0.0, \"Beta\": 0.0, \"HiBeta\": 0.0 },\n   518â†’    \"Pz\": { \"Delta\": 0.0, \"Theta\": 0.0, \"Alpha\": 0.0, \"Beta\": 0.0, \"HiBeta\": 0.0 },\n   519â†’    \"F3\": { \"Delta\": 0.0, \"Theta\": 0.0, \"Alpha\": 0.0, \"Beta\": 0.0, \"HiBeta\": 0.0 },\n   520â†’    \"F4\": { \"Delta\": 0.0, \"Theta\": 0.0, \"Alpha\": 0.0, \"Beta\": 0.0, \"HiBeta\": 0.0 },\n   521â†’    \"C3\": { \"Delta\": 0.0, \"Theta\": 0.0, \"Alpha\": 0.0, \"Beta\": 0.0, \"HiBeta\": 0.0 },\n   522â†’    \"C4\": { \"Delta\": 0.0, \"Theta\": 0.0, \"Alpha\": 0.0, \"Beta\": 0.0, \"HiBeta\": 0.0 },\n   523â†’    \"P3\": { \"Delta\": 0.0, \"Theta\": 0.0, \"Alpha\": 0.0, \"Beta\": 0.0, \"HiBeta\": 0.0 },\n   524â†’    \"P4\": { \"Delta\": 0.0, \"Theta\": 0.0, \"Alpha\": 0.0, \"Beta\": 0.0, \"HiBeta\": 0.0 }\n   525â†’  },\n   526â†’  \"special\": {\n   527â†’    \"alphaPeak\": 10.0,\n   528â†’    \"O1\": 10.0\n   529â†’  }\n   530â†’}\n   531â†’\n   532â†’PDF Content:\n   533â†’${pdfText.substring(0, 15000)}`;\n   534â†’    }\n   535â†’  }\n   536â†’\n   537â†’  /**\n   538â†’   * Calculate MD5 hash of PDF file for caching\n   539â†’   * @param {Buffer} dataBuffer - PDF file buffer\n   540â†’   * @returns {string} MD5 hash\n   541â†’   */\n   542â†’  static calculatePDFHash(dataBuffer) {\n   543â†’    return crypto.createHash('md5').update(dataBuffer).digest('hex');\n   544â†’  }\n   545â†’\n   546â†’  /**\n   547â†’   * Normalize extracted value to consistent decimal places\n   548â†’   * Prevents precision-related variations\n   549â†’   * @param {number} value - The value to normalize\n   550â†’   * @param {number} decimalPlaces - Number of decimal places (default: 2)\n   551â†’   * @returns {number|null} Normalized value\n   552â†’   */\n   553â†’  static normalizeValue(value, decimalPlaces = 2) {\n   554â†’    if (value === null || value === undefined || isNaN(value)) {\n   555â†’      return null;\n   556â†’    }\n   557â†’\n   558â†’    // Round to consistent decimal places\n   559â†’    const multiplier = Math.pow(10, decimalPlaces);\n   560â†’    return Math.round(value * multiplier) / multiplier;\n   561â†’  }\n   562â†’\n   563â†’  /**\n   564â†’   * Normalize all values in extracted QEEG data\n   565â†’   * Ensures consistent precision across all measurements\n   566â†’   * @param {Object} extractedData - The raw extracted data\n   567â†’   * @returns {Object} Normalized data\n   568â†’   */\n   569â†’  static normalizeExtractedData(extractedData) {\n   570â†’    const normalized = JSON.parse(JSON.stringify(extractedData)); // Deep clone\n   571â†’\n   572â†’    // Normalize absolute power values\n   573â†’    if (normalized.absolute) {\n   574â†’      Object.keys(normalized.absolute).forEach(channel => {\n   575â†’        Object.keys(normalized.absolute[channel]).forEach(band => {\n   576â†’          normalized.absolute[channel][band] =\n   577â†’            this.normalizeValue(normalized.absolute[channel][band], 2);\n   578â†’        });\n   579â†’      });\n   580â†’    }\n   581â†’\n   582â†’    // Normalize relative power values\n   583â†’    if (normalized.relative) {\n   584â†’      Object.keys(normalized.relative).forEach(channel => {\n   585â†’        Object.keys(normalized.relative[channel]).forEach(band => {\n   586â†’          normalized.relative[channel][band] =\n   587â†’            this.normalizeValue(normalized.relative[channel][band], 2);\n   588â†’        });\n   589â†’      });\n   590â†’    }\n   591â†’\n   592â†’    // Normalize special values (alpha peak, etc.)\n   593â†’    if (normalized.special) {\n   594â†’      Object.keys(normalized.special).forEach(key => {\n   595â†’        normalized.special[key] = this.normalizeValue(normalized.special[key], 2);\n   596â†’      });\n   597â†’    }\n   598â†’\n   599â†’    // Normalize zscores if present (for z-score reports)\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"335f410f-ede6-4f2d-8863-c4a82118ef1b","timestamp":"2025-12-09T06:12:09.572Z","toolUseResult":{"type":"text","file":{"filePath":"D:\\Todays\\Neuro360\\server\\services\\qeegParser.js","content":"    \"alphaPeakZscore\": 0.0\n  }\n}\n\nPDF Content:\n${pdfText.substring(0, 15000)}`;\n\n    } else {\n      // RAW POWER extraction prompt (highly improved for complete extraction)\n      return `You are an expert QEEG data extraction specialist. Your task is to extract COMPLETE frequency band data from this ${conditionName} QEEG report PDF.\n\nðŸŽ¯ YOUR MISSION: Extract 100% COMPLETE DATA - No Missing Bands Allowed!\n\nðŸ“Š WHAT TO EXTRACT:\nExtract TWO complete tables:\n1. **Absolute Power (Î¼VÂ²)** - Brain wave power in microvolts squared\n2. **Relative Power (%)** - Percentage distribution (MUST sum to ~100% per channel)\n\nðŸ“ WHERE TO LOOK IN THE PDF:\n- Usually on Pages 13 & 24 (for Eyes Open & Eyes Closed)\n- Look for table headers like:\n  * \"Absolute Power\" / \"Absolute Spectral Power\" / \"Absolute\" / \"ABS\"\n  * \"Relative Power\" / \"Relative Spectral Power\" / \"Relative\" / \"REL\"\n  * \"Monopolar\" / \"Linked Ears\" / \"Average Reference\"\n- Tables may span multiple pages - check thoroughly!\n- Sometimes bands are in separate sections or sub-tables\n\nðŸ§  CHANNELS TO EXTRACT (19 channels):\nFP1, FP2, F7, F3, Fz, F4, F8, T3, C3, Cz, C4, T4, T5, P3, Pz, P4, T6, O1, O2\n\nðŸ“Š FREQUENCY BANDS (ALL 5 REQUIRED):\nFor EACH channel, you MUST extract ALL 5 bands:\n1. **Delta** (Î´) - 0.5-4 Hz - Usually highest power\n2. **Theta** (Î¸) - 4-8 Hz\n3. **Alpha** (Î±) - 8-13 Hz - Often dominant when relaxed\n4. **Beta** (Î²) - 13-30 Hz\n5. **HiBeta** (High Beta / Î²Î²) - 30-50 Hz - Usually smallest\n\nâš ï¸âš ï¸âš ï¸ ABSOLUTELY CRITICAL REQUIREMENTS âš ï¸âš ï¸âš ï¸\n\n1. **100% COMPLETENESS**: Extract ALL 5 bands for EVERY channel\n   - If a band shows \"0\" or very small value (0.1, 0.01), INCLUDE IT\n   - DO NOT leave any band as 0 unless it truly says 0 in the table\n\n2. **VALIDATION CHECK**: For Relative Power, EACH channel must sum to ~100%\n   Example: Fz: Delta(30%) + Theta(20%) + Alpha(25%) + Beta(20%) + HiBeta(5%) = 100%\n   - If your extracted data doesn't sum to ~100% for EACH channel, YOU MADE A MISTAKE\n   - Go back and find the missing bands!\n\n3. **SEARCH THOROUGHLY**:\n   - Check ALL pages of the PDF, not just the first page\n   - Look for continuation of tables on next pages\n   - Some PDFs have separate sub-tables for each band - combine them\n   - Tables might be labeled \"Page 1/2\", \"Page 2/2\" - check both!\n\n4. **DON'T SKIP CHANNELS**: All 19 channels should have complete data\n   - If some channels are truly missing from PDF, use 0 for those\n   - But most standard QEEG reports have all 19 channels\n\n5. **PRESERVE EXACT VALUES**: Copy numbers exactly as they appear\n   - Don't round or modify values\n   - Include decimal places (e.g., 25.3, not 25)\n\nðŸ“‹ EXAMPLE OF **CORRECT** EXTRACTION (Relative Power):\n{\n  \"Fz\": {\n    \"Delta\": 28.5,   // âœ“ Has value\n    \"Theta\": 22.3,   // âœ“ Has value\n    \"Alpha\": 25.1,   // âœ“ Has value\n    \"Beta\": 18.9,    // âœ“ Has value\n    \"HiBeta\": 5.2    // âœ“ Has value\n  }\n  // Sum = 100% âœ“ CORRECT!\n}\n\nâŒ EXAMPLE OF **WRONG** EXTRACTION:\n{\n  \"Fz\": {\n    \"Delta\": 28.5,\n    \"Theta\": 22.3,\n    \"Alpha\": 0,      // âŒ WRONG - Missing!\n    \"Beta\": 0,       // âŒ WRONG - Missing!\n    \"HiBeta\": 0      // âŒ WRONG - Missing!\n  }\n  // Sum = 50.8% âŒ INCOMPLETE! Find the missing bands!\n}\n\nðŸ” EXTRACTION STRATEGY:\n1. First, locate the Absolute Power table - extract all bands for all channels\n2. Then, locate the Relative Power table - extract all bands for all channels\n3. Double-check: Does each channel's relative power sum to ~100%?\n4. If NO, go back and search for missing data in other pages/sections\n5. Extract Alpha Peak Frequency (usually noted as \"Peak Alpha\" or \"APF\")\n\nAlso extract Alpha Peak Frequency (APF) if available (typical range: 8-13 Hz).\n\n**OUTPUT FORMAT RULES**:\n- Return ONLY the JSON object (no markdown, no explanations, no code blocks)\n- Just pure JSON starting with { and ending with }\n- No \\`\\`\\`json markers\n- No text before or after the JSON\n\nReturn the data in this EXACT JSON format:\n{\n  \"absolute\": {\n    \"Fz\": { \"Delta\": 0.0, \"Theta\": 0.0, \"Alpha\": 0.0, \"Beta\": 0.0, \"HiBeta\": 0.0 },\n    \"Cz\": { \"Delta\": 0.0, \"Theta\": 0.0, \"Alpha\": 0.0, \"Beta\": 0.0, \"HiBeta\": 0.0 },\n    \"Pz\": { \"Delta\": 0.0, \"Theta\": 0.0, \"Alpha\": 0.0, \"Beta\": 0.0, \"HiBeta\": 0.0 },\n    \"F3\": { \"Delta\": 0.0, \"Theta\": 0.0, \"Alpha\": 0.0, \"Beta\": 0.0, \"HiBeta\": 0.0 },\n    \"F4\": { \"Delta\": 0.0, \"Theta\": 0.0, \"Alpha\": 0.0, \"Beta\": 0.0, \"HiBeta\": 0.0 },\n    \"C3\": { \"Delta\": 0.0, \"Theta\": 0.0, \"Alpha\": 0.0, \"Beta\": 0.0, \"HiBeta\": 0.0 },\n    \"C4\": { \"Delta\": 0.0, \"Theta\": 0.0, \"Alpha\": 0.0, \"Beta\": 0.0, \"HiBeta\": 0.0 },\n    \"P3\": { \"Delta\": 0.0, \"Theta\": 0.0, \"Alpha\": 0.0, \"Beta\": 0.0, \"HiBeta\": 0.0 },\n    \"P4\": { \"Delta\": 0.0, \"Theta\": 0.0, \"Alpha\": 0.0, \"Beta\": 0.0, \"HiBeta\": 0.0 }\n  },\n  \"relative\": {\n    \"Fz\": { \"Delta\": 0.0, \"Theta\": 0.0, \"Alpha\": 0.0, \"Beta\": 0.0, \"HiBeta\": 0.0 },\n    \"Cz\": { \"Delta\": 0.0, \"Theta\": 0.0, \"Alpha\": 0.0, \"Beta\": 0.0, \"HiBeta\": 0.0 },\n    \"Pz\": { \"Delta\": 0.0, \"Theta\": 0.0, \"Alpha\": 0.0, \"Beta\": 0.0, \"HiBeta\": 0.0 },\n    \"F3\": { \"Delta\": 0.0, \"Theta\": 0.0, \"Alpha\": 0.0, \"Beta\": 0.0, \"HiBeta\": 0.0 },\n    \"F4\": { \"Delta\": 0.0, \"Theta\": 0.0, \"Alpha\": 0.0, \"Beta\": 0.0, \"HiBeta\": 0.0 },\n    \"C3\": { \"Delta\": 0.0, \"Theta\": 0.0, \"Alpha\": 0.0, \"Beta\": 0.0, \"HiBeta\": 0.0 },\n    \"C4\": { \"Delta\": 0.0, \"Theta\": 0.0, \"Alpha\": 0.0, \"Beta\": 0.0, \"HiBeta\": 0.0 },\n    \"P3\": { \"Delta\": 0.0, \"Theta\": 0.0, \"Alpha\": 0.0, \"Beta\": 0.0, \"HiBeta\": 0.0 },\n    \"P4\": { \"Delta\": 0.0, \"Theta\": 0.0, \"Alpha\": 0.0, \"Beta\": 0.0, \"HiBeta\": 0.0 }\n  },\n  \"special\": {\n    \"alphaPeak\": 10.0,\n    \"O1\": 10.0\n  }\n}\n\nPDF Content:\n${pdfText.substring(0, 15000)}`;\n    }\n  }\n\n  /**\n   * Calculate MD5 hash of PDF file for caching\n   * @param {Buffer} dataBuffer - PDF file buffer\n   * @returns {string} MD5 hash\n   */\n  static calculatePDFHash(dataBuffer) {\n    return crypto.createHash('md5').update(dataBuffer).digest('hex');\n  }\n\n  /**\n   * Normalize extracted value to consistent decimal places\n   * Prevents precision-related variations\n   * @param {number} value - The value to normalize\n   * @param {number} decimalPlaces - Number of decimal places (default: 2)\n   * @returns {number|null} Normalized value\n   */\n  static normalizeValue(value, decimalPlaces = 2) {\n    if (value === null || value === undefined || isNaN(value)) {\n      return null;\n    }\n\n    // Round to consistent decimal places\n    const multiplier = Math.pow(10, decimalPlaces);\n    return Math.round(value * multiplier) / multiplier;\n  }\n\n  /**\n   * Normalize all values in extracted QEEG data\n   * Ensures consistent precision across all measurements\n   * @param {Object} extractedData - The raw extracted data\n   * @returns {Object} Normalized data\n   */\n  static normalizeExtractedData(extractedData) {\n    const normalized = JSON.parse(JSON.stringify(extractedData)); // Deep clone\n\n    // Normalize absolute power values\n    if (normalized.absolute) {\n      Object.keys(normalized.absolute).forEach(channel => {\n        Object.keys(normalized.absolute[channel]).forEach(band => {\n          normalized.absolute[channel][band] =\n            this.normalizeValue(normalized.absolute[channel][band], 2);\n        });\n      });\n    }\n\n    // Normalize relative power values\n    if (normalized.relative) {\n      Object.keys(normalized.relative).forEach(channel => {\n        Object.keys(normalized.relative[channel]).forEach(band => {\n          normalized.relative[channel][band] =\n            this.normalizeValue(normalized.relative[channel][band], 2);\n        });\n      });\n    }\n\n    // Normalize special values (alpha peak, etc.)\n    if (normalized.special) {\n      Object.keys(normalized.special).forEach(key => {\n        normalized.special[key] = this.normalizeValue(normalized.special[key], 2);\n      });\n    }\n\n    // Normalize zscores if present (for z-score reports)","numLines":200,"startLine":400,"totalLines":1073}}}
{"parentUuid":"335f410f-ede6-4f2d-8863-c4a82118ef1b","isSidechain":true,"userType":"external","cwd":"D:\\Todays\\Neuro360","sessionId":"042556c2-8872-4445-8efb-d2658cbac4a7","version":"2.0.33","gitBranch":"main","agentId":"63bdb4e9","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01YY18ezKWXjo2WdheZ3ePvZ","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01AgiJ5aw1jhmwRp9afm66BN","name":"Read","input":{"file_path":"D:\\Todays\\Neuro360\\server\\services\\qeegParser.js","offset":600,"limit":250}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":4021,"cache_read_input_tokens":85325,"cache_creation":{"ephemeral_5m_input_tokens":4021,"ephemeral_1h_input_tokens":0},"output_tokens":107,"service_tier":"standard"}},"requestId":"req_011CVvcqF95qfRdq14orNuCb","type":"assistant","uuid":"00e0628d-bd84-4f81-b47f-80d85ebdccb3","timestamp":"2025-12-09T06:12:14.189Z"}
{"parentUuid":"00e0628d-bd84-4f81-b47f-80d85ebdccb3","isSidechain":true,"userType":"external","cwd":"D:\\Todays\\Neuro360","sessionId":"042556c2-8872-4445-8efb-d2658cbac4a7","version":"2.0.33","gitBranch":"main","agentId":"63bdb4e9","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01AgiJ5aw1jhmwRp9afm66BN","type":"tool_result","content":"   600â†’    if (normalized.zscores) {\n   601â†’      if (normalized.zscores.absolute) {\n   602â†’        Object.keys(normalized.zscores.absolute).forEach(channel => {\n   603â†’          Object.keys(normalized.zscores.absolute[channel]).forEach(band => {\n   604â†’            normalized.zscores.absolute[channel][band] =\n   605â†’              this.normalizeValue(normalized.zscores.absolute[channel][band], 2);\n   606â†’          });\n   607â†’        });\n   608â†’      }\n   609â†’      if (normalized.zscores.relative) {\n   610â†’        Object.keys(normalized.zscores.relative).forEach(channel => {\n   611â†’          Object.keys(normalized.zscores.relative[channel]).forEach(band => {\n   612â†’            normalized.zscores.relative[channel][band] =\n   613â†’              this.normalizeValue(normalized.zscores.relative[channel][band], 2);\n   614â†’          });\n   615â†’        });\n   616â†’      }\n   617â†’    }\n   618â†’\n   619â†’    return normalized;\n   620â†’  }\n   621â†’\n   622â†’  /**\n   623â†’   * Parse PDF file using Gemini AI with caching for deterministic results\n   624â†’   * @param {Object} file - Multer file object\n   625â†’   * @param {string} condition - 'EO' or 'EC'\n   626â†’   * @param {string} reportType - 'raw' or 'zscore'\n   627â†’   */\n   628â†’  static async parsePDF(file, condition, reportType = 'raw') {\n   629â†’    console.log(`  ðŸ” Parsing PDF with Gemini AI (${condition}, ${reportType.toUpperCase()} mode)...`);\n   630â†’\n   631â†’    try {\n   632â†’      // Validate API key before attempting to use it\n   633â†’      this.validateAPIKey();\n   634â†’\n   635â†’      // Read PDF file\n   636â†’      const dataBuffer = fs.readFileSync(file.path);\n   637â†’\n   638â†’      // Calculate PDF hash for caching (ensures same PDF = same result)\n   639â†’      const pdfHash = this.calculatePDFHash(dataBuffer);\n   640â†’      const cacheKey = `${pdfHash}_${condition}_${reportType}`;\n   641â†’\n   642â†’      console.log(`  ðŸ”‘ PDF Hash: ${pdfHash.substring(0, 12)}... (for deterministic caching)`);\n   643â†’\n   644â†’      // Check cache first\n   645â†’      if (extractionCache.has(cacheKey)) {\n   646â†’        cacheStats.hits++;\n   647â†’        cacheStats.totalExtractions++;\n   648â†’        console.log(`  âœ… CACHE HIT! Using cached extraction result (100% deterministic)`);\n   649â†’        console.log(`  ðŸ“Š Cache Stats: ${cacheStats.hits} hits, ${cacheStats.misses} misses, ${((cacheStats.hits / cacheStats.totalExtractions) * 100).toFixed(1)}% hit rate`);\n   650â†’        return extractionCache.get(cacheKey);\n   651â†’      }\n   652â†’\n   653â†’      cacheStats.misses++;\n   654â†’      cacheStats.totalExtractions++;\n   655â†’      console.log(`  âš ï¸  Cache miss - extracting data with Gemini AI...`);\n   656â†’      console.log(`  ðŸ“Š Cache Stats: ${cacheStats.hits} hits, ${cacheStats.misses} misses`);\n   657â†’\n   658â†’      const pdfData = await pdfParse(dataBuffer);\n   659â†’\n   660â†’      // Extract text from PDF\n   661â†’      const pdfText = pdfData.text;\n   662â†’\n   663â†’      // Get appropriate extraction prompt based on report type\n   664â†’      const prompt = this.getExtractionPrompt(condition, reportType, pdfText);\n   665â†’\n   666â†’      // Initialize Gemini model if not already done\n   667â†’      if (!geminiModel) {\n   668â†’        console.log('  ðŸ”§ Initializing Gemini model for data extraction...');\n   669â†’        console.log('  ðŸ”‘ API Key status:', process.env.GEMINI_API_KEY ? 'Present' : 'MISSING');\n   670â†’        console.log('  ðŸ”‘ API Key length:', process.env.GEMINI_API_KEY?.length || 0);\n   671â†’        console.log('  ðŸ”‘ API Key preview:', process.env.GEMINI_API_KEY ? `${process.env.GEMINI_API_KEY.substring(0, 20)}...` : 'N/A');\n   672â†’\n   673â†’        // Fetch available models dynamically\n   674â†’        const availableModels = await this.fetchAvailableModels();\n   675â†’\n   676â†’        if (availableModels.length === 0) {\n   677â†’          console.error('\\n  âŒ === NO MODELS AVAILABLE ===');\n   678â†’          console.error('  Please check:');\n   679â†’          console.error('  1. GEMINI_API_KEY is correct in .env file');\n   680â†’          console.error('  2. API key has proper permissions');\n   681â†’          console.error('  3. Visit: https://aistudio.google.com/apikey to get a new key');\n   682â†’          console.error('  4. Make sure Generative Language API is enabled');\n   683â†’          console.error('  ================================\\n');\n   684â†’          throw new Error('No Gemini models available. Check your API key.');\n   685â†’        }\n   686â†’\n   687â†’        // Select best model\n   688â†’        const modelName = this.selectBestModel(availableModels);\n   689â†’\n   690â†’        if (!modelName) {\n   691â†’          throw new Error('Could not select a valid model from available models');\n   692â†’        }\n   693â†’\n   694â†’        // Initialize model with full path and deterministic config\n   695â†’        console.log(`  ðŸ”§ Initializing model: ${modelName}`);\n   696â†’        geminiModel = genAI.getGenerativeModel({\n   697â†’          model: modelName,\n   698â†’          generationConfig: {\n   699â†’            temperature: 0,      // Minimum randomness for deterministic extraction\n   700â†’            topK: 1,            // Only pick most likely token\n   701â†’            topP: 1             // No nucleus sampling\n   702â†’          }\n   703â†’        });\n   704â†’\n   705â†’        // Test the model with a simple call\n   706â†’        console.log(`  ðŸ“ž Testing ${modelName} with simple call...`);\n   707â†’        try {\n   708â†’          const testResult = await geminiModel.generateContent('Hello');\n   709â†’          const testResponse = await testResult.response;\n   710â†’          const testText = testResponse.text();\n   711â†’\n   712â†’          console.log(`  âœ… Model initialized and tested successfully`);\n   713â†’          console.log(`  ðŸ“ Test response: ${testText.substring(0, 50)}...`);\n   714â†’        } catch (testError) {\n   715â†’          console.error(`  âŒ Model test failed:`, testError.message);\n   716â†’          throw new Error(`Failed to test model ${modelName}: ${testError.message}`);\n   717â†’        }\n   718â†’      }\n   719â†’\n   720â†’      console.log(`  ðŸ¤– Using Gemini AI for data extraction (${condition})...`);\n   721â†’\n   722â†’      // Call Gemini API with retry logic for quota/rate limit errors\n   723â†’      let result;\n   724â†’      let retryCount = 0;\n   725â†’      const maxRetries = 3;\n   726â†’\n   727â†’      while (retryCount <= maxRetries) {\n   728â†’        try {\n   729â†’          result = await geminiModel.generateContent(prompt);\n   730â†’          break; // Success, exit retry loop\n   731â†’        } catch (apiError) {\n   732â†’          // Check if it's a quota/rate limit error\n   733â†’          if (apiError.message && (apiError.message.includes('quota') || apiError.message.includes('429'))) {\n   734â†’            const retryDelay = Math.pow(2, retryCount) * 5000; // Exponential backoff: 5s, 10s, 20s\n   735â†’\n   736â†’            console.warn(`  âš ï¸  Gemini API quota/rate limit hit (attempt ${retryCount + 1}/${maxRetries + 1})`);\n   737â†’\n   738â†’            if (retryCount < maxRetries) {\n   739â†’              console.log(`  â³ Waiting ${retryDelay / 1000} seconds before retry...`);\n   740â†’              await new Promise(resolve => setTimeout(resolve, retryDelay));\n   741â†’              retryCount++;\n   742â†’              continue;\n   743â†’            } else {\n   744â†’              // Max retries reached, throw enhanced error\n   745â†’              const enhancedError = new Error(\n   746â†’                'Gemini API quota exceeded. Your free tier allows 20 requests per day. ' +\n   747â†’                'Please wait a few hours for quota to reset, or upgrade to a paid plan at https://ai.google.dev/pricing'\n   748â†’              );\n   749â†’              enhancedError.code = 'GEMINI_QUOTA_EXCEEDED';\n   750â†’              enhancedError.originalError = apiError;\n   751â†’              throw enhancedError;\n   752â†’            }\n   753â†’          } else {\n   754â†’            // Not a quota error, throw immediately\n   755â†’            throw apiError;\n   756â†’          }\n   757â†’        }\n   758â†’      }\n   759â†’\n   760â†’      const response = await result.response;\n   761â†’      const text = response.text();\n   762â†’\n   763â†’      console.log(`  ðŸ“ Gemini response received (${condition}), length: ${text.length} characters`);\n   764â†’\n   765â†’      // Parse JSON from response (remove markdown code blocks if present)\n   766â†’      let extractedData;\n   767â†’      try {\n   768â†’        const jsonText = text.replace(/```json\\n?/g, '').replace(/```\\n?/g, '').trim();\n   769â†’        const rawData = JSON.parse(jsonText);\n   770â†’\n   771â†’        // ðŸ”§ NORMALIZE all values to consistent decimal places\n   772â†’        // This ensures minor extraction variations don't affect calculations\n   773â†’        extractedData = this.normalizeExtractedData(rawData);\n   774â†’\n   775â†’        console.log(`  âœ… PDF data extracted and normalized successfully (${condition})`);\n   776â†’\n   777â†’        // === ENHANCED DEBUG: Show COMPLETE extracted data ===\n   778â†’        console.log(`\\n  ðŸ› === DEBUG: COMPLETE EXTRACTED DATA (${condition}) ===`);\n   779â†’        console.log(`  ðŸ“Š ABSOLUTE POWER (Î¼VÂ²):`);\n   780â†’        if (extractedData.absolute) {\n   781â†’          Object.keys(extractedData.absolute).forEach(channel => {\n   782â†’            const bands = extractedData.absolute[channel];\n   783â†’            console.log(`     ${channel}: Delta=${bands.Delta}, Theta=${bands.Theta}, Alpha=${bands.Alpha}, Beta=${bands.Beta}, HiBeta=${bands.HiBeta}`);\n   784â†’          });\n   785â†’        }\n   786â†’\n   787â†’        console.log(`\\n  ðŸ“Š RELATIVE POWER (%):`);\n   788â†’        if (extractedData.relative) {\n   789â†’          Object.keys(extractedData.relative).forEach(channel => {\n   790â†’            const bands = extractedData.relative[channel];\n   791â†’            const sum = (bands.Delta || 0) + (bands.Theta || 0) + (bands.Alpha || 0) + (bands.Beta || 0) + (bands.HiBeta || 0);\n   792â†’            console.log(`     ${channel}: Delta=${bands.Delta}%, Theta=${bands.Theta}%, Alpha=${bands.Alpha}%, Beta=${bands.Beta}%, HiBeta=${bands.HiBeta}% [Sum=${sum.toFixed(1)}%]`);\n   793â†’          });\n   794â†’        }\n   795â†’\n   796â†’        console.log(`\\n  ðŸ“Š SPECIAL VALUES:`);\n   797â†’        if (extractedData.special) {\n   798â†’          console.log(`     Alpha Peak: ${extractedData.special.alphaPeak} Hz`);\n   799â†’          if (extractedData.special.O1) console.log(`     O1: ${extractedData.special.O1} Hz`);\n   800â†’        }\n   801â†’\n   802â†’        // If Z-score data exists\n   803â†’        if (extractedData.zscores) {\n   804â†’          console.log(`\\n  ðŸ“Š Z-SCORE DATA (ABSOLUTE):`);\n   805â†’          if (extractedData.zscores.absolute) {\n   806â†’            Object.keys(extractedData.zscores.absolute).forEach(channel => {\n   807â†’              const bands = extractedData.zscores.absolute[channel];\n   808â†’              console.log(`     ${channel}: Delta=${bands.Delta}, Theta=${bands.Theta}, Alpha=${bands.Alpha}, Beta=${bands.Beta}, HiBeta=${bands.HiBeta}`);\n   809â†’            });\n   810â†’          }\n   811â†’\n   812â†’          console.log(`\\n  ðŸ“Š Z-SCORE DATA (RELATIVE):`);\n   813â†’          if (extractedData.zscores.relative) {\n   814â†’            Object.keys(extractedData.zscores.relative).forEach(channel => {\n   815â†’              const bands = extractedData.zscores.relative[channel];\n   816â†’              console.log(`     ${channel}: Delta=${bands.Delta}, Theta=${bands.Theta}, Alpha=${bands.Alpha}, Beta=${bands.Beta}, HiBeta=${bands.HiBeta}`);\n   817â†’            });\n   818â†’          }\n   819â†’        }\n   820â†’        console.log(`  === END DEBUG: EXTRACTED DATA ===\\n`);\n   821â†’\n   822â†’      } catch (parseError) {\n   823â†’        console.error(`  âŒ Failed to parse JSON from Gemini response (${condition}):`, parseError.message);\n   824â†’        console.error(`  ðŸ“„ Raw response:`, text.substring(0, 500));\n   825â†’        throw new Error(`Failed to parse JSON from Gemini response: ${parseError.message}`);\n   826â†’      }\n   827â†’\n   828â†’      // Add detailed logging\n   829â†’      console.log(`  ðŸ“Š Data extraction summary (${condition}):`);\n   830â†’      console.log(`     - Absolute power channels: ${Object.keys(extractedData.absolute || {}).length}`);\n   831â†’      console.log(`     - Relative power channels: ${Object.keys(extractedData.relative || {}).length}`);\n   832â†’      console.log(`     - Special values: ${JSON.stringify(extractedData.special || {})}`);\n   833â†’\n   834â†’      // Log sample extracted values for verification (prove it's real patient data, not static)\n   835â†’      console.log(`\\n  ðŸ“‹ Sample Extracted Values (${condition}) - Proof of Dynamic Extraction:`);\n   836â†’      if (extractedData.absolute?.Fz) {\n   837â†’        console.log(`     - Fz Absolute: Theta=${extractedData.absolute.Fz.Theta}, Beta=${extractedData.absolute.Fz.Beta}`);\n   838â†’      }\n   839â†’      if (extractedData.absolute?.Pz) {\n   840â†’        console.log(`     - Pz Absolute: Alpha=${extractedData.absolute.Pz.Alpha}, HiBeta=${extractedData.absolute.Pz.HiBeta}`);\n   841â†’      }\n   842â†’      if (extractedData.relative?.Pz) {\n   843â†’        console.log(`     - Pz Relative: Alpha=${extractedData.relative.Pz.Alpha}, Beta=${extractedData.relative.Pz.Beta}`);\n   844â†’      }\n   845â†’      if (extractedData.absolute?.F3 && extractedData.absolute?.F4) {\n   846â†’        console.log(`     - F3/F4 Absolute Alpha: F3=${extractedData.absolute.F3.Alpha}, F4=${extractedData.absolute.F4.Alpha}`);\n   847â†’      }\n   848â†’      if (extractedData.special?.alphaPeak) {\n   849â†’        console.log(`     - Alpha Peak Frequency: ${extractedData.special.alphaPeak} Hz`);\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"12c44cdc-6cb7-44b8-97ec-4e26bacc97b5","timestamp":"2025-12-09T06:12:16.374Z","toolUseResult":{"type":"text","file":{"filePath":"D:\\Todays\\Neuro360\\server\\services\\qeegParser.js","content":"    if (normalized.zscores) {\n      if (normalized.zscores.absolute) {\n        Object.keys(normalized.zscores.absolute).forEach(channel => {\n          Object.keys(normalized.zscores.absolute[channel]).forEach(band => {\n            normalized.zscores.absolute[channel][band] =\n              this.normalizeValue(normalized.zscores.absolute[channel][band], 2);\n          });\n        });\n      }\n      if (normalized.zscores.relative) {\n        Object.keys(normalized.zscores.relative).forEach(channel => {\n          Object.keys(normalized.zscores.relative[channel]).forEach(band => {\n            normalized.zscores.relative[channel][band] =\n              this.normalizeValue(normalized.zscores.relative[channel][band], 2);\n          });\n        });\n      }\n    }\n\n    return normalized;\n  }\n\n  /**\n   * Parse PDF file using Gemini AI with caching for deterministic results\n   * @param {Object} file - Multer file object\n   * @param {string} condition - 'EO' or 'EC'\n   * @param {string} reportType - 'raw' or 'zscore'\n   */\n  static async parsePDF(file, condition, reportType = 'raw') {\n    console.log(`  ðŸ” Parsing PDF with Gemini AI (${condition}, ${reportType.toUpperCase()} mode)...`);\n\n    try {\n      // Validate API key before attempting to use it\n      this.validateAPIKey();\n\n      // Read PDF file\n      const dataBuffer = fs.readFileSync(file.path);\n\n      // Calculate PDF hash for caching (ensures same PDF = same result)\n      const pdfHash = this.calculatePDFHash(dataBuffer);\n      const cacheKey = `${pdfHash}_${condition}_${reportType}`;\n\n      console.log(`  ðŸ”‘ PDF Hash: ${pdfHash.substring(0, 12)}... (for deterministic caching)`);\n\n      // Check cache first\n      if (extractionCache.has(cacheKey)) {\n        cacheStats.hits++;\n        cacheStats.totalExtractions++;\n        console.log(`  âœ… CACHE HIT! Using cached extraction result (100% deterministic)`);\n        console.log(`  ðŸ“Š Cache Stats: ${cacheStats.hits} hits, ${cacheStats.misses} misses, ${((cacheStats.hits / cacheStats.totalExtractions) * 100).toFixed(1)}% hit rate`);\n        return extractionCache.get(cacheKey);\n      }\n\n      cacheStats.misses++;\n      cacheStats.totalExtractions++;\n      console.log(`  âš ï¸  Cache miss - extracting data with Gemini AI...`);\n      console.log(`  ðŸ“Š Cache Stats: ${cacheStats.hits} hits, ${cacheStats.misses} misses`);\n\n      const pdfData = await pdfParse(dataBuffer);\n\n      // Extract text from PDF\n      const pdfText = pdfData.text;\n\n      // Get appropriate extraction prompt based on report type\n      const prompt = this.getExtractionPrompt(condition, reportType, pdfText);\n\n      // Initialize Gemini model if not already done\n      if (!geminiModel) {\n        console.log('  ðŸ”§ Initializing Gemini model for data extraction...');\n        console.log('  ðŸ”‘ API Key status:', process.env.GEMINI_API_KEY ? 'Present' : 'MISSING');\n        console.log('  ðŸ”‘ API Key length:', process.env.GEMINI_API_KEY?.length || 0);\n        console.log('  ðŸ”‘ API Key preview:', process.env.GEMINI_API_KEY ? `${process.env.GEMINI_API_KEY.substring(0, 20)}...` : 'N/A');\n\n        // Fetch available models dynamically\n        const availableModels = await this.fetchAvailableModels();\n\n        if (availableModels.length === 0) {\n          console.error('\\n  âŒ === NO MODELS AVAILABLE ===');\n          console.error('  Please check:');\n          console.error('  1. GEMINI_API_KEY is correct in .env file');\n          console.error('  2. API key has proper permissions');\n          console.error('  3. Visit: https://aistudio.google.com/apikey to get a new key');\n          console.error('  4. Make sure Generative Language API is enabled');\n          console.error('  ================================\\n');\n          throw new Error('No Gemini models available. Check your API key.');\n        }\n\n        // Select best model\n        const modelName = this.selectBestModel(availableModels);\n\n        if (!modelName) {\n          throw new Error('Could not select a valid model from available models');\n        }\n\n        // Initialize model with full path and deterministic config\n        console.log(`  ðŸ”§ Initializing model: ${modelName}`);\n        geminiModel = genAI.getGenerativeModel({\n          model: modelName,\n          generationConfig: {\n            temperature: 0,      // Minimum randomness for deterministic extraction\n            topK: 1,            // Only pick most likely token\n            topP: 1             // No nucleus sampling\n          }\n        });\n\n        // Test the model with a simple call\n        console.log(`  ðŸ“ž Testing ${modelName} with simple call...`);\n        try {\n          const testResult = await geminiModel.generateContent('Hello');\n          const testResponse = await testResult.response;\n          const testText = testResponse.text();\n\n          console.log(`  âœ… Model initialized and tested successfully`);\n          console.log(`  ðŸ“ Test response: ${testText.substring(0, 50)}...`);\n        } catch (testError) {\n          console.error(`  âŒ Model test failed:`, testError.message);\n          throw new Error(`Failed to test model ${modelName}: ${testError.message}`);\n        }\n      }\n\n      console.log(`  ðŸ¤– Using Gemini AI for data extraction (${condition})...`);\n\n      // Call Gemini API with retry logic for quota/rate limit errors\n      let result;\n      let retryCount = 0;\n      const maxRetries = 3;\n\n      while (retryCount <= maxRetries) {\n        try {\n          result = await geminiModel.generateContent(prompt);\n          break; // Success, exit retry loop\n        } catch (apiError) {\n          // Check if it's a quota/rate limit error\n          if (apiError.message && (apiError.message.includes('quota') || apiError.message.includes('429'))) {\n            const retryDelay = Math.pow(2, retryCount) * 5000; // Exponential backoff: 5s, 10s, 20s\n\n            console.warn(`  âš ï¸  Gemini API quota/rate limit hit (attempt ${retryCount + 1}/${maxRetries + 1})`);\n\n            if (retryCount < maxRetries) {\n              console.log(`  â³ Waiting ${retryDelay / 1000} seconds before retry...`);\n              await new Promise(resolve => setTimeout(resolve, retryDelay));\n              retryCount++;\n              continue;\n            } else {\n              // Max retries reached, throw enhanced error\n              const enhancedError = new Error(\n                'Gemini API quota exceeded. Your free tier allows 20 requests per day. ' +\n                'Please wait a few hours for quota to reset, or upgrade to a paid plan at https://ai.google.dev/pricing'\n              );\n              enhancedError.code = 'GEMINI_QUOTA_EXCEEDED';\n              enhancedError.originalError = apiError;\n              throw enhancedError;\n            }\n          } else {\n            // Not a quota error, throw immediately\n            throw apiError;\n          }\n        }\n      }\n\n      const response = await result.response;\n      const text = response.text();\n\n      console.log(`  ðŸ“ Gemini response received (${condition}), length: ${text.length} characters`);\n\n      // Parse JSON from response (remove markdown code blocks if present)\n      let extractedData;\n      try {\n        const jsonText = text.replace(/```json\\n?/g, '').replace(/```\\n?/g, '').trim();\n        const rawData = JSON.parse(jsonText);\n\n        // ðŸ”§ NORMALIZE all values to consistent decimal places\n        // This ensures minor extraction variations don't affect calculations\n        extractedData = this.normalizeExtractedData(rawData);\n\n        console.log(`  âœ… PDF data extracted and normalized successfully (${condition})`);\n\n        // === ENHANCED DEBUG: Show COMPLETE extracted data ===\n        console.log(`\\n  ðŸ› === DEBUG: COMPLETE EXTRACTED DATA (${condition}) ===`);\n        console.log(`  ðŸ“Š ABSOLUTE POWER (Î¼VÂ²):`);\n        if (extractedData.absolute) {\n          Object.keys(extractedData.absolute).forEach(channel => {\n            const bands = extractedData.absolute[channel];\n            console.log(`     ${channel}: Delta=${bands.Delta}, Theta=${bands.Theta}, Alpha=${bands.Alpha}, Beta=${bands.Beta}, HiBeta=${bands.HiBeta}`);\n          });\n        }\n\n        console.log(`\\n  ðŸ“Š RELATIVE POWER (%):`);\n        if (extractedData.relative) {\n          Object.keys(extractedData.relative).forEach(channel => {\n            const bands = extractedData.relative[channel];\n            const sum = (bands.Delta || 0) + (bands.Theta || 0) + (bands.Alpha || 0) + (bands.Beta || 0) + (bands.HiBeta || 0);\n            console.log(`     ${channel}: Delta=${bands.Delta}%, Theta=${bands.Theta}%, Alpha=${bands.Alpha}%, Beta=${bands.Beta}%, HiBeta=${bands.HiBeta}% [Sum=${sum.toFixed(1)}%]`);\n          });\n        }\n\n        console.log(`\\n  ðŸ“Š SPECIAL VALUES:`);\n        if (extractedData.special) {\n          console.log(`     Alpha Peak: ${extractedData.special.alphaPeak} Hz`);\n          if (extractedData.special.O1) console.log(`     O1: ${extractedData.special.O1} Hz`);\n        }\n\n        // If Z-score data exists\n        if (extractedData.zscores) {\n          console.log(`\\n  ðŸ“Š Z-SCORE DATA (ABSOLUTE):`);\n          if (extractedData.zscores.absolute) {\n            Object.keys(extractedData.zscores.absolute).forEach(channel => {\n              const bands = extractedData.zscores.absolute[channel];\n              console.log(`     ${channel}: Delta=${bands.Delta}, Theta=${bands.Theta}, Alpha=${bands.Alpha}, Beta=${bands.Beta}, HiBeta=${bands.HiBeta}`);\n            });\n          }\n\n          console.log(`\\n  ðŸ“Š Z-SCORE DATA (RELATIVE):`);\n          if (extractedData.zscores.relative) {\n            Object.keys(extractedData.zscores.relative).forEach(channel => {\n              const bands = extractedData.zscores.relative[channel];\n              console.log(`     ${channel}: Delta=${bands.Delta}, Theta=${bands.Theta}, Alpha=${bands.Alpha}, Beta=${bands.Beta}, HiBeta=${bands.HiBeta}`);\n            });\n          }\n        }\n        console.log(`  === END DEBUG: EXTRACTED DATA ===\\n`);\n\n      } catch (parseError) {\n        console.error(`  âŒ Failed to parse JSON from Gemini response (${condition}):`, parseError.message);\n        console.error(`  ðŸ“„ Raw response:`, text.substring(0, 500));\n        throw new Error(`Failed to parse JSON from Gemini response: ${parseError.message}`);\n      }\n\n      // Add detailed logging\n      console.log(`  ðŸ“Š Data extraction summary (${condition}):`);\n      console.log(`     - Absolute power channels: ${Object.keys(extractedData.absolute || {}).length}`);\n      console.log(`     - Relative power channels: ${Object.keys(extractedData.relative || {}).length}`);\n      console.log(`     - Special values: ${JSON.stringify(extractedData.special || {})}`);\n\n      // Log sample extracted values for verification (prove it's real patient data, not static)\n      console.log(`\\n  ðŸ“‹ Sample Extracted Values (${condition}) - Proof of Dynamic Extraction:`);\n      if (extractedData.absolute?.Fz) {\n        console.log(`     - Fz Absolute: Theta=${extractedData.absolute.Fz.Theta}, Beta=${extractedData.absolute.Fz.Beta}`);\n      }\n      if (extractedData.absolute?.Pz) {\n        console.log(`     - Pz Absolute: Alpha=${extractedData.absolute.Pz.Alpha}, HiBeta=${extractedData.absolute.Pz.HiBeta}`);\n      }\n      if (extractedData.relative?.Pz) {\n        console.log(`     - Pz Relative: Alpha=${extractedData.relative.Pz.Alpha}, Beta=${extractedData.relative.Pz.Beta}`);\n      }\n      if (extractedData.absolute?.F3 && extractedData.absolute?.F4) {\n        console.log(`     - F3/F4 Absolute Alpha: F3=${extractedData.absolute.F3.Alpha}, F4=${extractedData.absolute.F4.Alpha}`);\n      }\n      if (extractedData.special?.alphaPeak) {\n        console.log(`     - Alpha Peak Frequency: ${extractedData.special.alphaPeak} Hz`);","numLines":250,"startLine":600,"totalLines":1073}}}
{"parentUuid":"12c44cdc-6cb7-44b8-97ec-4e26bacc97b5","isSidechain":true,"userType":"external","cwd":"D:\\Todays\\Neuro360","sessionId":"042556c2-8872-4445-8efb-d2658cbac4a7","version":"2.0.33","gitBranch":"main","agentId":"63bdb4e9","message":{"model":"claude-sonnet-4-5-20250929","id":"msg_01Bt7mqnzY1XsfhD77WqMj7D","type":"message","role":"assistant","content":[{"type":"text","text":"Perfect! Now I have a complete understanding of the issue. Let me compile my analysis:\n\n## Comprehensive Analysis: Google Gemini API Quota Exceeded Error\n\nBased on my investigation, here's what I found:\n\n### Current Implementation\n\n**1. Gemini API Usage Points:**\n- **qeegParser.js (line 729)**: Calls `geminiModel.generateContent(prompt)` to extract QEEG data from PDF files\n- **geminiPdfGenerator.js (line 337)**: Calls Gemini AI to generate report structure (via `GeminiService.generateBrainPerformanceReport`)\n- **geminiService.js (line 337)**: The actual Gemini API call for report generation\n\n**2. API Configuration:**\n- API Key is set in `server/.env`: `GEMINI_API_KEY=AIzaSyAu3OFmfKDGG7Ur7nuiWMbC7dnMqk5tZ-Q`\n- The key appears to be valid (40 characters, starts with AIzaSy...)\n- API Key is loaded correctly in multiple services\n\n**3. Where Quota is Consumed:**\nThe system makes TWO Gemini API calls per QEEG processing request:\n   - **Call 1**: `qeegParser.parsePDF()` - Extract data from Eyes Open PDF\n   - **Call 2**: `qeegParser.parsePDF()` - Extract data from Eyes Closed PDF\n   - **Call 3** (line 394 in qeegRoutes.js): PDF generation with Gemini AI is DISABLED (`USE_GEMINI = false`)\n\nSo each patient report consumes **2 API calls** (not 3, since PDF generation is disabled).\n\n**4. Existing Error Handling:**\n- qeegParser.js has retry logic with exponential backoff (5s, 10s, 20s delays) - lines 727-758\n- Error is properly caught and categorized as `GEMINI_QUOTA_EXCEEDED`\n- Frontend displays user-friendly error message with solutions\n\n**5. Caching Mechanism:**\n- File-based caching using MD5 hash (lines 638-651)\n- Cache key format: `{md5hash}_{condition}_{reportType}`\n- Cached files don't consume quota\n- Cache statistics tracked (hits, misses, hit rate)\n\n### Why Quota Error Occurs Despite Billing\n\n**ROOT CAUSES IDENTIFIED:**\n\n1. **Wrong API Key Being Used** (MOST LIKELY):\n   - The API key `AIzaSyAu3OFmfKDGG7Ur7nuiWMbC7dnMqk5tZ-Q` might be:\n     - Associated with a FREE tier account (not billing-enabled)\n     - From a different Google Cloud project than the one with billing\n     - Not linked to the billing account properly\n\n2. **Billing Not Actually Enabled**:\n   - Billing might be enabled on Google Cloud Console but:\n     - The Generative Language API quota might still be on free tier\n     - Need to explicitly enable \"Pay-as-you-go\" for Gemini API\n     - The API might need to be enabled in a specific GCP project with billing\n\n3. **API Quota Limits Still Apply**:\n   - Even with billing enabled, there are quota limits:\n     - Free tier: 20 requests/day, 2 requests/minute\n     - Paid tier DEFAULT quotas are still limited (e.g., 60 requests/minute)\n     - Need to request quota increase in Google Cloud Console\n\n4. **Multiple API Calls Per Request**:\n   - Each QEEG processing makes 2 Gemini calls (EO + EC PDFs)\n   - Processing 10 patients = 20 API calls\n   - Can hit quota quickly even with modest usage\n\n5. **API Key Permissions**:\n   - The API key might not have proper permissions to use billing\n   - Generative Language API might not be enabled for the billing-enabled project\n\n### What Needs to be Fixed\n\n**IMMEDIATE FIXES:**\n\n1. **Verify API Key is from Billing-Enabled Project**:\n   - Go to https://console.cloud.google.com/apis/credentials\n   - Verify which project the API key belongs to\n   - Check if that project has billing enabled\n   - Check if Generative Language API is enabled for that project\n\n2. **Create NEW API Key from Correct Project**:\n   - Go to the Google Cloud project that has billing enabled\n   - Enable \"Generative Language API\" in API & Services\n   - Create a NEW API key\n   - Update `server/.env` with the new key\n\n3. **Request Quota Increase** (if using billing):\n   - Go to https://console.cloud.google.com/apis/api/generativelanguage.googleapis.com/quotas\n   - Request higher quota limits for \"Requests per minute\" and \"Requests per day\"\n   - With billing, you can request much higher limits\n\n4. **Implement Request Batching/Throttling**:\n   - Add delay between API calls to avoid rate limits\n   - Process files sequentially with delays instead of parallel\n\n5. **Optimize API Usage**:\n   - The caching mechanism is already in place - ensure it's working\n   - Consider processing both PDFs in a single API call with combined prompt\n   - Re-use cached results aggressively\n\n**LONG-TERM FIXES:**\n\n1. **Switch to Correct Billing Setup**:\n   - Ensure using AI Studio API with \"Pay as you go\" enabled\n   - OR use Vertex AI (Google Cloud's enterprise Gemini API) which has better quota management\n\n2. **Add Rate Limiting Middleware**:\n   - Limit concurrent Gemini API calls\n   - Queue requests if rate limit is approaching\n\n3. **Alternative Solutions**:\n   - Use OpenAI GPT-4 as fallback (OpenAI key is already configured)\n   - Implement local OCR + table extraction as fallback\n\n### Summary\n\n**The issue is NOT that billing is disabled** - it's likely one of these:\n1. âœ… **API key is from a FREE tier project** (not the billing-enabled one)\n2. âœ… **Need to enable \"Pay as you go\" specifically for Generative Language API**\n3. âœ… **Even with billing, default quotas are still limited - need quota increase**\n4. âœ… **Making too many API calls too quickly** (2 calls per patient)\n\n**The fix:**\n1. Create API key from the CORRECT Google Cloud project (the one with billing)\n2. Enable Generative Language API in that project\n3. Enable \"Pay as you go\" pricing tier\n4. Request quota increase if needed\n5. Update `server/.env` with new API key\n\nThe existing error handling and caching mechanisms are already well-implemented. The problem is purely with the API key/billing configuration on Google's side, not the code implementation."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":2,"cache_creation_input_tokens":4637,"cache_read_input_tokens":89346,"cache_creation":{"ephemeral_5m_input_tokens":4637,"ephemeral_1h_input_tokens":0},"output_tokens":1633,"service_tier":"standard"}},"requestId":"req_011CVvcqjfpj4zfR8ish2rRm","type":"assistant","uuid":"710fb0bf-5fbd-49b1-a8c1-2834a878df3b","timestamp":"2025-12-09T06:12:56.610Z"}
