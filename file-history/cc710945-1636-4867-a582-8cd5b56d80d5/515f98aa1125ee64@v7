const { GoogleGenerativeAI } = require('@google/generative-ai');

class GeminiService {
  constructor() {
    console.log('\nüîß Initializing Gemini Service...');
    this.apiKey = process.env.GEMINI_API_KEY;

    if (!this.apiKey) {
      console.error('‚ùå CRITICAL: GEMINI_API_KEY not found in environment variables!');
      console.error('   Please check your .env file');
    } else {
      console.log('‚úÖ Gemini API Key found');
      console.log('   Key length:', this.apiKey.length);
      console.log('   Key preview:', `${this.apiKey.substring(0, 15)}...`);
    }

    this.genAI = this.apiKey ? new GoogleGenerativeAI(this.apiKey) : null;
    this.model = null;
    console.log('‚úÖ Gemini Service initialized\n');
  }

  /**
   * Initialize the Gemini model
   */
  async initModel() {
    if (!this.genAI) {
      throw new Error('Gemini API not initialized. Please check GEMINI_API_KEY.');
    }

    console.log('üîß Initializing Gemini model for PDF generation...');

    // List available models
    try {
      const response = await fetch(
        `https://generativelanguage.googleapis.com/v1beta/models?key=${this.apiKey}`
      );
      const data = await response.json();

      console.log('üìã Available models:', data.models?.map(m => m.name.replace('models/', '')).join(', '));

      // Try models in order of preference for report generation
      const modelPreferences = [
        'models/gemini-1.5-flash-latest',
        'models/gemini-1.5-flash',
        'models/gemini-1.5-pro-latest',
        'models/gemini-1.5-pro',
        'models/gemini-pro'
      ];

      let modelToUse = null;
      for (const preferredModel of modelPreferences) {
        const found = data.models?.find(m => m.name === preferredModel && m.supportedGenerationMethods?.includes('generateContent'));
        if (found) {
          modelToUse = found.name.replace('models/', '');
          console.log(`‚úÖ Selected model for PDF generation: ${modelToUse}`);
          break;
        }
      }

      if (!modelToUse) {
        console.warn('‚ö†Ô∏è No preferred model found, using gemini-pro as fallback');
        modelToUse = 'gemini-pro';
      }

      // Use selected model for fast text generation
      this.model = this.genAI.getGenerativeModel({
        model: modelToUse,
        generationConfig: {
          temperature: 0.7,
          topP: 0.95,
          topK: 40,
          maxOutputTokens: 8192,
        }
      });
    } catch (error) {
      console.error('‚ö†Ô∏è Failed to list models, using gemini-pro as fallback');
      this.model = this.genAI.getGenerativeModel({
        model: 'gemini-pro',
        generationConfig: {
          temperature: 0.7,
          topP: 0.95,
          topK: 40,
          maxOutputTokens: 8192,
        }
      });
    }

    return this.model;
  }

  /**
   * System prompt for brain performance report generation
   */
  getReportGenerationPrompt() {
    return `You are an AI report generator. The input will be the calculated scores and buckets from Algorithm 1 for 7 major brain parameters. Using this input, generate a one page A4 infographic-style report for a patient.

Report requirements:
1. Include all 7 parameters on the single page.
2. Each parameter must include its subparameters with individual scores and short explanations.
3. Display every score clearly with icons, short titles, and small text descriptions that are easy for normal people to understand.
4. Layout should be modern, clean, colorful, and infographic style.
5. Use a professional medical tone but keep the language simple for patients.
6. No diagnosis or medical claim. Only interpretation of brain performance patterns.
7. Add a short one-line summary for every parameter.
8. Add a short summary paragraph at the bottom of the page.

Parameters:
1. Cognition
2. Stress
3. Focus and Attention
4. Burnout and Fatigue
5. Emotional Regulation
6. Learning
7. Creativity

Formatting points:
‚Ä¢ Use icons and graphical representation for every parameter.
‚Ä¢ Parameter names must be bold and attractive.
‚Ä¢ Scores must be visible and easy to compare.
‚Ä¢ Place all details inside a single A4 page layout.
‚Ä¢ Use bullet points and clear sections.
‚Ä¢ Suggest appropriate colors for each bucket (e.g., red for poor, yellow for average, green for good).

Input format that will be given to you:
{
  "Cognition": { "score": x, "bucket": "", "subparameters": [‚Ä¶] },
  "Stress": { "score": x, "bucket": "", "subparameters": [‚Ä¶] },
  "FocusAndAttention": { "score": x, "bucket": "", "subparameters": [‚Ä¶] },
  "BurnoutAndFatigue": { "score": x, "bucket": "", "subparameters": [‚Ä¶] },
  "EmotionalRegulation": { "score": x, "bucket": "", "subparameters": [‚Ä¶] },
  "Learning": { "score": x, "bucket": "", "subparameters": [‚Ä¶] },
  "Creativity": { "score": x, "bucket": "", "subparameters": [‚Ä¶] }
}

Final output:
Return structured text and layout description for designing the single A4 infographic page. The result should be a detailed textual description that a designer or frontend developer can use to create the visual report. Include:
- Suggested layout structure
- Color schemes for each parameter based on bucket
- Icons suggestions
- Text content for each section
- Summary interpretation

Return the output in JSON format with the following structure:
{
  "title": "Brain Performance Report",
  "patientSummary": "Overall summary paragraph",
  "parameters": [
    {
      "name": "Parameter Name",
      "score": x,
      "maxScore": y,
      "bucket": "bucket name",
      "bucketColor": "#hexcolor",
      "icon": "icon suggestion",
      "summary": "One-line summary",
      "subparameters": [
        {
          "name": "subparam name",
          "score": x,
          "interpretation": "Easy explanation",
          "details": "Additional details about the metric"
        }
      ]
    }
  ],
  "recommendations": ["List of general recommendations"],
  "layoutSuggestions": {
    "colorScheme": "Color palette suggestions",
    "structure": "Layout structure description"
  }
}

IMPORTANT:
- Include the "maxScore" field for each parameter
- The subparameters array should contain ALL the metrics from the input data
- Provide clear, easy-to-understand interpretations for each subparameter`;
  }

  /**
   * Generate brain performance report using Gemini AI
   * @param {Object} brainParameters - The 7 brain parameters with scores and buckets
   * @returns {Promise<Object>} Generated report structure
   */
  async generateBrainPerformanceReport(brainParameters) {
    try {
      console.log('\nüîë Checking Gemini API configuration...');
      console.log('   API Key exists:', !!this.apiKey);
      console.log('   API Key length:', this.apiKey ? this.apiKey.length : 0);
      console.log('   API Key preview:', this.apiKey ? `${this.apiKey.substring(0, 10)}...` : 'MISSING');

      if (!this.model) {
        console.log('üì± Initializing Gemini model...');
        await this.initModel();
      }

      console.log('ü§ñ Generating brain performance report with Gemini AI...');
      console.log('üìä Input parameters count:', Object.keys(brainParameters).length);

      // Create the prompt with system instructions and data
      const systemPrompt = this.getReportGenerationPrompt();
      const dataPrompt = `\n\nBrain Parameters Data:\n${JSON.stringify(brainParameters, null, 2)}\n\nPlease generate the infographic report description in JSON format as specified.`;

      const fullPrompt = systemPrompt + dataPrompt;
      console.log('üìù Prompt length:', fullPrompt.length, 'characters');

      // Generate content
      console.log('‚è≥ Calling Gemini API...');
      const result = await this.model.generateContent(fullPrompt);
      const response = await result.response;
      const text = response.text();

      console.log('‚úÖ Gemini response received!');
      console.log('   Response length:', text.length, 'characters');

      // Try to parse JSON from the response
      let reportData;
      try {
        // Remove markdown code blocks if present
        const jsonText = text.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
        reportData = JSON.parse(jsonText);
      } catch (parseError) {
        console.error('Failed to parse JSON response:', parseError);
        // Return raw text if JSON parsing fails
        reportData = {
          title: 'Brain Performance Report',
          rawContent: text,
          parameters: [],
          error: 'Failed to parse structured response'
        };
      }

      return {
        success: true,
        data: reportData,
        rawResponse: text
      };

    } catch (error) {
      console.error('\n‚ùå === GEMINI API ERROR ===');
      console.error('Error Type:', error.constructor.name);
      console.error('Error Message:', error.message);
      console.error('Error Code:', error.code || 'N/A');
      console.error('Error Status:', error.status || 'N/A');
      console.error('Full Error:', JSON.stringify(error, null, 2));
      console.error('Stack:', error.stack);
      console.error('==========================\n');

      return {
        success: false,
        error: error.message,
        errorDetails: {
          type: error.constructor.name,
          code: error.code,
          status: error.status
        },
        data: null
      };
    }
  }

  /**
   * Generate simple text completion
   * @param {string} prompt - The prompt text
   * @returns {Promise<string>} Generated text
   */
  async generateText(prompt) {
    try {
      if (!this.model) {
        await this.initModel();
      }

      const result = await this.model.generateContent(prompt);
      const response = await result.response;
      return response.text();

    } catch (error) {
      console.error('Error generating text with Gemini:', error);
      throw error;
    }
  }

  /**
   * Test Gemini API connection
   */
  async testConnection() {
    try {
      const response = await this.generateText('Hello! Please respond with "OK" if you can read this.');
      console.log('Gemini API test response:', response);
      return { success: true, response };
    } catch (error) {
      console.error('Gemini API test failed:', error);
      return { success: false, error: error.message };
    }
  }
}

module.exports = new GeminiService();
