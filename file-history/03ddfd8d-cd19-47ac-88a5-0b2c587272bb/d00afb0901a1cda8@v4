/**
 * Enhanced AI-Powered PDF Report Generator
 * Uses OpenAI to generate content + PDFKit to create beautiful PDFs
 *
 * Features:
 * - Page 1: Blue gradient background with NeuroSense branding
 * - Page 2: Parameter scores with visual cards
 * - AI-generated content for insights and recommendations
 */

const PDFDocument = require('pdfkit');
const OpenAI = require('openai');
const fs = require('fs');
const path = require('path');

// Initialize OpenAI client
const openai = new OpenAI({
  apiKey: process.env.OPENAI_API_KEY
});

// Color scheme (matching NeuroSense requirements from pdfStyles.js)
const COLORS = {
  primary: '#4A90E2',        // NeuroSense Primary Blue
  primaryLight: '#5BA3F5',   // Light Blue (for gradient)
  primaryDark: '#2E5C8A',    // Dark Blue
  teal: '#7DD3C0',           // Teal/Turquoise
  white: '#FFFFFF',
  black: '#000000',
  darkGray: '#333333',
  lightGray: '#F5F5F5',
  // Classification colors (matching requirement)
  green: '#4CAF50',          // High score - Green
  orange: '#FF9800',         // Low score - Orange
  blue: '#4A90E2'            // Medium score - Primary Blue
};

// Fonts
const FONTS = {
  regular: 'Helvetica',
  bold: 'Helvetica-Bold',
  italic: 'Helvetica-Oblique',
  boldItalic: 'Helvetica-BoldOblique'
};

class EnhancedAIPdfGenerator {
  constructor(patientData, algorithmResults, qeegData) {
    this.patientData = patientData;
    this.algorithmResults = algorithmResults;
    this.qeegData = qeegData;
    this.doc = null;
  }

  /**
   * Generate complete PDF report with AI insights
   */
  async generateReport(outputPath) {
    return new Promise(async (resolve, reject) => {
      try {
        console.log('\nü§ñ === Enhanced AI PDF Generation Started ===\n');
        console.log('üë§ Patient:', this.patientData.name);
        console.log('üìä Parameters:', this.algorithmResults.parameters.length);
        console.log('üéØ Overall Score:', this.algorithmResults.overallScore);

        // Step 1: Create PDF document
        this.doc = new PDFDocument({
          size: 'A4',
          margins: {
            top: 0,
            bottom: 0,
            left: 0,
            right: 0
          },
          bufferPages: true,
          autoFirstPage: false
        });

        // Create write stream
        const stream = fs.createWriteStream(outputPath);
        this.doc.pipe(stream);

        // Step 2: Generate AI insights (parallel to PDF creation)
        console.log('üß† Generating AI insights...');
        const aiInsights = await this.generateAIInsights();
        console.log('‚úÖ AI insights generated');

        // Step 3: Generate PDF pages
        console.log('üìÑ Creating Page 1: Cover with branding...');
        this.generateCoverPage();

        console.log('üìÑ Creating Page 2: Parameter Scores...');
        this.generateParametersPage();

        console.log('üìÑ Creating Page 3: AI Insights & Recommendations...');
        this.generateInsightsPage(aiInsights);

        // Finalize PDF
        this.doc.end();

        // Handle completion
        stream.on('finish', () => {
          console.log('‚úÖ Enhanced AI PDF generated successfully:', outputPath);
          const stats = fs.statSync(outputPath);
          console.log('üìä File size:', (stats.size / 1024).toFixed(2), 'KB');
          resolve(outputPath);
        });

        stream.on('error', (error) => {
          console.error('‚ùå Error writing PDF:', error);
          reject(error);
        });

      } catch (error) {
        console.error('‚ùå Error generating AI PDF:', error);
        reject(error);
      }
    });
  }

  /**
   * PAGE 1: Cover Page with Blue Gradient Background
   */
  generateCoverPage() {
    this.doc.addPage();

    const pageWidth = 595.28;   // A4 width
    const pageHeight = 841.89;  // A4 height
    const centerX = pageWidth / 2;

    // === BLUE GRADIENT BACKGROUND (Top 70%) ===
    const blueHeight = pageHeight * 0.70;

    // Draw gradient rectangles from top to middle
    const gradientSteps = 100;
    for (let i = 0; i < gradientSteps; i++) {
      const y = (i / gradientSteps) * blueHeight;
      const height = blueHeight / gradientSteps;

      // Interpolate between primary and primaryLight
      const factor = i / gradientSteps;
      const color = this.interpolateColor(COLORS.primary, COLORS.primaryLight, factor);

      this.doc.rect(0, y, pageWidth, height)
        .fillColor(color)
        .fill();
    }

    // === LOGO AREA (Top Right) ===
    const logoX = pageWidth - 120;
    const logoY = 35;

    // Brain icon circle
    this.doc.save();
    this.doc.circle(logoX + 20, logoY + 10, 18)
      .fillColor(COLORS.white, 0.3)
      .fill()
      .circle(logoX + 20, logoY + 10, 18)
      .strokeColor(COLORS.white)
      .lineWidth(2)
      .stroke();

    // Logo text
    this.doc.fontSize(11)
      .fillColor(COLORS.white)
      .font(FONTS.bold)
      .text('NEUROSENSE', logoX + 42, logoY, { width: 100 });

    this.doc.fontSize(7)
      .fillColor(COLORS.white)
      .font(FONTS.regular)
      .text('EEG Intelligence‚Ñ¢', logoX + 42, logoY + 15, { width: 100 });
    this.doc.restore();

    // === MAIN TITLE ===
    let yPos = 180;

    this.doc.fontSize(32)
      .fillColor(COLORS.white)
      .font(FONTS.bold)
      .text('NEUROSENSE QUANTITATIVE', 0, yPos, {
        width: pageWidth,
        align: 'center'
      });

    yPos += 42;
    this.doc.fontSize(32)
      .fillColor(COLORS.white)
      .font(FONTS.bold)
      .text('TRANSLATIONAL EEG INTELLIGENCE', 0, yPos, {
        width: pageWidth,
        align: 'center'
      });

    // === BRAIN ILLUSTRATION ===
    yPos += 100;
    this.drawBrainIllustration(centerX, yPos, 120, COLORS.white);

    // === TEAL SECTION (Bottom 30%) ===
    const tealY = blueHeight;
    const tealHeight = pageHeight - blueHeight;

    this.doc.save();
    this.doc.rect(0, tealY, pageWidth, tealHeight)
      .fillColor(COLORS.teal)
      .fill();
    this.doc.restore();

    // === PATIENT INFORMATION TABLE ===
    const tableY = tealY + 40;
    const tableX = 100;
    const tableWidth = pageWidth - 200;
    const rowHeight = 30;

    const fields = [
      { label: 'Name', value: this.patientData.name || 'N/A' },
      { label: 'Date of Recording', value: this.patientData.dateOfRecording || new Date().toISOString().split('T')[0] },
      { label: 'Age', value: this.patientData.age ? `${this.patientData.age} years` : 'N/A' },
      { label: 'Gender', value: this.patientData.gender || 'N/A' },
      { label: 'Handedness', value: this.patientData.handedness || 'Right' }
    ];

    let rowY = tableY;
    fields.forEach((field, index) => {
      // Row separator
      if (index > 0) {
        this.doc.save();
        this.doc.moveTo(tableX, rowY)
          .lineTo(tableX + tableWidth, rowY)
          .strokeColor(COLORS.darkGray, 0.3)
          .lineWidth(1)
          .stroke();
        this.doc.restore();
      }

      // Label
      this.doc.fontSize(10)
        .fillColor(COLORS.darkGray)
        .font(FONTS.bold)
        .text(field.label, tableX + 10, rowY + 10, { width: tableWidth * 0.4 });

      // Value
      this.doc.fontSize(10)
        .fillColor(COLORS.black)
        .font(FONTS.regular)
        .text(field.value, tableX + tableWidth * 0.45, rowY + 10, { width: tableWidth * 0.5 });

      rowY += rowHeight;
    });

    // === FOOTER ===
    const footerY = pageHeight - 35;
    this.doc.fontSize(7)
      .fillColor(COLORS.darkGray)
      .font(FONTS.italic)
      .text(
        'This AI-generated report is not diagnostic. Please consult your doctor for proper interpretation and clinical correlation.',
        50,
        footerY,
        { width: pageWidth - 100, align: 'left' }
      );

    this.doc.fontSize(7)
      .fillColor(COLORS.darkGray)
      .font(FONTS.regular)
      .text('www.neurosenseeeg.com', pageWidth - 150, footerY, { width: 100, align: 'right' });
  }

  /**
   * PAGE 2: Parameters Page with Detailed Sub-Parameters
   */
  generateParametersPage() {
    this.doc.addPage();

    const margin = 50;
    const pageWidth = 595.28;
    const contentWidth = pageWidth - (margin * 2);
    let yPos = margin;

    // === HEADER ===
    this.doc.fontSize(24)
      .fillColor(COLORS.primary)
      .font(FONTS.bold)
      .text('Brain Health Assessment Results', margin, yPos);

    yPos += 40;

    // === OVERALL SCORE BOX ===
    const scoreBoxHeight = 60;
    this.doc.roundedRect(margin, yPos, contentWidth, scoreBoxHeight, 8)
      .fillColor(COLORS.primary)
      .fill();

    const overallScore = this.algorithmResults.overallScore || 0;
    const maxScore = (this.algorithmResults.parameters?.length || 7) * 3;
    const percentage = Math.round((overallScore / maxScore) * 100);

    this.doc.fontSize(20)
      .fillColor(COLORS.white)
      .font(FONTS.bold)
      .text(
        `Overall Brain Health Score: ${overallScore}/${maxScore} (${percentage}%)`,
        margin + 20,
        yPos + 20,
        { width: contentWidth - 40 }
      );

    yPos += scoreBoxHeight + 30;

    // === INTRO TEXT ===
    this.doc.fontSize(11)
      .fillColor(COLORS.darkGray)
      .font(FONTS.regular)
      .text(
        'Below are your 7 brain health parameters with detailed sub-parameter analysis. Each parameter is scored from 0-3.',
        margin,
        yPos,
        { width: contentWidth, align: 'justify' }
      );

    yPos += 40;

    // === DETAILED PARAMETER SECTIONS ===
    const parameters = this.algorithmResults.parameters || [];

    parameters.forEach((param, index) => {
      // Check if we need a new page (estimate: ~150 points per parameter)
      if (yPos > 650) {
        this.doc.addPage();
        yPos = margin + 20;
      }

      // Draw parameter section
      yPos = this.drawParameterSection(param, index + 1, margin, yPos, contentWidth);
    });

    // === BRAIN TYPE PATTERN ===
    if (yPos > 700) {
      this.doc.addPage();
      yPos = margin;
    } else {
      yPos += 20;
    }

    const brainTypePattern = parameters.map(p => `${p.name} ${p.classification.charAt(0)}`).join(' ¬∑ ');

    this.doc.fontSize(12)
      .fillColor(COLORS.primary)
      .font(FONTS.bold)
      .text('Brain-Type Pattern:', margin, yPos);

    yPos += 20;

    this.doc.fontSize(10)
      .fillColor(COLORS.darkGray)
      .font(FONTS.regular)
      .text(brainTypePattern, margin, yPos, { width: contentWidth });
  }

  /**
   * Draw detailed parameter section with sub-parameters
   */
  drawParameterSection(param, number, x, yPos, width) {
    const startY = yPos;

    // === PARAMETER HEADER ===
    // Parameter name and score in format: "Cognition - [scoring system score is 2 / 3]"
    this.doc.fontSize(14)
      .fillColor(COLORS.primary)
      .font(FONTS.bold)
      .text(`${number}. ${param.name} - `, x, yPos, { continued: true });

    this.doc.fontSize(12)
      .fillColor(COLORS.darkGray)
      .font(FONTS.regular)
      .text(`[scoring system score is ${param.score} / ${param.maxScore}]`);

    yPos += 25;

    // Classification badge (small, inline)
    const badgeWidth = 80;
    const badgeHeight = 22;
    const classColor = this.getClassificationColor(param.classification);

    this.doc.roundedRect(x, yPos, badgeWidth, badgeHeight, 4)
      .fillColor(classColor)
      .fill();

    this.doc.fontSize(10)
      .fillColor(COLORS.white)
      .font(FONTS.bold)
      .text(param.classification, x, yPos + 5, { width: badgeWidth, align: 'center' });

    yPos += badgeHeight + 15;

    // === SUB-PARAMETERS ===
    if (param.metrics && param.metrics.length > 0) {
      param.metrics.forEach((metric, idx) => {
        // Check page break
        if (yPos > 720) {
          this.doc.addPage();
          yPos = 50;
        }

        // Sub-parameter name with score status
        const statusColor = this.getMetricStatusColor(metric.score);
        const statusText = this.getMetricStatusText(metric.score);

        this.doc.fontSize(11)
          .fillColor(COLORS.darkGray)
          .font(FONTS.bold)
          .text(`${metric.name}`, x + 10, yPos, { continued: true });

        this.doc.fontSize(10)
          .fillColor(statusColor)
          .font(FONTS.bold)
          .text(` - ${statusText}`, { continued: false });

        yPos += 18;

        // Metric description
        if (metric.description) {
          this.doc.fontSize(9)
            .fillColor(COLORS.darkGray)
            .font(FONTS.regular)
            .text(metric.description, x + 20, yPos, {
              width: width - 30,
              align: 'left',
              lineGap: 2
            });

          yPos += this.doc.heightOfString(metric.description, {
            width: width - 30,
            lineGap: 2
          }) + 10;
        }
      });
    }

    // Add spacing between parameters
    yPos += 15;

    // Optional: Add a subtle separator line
    this.doc.moveTo(x, yPos)
      .lineTo(x + width, yPos)
      .strokeColor(COLORS.lightGray)
      .lineWidth(0.5)
      .stroke();

    yPos += 15;

    return yPos;
  }

  /**
   * Get color for metric status (0 = red, 1 = green)
   */
  getMetricStatusColor(score) {
    if (score === 1) return COLORS.green;
    if (score === 0) return COLORS.orange;
    return COLORS.darkGray;
  }

  /**
   * Get status text for metric
   */
  getMetricStatusText(score) {
    if (score === 1) return 'Normal';
    if (score === 0) return 'Needs Attention';
    return 'Unknown';
  }

  /**
   * PAGE 3: AI Insights and Recommendations
   */
  generateInsightsPage(aiInsights) {
    this.doc.addPage();

    const margin = 50;
    const pageWidth = 595.28;
    const contentWidth = pageWidth - (margin * 2);
    let yPos = margin;

    // === HEADER ===
    this.doc.fontSize(24)
      .fillColor(COLORS.primary)
      .font(FONTS.bold)
      .text('AI-Generated Insights & Recommendations', margin, yPos);

    yPos += 50;

    // === AI CONTENT ===
    this.doc.fontSize(11)
      .fillColor(COLORS.darkGray)
      .font(FONTS.regular)
      .text(aiInsights, margin, yPos, {
        width: contentWidth,
        align: 'justify',
        lineGap: 5
      });
  }

  /**
   * Generate AI insights using OpenAI
   */
  async generateAIInsights() {
    try {
      // Skip AI if no API key
      if (!process.env.OPENAI_API_KEY) {
        console.log('‚ö†Ô∏è  No OpenAI API key - using default insights');
        return this.getDefaultInsights();
      }

      const parametersText = this.algorithmResults.parameters.map((param, index) => {
        return `${index + 1}. ${param.name}: ${param.score}/${param.maxScore} (${param.classification})`;
      }).join('\n');

      const prompt = `As a neuroscience expert, provide a brief, patient-friendly analysis (max 300 words) of these brain health results:

Patient: ${this.patientData.name}, Age ${this.patientData.age}
Overall Score: ${this.algorithmResults.overallScore}/21

Parameters:
${parametersText}

Please provide:
1. A brief summary of the overall brain health profile
2. Key strengths and areas for improvement
3. 2-3 practical recommendations for brain health optimization

Keep the language simple, positive, and actionable. Avoid medical jargon.`;

      const response = await openai.chat.completions.create({
        model: 'gpt-4-turbo-preview',
        messages: [
          {
            role: 'system',
            content: 'You are a compassionate neuroscience expert who explains brain health results in simple, encouraging language.'
          },
          {
            role: 'user',
            content: prompt
          }
        ],
        temperature: 0.7,
        max_tokens: 500
      });

      return response.choices[0].message.content;

    } catch (error) {
      console.error('‚ö†Ô∏è  AI generation failed, using default insights:', error.message);
      return this.getDefaultInsights();
    }
  }

  /**
   * Default insights if AI is not available
   */
  getDefaultInsights() {
    const overallScore = this.algorithmResults.overallScore || 0;
    const maxScore = (this.algorithmResults.parameters?.length || 7) * 3;
    const percentage = Math.round((overallScore / maxScore) * 100);

    return `Based on your QEEG analysis, your overall brain health score is ${overallScore} out of ${maxScore} (${percentage}%).

Your results show a unique brain profile with specific strengths and areas for optimization. Each person's brain is different, and these results help us understand how your brain is currently functioning.

Key Observations:
${this.algorithmResults.parameters.map((param, i) => {
  return `${i + 1}. ${param.name}: Your score is ${param.classification.toLowerCase()}, indicating ${this.getParameterInsight(param)}.`;
}).join('\n')}

Recommendations:
- Continue monitoring your brain health through regular assessments
- Focus on lifestyle factors that support brain function: sleep, exercise, nutrition, and stress management
- Consider targeted brain training exercises for areas showing room for improvement
- Consult with your healthcare provider for personalized guidance

Remember, your brain is capable of remarkable change and improvement through neuroplasticity. These results are a starting point for optimizing your cognitive performance and overall brain health.`;
  }

  /**
   * Get parameter-specific insight
   */
  getParameterInsight(param) {
    const insights = {
      'High': 'strong performance in this area',
      'Medium': 'balanced functioning with room for enhancement',
      'Low': 'potential for significant improvement through targeted interventions'
    };
    return insights[param.classification] || 'normal range';
  }

  /**
   * Get color based on classification (matching NeuroSense requirements)
   * High = Green (#4CAF50)
   * Medium = Blue (#4A90E2)
   * Low = Orange (#FF9800)
   */
  getClassificationColor(classification) {
    const colors = {
      'High': COLORS.green,     // #4CAF50 - Green
      'Medium': COLORS.blue,    // #4A90E2 - Blue (Primary)
      'Low': COLORS.orange      // #FF9800 - Orange
    };
    return colors[classification] || COLORS.darkGray;
  }

  /**
   * Draw brain illustration (simplified)
   */
  drawBrainIllustration(x, y, size, color) {
    const radius = size / 2;

    // Main circle
    this.doc.save();
    this.doc.circle(x, y, radius)
      .strokeColor(color)
      .lineWidth(3)
      .stroke();

    // Brain details (simplified curves)
    // Left hemisphere
    this.doc.moveTo(x - radius * 0.7, y - radius * 0.3)
      .bezierCurveTo(
        x - radius * 0.5, y - radius * 0.5,
        x - radius * 0.3, y - radius * 0.7,
        x - radius * 0.1, y - radius * 0.5
      )
      .strokeColor(color)
      .lineWidth(2)
      .stroke();

    // Right hemisphere
    this.doc.moveTo(x + radius * 0.7, y - radius * 0.3)
      .bezierCurveTo(
        x + radius * 0.5, y - radius * 0.5,
        x + radius * 0.3, y - radius * 0.7,
        x + radius * 0.1, y - radius * 0.5
      )
      .strokeColor(color)
      .lineWidth(2)
      .stroke();

    // Center line
    this.doc.moveTo(x, y - radius * 0.6)
      .lineTo(x, y + radius * 0.6)
      .strokeColor(color)
      .lineWidth(2)
      .stroke();

    this.doc.restore();
  }

  /**
   * Interpolate between two hex colors
   */
  interpolateColor(color1, color2, factor) {
    const hex1 = color1.replace('#', '');
    const hex2 = color2.replace('#', '');

    const r1 = parseInt(hex1.substring(0, 2), 16);
    const g1 = parseInt(hex1.substring(2, 4), 16);
    const b1 = parseInt(hex1.substring(4, 6), 16);

    const r2 = parseInt(hex2.substring(0, 2), 16);
    const g2 = parseInt(hex2.substring(2, 4), 16);
    const b2 = parseInt(hex2.substring(4, 6), 16);

    const r = Math.round(r1 + (r2 - r1) * factor);
    const g = Math.round(g1 + (g2 - g1) * factor);
    const b = Math.round(b1 + (b2 - b1) * factor);

    return `#${r.toString(16).padStart(2, '0')}${g.toString(16).padStart(2, '0')}${b.toString(16).padStart(2, '0')}`;
  }
}

module.exports = EnhancedAIPdfGenerator;
