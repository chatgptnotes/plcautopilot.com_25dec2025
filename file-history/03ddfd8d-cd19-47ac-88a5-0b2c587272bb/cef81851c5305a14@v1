/**
 * Cover Page Generator
 * Generates the professional cover page for the NeuroSense report
 */

const { COLORS, FONTS, LAYOUT } = require('./pdfStyles');

/**
 * Generate the cover page (matching reference PDF design)
 */
function generateCoverPage(doc, patientData) {
  doc.addPage();

  const centerX = LAYOUT.pageWidth / 2;

  // ===== BLUE GRADIENT BACKGROUND (Top 70% of page) =====
  const blueHeight = LAYOUT.pageHeight * 0.70; // 70% for blue section

  // Create blue gradient background (top to bottom)
  doc.save();
  for (let i = 0; i < blueHeight; i++) {
    const factor = i / blueHeight;
    const color = interpolateColor(COLORS.primary, COLORS.primaryLight, factor);
    doc.rect(0, i, LAYOUT.pageWidth, 1)
       .fillColor(color)
       .fill();
  }
  doc.restore();

  // ===== LOGO IN TOP RIGHT =====
  const logoX = LAYOUT.pageWidth - 120;
  const logoY = 35;

  doc.save();
  // Brain icon placeholder (circle with pattern)
  doc.circle(logoX + 20, logoY + 10, 18)
     .fillColor(COLORS.white, 0.3)
     .fill()
     .circle(logoX + 20, logoY + 10, 18)
     .strokeColor(COLORS.white)
     .lineWidth(2)
     .stroke();

  // "NEUROSENSE" text
  doc.fontSize(11)
     .fillColor(COLORS.white)
     .font(FONTS.bold)
     .text('NEUROSENSE', logoX + 42, logoY, { width: 100 });

  // "EEG Intelligence™" text
  doc.fontSize(7)
     .fillColor(COLORS.white)
     .font(FONTS.regular)
     .text('EEG Intelligence™', logoX + 42, logoY + 15, { width: 100 });
  doc.restore();

  // ===== MAIN TITLE (White text on blue background) =====
  let yPos = 180;

  doc.fontSize(32)
     .fillColor(COLORS.white)
     .font(FONTS.bold)
     .text('NEUROSENSE QUANTITATIVE', 0, yPos, {
       width: LAYOUT.pageWidth,
       align: 'center'
     });

  yPos += 42;
  doc.fontSize(32)
     .fillColor(COLORS.white)
     .font(FONTS.bold)
     .text('TRANSLATIONAL EEG INTELLIGENCE', 0, yPos, {
       width: LAYOUT.pageWidth,
       align: 'center'
     });

  // ===== BRAIN ILLUSTRATION (White outline) =====
  yPos += 100;
  drawBrainIllustration(doc, centerX, yPos, 120, COLORS.white);

  // ===== TEAL/TURQUOISE SECTION (Bottom 30%) =====
  const tealY = blueHeight;
  const tealHeight = LAYOUT.pageHeight - blueHeight;

  doc.save();
  doc.rect(0, tealY, LAYOUT.pageWidth, tealHeight)
     .fillColor(COLORS.teal)
     .fill();
  doc.restore();

  // ===== PATIENT INFORMATION TABLE =====
  const tableY = tealY + 40;
  const tableX = 100;
  const tableWidth = LAYOUT.pageWidth - 200;
  const rowHeight = 30;

  const fields = [
    { label: 'Name', value: patientData.name || 'N/A' },
    { label: 'Date of Recording', value: patientData.dateOfRecording || new Date().toISOString().split('T')[0] },
    { label: 'Age', value: patientData.age ? `${patientData.age} years` : 'N/A' },
    { label: 'Gender', value: patientData.gender || 'N/A' },
    { label: 'Handedness', value: patientData.handedness || 'N/A' }
  ];

  let rowY = tableY;
  fields.forEach((field, index) => {
    // Draw row separator line
    if (index > 0) {
      doc.save();
      doc.moveTo(tableX, rowY)
         .lineTo(tableX + tableWidth, rowY)
         .strokeColor(COLORS.darkGray, 0.3)
         .lineWidth(1)
         .stroke();
      doc.restore();
    }

    // Label (left side)
    doc.fontSize(FONTS.body)
       .fillColor(COLORS.darkGray)
       .font(FONTS.bold)
       .text(field.label, tableX + 10, rowY + 10, { width: tableWidth * 0.4 });

    // Value (right side)
    doc.fontSize(FONTS.body)
       .fillColor(COLORS.black)
       .font(FONTS.regular)
       .text(field.value, tableX + tableWidth * 0.45, rowY + 10, { width: tableWidth * 0.5 });

    rowY += rowHeight;
  });

  // ===== FOOTER DISCLAIMER =====
  const footerY = LAYOUT.pageHeight - 35;
  doc.fontSize(7)
     .fillColor(COLORS.darkGray)
     .font(FONTS.italic)
     .text(
       'This AI-generated report is not diagnostic. Please consult your doctor for proper interpretation and clinical correlation.',
       50,
       footerY,
       { width: LAYOUT.pageWidth - 100, align: 'left' }
     );

  // ===== WEBSITE =====
  doc.fontSize(7)
     .fillColor(COLORS.darkGray)
     .font(FONTS.regular)
     .text(
       'www.neurosenseeeg.com',
       LAYOUT.pageWidth - 150,
       footerY,
       { width: 100, align: 'right' }
     );
}

/**
 * Helper function to interpolate between two colors
 */
function interpolateColor(color1, color2, factor) {
  // Simple hex color interpolation
  const hex1 = color1.replace('#', '');
  const hex2 = color2.replace('#', '');

  const r1 = parseInt(hex1.substring(0, 2), 16);
  const g1 = parseInt(hex1.substring(2, 4), 16);
  const b1 = parseInt(hex1.substring(4, 6), 16);

  const r2 = parseInt(hex2.substring(0, 2), 16);
  const g2 = parseInt(hex2.substring(2, 4), 16);
  const b2 = parseInt(hex2.substring(4, 6), 16);

  const r = Math.round(r1 + (r2 - r1) * factor);
  const g = Math.round(g1 + (g2 - g1) * factor);
  const b = Math.round(b1 + (b2 - b1) * factor);

  return `#${r.toString(16).padStart(2, '0')}${g.toString(16).padStart(2, '0')}${b.toString(16).padStart(2, '0')}`;
}

/**
 * Draw a stylized brain illustration (white outline on blue background)
 */
function drawBrainIllustration(doc, x, y, size, color) {
  doc.save();

  const radius = size / 2;

  // Main brain outline (simplified head shape)
  doc.circle(x, y, radius)
     .strokeColor(color)
     .lineWidth(3)
     .stroke();

  // Left hemisphere detail (top curve)
  doc.moveTo(x - radius * 0.7, y - radius * 0.3)
     .bezierCurveTo(
       x - radius * 0.5, y - radius * 0.5,
       x - radius * 0.3, y - radius * 0.7,
       x - radius * 0.1, y - radius * 0.5
     )
     .strokeColor(color)
     .lineWidth(2)
     .stroke();

  // Left hemisphere detail (bottom curve)
  doc.moveTo(x - radius * 0.7, y)
     .bezierCurveTo(
       x - radius * 0.5, y + radius * 0.2,
       x - radius * 0.3, y + radius * 0.4,
       x - radius * 0.1, y + radius * 0.2
     )
     .strokeColor(color)
     .lineWidth(2)
     .stroke();

  // Right hemisphere detail (top curve)
  doc.moveTo(x + radius * 0.7, y - radius * 0.3)
     .bezierCurveTo(
       x + radius * 0.5, y - radius * 0.5,
       x + radius * 0.3, y - radius * 0.7,
       x + radius * 0.1, y - radius * 0.5
     )
     .strokeColor(color)
     .lineWidth(2)
     .stroke();

  // Right hemisphere detail (bottom curve)
  doc.moveTo(x + radius * 0.7, y)
     .bezierCurveTo(
       x + radius * 0.5, y + radius * 0.2,
       x + radius * 0.3, y + radius * 0.4,
       x + radius * 0.1, y + radius * 0.2
     )
     .strokeColor(color)
     .lineWidth(2)
     .stroke();

  // Center division line
  doc.moveTo(x, y - radius * 0.6)
     .lineTo(x, y + radius * 0.6)
     .strokeColor(color)
     .lineWidth(2)
     .stroke();

  // Small connection dots
  doc.circle(x - radius * 0.4, y - radius * 0.2, 3)
     .fillColor(color)
     .fill();

  doc.circle(x + radius * 0.4, y - radius * 0.2, 3)
     .fillColor(color)
     .fill();

  doc.circle(x - radius * 0.4, y + radius * 0.2, 3)
     .fillColor(color)
     .fill();

  doc.circle(x + radius * 0.4, y + radius * 0.2, 3)
     .fillColor(color)
     .fill();

  doc.restore();
}

module.exports = { generateCoverPage };
