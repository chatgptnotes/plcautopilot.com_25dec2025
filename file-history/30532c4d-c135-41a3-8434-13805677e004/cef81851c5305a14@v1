/**
 * Cover Page Generator
 * Generates the professional cover page for the NeuroSense report
 */

const { COLORS, FONTS, LAYOUT } = require('./pdfStyles');

/**
 * Generate the cover page
 */
function generateCoverPage(doc, patientData) {
  doc.addPage();

  const centerX = LAYOUT.pageWidth / 2;
  let yPos = 100;

  // Add gradient background (simulated with rectangles)
  doc.save();
  doc.rect(0, 0, LAYOUT.pageWidth, LAYOUT.pageHeight)
     .fill(COLORS.white);

  // Add top gradient effect
  for (let i = 0; i < 200; i++) {
    const alpha = i / 200;
    const color = interpolateColor(COLORS.primaryLight, COLORS.white, alpha);
    doc.rect(0, i, LAYOUT.pageWidth, 1)
       .fillColor(color, 0.3)
       .fill();
  }
  doc.restore();

  // Logo / Brand
  doc.save();
  doc.fontSize(FONTS.small)
     .fillColor(COLORS.primary)
     .font(FONTS.bold)
     .text('NeuroSenseâ„¢', 50, 40);
  doc.restore();

  // Main title
  yPos = 150;
  doc.fontSize(28)
     .fillColor(COLORS.primaryDark)
     .font(FONTS.bold)
     .text('NEUROSENSE', 0, yPos, { width: LAYOUT.pageWidth, align: 'center' });

  yPos += 40;
  doc.fontSize(22)
     .fillColor(COLORS.primary)
     .font(FONTS.regular)
     .text('QUANTITATIVE TRANSLATIONAL', 0, yPos, { width: LAYOUT.pageWidth, align: 'center' });

  yPos += 35;
  doc.fontSize(22)
     .fillColor(COLORS.primary)
     .text('EEG INTELLIGENCE', 0, yPos, { width: LAYOUT.pageWidth, align: 'center' });

  // Subtitle
  yPos += 50;
  doc.fontSize(FONTS.body)
     .fillColor(COLORS.gray)
     .font(FONTS.italic)
     .text('Comprehensive Brain Health Analysis Report', 0, yPos, { width: LAYOUT.pageWidth, align: 'center' });

  // Draw brain illustration placeholder (simplified text-based)
  yPos += 80;
  doc.save();
  doc.fontSize(80)
     .fillColor(COLORS.primary, 0.2)
     .text('ðŸ§ ', 0, yPos, { width: LAYOUT.pageWidth, align: 'center' });
  doc.restore();

  // Patient Information Box
  yPos += 150;
  const boxX = centerX - 200;
  const boxWidth = 400;
  const boxHeight = 180;

  // Draw info box background
  doc.save();
  doc.roundedRect(boxX, yPos, boxWidth, boxHeight, 10)
     .fillColor(COLORS.white)
     .fill()
     .roundedRect(boxX, yPos, boxWidth, boxHeight, 10)
     .strokeColor(COLORS.primary, 0.3)
     .lineWidth(2)
     .stroke();
  doc.restore();

  // Patient info fields
  let infoY = yPos + 20;
  const labelX = boxX + 30;
  const valueX = boxX + 180;

  const fields = [
    { label: 'Patient Name', value: patientData.name || 'N/A' },
    { label: 'Date of Recording', value: patientData.dateOfRecording || new Date().toISOString().split('T')[0] },
    { label: 'Age', value: patientData.age ? `${patientData.age} years` : 'N/A' },
    { label: 'Gender', value: patientData.gender || 'N/A' },
    { label: 'Handedness', value: patientData.handedness || 'Right' }
  ];

  fields.forEach(field => {
    // Label
    doc.fontSize(FONTS.small)
       .fillColor(COLORS.gray)
       .font(FONTS.regular)
       .text(field.label, labelX, infoY);

    // Value
    doc.fontSize(FONTS.body)
       .fillColor(COLORS.darkGray)
       .font(FONTS.bold)
       .text(field.value, valueX, infoY);

    infoY += 30;
  });

  // Footer
  yPos = LAYOUT.pageHeight - 100;
  doc.fontSize(FONTS.tiny)
     .fillColor(COLORS.lightGray)
     .font(FONTS.italic)
     .text(
       'This report provides quantitative EEG analysis for brain health assessment.\nGenerated by NeuroSense Intelligenceâ„¢',
       0,
       yPos,
       { width: LAYOUT.pageWidth, align: 'center' }
     );

  // Copyright
  yPos += 40;
  doc.fontSize(FONTS.tiny)
     .fillColor(COLORS.lightGray)
     .text(
       `Â© ${new Date().getFullYear()} NeuroSense Intelligence. All rights reserved.`,
       0,
       yPos,
       { width: LAYOUT.pageWidth, align: 'center' }
     );
}

/**
 * Helper function to interpolate between two colors
 */
function interpolateColor(color1, color2, factor) {
  // Simple hex color interpolation
  const hex1 = color1.replace('#', '');
  const hex2 = color2.replace('#', '');

  const r1 = parseInt(hex1.substring(0, 2), 16);
  const g1 = parseInt(hex1.substring(2, 4), 16);
  const b1 = parseInt(hex1.substring(4, 6), 16);

  const r2 = parseInt(hex2.substring(0, 2), 16);
  const g2 = parseInt(hex2.substring(2, 4), 16);
  const b2 = parseInt(hex2.substring(4, 6), 16);

  const r = Math.round(r1 + (r2 - r1) * factor);
  const g = Math.round(g1 + (g2 - g1) * factor);
  const b = Math.round(b1 + (b2 - b1) * factor);

  return `#${r.toString(16).padStart(2, '0')}${g.toString(16).padStart(2, '0')}${b.toString(16).padStart(2, '0')}`;
}

module.exports = { generateCoverPage };
