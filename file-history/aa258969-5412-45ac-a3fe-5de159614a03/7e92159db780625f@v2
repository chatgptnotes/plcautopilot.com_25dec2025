-- =====================================================
-- CREATE NEUROSENSE REPORTS STORAGE BUCKET
-- =====================================================
-- This script creates a Supabase storage bucket for storing
-- NeuroSense PDF reports generated by Algorithm 1
--
-- Run this in Supabase SQL Editor:
-- https://supabase.com/dashboard/project/YOUR_PROJECT/sql
-- =====================================================

-- Step 1: Create the storage bucket
INSERT INTO storage.buckets (id, name, public, file_size_limit, allowed_mime_types)
VALUES (
  'neurosense-reports',
  'neurosense-reports',
  true,  -- Make bucket public so PDFs can be accessed via URL
  52428800,  -- 50MB file size limit
  ARRAY['application/pdf']  -- Only allow PDF files
)
ON CONFLICT (id) DO NOTHING;

-- Step 2: Set up RLS (Row Level Security) policies for the bucket

-- Allow authenticated users to upload PDFs
CREATE POLICY "Allow authenticated users to upload PDFs"
ON storage.objects FOR INSERT
TO authenticated
WITH CHECK (
  bucket_id = 'neurosense-reports' AND
  (storage.extension(name) = 'pdf')
);

-- Allow public read access to all PDFs (so they can be downloaded via URL)
CREATE POLICY "Allow public read access to PDFs"
ON storage.objects FOR SELECT
TO public
USING (bucket_id = 'neurosense-reports');

-- Allow authenticated users to update their own PDFs
CREATE POLICY "Allow authenticated users to update PDFs"
ON storage.objects FOR UPDATE
TO authenticated
USING (bucket_id = 'neurosense-reports')
WITH CHECK (bucket_id = 'neurosense-reports');

-- Allow authenticated users to delete PDFs (optional - remove if not needed)
CREATE POLICY "Allow authenticated users to delete PDFs"
ON storage.objects FOR DELETE
TO authenticated
USING (bucket_id = 'neurosense-reports');

-- Step 3: Verify bucket creation
SELECT
  id,
  name,
  public,
  file_size_limit,
  allowed_mime_types,
  created_at
FROM storage.buckets
WHERE id = 'neurosense-reports';

-- =====================================================
-- BUCKET STRUCTURE
-- =====================================================
-- Files will be stored in this structure:
-- neurosense-reports/
--   └── reports/
--       ├── neurosense-report-patient1-1234567890.pdf
--       ├── neurosense-report-patient2-1234567891.pdf
--       └── ...
-- =====================================================

-- =====================================================
-- MANUAL SETUP (Alternative to SQL)
-- =====================================================
-- If you prefer to create the bucket manually:
--
-- 1. Go to Supabase Dashboard > Storage
-- 2. Click "New bucket"
-- 3. Bucket name: neurosense-reports
-- 4. Public bucket: YES (checked)
-- 5. File size limit: 50 MB
-- 6. Allowed MIME types: application/pdf
-- 7. Click "Create bucket"
--
-- 8. After creating, click on the bucket > Policies
-- 9. Add policies:
--    - INSERT: authenticated users can upload
--    - SELECT: public can read (for PDF downloads)
--    - UPDATE: authenticated users can update
--    - DELETE: authenticated users can delete (optional)
-- =====================================================

-- =====================================================
-- TESTING THE BUCKET
-- =====================================================
-- After creating the bucket, you can test it with:
--
-- 1. Upload a test PDF from your backend
-- 2. Check if the public URL works:
--    https://YOUR_PROJECT.supabase.co/storage/v1/object/public/neurosense-reports/reports/test.pdf
--
-- 3. Verify in Supabase Dashboard > Storage > neurosense-reports
-- =====================================================
