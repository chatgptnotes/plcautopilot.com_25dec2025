# Supabase Storage Bucket Setup Guide
## For NeuroSense Reports

This guide will help you create and configure the `neurosense-reports` bucket in Supabase to store PDF reports.

---

## ğŸ“‹ Prerequisites

Before starting, make sure you have:
- âœ… Active Supabase account (https://supabase.com)
- âœ… NeuroSense project created in Supabase
- âœ… Supabase credentials in your `.env` file:
  ```env
  SUPABASE_URL=https://your-project.supabase.co
  SUPABASE_SERVICE_ROLE_KEY=your-service-role-key
  ```

---

## ğŸš€ Method 1: Automated Setup (Using SQL Script)

### Step 1: Run the SQL Script

1. **Go to Supabase Dashboard**
   - Navigate to: https://supabase.com/dashboard
   - Select your NeuroSense project

2. **Open SQL Editor**
   - Click on **SQL Editor** in the left sidebar
   - Click **"+ New query"**

3. **Copy and Run the Script**
   - Open the file: `CREATE_NEUROSENSE_REPORTS_BUCKET.sql`
   - Copy all the SQL code
   - Paste into the SQL Editor
   - Click **"Run"** or press `Ctrl+Enter`

4. **Verify Creation**
   - You should see a success message
   - The bucket and policies will be created automatically

### Step 2: Verify in Storage

1. Go to **Storage** in the left sidebar
2. You should see a new bucket named: **neurosense-reports**
3. Click on it to view details:
   - **Public**: Yes (checked)
   - **File size limit**: 50 MB
   - **Allowed MIME types**: application/pdf

---

## ğŸ› ï¸ Method 2: Manual Setup (UI)

If you prefer to create the bucket manually through the UI:

### Step 1: Create the Bucket

1. **Go to Supabase Dashboard** â†’ **Storage**
2. Click **"New bucket"**
3. Fill in the details:
   - **Bucket name**: `neurosense-reports`
   - **Public bucket**: âœ… **YES** (Check this box)
   - **File size limit**: `50 MB`
   - **Allowed MIME types**: `application/pdf`
4. Click **"Create bucket"**

### Step 2: Set Up Policies (RLS)

1. Click on the **neurosense-reports** bucket
2. Click on **"Policies"** tab
3. Add the following policies:

#### Policy 1: Allow Upload (INSERT)
- **Policy name**: Allow authenticated users to upload PDFs
- **Target roles**: `authenticated`
- **Operation**: `INSERT`
- **Policy definition**:
  ```sql
  bucket_id = 'neurosense-reports' AND
  (storage.extension(name) = 'pdf')
  ```

#### Policy 2: Allow Public Read (SELECT)
- **Policy name**: Allow public read access to PDFs
- **Target roles**: `public`
- **Operation**: `SELECT`
- **Policy definition**:
  ```sql
  bucket_id = 'neurosense-reports'
  ```

#### Policy 3: Allow Update (UPDATE)
- **Policy name**: Allow authenticated users to update PDFs
- **Target roles**: `authenticated`
- **Operation**: `UPDATE`
- **Policy definition**:
  ```sql
  bucket_id = 'neurosense-reports'
  ```

#### Policy 4: Allow Delete (DELETE) - Optional
- **Policy name**: Allow authenticated users to delete PDFs
- **Target roles**: `authenticated`
- **Operation**: `DELETE`
- **Policy definition**:
  ```sql
  bucket_id = 'neurosense-reports'
  ```

---

## âœ… Step 3: Verify Your Setup

### Check Environment Variables

Make sure your `.env` file has the correct Supabase credentials:

```env
# Supabase Configuration
SUPABASE_URL=https://your-project-id.supabase.co
SUPABASE_SERVICE_ROLE_KEY=your-service-role-key-here
```

**How to get these:**
1. Go to Supabase Dashboard â†’ Project Settings â†’ API
2. **SUPABASE_URL**: Copy from "Project URL"
3. **SUPABASE_SERVICE_ROLE_KEY**: Copy from "service_role" (secret key)

### Test the Upload

1. **Start your backend server**:
   ```bash
   npm run dev:backend
   ```

2. **Check the logs** for Supabase initialization:
   ```
   âœ… Supabase credentials found
   âœ… SUPABASE_URL: Set
   âœ… SUPABASE_SERVICE_ROLE_KEY: Set
   ```

3. **Generate a test report**:
   - Go to Algorithm Processor in your app
   - Upload QEEG files
   - Execute calculation
   - Click "Save & Download NeuroSense Report"

4. **Watch the backend logs** for:
   ```
   â˜ï¸  Uploading PDF to Supabase storage...
   âœ… PDF uploaded to Supabase successfully
   ğŸ”— Supabase URL: https://your-project.supabase.co/storage/v1/object/public/neurosense-reports/reports/neurosense-report-...pdf
   ```

5. **Verify in Supabase Dashboard**:
   - Go to Storage â†’ neurosense-reports â†’ reports/
   - You should see your PDF file
   - Click on it to view/download

---

## ğŸ“‚ Bucket Structure

Your PDFs will be stored in this structure:

```
neurosense-reports/
  â””â”€â”€ reports/
      â”œâ”€â”€ neurosense-report-patient1-1234567890.pdf
      â”œâ”€â”€ neurosense-report-patient2-1234567891.pdf
      â”œâ”€â”€ neurosense-report-john_doe-1765341955844.pdf
      â””â”€â”€ ...
```

---

## ğŸ”— PDF URL Format

After upload, your PDFs will be accessible via:

```
https://[your-project-id].supabase.co/storage/v1/object/public/neurosense-reports/reports/[filename].pdf
```

Example:
```
https://abcdefgh.supabase.co/storage/v1/object/public/neurosense-reports/reports/neurosense-report-priyanka_sahare-1765341955844.pdf
```

---

## ğŸ”§ Troubleshooting

### Issue 1: Upload Fails - Credentials Not Found

**Error:**
```
âš ï¸ Supabase credentials not found in environment variables
```

**Solution:**
1. Check your `.env` file has `SUPABASE_URL` and `SUPABASE_SERVICE_ROLE_KEY`
2. Restart your backend server after updating `.env`
3. Make sure the `.env` file is in the root directory (not in `server/` folder)

### Issue 2: Upload Fails - Bucket Not Found

**Error:**
```
Failed to upload to Supabase: Bucket not found
```

**Solution:**
1. Verify bucket exists: Go to Supabase Dashboard â†’ Storage
2. Check the bucket name is exactly: `neurosense-reports` (no typos)
3. Re-run the SQL script if needed

### Issue 3: Upload Fails - Permission Denied

**Error:**
```
Failed to upload to Supabase: new row violates row-level security policy
```

**Solution:**
1. Check RLS policies are set up correctly (see Method 2, Step 2)
2. Make sure "Public bucket" is enabled
3. Verify policies allow `INSERT` for authenticated users

### Issue 4: PDF URL Not Working (404 Error)

**Error:**
```
404 Not Found when accessing PDF URL
```

**Solution:**
1. Verify bucket is **public** (check the box in bucket settings)
2. Check the `SELECT` policy allows `public` access
3. Verify the file exists in Storage â†’ neurosense-reports

### Issue 5: Falls Back to Local Storage

**Warning:**
```
âš ï¸ Supabase upload failed, using local storage
```

**This is OK!** The system has a fallback mechanism:
1. **Tries to upload to Supabase first**
2. **If fails**, keeps the PDF in local `server/uploads/` folder
3. **Both work fine**, Supabase is just preferred for cloud storage

---

## ğŸ¯ How It Works

### Upload Flow:

1. **User clicks "Save & Download NeuroSense Report"**
   â†“
2. **Frontend sends request to backend** (`/api/qeeg/generate-pdf`)
   â†“
3. **Backend generates PDF** with Gemini AI content
   â†“
4. **PDF saved to local** `server/uploads/` folder
   â†“
5. **Attempts Supabase upload**:
   - âœ… **Success**: Upload to `neurosense-reports/reports/`
   - âœ… **Success**: Delete local file (to save space)
   - âœ… **Success**: Return Supabase URL
   - âŒ **Failure**: Keep local file, return local URL
   â†“
6. **URL stored in database** (algorithmResults table)
   â†“
7. **Frontend auto-downloads PDF** for user

### Benefits of Supabase Storage:

âœ… **Cloud-based**: PDFs accessible from anywhere
âœ… **Scalable**: No server disk space limits
âœ… **Fast CDN**: Quick downloads globally
âœ… **Secure**: Row-level security policies
âœ… **Automatic backups**: Built into Supabase
âœ… **Cost-effective**: Free tier includes 1GB storage

---

## ğŸ“Š Monitoring

### Check Upload Statistics

You can monitor your bucket usage:

1. Go to **Supabase Dashboard** â†’ **Storage**
2. Click on **neurosense-reports**
3. You'll see:
   - Number of files
   - Total size used
   - Bandwidth usage

### View Recent Uploads

```sql
-- Run this in SQL Editor to see recent uploads
SELECT
  name,
  created_at,
  metadata->>'size' as size_bytes,
  metadata->>'mimetype' as mime_type
FROM storage.objects
WHERE bucket_id = 'neurosense-reports'
ORDER BY created_at DESC
LIMIT 10;
```

---

## ğŸ”’ Security Best Practices

1. **Never commit `.env` file** to Git
2. **Use service_role key only on backend** (never expose to frontend)
3. **Keep bucket public** for PDF downloads (PDFs aren't sensitive data)
4. **Use signed URLs** if you need expiring links (future enhancement)
5. **Regularly review policies** in Supabase Dashboard

---

## ğŸ“ Need Help?

If you encounter issues:

1. **Check backend logs** for error messages
2. **Verify bucket exists** in Supabase Dashboard
3. **Test credentials** in Supabase â†’ Project Settings â†’ API
4. **Review policies** in Storage â†’ neurosense-reports â†’ Policies
5. **Check Supabase status**: https://status.supabase.com

---

## âœ¨ You're All Set!

Your NeuroSense reports are now being stored in the cloud! ğŸ‰

Every time a user generates a report, it will:
- âœ… Generate professional PDF with AI insights
- âœ… Upload to Supabase cloud storage
- âœ… Store public URL in database
- âœ… Auto-download for user
- âœ… Available in Processing History with download link

Enjoy your cloud-powered NeuroSense system! ğŸ§ â˜ï¸
