const express = require('express');
const multer = require('multer');
const path = require('path');
const fs = require('fs');
const QEEGParser = require('../services/qeegParser');
const AlgorithmCalculator = require('../services/algorithmCalculator');
const PDFReportGenerator = require('../services/pdfGenerator');
const AIPdfGenerator = require('../services/aiPdfGenerator');
const SupabaseStorage = require('../services/supabaseStorage');

const router = express.Router();

// Configure multer for file uploads
const storage = multer.diskStorage({
  destination: function (req, file, cb) {
    const uploadDir = path.join(__dirname, '../uploads');
    // Ensure upload directory exists
    if (!fs.existsSync(uploadDir)) {
      fs.mkdirSync(uploadDir, { recursive: true });
    }
    cb(null, uploadDir);
  },
  filename: function (req, file, cb) {
    const uniqueSuffix = Date.now() + '-' + Math.round(Math.random() * 1E9);
    cb(null, file.fieldname + '-' + uniqueSuffix + path.extname(file.originalname));
  }
});

const upload = multer({
  storage: storage,
  limits: {
    fileSize: 10 * 1024 * 1024 // 10MB limit
  },
  fileFilter: function (req, file, cb) {
    const allowedExtensions = ['.pdf', '.csv', '.xlsx', '.xls'];
    const ext = path.extname(file.originalname).toLowerCase();
    if (allowedExtensions.includes(ext)) {
      cb(null, true);
    } else {
      cb(new Error(`Only ${allowedExtensions.join(', ')} files are allowed`));
    }
  }
});

/**
 * POST /api/qeeg/process
 * Process QEEG files and calculate 7 brain health parameters
 */
router.post('/process', upload.fields([
  { name: 'eyesOpen', maxCount: 1 },
  { name: 'eyesClosed', maxCount: 1 }
]), async (req, res) => {
  let eyesOpenFile = null;
  let eyesClosedFile = null;

  try {
    console.log('\nðŸ”¬ === QEEG Processing Started ===\n');

    // Get uploaded files
    const files = req.files;
    if (!files || !files.eyesOpen || !files.eyesClosed) {
      return res.status(400).json({
        error: true,
        message: 'Both Eyes Open and Eyes Closed files are required'
      });
    }

    eyesOpenFile = files.eyesOpen[0];
    eyesClosedFile = files.eyesClosed[0];

    console.log('ðŸ“ Files received:');
    console.log('  - Eyes Open:', eyesOpenFile.originalname, `(${(eyesOpenFile.size / 1024).toFixed(2)} KB)`);
    console.log('  - Eyes Closed:', eyesClosedFile.originalname, `(${(eyesClosedFile.size / 1024).toFixed(2)} KB)`);

    // Get patient info from request body
    const { patientId, patientName, clinicName } = req.body;

    console.log('\nðŸ‘¤ Patient Information:');
    console.log('  - Patient ID:', patientId);
    console.log('  - Patient Name:', patientName);
    console.log('  - Clinic:', clinicName);

    // Validate OpenAI API configuration before processing
    console.log('\nðŸ” Validating OpenAI API configuration...');
    try {
      await QEEGParser.testAPIConnection();
    } catch (apiError) {
      throw new Error(`Cannot process QEEG data: ${apiError.message}`);
    }

    // Step 1: Parse QEEG files
    console.log('\nðŸ“Š Step 1: Parsing QEEG files...');
    const qeegData = await QEEGParser.parse(eyesOpenFile, eyesClosedFile);

    // Validate that we got real patient data
    console.log('\nðŸ“Š QEEG Data Validation:');
    console.log('  - Eyes Open (EO) channels:', Object.keys(qeegData.EO?.absolute || {}).length);
    console.log('  - Eyes Closed (EC) channels:', Object.keys(qeegData.EC?.absolute || {}).length);
    console.log('  - Using REAL PATIENT DATA (not sample data)');
    console.log('  - Patient:', patientName, `(ID: ${patientId})`);

    // Step 2: Calculate parameters
    console.log('\nðŸ§® Step 2: Calculating 7 brain health parameters...');
    const calculator = new AlgorithmCalculator(qeegData);
    const results = calculator.calculate();

    console.log('\nâœ… Calculation completed successfully!');
    console.log('ðŸ“ˆ Results Summary:');
    results.parameters.forEach(param => {
      console.log(`  - ${param.name}: ${param.score}/${param.maxScore} (${param.classification})`);
    });
    console.log(`  - Overall Score: ${results.overallScore}/21`);

    // Step 3: Auto-generate PDF report
    console.log('\nðŸ“„ Step 3: Auto-generating PDF report...');
    let pdfUrl = null;
    let pdfFilename = null;

    try {
      // Prepare patient data for PDF
      const pdfPatientData = {
        name: patientName,
        dateOfRecording: new Date().toISOString().split('T')[0],
        age: 'N/A', // Not available during processing
        gender: 'Not specified',
        handedness: 'Not specified',
        patientId: patientId,
        clinicName: clinicName
      };

      // Prepare algorithm results for PDF
      const pdfAlgorithmResults = {
        parameters: results.parameters,
        overallScore: results.overallScore
      };

      // Generate PDF
      const pdfGenerator = new PDFReportGenerator(pdfPatientData, pdfAlgorithmResults, qeegData);

      // Create output filename
      const timestamp = Date.now();
      const sanitizedName = (patientName || 'patient').replace(/[^a-z0-9]/gi, '_').toLowerCase();
      pdfFilename = `neurosense-report-${sanitizedName}-${timestamp}.pdf`;
      const pdfOutputPath = path.join(__dirname, '../uploads', pdfFilename);

      console.log('ðŸ“ Generating PDF to:', pdfFilename);

      // Generate the PDF
      await pdfGenerator.generateReport(pdfOutputPath);

      console.log('âœ… PDF generated successfully!');
      console.log('ðŸ“„ File:', pdfFilename);
      console.log('ðŸ“Š Size:', (fs.statSync(pdfOutputPath).size / 1024).toFixed(2), 'KB');

      // Upload to Supabase Storage
      try {
        console.log('\nâ˜ï¸  Uploading PDF to Supabase storage...');
        const uploadResult = await SupabaseStorage.uploadFile(
          pdfOutputPath,
          'neurosense_bucketreports', // bucket name
          `reports/${pdfFilename}` // path in bucket
        );

        // Verify upload was successful and URL is valid
        if (uploadResult && uploadResult.url) {
          pdfUrl = uploadResult.url;
          console.log('âœ… PDF uploaded to Supabase successfully');
          console.log('ðŸ”— Supabase URL:', pdfUrl);

          // Delete local file after successful Supabase upload
          try {
            fs.unlinkSync(pdfOutputPath);
            console.log('ðŸ—‘ï¸  Local PDF file deleted after successful upload');
          } catch (deleteError) {
            console.warn('âš ï¸  Could not delete local PDF file:', deleteError.message);
          }
        } else {
          throw new Error('Supabase upload returned invalid result');
        }
      } catch (supabaseError) {
        console.error('âš ï¸  Supabase upload failed, using local storage:', supabaseError.message);
        // Fallback to local storage
        pdfUrl = `/uploads/${pdfFilename}`;
        console.log('ðŸ“ Using local file as fallback:', pdfUrl);
      }

    } catch (pdfError) {
      console.error('âš ï¸ PDF generation failed, but processing succeeded:', pdfError.message);
      // Don't fail the whole request if PDF fails
    }

    // Clean up uploaded files
    try {
      fs.unlinkSync(eyesOpenFile.path);
      fs.unlinkSync(eyesClosedFile.path);
      console.log('\nðŸ—‘ï¸  Temporary files cleaned up');
    } catch (cleanupError) {
      console.error('âš ï¸  Error cleaning up files:', cleanupError.message);
    }

    console.log('\nðŸ === QEEG Processing Completed ===\n');

    // Send response
    res.json({
      success: true,
      data: {
        patientId,
        patientName,
        clinicName,
        processedAt: new Date().toISOString(),
        results: results.parameters,
        overallScore: results.overallScore,
        maxScore: 21,
        pdfUrl: pdfUrl,
        pdfFilename: pdfFilename
      }
    });

  } catch (error) {
    console.error('\nâŒ === QEEG Processing Failed ===');
    console.error('Error:', error.message);
    console.error('Error Code:', error.code || 'UNKNOWN');
    console.error('Stack:', error.stack);

    // Clean up files on error
    if (eyesOpenFile && fs.existsSync(eyesOpenFile.path)) {
      try {
        fs.unlinkSync(eyesOpenFile.path);
      } catch (e) {
        console.error('Error deleting Eyes Open file:', e.message);
      }
    }
    if (eyesClosedFile && fs.existsSync(eyesClosedFile.path)) {
      try {
        fs.unlinkSync(eyesClosedFile.path);
      } catch (e) {
        console.error('Error deleting Eyes Closed file:', e.message);
      }
    }

    // Categorize errors for better user feedback
    let statusCode = 500;
    let userMessage = error.message;

    switch (error.code) {
      case 'MISSING_API_KEY':
      case 'INVALID_API_KEY':
      case 'INVALID_API_KEY_FORMAT':
      case 'API_CONNECTION_FAILED':
        statusCode = 503; // Service Unavailable
        userMessage = 'System configuration error: OpenAI API key not properly configured. Please contact support.';
        break;

      case 'PDF_EXTRACTION_FAILED':
        statusCode = 422; // Unprocessable Entity
        userMessage = 'Failed to extract QEEG data from PDF. Please ensure the PDF contains valid QEEG tables with absolute and relative power values.';
        break;

      default:
        userMessage = error.message || 'Failed to process QEEG files';
    }

    res.status(statusCode).json({
      error: true,
      message: userMessage,
      code: error.code || 'UNKNOWN_ERROR',
      technicalDetails: process.env.NODE_ENV === 'development' ? {
        originalMessage: error.message,
        stack: error.stack,
        condition: error.condition
      } : undefined
    });
  }
});

/**
 * POST /api/qeeg/generate-pdf
 * Generate PDF report from algorithm results
 */
router.post('/generate-pdf', async (req, res) => {
  try {
    console.log('\nðŸ“„ === PDF Report Generation Started ===\n');

    const { patientData, algorithmResults, qeegData } = req.body;

    // Validate input
    if (!patientData || !algorithmResults || !qeegData) {
      return res.status(400).json({
        error: true,
        message: 'Missing required data: patientData, algorithmResults, and qeegData are required'
      });
    }

    console.log('ðŸ‘¤ Patient:', patientData.name);
    console.log('ðŸ“Š Parameters:', algorithmResults.parameters?.length);

    // Generate PDF
    const generator = new PDFReportGenerator(patientData, algorithmResults, qeegData);

    // Create output filename
    const timestamp = Date.now();
    const sanitizedName = (patientData.name || 'patient').replace(/[^a-z0-9]/gi, '_').toLowerCase();
    const filename = `neurosense-report-${sanitizedName}-${timestamp}.pdf`;
    const outputPath = path.join(__dirname, '../uploads', filename);

    console.log('ðŸ“ Generating PDF to:', filename);

    // Generate the PDF
    const pdfPath = await generator.generateReport(outputPath);

    console.log('\nâœ… PDF Report Generated Successfully!');
    console.log('ðŸ“„ File:', filename);
    console.log('ðŸ“Š Size:', (fs.statSync(pdfPath).size / 1024).toFixed(2), 'KB');

    // Upload to Supabase Storage - TEMPORARILY DISABLED
    let supabaseUrl = null;
    let supabasePath = null;
    let uploadError = null;

    // DISABLE SUPABASE UPLOAD FOR NOW - USE LOCAL STORAGE ONLY
    console.log('\nðŸ“ Using local storage (Supabase upload disabled)');
    uploadError = 'Supabase upload disabled - using local storage';

    /* COMMENTED OUT - Enable when Supabase is configured properly
    try {
      console.log('\nâ˜ï¸  Uploading PDF to Supabase storage...');
      const uploadResult = await SupabaseStorage.uploadFile(
        pdfPath,
        'patient-reports', // bucket name
        `reports/${filename}` // path in bucket
      );

      // Verify upload was successful and URL is valid
      if (uploadResult && uploadResult.url) {
        supabaseUrl = uploadResult.url;
        supabasePath = uploadResult.path;

        console.log('âœ… PDF uploaded to Supabase successfully');
        console.log('ðŸ”— Supabase URL:', supabaseUrl);

        // Only delete local file after SUCCESSFUL Supabase upload
        try {
          fs.unlinkSync(pdfPath);
          console.log('ðŸ—‘ï¸  Local PDF file deleted after successful upload');
        } catch (deleteError) {
          console.warn('âš ï¸  Could not delete local PDF file:', deleteError.message);
        }
      } else {
        throw new Error('Supabase upload returned invalid result');
      }

    } catch (error) {
      console.error('âš ï¸  Supabase upload failed, using local storage:', error.message);
      uploadError = error.message;
      // Keep local file as fallback - DO NOT DELETE
      console.log('ðŸ“ Using local file as fallback');
    }
    */

    console.log('\nðŸ === PDF Generation Completed ===\n');

    // Return PDF info - prioritize Supabase URL
    res.json({
      success: true,
      data: {
        filename: filename,
        path: supabasePath || `/uploads/${filename}`,
        url: supabaseUrl || `${req.protocol}://${req.get('host')}/uploads/${filename}`,
        size: fs.existsSync(pdfPath) ? fs.statSync(pdfPath).size : 0,
        generatedAt: new Date().toISOString(),
        storage: supabaseUrl ? 'supabase' : 'local',
        uploadError: uploadError
      }
    });

  } catch (error) {
    console.error('\nâŒ === PDF Generation Failed ===');
    console.error('Error:', error.message);
    console.error('Stack:', error.stack);

    res.status(500).json({
      error: true,
      message: error.message || 'Failed to generate PDF report',
      details: process.env.NODE_ENV === 'development' ? error.stack : undefined
    });
  }
});

/**
 * POST /api/qeeg/generate-sample-pdf
 * Generate a sample PDF report for testing
 */
router.post('/generate-sample-pdf', async (req, res) => {
  try {
    console.log('\nðŸ“„ === Sample PDF Generation Started ===\n');

    const pdfPath = await PDFReportGenerator.generateSampleReport();

    console.log('âœ… Sample PDF Generated!');
    console.log('ðŸ“„ Path:', pdfPath);

    const filename = path.basename(pdfPath);

    res.json({
      success: true,
      data: {
        filename: filename,
        path: `/uploads/${filename}`,
        url: `${req.protocol}://${req.get('host')}/uploads/${filename}`,
        size: fs.statSync(pdfPath).size
      }
    });

  } catch (error) {
    console.error('âŒ Sample PDF generation failed:', error);

    res.status(500).json({
      error: true,
      message: error.message
    });
  }
});

/**
 * POST /api/qeeg/generate-ai-pdf
 * Generate AI-powered PDF report with enhanced design and content
 */
router.post('/generate-ai-pdf', async (req, res) => {
  try {
    console.log('\nðŸ¤– === AI PDF Report Generation Started ===\n');

    const { patientData, algorithmResults, qeegData } = req.body;

    // Validate input
    if (!patientData || !algorithmResults || !qeegData) {
      return res.status(400).json({
        error: true,
        message: 'Missing required data: patientData, algorithmResults, and qeegData are required'
      });
    }

    console.log('ðŸ‘¤ Patient:', patientData.name);
    console.log('ðŸ“Š Parameters:', algorithmResults.parameters?.length);
    console.log('ðŸŽ¯ Using AI-powered generation with enhanced prompt');

    // Generate AI PDF
    const generator = new AIPdfGenerator(patientData, algorithmResults, qeegData);

    // Create output filename
    const timestamp = Date.now();
    const sanitizedName = (patientData.name || 'patient').replace(/[^a-z0-9]/gi, '_').toLowerCase();
    const filename = `ai-neurosense-report-${sanitizedName}-${timestamp}.pdf`;
    const outputPath = path.join(__dirname, '../uploads', filename);

    console.log('ðŸ“ Generating AI PDF to:', filename);

    // Generate the PDF
    const result = await generator.generateReport(outputPath);

    console.log('\nâœ… AI NeuroSense Report Generated Successfully!');
    console.log('ðŸ“„ Text File:', path.basename(result.textOutputPath));
    console.log('ðŸ“„ JSON File:', path.basename(result.outputPath));
    console.log('ðŸ“Š Tokens Used:', result.tokensUsed);
    console.log('ðŸ“ Content Length:', result.contentLength, 'characters');
    console.log('\nðŸ === AI PDF Generation Completed ===\n');

    // Return report info
    res.json({
      success: true,
      data: {
        textFile: {
          filename: path.basename(result.textOutputPath),
          path: `/uploads/${path.basename(result.textOutputPath)}`,
          url: `${req.protocol}://${req.get('host')}/uploads/${path.basename(result.textOutputPath)}`,
          type: 'Plain Text Report'
        },
        jsonFile: {
          filename: path.basename(result.outputPath),
          path: `/uploads/${path.basename(result.outputPath)}`,
          url: `${req.protocol}://${req.get('host')}/uploads/${path.basename(result.outputPath)}`,
          type: 'Structured Data (JSON)'
        },
        contentLength: result.contentLength,
        tokensUsed: result.tokensUsed,
        generatedAt: new Date().toISOString()
      },
      message: 'AI-powered NeuroSense report generated successfully. Text file contains formatted report ready for PDF conversion.'
    });

  } catch (error) {
    console.error('\nâŒ === AI PDF Generation Failed ===');
    console.error('Error:', error.message);
    console.error('Stack:', error.stack);

    res.status(500).json({
      error: true,
      message: error.message || 'Failed to generate AI PDF report',
      details: process.env.NODE_ENV === 'development' ? error.stack : undefined
    });
  }
});

/**
 * POST /api/qeeg/generate-ai-sample-pdf
 * Generate a sample AI-powered PDF report for testing
 */
router.post('/generate-ai-sample-pdf', async (req, res) => {
  try {
    console.log('\nðŸ¤– === Sample AI PDF Generation Started ===\n');

    const result = await AIPdfGenerator.generateSampleReport();

    console.log('âœ… Sample AI PDF Generated!');
    console.log('ðŸ“„ Path:', result.outputPath);

    const filename = path.basename(result.outputPath);

    res.json({
      success: true,
      data: {
        filename: filename,
        path: `/uploads/${filename}`,
        url: `${req.protocol}://${req.get('host')}/uploads/${filename}`,
        contentLength: result.contentLength,
        tokensUsed: result.tokensUsed,
        type: 'AI-Generated Sample (JSON format)'
      }
    });

  } catch (error) {
    console.error('âŒ Sample AI PDF generation failed:', error);

    res.status(500).json({
      error: true,
      message: error.message
    });
  }
});

/**
 * GET /api/qeeg/test
 * Test endpoint to verify API is working
 */
router.get('/test', (req, res) => {
  res.json({
    success: true,
    message: 'QEEG Processing API is working',
    endpoints: {
      process: 'POST /api/qeeg/process - Upload and process QEEG files',
      generatePdf: 'POST /api/qeeg/generate-pdf - Generate PDF report from results (PDFKit)',
      generateSamplePdf: 'POST /api/qeeg/generate-sample-pdf - Generate sample PDF report (PDFKit)',
      generateAiPdf: 'POST /api/qeeg/generate-ai-pdf - Generate AI-powered PDF report (OpenAI)',
      generateAiSamplePdf: 'POST /api/qeeg/generate-ai-sample-pdf - Generate AI sample PDF report (OpenAI)'
    }
  });
});

module.exports = router;
