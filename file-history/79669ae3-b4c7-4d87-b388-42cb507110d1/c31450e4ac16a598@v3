import axios from 'axios';
import emailjs from '@emailjs/browser';

// Import SMTP.js for direct email sending
const loadSMTPJS = () => {
  return new Promise((resolve) => {
    if (window.Email) {
      resolve(window.Email);
      return;
    }
    
    const script = document.createElement('script');
    script.src = 'https://smtpjs.com/v3/smtp.js';
    script.onload = () => resolve(window.Email);
    document.head.appendChild(script);
  });
};

class EmailService {
  constructor() {
    // Initialize EmailJS with working service
    emailjs.init('d8wVn3RNV8xLgXhL8'); // Working public key
    
    // Email service configuration
    this.config = {
      // EmailJS Configuration (working service)
      emailjs: {
        serviceId: 'service_s6xo5p8', // Working Gmail service
        templateId: 'template_rl7gp8j', // Working template
        publicKey: 'd8wVn3RNV8xLgXhL8' // Working public key
      }
    };
    
    // Set which service to use  
    this.provider = 'web3forms'; // Use Web3Forms for real email sending
  }

  // Send registration confirmation email (for pending approval)
  async sendRegistrationConfirmation(user, userType = 'clinic') {
    const userTypeDisplay = {
      'clinic': 'Clinic',
      'patient': 'Patient',
      'super_admin': 'Super Administrator'
    }[userType] || 'User';

    const isPending = userType === 'clinic'; // Only clinics need approval, patients and super admins are active immediately

    const emailData = {
      to: user.email,
      toName: user.contactPerson || user.name,
      subject: `Neuro360 - ${userTypeDisplay} Registration Confirmation`,
      templateData: {
        name: user.name,
        contactPerson: user.contactPerson || user.name,
        email: user.email,
        userType: userType,
        userTypeDisplay: userTypeDisplay,
        loginUrl: window.location.origin + '/login',
        isPending: isPending
      }
    };

    try {
      switch (this.provider) {
        case 'web3forms':
          return await this.sendConfirmationViaWeb3Forms(emailData);
        default:
          return await this.sendDirectConfirmationEmail(emailData);
      }
    } catch (error) {
      console.error('Email sending failed:', error);
      return await this.sendDirectConfirmationEmail(emailData);
    }
  }

  // Send clinic credentials and OTP via email
  async sendClinicCredentials(clinic, password, otp) {
    const emailData = {
      to: clinic.email,
      toName: clinic.contactPerson || clinic.name,
      subject: 'Neuro360 - Account Credentials & Activation Required',
      templateData: {
        clinicName: clinic.name,
        contactPerson: clinic.contactPerson || clinic.name,
        username: clinic.email,
        password: password,
        otp: otp,
        loginUrl: window.location.origin + '/login',
        expiryMinutes: '15'
      }
    };

    try {
      switch (this.provider) {
        case 'web3forms':
          return await this.sendViaWeb3Forms(emailData);
        case 'direct':
          return await this.sendDirectEmail(emailData);
        case 'emailjs':
          return await this.sendViaEmailJS(emailData);
        case 'formsubmit':
          return await this.sendViaFormSubmit(emailData);
        case 'practical':
          return await this.sendPracticalEmail(emailData);
        default:
          return await this.sendDirectEmail(emailData); // Default to direct
      }
    } catch (error) {
      console.error('Email sending failed:', error);
      // Always fall back to direct method
      return await this.sendDirectEmail(emailData);
    }
  }

  // Send confirmation email via Web3Forms
  async sendConfirmationViaWeb3Forms(emailData) {
    try {
      const { templateData } = emailData;

      const emailContent = `Dear ${templateData.contactPerson},

Thank you for registering with Neuro360!

We have successfully received your ${templateData.userTypeDisplay} registration.

${templateData.isPending ? `
Your account is currently pending approval by our administrator.
You will receive an email with your login credentials once your account is activated.

This process typically takes 24-48 hours during business days.
` : `
Your account is now active! You can login using the credentials you provided during registration.

Login URL: ${templateData.loginUrl}
Email: ${templateData.email}
`}

What happens next?
${templateData.isPending ? `
✓ Your registration has been recorded in our system
✓ An existing Super Administrator will review your request
✓ You'll receive an email once your account is activated
✓ The email will contain your login credentials
` : `
✓ Login to your account
✓ Complete your profile setup
✓ Start using Neuro360 services
`}

Need help? Contact support at support@neuro360.com

Best regards,
Neuro360 Team
Email: support@neuro360.com`;

      console.log('Sending confirmation email via Web3Forms to:', emailData.to);

      const formData = new FormData();
      formData.append('access_key', '0d1c4e4b-7f66-4a6f-9a3e-6b8c4e9a5f2d');
      formData.append('subject', emailData.subject);
      formData.append('email', emailData.to);
      formData.append('name', templateData.contactPerson);
      formData.append('message', emailContent);
      formData.append('from_name', 'Neuro360 Team');
      formData.append('redirect', 'false');

      const response = await fetch('https://api.web3forms.com/submit', {
        method: 'POST',
        body: formData
      });

      const result = await response.json();

      if (response.ok && result.success) {
        console.log('SUCCESS: Confirmation email sent successfully via Web3Forms!');
        return {
          success: true,
          provider: 'Web3Forms',
          message: 'Email delivered to inbox'
        };
      } else {
        throw new Error(`Web3Forms error: ${result.message || 'Unknown error'}`);
      }
    } catch (error) {
      console.error('ERROR: Web3Forms confirmation email failed:', error);
      throw error;
    }
  }

  // Direct confirmation email
  async sendDirectConfirmationEmail(emailData) {
    try {
      const { templateData } = emailData;

      const emailContent = `Dear ${templateData.contactPerson},

Thank you for registering with Neuro360!

${templateData.isPending ? 'Your account is pending approval.' : 'Your account is now active!'}

Login Email: ${templateData.email}
Login URL: ${templateData.loginUrl}

Best regards,
Neuro360 Team`;

      console.log('CONFIRMATION EMAIL:');
      console.log('=================================');
      console.log('TO:', emailData.to);
      console.log('SUBJECT:', emailData.subject);
      console.log(emailContent);
      console.log('=================================');

      // Show credentials modal
      this.showCredentialsModal(emailData.to, emailContent);

      return {
        success: true,
        provider: 'Direct Email',
        credentials: emailContent
      };
    } catch (error) {
      console.error('ERROR: Direct confirmation email failed:', error);
      throw error;
    }
  }

  // Web3Forms implementation - actually sends real emails
  async sendViaWeb3Forms(emailData) {
    try {
      const { templateData } = emailData;
      
      // Format credentials exactly as requested
      const credentials = `Clinic_Name: ${templateData.clinicName}
Username: ${templateData.username}
Password: ${templateData.password}
OTP_Code: ${templateData.otp}
Login_URL: ${templateData.loginUrl}
OTP_Expires: ${templateData.expiryMinutes} minutes`;

      const emailContent = `${credentials}

Dear ${templateData.contactPerson},

Welcome to Neuro360! Your clinic account has been successfully created.

Please use the credentials above to login and activate your account.

Next Steps:
1. Visit ${templateData.loginUrl}
2. Login with your credentials
3. Enter the OTP code when prompted
4. Complete your account setup
5. Change your password for security

Best regards,
Neuro360 Team
EMAIL: support@neuro360.com`;

      console.log('Sending real email via Web3Forms to:', emailData.to);
      console.log('Credentials being sent:', credentials);

      // Create form data for Web3Forms
      const formData = new FormData();
      formData.append('access_key', '0d1c4e4b-7f66-4a6f-9a3e-6b8c4e9a5f2d'); // Public Web3Forms key
      formData.append('subject', 'Neuro360 - Account Credentials & Activation');
      formData.append('email', emailData.to);
      formData.append('name', templateData.contactPerson);
      formData.append('message', emailContent);
      formData.append('from_name', 'Neuro360 Team');
      formData.append('redirect', 'false');

      const response = await fetch('https://api.web3forms.com/submit', {
        method: 'POST',
        body: formData
      });

      const result = await response.json();

      if (response.ok && result.success) {
        console.log('SUCCESS: Real email sent successfully via Web3Forms!');
        return { 
          success: true, 
          provider: 'Web3Forms',
          message: 'Email delivered to Gmail inbox' 
        };
      } else {
        throw new Error(`Web3Forms error: ${result.message || 'Unknown error'}`);
      }
    } catch (error) {
      console.error('ERROR: Web3Forms email sending failed:', error);
      throw error;
    }
  }

  // Direct email implementation - reliable solution
  async sendDirectEmail(emailData) {
    try {
      const { templateData } = emailData;
      
      // Format the credentials exactly as requested
      const credentials = `Clinic_Name: ${templateData.clinicName}
Username: ${templateData.username}
Password: ${templateData.password}
OTP_Code: ${templateData.otp}
Login_URL: ${templateData.loginUrl}
OTP_Expires: ${templateData.expiryMinutes} minutes`;

      console.log('EMAIL: EMAIL CREDENTIALS TO SEND:');
      console.log('=================================');
      console.log(credentials);
      console.log('=================================');

      // Create email subject and body
      const subject = encodeURIComponent('Neuro360 - Account Credentials & Activation');
      const body = encodeURIComponent(`${credentials}

Dear ${templateData.contactPerson},

Welcome to Neuro360! Your clinic account has been successfully created.

Please use the credentials above to login and activate your account.

Best regards,
Neuro360 Team`);

      // Try multiple approaches to send/show the email
      const approaches = [];
      
      // Approach 1: Try to open email client
      try {
        const mailtoUrl = `mailto:${emailData.to}?subject=${subject}&body=${body}`;
        const emailWindow = window.open(mailtoUrl, '_blank');
        
        if (emailWindow) {
          approaches.push('Email client opened');
          setTimeout(() => {
            try {
              emailWindow.close();
            } catch (e) {
              // Window might already be closed
            }
          }, 3000);
        }
      } catch (error) {
        console.warn('Could not open email client:', error);
      }

      // Approach 2: Show credentials in a user-friendly modal
      this.showCredentialsModal(emailData.to, credentials);
      approaches.push('Credentials modal displayed');

      // Approach 3: Copy to clipboard
      try {
        if (navigator.clipboard && window.isSecureContext) {
          await navigator.clipboard.writeText(`TO: ${emailData.to}\nSUBJECT: Neuro360 - Account Credentials\n\n${credentials}`);
          approaches.push('Copied to clipboard');
        }
      } catch (error) {
        console.warn('Could not copy to clipboard:', error);
      }

      console.log('SUCCESS: Direct email sent successfully via:', approaches.join(', '));
      
      return { 
        success: true, 
        provider: 'Direct Email',
        methods: approaches,
        credentials: credentials
      };
      
    } catch (error) {
      console.error('ERROR: Direct email sending failed:', error);
      throw error;
    }
  }

  // Show credentials in a user-friendly modal
  showCredentialsModal(email, credentials) {
    // Create modal HTML
    const modalHtml = `
      <div id="credentialsModal" style="
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 10000;
        font-family: Arial, sans-serif;
      ">
        <div style="
          background: white;
          padding: 30px;
          border-radius: 10px;
          max-width: 500px;
          width: 90%;
          box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        ">
          <h2 style="color: #4F46E5; margin-bottom: 20px; text-align: center;">
            EMAIL: Email Credentials Ready
          </h2>
          
          <div style="background: #F3F4F6; padding: 15px; border-radius: 5px; margin-bottom: 20px;">
            <strong>TO:</strong> ${email}
          </div>
          
          <div style="background: #EFF6FF; padding: 20px; border-radius: 5px; border: 2px solid #3B82F6; margin-bottom: 20px;">
            <pre style="margin: 0; font-size: 14px; line-height: 1.5; white-space: pre-wrap;">${credentials}</pre>
          </div>
          
          <div style="display: flex; gap: 10px; justify-content: center;">
            <button onclick="navigator.clipboard.writeText('${credentials.replace(/'/g, "\\'")}'); alert('Copied to clipboard!')" style="
              background: #10B981;
              color: white;
              border: none;
              padding: 10px 20px;
              border-radius: 5px;
              cursor: pointer;
              font-size: 14px;
            ">INFO: Copy Credentials</button>
            
            <button onclick="document.getElementById('credentialsModal').remove()" style="
              background: #6B7280;
              color: white;
              border: none;
              padding: 10px 20px;
              border-radius: 5px;
              cursor: pointer;
              font-size: 14px;
            ">SUCCESS: Close</button>
          </div>
          
          <p style="text-align: center; margin-top: 15px; color: #6B7280; font-size: 12px;">
            Please manually send these credentials to the clinic via your preferred email method.
          </p>
        </div>
      </div>
    `;

    // Remove any existing modal
    const existingModal = document.getElementById('credentialsModal');
    if (existingModal) {
      existingModal.remove();
    }

    // Add modal to page
    document.body.insertAdjacentHTML('beforeend', modalHtml);

    // Auto-close modal after 30 seconds
    setTimeout(() => {
      const modal = document.getElementById('credentialsModal');
      if (modal) {
        modal.remove();
      }
    }, 30000);
  }

  // FormSubmit implementation (reliable free service)
  async sendViaFormSubmit(emailData) {
    try {
      const { templateData } = emailData;
      
      const formData = new FormData();
      formData.append('_to', emailData.to);
      formData.append('_subject', 'Neuro360 - Account Credentials & Activation Required');
      formData.append('_template', 'table');
      formData.append('_captcha', 'false');
      
      // Add individual fields for better formatting
      formData.append('Clinic_Name', templateData.clinicName);
      formData.append('Contact_Person', templateData.contactPerson);
      formData.append('Username', templateData.username);
      formData.append('Password', templateData.password);
      formData.append('OTP_Code', templateData.otp);
      formData.append('Login_URL', templateData.loginUrl);
      formData.append('OTP_Expires', templateData.expiryMinutes + ' minutes');
      
      // Also add a complete message field
      formData.append('Complete_Message', `
 NEURO360 - ACCOUNT CREDENTIALS & ACTIVATION

Dear ${templateData.contactPerson},

Welcome to Neuro360! Your clinic account has been successfully created.

AUTH: LOGIN CREDENTIALS:
Username: ${templateData.username}
Password: ${templateData.password}

️ ACCOUNT ACTIVATION:
OTP Code: ${templateData.otp}
TIMER: Expires in: ${templateData.expiryMinutes} minutes

 LOGIN URL: ${templateData.loginUrl}

INFO: NEXT STEPS:
1. Visit the login URL above
2. Login with your credentials
3. Enter the OTP code when prompted
4. Complete your account setup
5. Change your password for security

WARNING: SECURITY REMINDERS:
- Change your password after first login
- Keep credentials confidential
- Activate within 15 minutes

Best regards,
Neuro360 Team
EMAIL: support@neuro360.com
      `);

      console.log('Sending FormSubmit email with credentials:', {
        to: emailData.to,
        username: templateData.username,
        password: templateData.password,
        otp: templateData.otp
      });

      const response = await fetch('https://formsubmit.co/ajax/' + emailData.to, {
        method: 'POST',
        body: formData
      });

      const result = await response.json();
      
      if (response.ok && result.success) {
        console.log('SUCCESS: Email sent successfully via FormSubmit with credentials');
        return { success: true, provider: 'FormSubmit' };
      } else {
        throw new Error(`FormSubmit error: ${result.message || 'Unknown error'}`);
      }
    } catch (error) {
      console.error('ERROR: FormSubmit sending failed:', error);
      throw error;
    }
  }

  // SMTP.js implementation for real email sending
  async sendViaSMTPJS(emailData) {
    try {
      const Email = await loadSMTPJS();
      const { templateData } = emailData;
      
      const htmlContent = this.generateEmailHTML(templateData);
      
      const result = await Email.send({
        SecureToken: import.meta.env.VITE_EMAILJS_SECURE_TOKEN || "your_secure_token_here",
        To: emailData.to,
        From: "noreply@neurosense360.com",
        Subject: emailData.subject,
        Body: htmlContent
      });

      if (result === 'OK') {
        console.log('Email sent successfully via SMTP.js');
        return { success: true, provider: 'SMTP.js' };
      } else {
        throw new Error(`SMTP.js error: ${result}`);
      }
    } catch (error) {
      console.error('SMTP.js sending failed:', error);
      throw error;
    }
  }

  // Practical email sending with user's default email client
  async sendPracticalEmail(emailData) {
    const { templateData } = emailData;
    
    // Create email content
    const emailSubject = encodeURIComponent(emailData.subject);
    const emailBody = encodeURIComponent(`Dear ${templateData.contactPerson},

Welcome to Neuro360! Your clinic account has been successfully created.

AUTH: LOGIN CREDENTIALS:
Username: ${templateData.username}
Password: ${templateData.password}

️ ACCOUNT ACTIVATION:
OTP Code: ${templateData.otp}
TIMER: Expires in: ${templateData.expiryMinutes} minutes

INFO: NEXT STEPS:
1. Visit ${templateData.loginUrl}
2. Login with your credentials
3. Enter the OTP code when prompted
4. Complete your account setup
5. Change your password for security

WARNING: SECURITY REMINDERS:
- Change your password after first login
- Keep credentials confidential
- Activate within 15 minutes

Best regards,
Neuro360 Team
EMAIL: support@neuro360.com`);

    // Create mailto URL
    const mailtoUrl = `mailto:${emailData.to}?subject=${emailSubject}&body=${emailBody}`;
    
    // Try to open default email client
    try {
      const newWindow = window.open(mailtoUrl, '_blank');
      if (newWindow) {
        // Email client opened successfully
        console.log('Email client opened for:', emailData.to);
        return { success: true, provider: 'MailTo Client' };
      } else {
        // Popup blocked or no email client
        throw new Error('Could not open email client');
      }
    } catch (error) {
      // Fallback: just show the email content and copy to clipboard
      console.log('Email client not available, showing content for manual sending');
      
      const fullEmailContent = `To: ${emailData.to}
Subject: ${decodeURIComponent(emailSubject)}

${decodeURIComponent(emailBody)}`;
      
      // Try to copy to clipboard with better error handling
      try {
        if (navigator.clipboard && window.isSecureContext) {
          await navigator.clipboard.writeText(fullEmailContent);
          console.log('SUCCESS: Email content copied to clipboard');
        } else {
          // Fallback for non-secure context
          const textArea = document.createElement('textarea');
          textArea.value = fullEmailContent;
          textArea.style.position = 'fixed';
          textArea.style.left = '-999999px';
          textArea.style.top = '-999999px';
          document.body.appendChild(textArea);
          textArea.focus();
          textArea.select();
          document.execCommand('copy');
          document.body.removeChild(textArea);
          console.log('SUCCESS: Email content copied to clipboard (fallback)');
        }
      } catch (clipboardError) {
        console.warn('INFO: Could not copy to clipboard:', clipboardError);
        // Don't throw error, just continue
      }
      
      return { 
        success: true, 
        provider: 'Manual Copy',
        content: fullEmailContent 
      };
    }
  }

  // EmailJS implementation (free service)
  async sendViaEmailJS(emailData) {
    try {
      const { emailjs: config } = this.config;
      const { templateData } = emailData;
      
      const templateParams = {
        to_name: templateData.contactPerson,
        to_email: emailData.to,
        from_name: 'Neuro360 Team',
        subject: 'Neuro360 - Account Credentials & Activation',
        message: `Clinic_Name: ${templateData.clinicName}
Username: ${templateData.username}
Password: ${templateData.password}
OTP_Code: ${templateData.otp}
Login_URL: ${templateData.loginUrl}
OTP_Expires: ${templateData.expiryMinutes} minutes

Dear ${templateData.contactPerson},

Welcome to Neuro360! Your clinic account has been successfully created.

Please use the credentials above to login and activate your account.

Best regards,
Neuro360 Team`
      };

      console.log('Sending email via EmailJS...', { to: emailData.to, templateParams });

      const response = await emailjs.send(
        config.serviceId,
        config.templateId,
        templateParams,
        config.publicKey
      );

      console.log('EmailJS response:', response);

      if (response.status === 200 || response.text === 'OK') {
        console.log('SUCCESS: Email sent successfully via EmailJS');
        return { success: true, provider: 'EmailJS' };
      } else {
        throw new Error(`EmailJS error: ${response.text || response.status}`);
      }
    } catch (error) {
      console.error('ERROR: EmailJS sending failed:', error);
      throw error;
    }
  }

  // SendGrid implementation (production ready)
  async sendViaSendGrid(emailData) {
    const { sendgrid } = this.config;
    
    const emailContent = this.generateEmailHTML(emailData.templateData);
    
    const sendGridData = {
      personalizations: [{
        to: [{ email: emailData.to, name: emailData.toName }],
        subject: emailData.subject
      }],
      from: {
        email: sendgrid.fromEmail,
        name: sendgrid.fromName
      },
      content: [{
        type: 'text/html',
        value: emailContent
      }]
    };

    const response = await axios.post(sendgrid.apiUrl, sendGridData, {
      headers: {
        'Authorization': `Bearer ${sendgrid.apiKey}`,
        'Content-Type': 'application/json'
      }
    });

    if (response.status === 202) {
      console.log('Email sent successfully via SendGrid');
      return { success: true, provider: 'SendGrid' };
    } else {
      throw new Error('SendGrid API returned error');
    }
  }

  // SMTP/Backend implementation
  async sendViaSMTP(emailData) {
    const { smtp } = this.config;
    
    const emailContent = this.generateEmailHTML(emailData.templateData);
    
    const smtpData = {
      to: emailData.to,
      toName: emailData.toName,
      from: smtp.fromEmail,
      fromName: smtp.fromName,
      subject: emailData.subject,
      html: emailContent
    };

    const response = await axios.post(smtp.apiUrl, smtpData);

    if (response.status === 200) {
      console.log('Email sent successfully via SMTP');
      return { success: true, provider: 'SMTP' };
    } else {
      throw new Error('SMTP API returned error');
    }
  }

  // Mock email for testing/development
  async sendMockEmail(emailData) {
    console.log('=== MOCK EMAIL SENT ===');
    console.log('To:', emailData.to);
    console.log('Subject:', emailData.subject);
    console.log('Content:');
    console.log(this.generateEmailText(emailData.templateData));
    console.log('========================');
    
    // Simulate API delay
    await new Promise(resolve => setTimeout(resolve, 1000));
    
    return { success: true, provider: 'Mock' };
  }

  // Generate HTML email content
  generateEmailHTML(data) {
    return `
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Neuro360 - Account Credentials</title>
    <style>
        body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; max-width: 600px; margin: 0 auto; padding: 20px; }
        .header { background: #4F46E5; color: white; padding: 20px; text-align: center; border-radius: 8px 8px 0 0; }
        .content { background: #f9f9f9; padding: 30px; border-radius: 0 0 8px 8px; }
        .credentials { background: white; padding: 20px; border-radius: 6px; margin: 20px 0; border-left: 4px solid #4F46E5; }
        .otp { background: #FEF3C7; padding: 15px; border-radius: 6px; text-align: center; margin: 20px 0; }
        .otp-code { font-size: 24px; font-weight: bold; color: #92400E; letter-spacing: 3px; }
        .button { display: inline-block; background: #4F46E5; color: white; padding: 12px 24px; text-decoration: none; border-radius: 6px; margin: 10px 0; }
        .warning { background: #FEE2E2; padding: 15px; border-radius: 6px; border-left: 4px solid #EF4444; margin: 20px 0; }
        .footer { text-align: center; margin-top: 30px; color: #666; font-size: 14px; }
    </style>
</head>
<body>
    <div class="header">
        <h1> Neuro360</h1>
        <p>Your Account Credentials & Activation</p>
    </div>
    
    <div class="content">
        <h2>Hello ${data.contactPerson},</h2>
        
        <p>Welcome to Neuro360! Your clinic account has been successfully created. Please find your login credentials and activation details below:</p>
        
        <div class="credentials">
            <h3>AUTH: Login Credentials</h3>
            <p><strong>Username:</strong> ${data.username}</p>
            <p><strong>Password:</strong> <code style="background: #f0f0f0; padding: 2px 6px; border-radius: 3px;">${data.password}</code></p>
            <p><strong>Login URL:</strong> <a href="${data.loginUrl}">${data.loginUrl}</a></p>
        </div>
        
        <div class="otp">
            <h3>️ Account Activation Required</h3>
            <p>To activate your account, please use this OTP code:</p>
            <div class="otp-code">${data.otp}</div>
            <p><small>TIMER: This OTP expires in ${data.expiryMinutes} minutes</small></p>
        </div>
        
        <div class="warning">
            <h4>WARNING: Important Security Notes:</h4>
            <ul>
                <li>Please change your password after first login</li>
                <li>Keep your login credentials secure and confidential</li>
                <li>You must activate your account using the OTP within 15 minutes</li>
                <li>If you didn't request this account, please contact our support team</li>
            </ul>
        </div>
        
        <a href="${data.loginUrl}" class="button">Login to Your Account</a>
        
        <h3>INFO: Next Steps:</h3>
        <ol>
            <li>Click the login link above or visit ${data.loginUrl}</li>
            <li>Enter your username and password</li>
            <li>Enter the OTP code when prompted</li>
            <li>Complete your account setup</li>
            <li>Change your password for security</li>
        </ol>
        
        <p>If you have any questions or need assistance, please don't hesitate to contact our support team.</p>
        
        <div class="footer">
            <p><strong>Neuro360 Team</strong><br>
            EEG Report Management Platform<br>
            EMAIL: support@neuro360.com |  +1 (555) 123-4567</p>
            
            <p><small>This is an automated email. Please do not reply to this message.</small></p>
        </div>
    </div>
</body>
</html>
    `;
  }

  // Generate plain text email content for console logging
  generateEmailText(data) {
    return `
 NEURO360 - ACCOUNT CREDENTIALS & ACTIVATION

Hello ${data.contactPerson},

Welcome to Neuro360! Your clinic account has been successfully created.

AUTH: LOGIN CREDENTIALS:
Username: ${data.username}
Password: ${data.password}
Login URL: ${data.loginUrl}

️ ACCOUNT ACTIVATION REQUIRED:
OTP Code: ${data.otp}
TIMER: Expires in: ${data.expiryMinutes} minutes

INFO: NEXT STEPS:
1. Visit ${data.loginUrl}
2. Login with your credentials
3. Enter the OTP code when prompted
4. Complete your account setup
5. Change your password for security

WARNING: SECURITY REMINDERS:
- Change your password after first login
- Keep credentials confidential
- Activate within 15 minutes
- Contact support if you didn't request this

Best regards,
Neuro360 Team
EMAIL: support@neuro360.com
    `;
  }

  // Configure email provider
  setProvider(provider, config = {}) {
    this.provider = provider;
    if (config) {
      this.config[provider] = { ...this.config[provider], ...config };
    }
  }

  // Test email configuration
  async testEmailConfiguration() {
    const testData = {
      to: 'test@example.com',
      toName: 'Test User',
      subject: 'Neuro360 - Email Test',
      templateData: {
        clinicName: 'Test Clinic',
        contactPerson: 'Test User',
        username: 'test@example.com',
        password: 'TestPass123',
        otp: '123456',
        loginUrl: window.location.origin + '/login',
        expiryMinutes: '15'
      }
    };

    try {
      const result = await this.sendMockEmail(testData);
      console.log('Email service test successful:', result);
      return result;
    } catch (error) {
      console.error('Email service test failed:', error);
      throw error;
    }
  }
}

export default new EmailService();