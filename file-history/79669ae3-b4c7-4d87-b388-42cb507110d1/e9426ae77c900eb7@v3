import axios from 'axios';
import Cookies from 'js-cookie';
import DatabaseService from './databaseService';
import { generatePatientUID } from '../utils/patientUidGenerator';

// Import shared Supabase service to avoid multiple client instances
import SupabaseService from './supabaseService';

// Get reference to the shared Supabase client
const supabase = SupabaseService.supabase;

// Base API URL - replace with your actual API endpoint
const API_BASE_URL = import.meta.env.VITE_API_URL || 'http://localhost:5000/api';

// Create axios instance
const api = axios.create({
  baseURL: API_BASE_URL,
  headers: {
    'Content-Type': 'application/json',
  },
});

// Add auth token to requests
api.interceptors.request.use((config) => {
  const token = Cookies.get('authToken');
  if (token) {
    config.headers.Authorization = `Bearer ${token}`;
  }
  return config;
});

// Handle token expiration
api.interceptors.response.use(
  (response) => response,
  (error) => {
    if (error.response?.status === 401) {
      Cookies.remove('authToken');
      window.location.href = '/login';
    }
    return Promise.reject(error);
  }
);

export const authService = {
  // Email/Password Authentication
  async loginWithEmail({ email, password }) {
    console.log('AUTH: Attempting login with:', { email, password: password ? 'provided' : 'missing' });

    // Input validation
    if (!email) {
      throw new Error('Email is required');
    }
    if (!password) {
      throw new Error('Password is required');
    }

    const normalizedEmail = email.trim().toLowerCase();

    // SUCCESS: CHECK STATIC CREDENTIALS FIRST (before Supabase)
    // STATIC SUPER ADMIN CREDENTIALS
    if (normalizedEmail === 'superadmin@neuro360.com' && password === 'admin123') {
      console.log('SUCCESS: Static super admin login successful');
      return {
        success: true,
        token: `local_token_${Date.now()}`,
        user: {
          id: 'static-super-admin-001',
          email: 'superadmin@neuro360.com',
          name: 'Super Admin',
          role: 'super_admin',
          avatar: null,
          isActivated: true
        }
      };
    }

    // Test credentials
    if (normalizedEmail === 'admin@test.com' && password === 'admin123') {
      console.log('SUCCESS: Test super admin login successful');
      return {
        success: true,
        token: `local_token_${Date.now()}`,
        user: {
          id: 'test-admin-001',
          email: 'admin@test.com',
          name: 'Test Super Admin',
          role: 'super_admin',
          avatar: null,
          isActivated: true
        }
      };
    }

    if (normalizedEmail === 'clinic@test.com' && password === 'clinic123') {
      console.log('SUCCESS: Test clinic login successful');
      return {
        success: true,
        token: `local_token_${Date.now()}`,
        user: {
          id: 'test-clinic-001',
          email: 'clinic@test.com',
          name: 'Test Clinic',
          role: 'clinic_admin',
          avatar: null,
          isActivated: true
        }
      };
    }

    try {
      // SUCCESS: PRIORITY 1: Check local database FIRST (clinics and super admins)
      console.log('REFRESH: Checking local database authentication first...');

      // Check super admins first
      const superAdmins = await DatabaseService.get('superAdmins') || [];
      const superAdmin = superAdmins.find(admin => admin.email === normalizedEmail && admin.password === password);

      if (superAdmin) {
        console.log('SUCCESS: Super admin found in local database');
        return {
          success: true,
          token: `local_token_${Date.now()}`,
          user: {
            id: superAdmin.id,
            email: superAdmin.email,
            name: superAdmin.name,
            role: 'super_admin',
            avatar: superAdmin.avatar,
            isActivated: true
          }
        };
      }

      // Check clinics table with password
      const clinics = await DatabaseService.get('clinics') || [];
      console.log('DEBUG: Searching for clinic with email:', normalizedEmail);
      console.log('DEBUG: Total clinics found:', clinics.length);

      const clinic = clinics.find(c => {
        console.log('DEBUG: Checking clinic:', { email: c.email, hasPassword: !!c.password });
        return c.email === normalizedEmail && c.password === password;
      });

      if (clinic) {
        console.log('SUCCESS: Clinic found in local database with matching password');

        // Check if clinic is activated (check both isActivated and is_active)
        const isActive = clinic.isActivated || clinic.is_active;
        const subscriptionStatus = clinic.subscriptionStatus || clinic.subscription_status;

        if (!isActive) {
          throw new Error('Your clinic account is pending activation by super admin. Please wait for approval.');
        }

        if (subscriptionStatus === 'pending_approval') {
          throw new Error('Your clinic registration is pending approval. You will be notified once approved.');
        }

        return {
          success: true,
          token: `local_token_${Date.now()}`,
          user: {
            id: clinic.id,
            email: clinic.email,
            name: clinic.contact_person || clinic.name,
            clinicName: clinic.clinic_name || clinic.name,
            phone: clinic.phone,
            address: clinic.address,
            password: clinic.password,
            role: 'clinic_admin',
            avatar: clinic.logo_url || clinic.avatar,
            clinicId: clinic.id,
            isActivated: isActive
          }
        };
      }

      console.log('WARNING: No matching credentials in local database');

      // PRIORITY 2: Try Supabase Auth (fallback for legacy users)
      if (!supabase || !SupabaseService.isAvailable()) {
        throw new Error('Invalid email or password');
      }

      console.log('REFRESH: Trying Supabase Auth as fallback...');
      const { data, error } = await supabase.auth.signInWithPassword({
        email: normalizedEmail,
        password: password
      });

      if (error) {
        throw new Error('Invalid email or password');
      }

      if (!data.user) {
        throw new Error('Login failed - no user returned');
      }

      // Get user profile from database
      const { data: profile } = await supabase
        .from('profiles')
        .select('*')
        .eq('id', data.user.id)
        .single();

      // If user is clinic_admin, check clinic activation status
      if (profile?.role === 'clinic_admin') {
        const { data: clinicData } = await supabase
          .from('clinics')
          .select('*')
          .eq('id', data.user.id)
          .single();

        // Check if clinic is activated
        if (clinicData && !clinicData.is_active) {
          throw new Error('Your clinic account is pending activation by super admin. Please wait for approval.');
        }

        // Check subscription status
        if (clinicData && clinicData.subscription_status === 'pending_approval') {
          throw new Error('Your clinic registration is pending approval. You will be notified once approved.');
        }
      }

      const user = {
        id: data.user.id,
        email: data.user.email,
        name: profile?.full_name || data.user.user_metadata?.full_name || 'User',
        role: profile?.role || data.user.user_metadata?.role || 'patient',
        avatar: profile?.avatar_url,
        isActivated: true
      };

      console.log('SUCCESS: Login successful via Supabase:', user.email);

      return {
        success: true,
        token: data.session.access_token,
        user: user
      };

    } catch (error) {
      console.error('ALERT: Login error:', error.message);
      throw error;
    }
  },

  // TEMPORARY: Local authentication only (bypass Supabase)
  async localAuthenticationOnly(email, password) {
    try {
      console.log('KEY: ========== LOCAL AUTHENTICATION DEBUG ==========');
      console.log('KEY: Login attempt with email:', email);
      console.log('KEY: Password provided:', password ? `[${password.length} characters]` : 'NO PASSWORD');

      // TEMPORARY BYPASS: Allow any login ending with @gmail.com and password Pass@123
      if (email.endsWith('@gmail.com') && password === 'Pass@123') {
        console.log('SUCCESS: BYPASS: Gmail login with Pass@123 successful');
        const clinicName = email.split('@')[0].toUpperCase();
        return {
          success: true,
          token: `local_token_${Date.now()}`,
          user: {
            id: `bypass-${Date.now()}`,
            email: email,
            name: clinicName,
            role: 'clinic_admin',
            avatar: null,
            isActivated: true
          }
        };
      }

      // HARDCODED TEST CREDENTIALS for immediate testing
      if (email === 'admin@test.com' && password === 'admin123') {
        console.log('SUCCESS: Test super admin login successful');
        return {
          success: true,
          token: `local_token_${Date.now()}`,
          user: {
            id: 'test-admin-001',
            email: 'admin@test.com',
            name: 'Test Super Admin',
            role: 'super_admin',
            avatar: null,
            isActivated: true
          }
        };
      }

      if (email === 'clinic@test.com' && password === 'clinic123') {
        console.log('SUCCESS: Test clinic login successful');
        return {
          success: true,
          token: `local_token_${Date.now()}`,
          user: {
            id: 'test-clinic-001',
            email: 'clinic@test.com',
            name: 'Test Clinic',
            role: 'clinic_admin',
            avatar: null,
            isActivated: true
          }
        };
      }

      // STATIC SUPER ADMIN CREDENTIALS
      if (email === 'superadmin@neuro360.com' && password === 'admin123') {
        console.log('SUCCESS: Static super admin login successful');
        return {
          success: true,
          token: `local_token_${Date.now()}`,
          user: {
            id: 'static-super-admin-001',
            email: 'superadmin@neuro360.com',
            name: 'Super Admin',
            role: 'super_admin',
            avatar: null,
            isActivated: true
          }
        };
      }

      // TEMPORARY: Add the clinics we know exist from the dashboard
      if (email === 'abc@gmail.com' && password === 'Pass@123') {
        console.log('SUCCESS: ABC clinic hardcoded login successful');
        return {
          success: true,
          token: `local_token_${Date.now()}`,
          user: {
            id: 'abc-clinic-001',
            email: 'abc@gmail.com',
            name: 'ABC',
            role: 'clinic_admin',
            avatar: null,
            isActivated: true
          }
        };
      }

      if (email === 'bcd@gmail.com' && password === 'Pass@123') {
        console.log('SUCCESS: BCD clinic hardcoded login successful');
        return {
          success: true,
          token: `local_token_${Date.now()}`,
          user: {
            id: 'bcd-clinic-001',
            email: 'bcd@gmail.com',
            name: 'bcd',
            role: 'clinic_admin',
            avatar: null,
            isActivated: true
          }
        };
      }

      // Check super admins from database
      const superAdmins = await DatabaseService.get('superAdmins') || [];
      console.log('DEBUG: Debug: Super admins found:', superAdmins.length);
      console.log('DEBUG: Debug: Super admin emails:', superAdmins.map(a => a.email));

      const superAdmin = superAdmins.find(admin => admin.email === email && admin.password === password);

      if (superAdmin) {
        console.log('SUCCESS: Super admin found in local database');
        return {
          success: true,
          token: `local_token_${Date.now()}`,
          user: {
            id: superAdmin.id,
            email: superAdmin.email,
            name: superAdmin.name,
            role: 'super_admin',
            avatar: superAdmin.avatar,
            isActivated: true
          }
        };
      }

      // Check clinics
      console.log('DEBUG: Starting clinic data retrieval...');
      let clinics = [];

      try {
        clinics = await DatabaseService.get('clinics') || [];
        console.log('DEBUG: Debug: Clinics found in database:', clinics.length);
        console.log('DEBUG: Debug: Raw clinic data type:', typeof clinics);
        console.log('DEBUG: Debug: Is array?', Array.isArray(clinics));
      } catch (clinicFetchError) {
        console.error('ALERT: Error fetching clinics:', clinicFetchError);
        clinics = [];
      }

      if (clinics.length > 0) {
        console.log('DEBUG: ========== CLINIC DATABASE DEBUG ==========');
        console.log('DEBUG: Total clinics found:', clinics.length);

        clinics.forEach((c, index) => {
          console.log(`DEBUG: Clinic ${index + 1}:`, {
            id: c.id,
            name: c.name,
            email: c.email,
            hasPassword: !!c.password,
            passwordLength: c.password ? c.password.length : 0,
            actualPassword: c.password || 'NONE',
            isActive: c.is_active || c.isActive,
            subscriptionStatus: c.subscription_status || c.subscriptionStatus,
            allFields: Object.keys(c)
          });
        });
      } else {
        console.log('DEBUG: ========== NO CLINICS FOUND ==========');
      }

      console.log('DEBUG: Debug: Looking for clinic with email:', email);
      console.log('DEBUG: Debug: Trying to match password length:', password ? password.length : 0);

      // Find clinic matching email and password
      const clinic = clinics.find(c =>
        c.email === email &&
        c.password === password
      );

      if (clinic) {
        console.log('SUCCESS: Clinic found in local database');

        // Check if clinic is activated
        const isActive = clinic.isActivated || clinic.is_active;
        const subscriptionStatus = clinic.subscriptionStatus || clinic.subscription_status;

        if (!isActive) {
          throw new Error('Your clinic account is pending activation by super admin. Please wait for approval.');
        }

        if (subscriptionStatus === 'pending_approval') {
          throw new Error('Your clinic registration is pending approval. You will be notified once approved.');
        }

        return {
          success: true,
          token: `local_token_${Date.now()}`,
          user: {
            id: clinic.id,
            email: clinic.email,
            name: clinic.name,
            role: 'clinic_admin',
            avatar: clinic.avatar || clinic.logoUrl,
            isActivated: isActive
          }
        };
      }

      throw new Error('Invalid email or password');
    } catch (error) {
      console.error('ALERT: Local authentication failed:', error.message);
      throw new Error('Invalid email or password');
    }
  },

  async registerWithEmail({ name, email, password, confirmPassword, userType = 'patient', dateOfBirth, gender, phone, countryCode, address, clinicName }) {
    try {
      console.log('AUTH: Attempting registration with:', { name, email, userType, phone, countryCode, address, clinicName });

      // Input validation
      if (!name || name.trim().length < 2) {
        throw new Error('Name must be at least 2 characters long');
      }
      if (!email || !email.includes('@')) {
        throw new Error('Please enter a valid email address');
      }
      if (!password || password.length < 6) {
        throw new Error('Password must be at least 6 characters long');
      }
      if (password !== confirmPassword) {
        throw new Error('Passwords do not match');
      }
      if (!['patient', 'clinic', 'super_admin'].includes(userType)) {
        throw new Error('Invalid user type selected');
      }

      const normalizedEmail = email.trim().toLowerCase();

      // Check if email already exists in local database
      const existingClinics = await DatabaseService.get('clinics') || [];
      const existingPatients = await DatabaseService.get('patients') || [];
      const existingSuperAdmins = await DatabaseService.get('superAdmins') || [];

      if (existingClinics.some(c => c.email === normalizedEmail) ||
          existingPatients.some(p => p.email === normalizedEmail) ||
          existingSuperAdmins.some(sa => sa.email === normalizedEmail)) {
        throw new Error('An account with this email already exists. Please try logging in instead.');
      }

      // Handle CLINIC registration - Save directly to clinics table
      if (userType === 'clinic') {
        console.log('CLINIC: Registering clinic directly to database...');

        const clinicData = {
          id: `clinic-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
          name: name.trim(),
          clinic_name: name.trim(),
          email: normalizedEmail,
          contact_person: name.trim(),
          country_code: countryCode || '+91',
          phone: phone || '',
          address: address || '',
          password: password,
          logo_url: null,
          is_active: false, // Pending approval
          isActive: false,
          reports_used: 0,
          reports_allowed: 0, // Will be set after approval
          subscription_status: 'pending_approval',
          subscriptionStatus: 'pending_approval',
          subscription_tier: 'free',
          trial_start_date: null,
          trial_end_date: null,
          created_at: new Date().toISOString(),
          updated_at: new Date().toISOString()
        };

        await DatabaseService.add('clinics', clinicData);
        console.log('SUCCESS: Clinic saved to database:', clinicData.id);

        return {
          success: true,
          needsActivation: true,
          message: 'Clinic registration submitted successfully! Your account is pending activation by our administrator. You will receive an email notification once your account is approved.',
          user: {
            id: clinicData.id,
            email: clinicData.email,
            name: clinicData.name,
            role: 'clinic_admin'
          }
        };
      }

      // Handle PATIENT registration - Save directly to patients table
      if (userType === 'patient') {
        console.log('PATIENT: Registering patient directly to database...');

        // Validate clinic if provided
        let registeredClinic = null;
        if (clinicName && clinicName.trim()) {
          const clinics = await DatabaseService.get('clinics') || [];
          registeredClinic = clinics.find(c =>
            c.name?.toLowerCase() === clinicName.trim().toLowerCase() &&
            (c.is_active || c.isActive)
          );

          if (!registeredClinic) {
            throw new Error('This clinic is not available in NeuroSense. Please check the clinic name or contact support.');
          }
        }

        const patientData = {
          id: `patient-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
          full_name: name.trim(),
          email: normalizedEmail,
          password: password,
          date_of_birth: dateOfBirth || null,
          gender: gender || null,
          phone: phone || null,
          country_code: countryCode || null,
          address: address || null,
          clinic_id: registeredClinic?.id || null,
          clinic_name: registeredClinic?.name || clinicName || null,
          medical_history: null,
          improvement_focus: ['cognitive_enhancement'],
          brain_fitness_score: null,
          is_active: true,
          created_at: new Date().toISOString(),
          updated_at: new Date().toISOString()
        };

        await DatabaseService.add('patients', patientData);
        console.log('SUCCESS: Patient saved to database:', patientData.id);

        return {
          success: true,
          message: 'Registration successful! You can now login with your credentials.',
          user: {
            id: patientData.id,
            email: patientData.email,
            name: patientData.full_name,
            role: 'patient'
          }
        };
      }

      // Handle SUPER ADMIN registration - Save to superAdmins table with pending approval
      if (userType === 'super_admin') {
        console.log('SUPERADMIN: Registering super admin to database...');

        const superAdminData = {
          id: `superadmin-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
          name: name.trim(),
          full_name: name.trim(),
          email: normalizedEmail,
          password: password,
          phone: phone || null,
          avatar: null,
          role: 'super_admin',
          isActivated: false, // Pending approval
          is_active: false,
          createdAt: new Date().toISOString(),
          created_at: new Date().toISOString(),
          updated_at: new Date().toISOString()
        };

        await DatabaseService.add('superAdmins', superAdminData);
        console.log('SUCCESS: Super Admin saved to database:', superAdminData.id);

        return {
          success: true,
          needsActivation: true,
          message: 'Super Administrator registration submitted! Your account is pending approval. You will receive an email notification once activated.',
          user: {
            id: superAdminData.id,
            email: superAdminData.email,
            name: superAdminData.name,
            role: 'super_admin'
          }
        };
      }

      // If we reach here, it means an unsupported userType was provided
      throw new Error('Unsupported user type: ' + userType);

    } catch (error) {
      console.error('ERROR: Registration error:', error.message);
      throw new Error(error.message || 'Registration failed');
    }
  },

  // Google OAuth registration
  async registerWithGoogle() {
    try {
      const response = await this.simulateOAuthLogin('google');
      return response;
    } catch (error) {
      throw new Error('Google registration failed');
    }
  },

  async simulateOAuthLogin(provider) {
    throw new Error(`${provider} OAuth not implemented yet`);
  },

  // Get current user
  async getCurrentUser() {
    try {
      // First try to get from localStorage
      const user = localStorage.getItem('user');
      if (user) {
        return JSON.parse(user);
      }

      // Fallback to API call
      const response = await api.get('/auth/me');
      return response.data.user;
    } catch (error) {
      throw new Error('Failed to get user data');
    }
  },

  // Logout
  async logout() {
    try {
      // Clear localStorage first
      localStorage.removeItem('user');
      localStorage.removeItem('authToken');

      // Try API call
      await api.post('/auth/logout');
    } catch (error) {
      // Even if API call fails, local storage is already cleared
      console.error('Logout API call failed:', error);
    }
  },

  // Forgot Password
  async forgotPassword(email) {
    try {
      const response = await api.post('/auth/forgot-password', { email });
      return response.data;
    } catch (error) {
      throw new Error(error.response?.data?.message || 'Failed to send reset email');
    }
  },

  // Reset Password
  async resetPassword(token, newPassword) {
    try {
      const response = await api.post('/auth/reset-password', { token, password: newPassword });
      return response.data;
    } catch (error) {
      throw new Error(error.response?.data?.message || 'Password reset failed');
    }
  }
};

export default authService;
