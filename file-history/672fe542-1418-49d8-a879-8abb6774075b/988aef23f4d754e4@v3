/**
 * Apply Patient UID Migration
 * This script applies the clinic_code column migration to organizations table
 */

import { supabase } from '../lib/supabaseClient.js';
import fs from 'fs';
import path from 'path';

async function applyMigration() {
  console.log('üöÄ Starting Patient UID Migration...\n');

  try {
    // Step 1: Add clinic_code column to organizations
    console.log('Step 1: Adding clinic_code column to organizations table...');

    const { error: alterError } = await supabase.rpc('exec_sql', {
      sql: `
        -- Add clinic_code column to organizations table
        ALTER TABLE organizations
        ADD COLUMN IF NOT EXISTS clinic_code VARCHAR(50);
      `
    });

    if (alterError && !alterError.message.includes('already exists')) {
      console.error('‚ùå Error adding clinic_code column:', alterError);

      // Try alternative method using direct SQL
      console.log('Trying alternative method...');
      const { error: directError } = await supabase
        .from('organizations')
        .select('id')
        .limit(1);

      if (directError) {
        throw new Error('Cannot connect to database');
      }
    } else {
      console.log('‚úÖ clinic_code column added successfully');
    }

    // Step 2: Fetch all organizations and generate clinic codes
    console.log('\nStep 2: Generating clinic codes for existing organizations...');

    const { data: organizations, error: fetchError } = await supabase
      .from('organizations')
      .select('id, name, clinic_code');

    if (fetchError) {
      throw fetchError;
    }

    console.log(`Found ${organizations.length} organizations`);

    // Step 3: Update organizations without clinic codes
    let updated = 0;
    const usedCodes = new Set();

    for (const org of organizations) {
      if (!org.clinic_code) {
        // Generate clinic code from name
        let baseCode = org.name
          .toUpperCase()
          .replace(/[^A-Z0-9]/g, '')
          .substring(0, 8);

        if (!baseCode) {
          baseCode = 'CLINIC';
        }

        let finalCode = baseCode;
        let counter = 1;

        // Ensure uniqueness
        while (usedCodes.has(finalCode)) {
          finalCode = baseCode + String(counter).padStart(2, '0');
          counter++;
        }

        usedCodes.add(finalCode);

        // Update organization
        const { error: updateError } = await supabase
          .from('organizations')
          .update({ clinic_code: finalCode })
          .eq('id', org.id);

        if (updateError) {
          console.error(`‚ùå Error updating org ${org.name}:`, updateError);
        } else {
          console.log(`‚úÖ Generated code "${finalCode}" for ${org.name}`);
          updated++;
        }
      } else {
        usedCodes.add(org.clinic_code);
        console.log(`‚ÑπÔ∏è  Organization "${org.name}" already has code: ${org.clinic_code}`);
      }
    }

    console.log(`\n‚úÖ Migration completed successfully!`);
    console.log(`üìä Summary:`);
    console.log(`   - Total organizations: ${organizations.length}`);
    console.log(`   - Updated with new codes: ${updated}`);
    console.log(`   - Already had codes: ${organizations.length - updated}`);

    console.log('\nüéâ Patient UID format is now active!');
    console.log('üìã Format: CLINICCODE-YYYYMM-XXXX');
    console.log('üìù Example: HOPE-202502-0012\n');

  } catch (error) {
    console.error('‚ùå Migration failed:', error);
    throw error;
  }
}

// Run migration
applyMigration()
  .then(() => {
    console.log('‚úÖ All done!');
    process.exit(0);
  })
  .catch((error) => {
    console.error('‚ùå Fatal error:', error);
    process.exit(1);
  });
